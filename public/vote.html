<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ è¯¾å ‚ç­”é¢˜å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f3f4f6; padding-bottom: 80px; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; color: #666; }
        
        /* é¢˜ç›®å¡ç‰‡ */
        .question-box {
            background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .q-title { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 15px; }
        .q-opt { font-size: 1rem; color: #555; margin-bottom: 8px; padding: 5px; }
        
        /* æŒ‰é’® */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button.vote-btn {
            padding: 20px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 12px; color: white; cursor: pointer;
            touch-action: manipulation; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        button:disabled { background-color: #cbd5e1 !important; opacity: 0.6; }
        
        .btn-a { background-color: #FF6384; } .btn-b { background-color: #36A2EB; }
        .btn-c { background-color: #FFCE56; } .btn-d { background-color: #4BC0C0; }
        
        #status-msg { text-align: center; margin-top: 20px; font-weight: bold; color: #666; }
    </style>
</head>
<body>

    <div class="info-bar">
        <span>ğŸ‘¤ <span id="user-name">...</span></span>
        <span>ç¬¬ <span id="round-num">1</span> é¢˜</span>
    </div>

    <div class="question-box">
        <div id="q-title" class="q-title">ç­‰å¾…è€å¸ˆå‡ºé¢˜...</div>
        <div id="q-options"></div>
    </div>

    <div class="options-grid">
        <button class="vote-btn btn-a" onclick="submitVote('A')">A</button>
        <button class="vote-btn btn-b" onclick="submitVote('B')">B</button>
        <button class="vote-btn btn-c" onclick="submitVote('C')">C</button>
        <button class="vote-btn btn-d" onclick="submitVote('D')">D</button>
    </div>

    <div id="status-msg"></div>

    <style>
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 999; }
        .nav-item { text-decoration: none; color: #94a3b8; font-size: 12px; display: flex; flex-direction: column; align-items: center; }
        .nav-icon { font-size: 24px; }
    </style>
    <div class="bottom-nav">
        <a href="sign.html" class="nav-item"><span>ğŸ“…</span>ç­¾åˆ°</a>
        <a href="vote.html" class="nav-item" style="color:#2563eb; font-weight:bold;"><span>ğŸ“Š</span>ç­”é¢˜</a>
        <a href="danmu.html" class="nav-item"><span>ğŸ’¬</span>å¼¹å¹•</a>
        <a href="buzzer.html" class="nav-item"><span>âš¡</span>æŠ¢ç­”</a>
    </div>
    <script>
        const supabaseUrl = 'https://ä½ çš„é¡¹ç›®ID.supabase.co' 
        const supabaseKey = 'ä½ çš„anon_public_key'
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)

        let myName = localStorage.getItem('my_name');
        let myId = localStorage.getItem('my_id');
        let currentRound = 1;
        let isRoundActive = true;

        if (!myName) window.location.href = 'sign.html';
        document.getElementById('user-name').innerText = myName;

        async function init() {
            const { data: config } = await supabaseClient.from('vote_config').select('*').eq('id', 1).single();
            if (config) handleRoundChange(config);

            supabaseClient.channel('student-vote')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => {
                    handleRoundChange(payload.new);
                }).subscribe();
        }

        async function handleRoundChange(config) {
            currentRound = config.current_round;
            isRoundActive = config.is_active;
            document.getElementById('round-num').innerText = currentRound;
            
            // åŠ è½½é¢˜ç›®
            loadQuestion(currentRound);
            checkIfIVoted();

            if (!isRoundActive) {
                disableButtons();
                document.getElementById('status-msg').innerText = "â›” ç­”é¢˜ç»“æŸ";
            } else {
                document.getElementById('status-msg').innerText = "è¯·ä½œç­”";
            }
        }

        async function loadQuestion(round) {
            const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
            if (data) {
                document.getElementById('q-title').innerText = `${round}. ${data.title}`;
                document.getElementById('q-options').innerHTML = `
                    <div class="q-opt">A. ${data.option_a}</div>
                    <div class="q-opt">B. ${data.option_b}</div>
                    <div class="q-opt">C. ${data.option_c}</div>
                    <div class="q-opt">D. ${data.option_d}</div>
                `;
            } else {
                document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜`;
                document.getElementById('q-options').innerHTML = `<div style="color:#999; font-style:italic;">(å¬è€å¸ˆå£è¿°é¢˜ç›®)</div>`;
            }
        }

        async function checkIfIVoted() {
            const { data } = await supabaseClient.from('vote_logs').select('option').eq('student_id', myId).eq('round', currentRound).single();
            if (data) {
                disableButtons();
                document.getElementById('status-msg').innerText = `âœ… ä½ å·²é€‰: ${data.option}`;
            } else if (isRoundActive) {
                enableButtons();
            }
        }

        async function submitVote(option) {
            if (!isRoundActive) return alert("å·²åœæ­¢ä½œç­”");
            disableButtons();
            const { error } = await supabaseClient.from('vote_logs').insert([{ student_name: myName, student_id: myId, option: option, round: currentRound }]);
            if (!error) document.getElementById('status-msg').innerText = `âœ… å·²æäº¤: ${option}`;
            else enableButtons();
        }

        function disableButtons() { document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true); }
        function enableButtons() { document.querySelectorAll('.vote-btn').forEach(b => b.disabled = false); }

        init();
    </script>
    <script>
(function() {
    // ä¿æŠ¤æœºåˆ¶ï¼šæ£€æŸ¥é¡µé¢æ˜¯å¦å·²ç»è¿æ¥äº† Supabase
    // å¦‚æœé¡µé¢æœ¬èº«è¿˜æ²¡åŠ è½½å¥½ supabaseClientï¼Œè¿™æ®µä»£ç å°±ä¸è¿è¡Œï¼Œé˜²æ­¢æŠ¥é”™
    const checkInterval = setInterval(() => {
        if (typeof supabaseClient !== 'undefined') {
            clearInterval(checkInterval);
            startListening();
        }
    }, 100);

    function startListening() {
        console.log("ğŸ“¡ å·²å¯åŠ¨è¯¾å ‚é¥æ§ç›‘å¬...");
        supabaseClient
            .channel('global-control-sub')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state' }, payload => {
                const data = payload.new;
                const currentPath = window.location.pathname; // è·å–å½“å‰æ–‡ä»¶å (å¦‚ /vote.html)
                
                // 1. è€å¸ˆå¼€å¯äº†æŸä¸ªåŠŸèƒ½
                if (data.status === 'active' && data.current_page !== 'idle') {
                    // å¦‚æœæˆ‘å½“å‰ä¸åœ¨è€å¸ˆæŒ‡å®šçš„é¡µé¢ï¼Œå°±å¼ºåˆ¶è·³è¿‡å»
                    // ä¾‹å¦‚ï¼šè€å¸ˆå¼€äº† vote.htmlï¼Œä½†æˆ‘è¿˜åœ¨ sign.htmlï¼Œæˆ‘å°±å¾—è·³
                    if (!currentPath.includes(data.current_page)) {
                        console.log(`ğŸ‘¨â€ğŸ« è€å¸ˆåˆ‡æ¢åˆ°äº† ${data.current_page}ï¼Œæ­£åœ¨è·Ÿè¿›...`);
                        window.location.href = data.current_page;
                    }
                } 
                // 2. è€å¸ˆé‡Šæ”¾äº†æ§åˆ¶ (ä¸‹è¯¾/è‡ªç”±æ´»åŠ¨)
                else if (data.status === 'idle') {
                    // å¦‚æœæˆ‘ç°åœ¨ä¸æ˜¯åœ¨é¦–é¡µï¼Œå°±è¢«è¸¢å›é¦–é¡µ
                    if (!currentPath.includes('index.html')) {
                        console.log("â¸ï¸ è‡ªç”±æ´»åŠ¨æ¨¡å¼ï¼Œè¿”å›é¦–é¡µ");
                        window.location.href = 'index.html';
                    }
                }
            })
            .subscribe();
    }
})();
</script>
</body>
</html>