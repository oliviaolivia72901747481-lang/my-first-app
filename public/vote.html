<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾å ‚å®æ—¶ç­”é¢˜</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; text-align: center; background-color: #f9f9f9; }
        h1 { color: #333; margin-bottom: 30px; }
        
        /* æŠ•ç¥¨æŒ‰é’®åŒºåŸŸ */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        button {
            padding: 25px;
            font-size: 2rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.96); box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        
        .btn-a { background-color: #FF6384; }
        .btn-b { background-color: #36A2EB; }
        .btn-c { background-color: #FFCE56; }
        .btn-d { background-color: #4BC0C0; }

        /* å›¾è¡¨åŒºåŸŸ */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .reset-btn {
            margin-top: 40px;
            background-color: #666;
            color: white;
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .reset-btn:hover { background-color: #444; }
    </style>
</head>
<body>

    <h1>ğŸ“Š è¯¾å ‚äº’åŠ¨ï¼šè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</h1>

    <div class="options-grid">
        <button class="btn-a" onclick="vote('count_a')">A</button>
        <button class="btn-b" onclick="vote('count_b')">B</button>
        <button class="btn-c" onclick="vote('count_c')">C</button>
        <button class="btn-d" onclick="vote('count_d')">D</button>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <button class="reset-btn" onclick="resetVotes()">ğŸ”„ ç®¡ç†å‘˜å½’é›¶</button>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // âš ï¸ è¯·åŠ¡å¿…ç¡®è®¤è¿™é‡Œå¡«å…¥çš„æ˜¯æ­£ç¡®çš„ URL å’Œ Key (å’Œ clicker.html é‡Œçš„ä¸€æ ·)
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co' 
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h'
        // ===========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)
        
        // æ³¨å†Œæ’ä»¶
        Chart.register(ChartDataLabels);

        // åˆå§‹åŒ–å›¾è¡¨
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A', 'B', 'C', 'D'],
                datasets: [{
                    label: 'å¾—ç¥¨æ•°',
                    data: [0, 0, 0, 0], 
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    borderRadius: 8, // æŸ±å­åœ†è§’
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { display: false }, // éšè—æ¨ªå‘ç½‘æ ¼çº¿ï¼Œæ›´æ¸…çˆ½
                        ticks: { display: false } // éšè—Yè½´åˆ»åº¦ï¼Œå› ä¸ºæŸ±å­ä¸Šæœ‰æ•°å­—äº†
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 16, weight: 'bold' } }
                    }
                },
                plugins: {
                    legend: { display: false }, // éšè—å›¾ä¾‹ï¼Œæ²¡å¿…è¦
                    // ğŸ†• é…ç½®æ•°å­—æ˜¾ç¤º
                    datalabels: {
                        color: 'white', // å­—ä½“é¢œè‰²
                        font: {
                            weight: 'bold',
                            size: 24 // å­—å·åŠ å¤§
                        },
                        anchor: 'center', // æ•°å­—æ˜¾ç¤ºåœ¨æŸ±å­ä¸­é—´
                        align: 'center',
                        // å¦‚æœæ•°å­—æ˜¯0ï¼Œå°±ä¸æ˜¾ç¤ºï¼Œé¿å…éš¾çœ‹
                        formatter: (value) => {
                            return value > 0 ? value : ''; 
                        }
                    }
                }
            }
        });

        let currentData = { count_a: 0, count_b: 0, count_c: 0, count_d: 0 };

        // è·å–åˆå§‹æ•°æ®
        async function fetchInitialData() {
            const { data, error } = await supabaseClient
                .from('counter')
                .select('*')
                .eq('id', 1)
                .single()

            if (data) updateLocalData(data)
        }

        // å®æ—¶ç›‘å¬
        supabaseClient
            .channel('vote-channel')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'counter' }, payload => {
                updateLocalData(payload.new)
            })
            .subscribe()

        function updateLocalData(data) {
            currentData = data;
            myChart.data.datasets[0].data = [data.count_a, data.count_b, data.count_c, data.count_d];
            myChart.update();
        }

        async function vote(columnName) {
            // ä¹è§‚æ›´æ–°ï¼šæœ¬åœ°å…ˆåŠ 
            const newValue = currentData[columnName] + 1
            currentData[columnName] = newValue; // æ›´æ–°æœ¬åœ°å˜é‡
            
            // æ‰‹åŠ¨è§¦å‘å›¾è¡¨æ›´æ–°ï¼ˆä¸ºäº†å¿«ï¼‰
            myChart.data.datasets[0].data = [currentData.count_a, currentData.count_b, currentData.count_c, currentData.count_d];
            myChart.update();

            const updateObj = {}
            updateObj[columnName] = newValue

            const { error } = await supabaseClient
                .from('counter')
                .update(updateObj)
                .eq('id', 1)
        }

        // ğŸ”’ å¸¦æœ‰å¯†ç ä¿æŠ¤çš„é‡ç½®åŠŸèƒ½
        async function resetVotes() {
            // 1. å¼¹å‡ºå¯†ç è¾“å…¥æ¡†
            let password = prompt("ğŸ” åªæœ‰è€å¸ˆå¯ä»¥æ“ä½œ\nè¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š");

            // 2. æ ¡éªŒå¯†ç  (ä½ å¯ä»¥æŠŠ '888888' æ”¹æˆä½ æƒ³è¦çš„ä»»ä½•æ•°å­—)
            if (password !== "888888") {
                alert("âŒ å¯†ç é”™è¯¯ï¼ä½ æ²¡æœ‰æƒé™æ¸…é›¶ã€‚");
                return; // ç›´æ¥ç»“æŸï¼Œä¸æ‰§è¡Œåé¢ä»£ç 
            }

            // 3. äºŒæ¬¡ç¡®è®¤é˜²æ­¢æ‰‹æ»‘
            if(!confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨æ•°æ®å—ï¼Ÿ\n(æ­¤æ“ä½œä¸å¯æ’¤é”€)")) return;
            
            // 4. ç«‹å³æœ¬åœ°å½’é›¶ (ä¹è§‚æ›´æ–°)
            const zeroData = { count_a: 0, count_b: 0, count_c: 0, count_d: 0 };
            updateLocalData(zeroData);

            // 5. å‘é€è¯·æ±‚ç»™æ•°æ®åº“
            const { error } = await supabaseClient
                .from('counter')
                .update(zeroData)
                .eq('id', 1)
            
            if (error) {
                alert("é‡ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
                console.error(error);
            } else {
                // å¯é€‰ï¼šé‡ç½®æˆåŠŸæç¤º
                // alert("å·²å½’é›¶ï¼"); 
            }
        }

        fetchInitialData()
    </script>
</body>
</html>