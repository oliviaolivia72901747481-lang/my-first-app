<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ è¯¾å ‚ç­”é¢˜å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #f3f4f6; 
            /* ç§»é™¤äº† padding-bottomï¼Œå› ä¸ºæ²¡æœ‰åº•éƒ¨æ äº† */
        }

        .info-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            font-size: 0.9rem; 
            color: #666; 
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* é¢˜ç›®å¡ç‰‡ */
        .question-box {
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            min-height: 120px;
        }
        .q-title { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 15px; line-height: 1.4; }
        .q-opt { font-size: 1rem; color: #555; margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 5px; }
        
        /* æŒ‰é’® */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button.vote-btn {
            padding: 20px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 12px; color: white; cursor: pointer;
            touch-action: manipulation; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        button.vote-btn:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background-color: #cbd5e1 !important; opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-a { background-color: #FF6384; } 
        .btn-b { background-color: #36A2EB; }
        .btn-c { background-color: #FFCE56; } 
        .btn-d { background-color: #4BC0C0; }
        
        #status-msg { text-align: center; margin-top: 20px; font-weight: bold; color: #666; height: 24px; }
    </style>
</head>
<body>

    <div class="info-bar">
        <span>ğŸ‘¤ <span id="user-name">...</span></span>
        <span>ç¬¬ <span id="round-num">1</span> é¢˜</span>
    </div>

    <div class="question-box">
        <div id="q-title" class="q-title">ç­‰å¾…è€å¸ˆå‡ºé¢˜...</div>
        <div id="q-options"></div>
    </div>

    <div class="options-grid">
        <button class="vote-btn btn-a" onclick="submitVote('A')">A</button>
        <button class="vote-btn btn-b" onclick="submitVote('B')">B</button>
        <button class="vote-btn btn-c" onclick="submitVote('C')">C</button>
        <button class="vote-btn btn-d" onclick="submitVote('D')">D</button>
    </div>

    <div id="status-msg"></div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // âš ï¸âš ï¸âš ï¸ è¯·åŠ¡å¿…å¡«å…¥æ‚¨çœŸå®çš„ Supabase URL å’Œ Key âš ï¸âš ï¸âš ï¸
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co' 
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h' 
        // (å¦‚æœä¸Šé¢çš„ Key æŠ¥é”™ï¼Œè¯·ç”¨æ‚¨ä¹‹å‰ vote.html é‡Œé‚£ä¸ªé•¿çš„ Key)
        // ===========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)

        let myName = localStorage.getItem('my_name');
        let myId = localStorage.getItem('my_id');
        let currentRound = 1;
        let isRoundActive = true;

        // èº«ä»½æ£€æŸ¥
        if (!myName) {
            alert("âš ï¸ è¯·å…ˆç­¾åˆ°ï¼");
            window.location.href = 'sign.html';
        } else {
            document.getElementById('user-name').innerText = myName;
        }

        async function init() {
            // ä½¿ç”¨ maybeSingle é˜²æ­¢ 406 æŠ¥é”™
            const { data: config } = await supabaseClient.from('vote_config').select('*').eq('id', 1).maybeSingle();
            if (config) handleRoundChange(config);

            supabaseClient.channel('student-vote')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => {
                    handleRoundChange(payload.new);
                }).subscribe();
        }

        async function handleRoundChange(config) {
            currentRound = config.current_round;
            isRoundActive = config.is_active;
            document.getElementById('round-num').innerText = currentRound;
            
            // åŠ è½½é¢˜ç›®
            loadQuestion(currentRound);
            checkIfIVoted();

            if (!isRoundActive) {
                disableButtons();
                document.getElementById('status-msg').innerText = "â›” ç­”é¢˜ç»“æŸ";
                document.getElementById('status-msg').style.color = "#ef4444";
            } else {
                document.getElementById('status-msg').innerText = "è¯·ä½œç­”";
                document.getElementById('status-msg').style.color = "#666";
            }
        }

        async function loadQuestion(round) {
            // ä½¿ç”¨ maybeSingle é˜²æ­¢ 406 æŠ¥é”™
            const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
            if (data) {
                document.getElementById('q-title').innerText = `${round}. ${data.title}`;
                document.getElementById('q-options').innerHTML = `
                    <div class="q-opt">A. ${data.option_a}</div>
                    <div class="q-opt">B. ${data.option_b}</div>
                    <div class="q-opt">C. ${data.option_c}</div>
                    <div class="q-opt">D. ${data.option_d}</div>
                `;
            } else {
                document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜`;
                document.getElementById('q-options').innerHTML = `<div style="color:#999; font-style:italic;">(å¬è€å¸ˆå£è¿°é¢˜ç›®æˆ–æŸ¥çœ‹å¤§å±)</div>`;
            }
        }

        async function checkIfIVoted() {
            // ä½¿ç”¨ maybeSingle é˜²æ­¢ 406 æŠ¥é”™
            const { data } = await supabaseClient.from('vote_logs').select('option').eq('student_id', myId).eq('round', currentRound).maybeSingle();
            if (data) {
                disableButtons();
                document.getElementById('status-msg').innerText = `âœ… ä½ å·²é€‰: ${data.option}`;
                document.getElementById('status-msg').style.color = "#10b981";
            } else if (isRoundActive) {
                enableButtons();
            }
        }

        async function submitVote(option) {
            if (!isRoundActive) return alert("å·²åœæ­¢ä½œç­”");
            disableButtons();
            
            const { error } = await supabaseClient.from('vote_logs').insert([{ 
                student_name: myName, 
                student_id: myId, 
                option: option, 
                round: currentRound 
            }]);

            if (!error) {
                document.getElementById('status-msg').innerText = `âœ… å·²æäº¤: ${option}`;
                document.getElementById('status-msg').style.color = "#10b981";
            } else {
                alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                enableButtons();
            }
        }

        function disableButtons() { document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true); }
        function enableButtons() { document.querySelectorAll('.vote-btn').forEach(b => b.disabled = false); }

        init();
    </script>

    <script>
    (function() {
        const checkInterval = setInterval(() => {
            if (typeof supabaseClient !== 'undefined') {
                clearInterval(checkInterval);
                startListening();
            }
        }, 100);

        function startListening() {
            supabaseClient
                .channel('global-control-sub')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state' }, payload => {
                    const data = payload.new;
                    const currentPath = window.location.pathname;
                    
                    if (data.status === 'active' && data.current_page !== 'idle') {
                        // å¦‚æœè€å¸ˆåˆ‡åˆ°äº†åˆ«çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚ buzzer.htmlï¼‰ï¼Œç«‹åˆ»è·³è¿‡å»
                        if (!currentPath.includes(data.current_page)) {
                            window.location.href = data.current_page;
                        }
                    } else if (data.status === 'idle') {
                        // è€å¸ˆä¸‹è¯¾ï¼Œè·³å›é¦–é¡µ
                        window.location.href = 'index.html';
                    }
                })
                .subscribe();
        }
    })();
    </script>
</body>
</html>