<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š å®åæŠ•ç¥¨ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; text-align: center; background-color: #f3f4f6; }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .user-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-name { font-weight: bold; color: #2563eb; }

        /* æŠ•ç¥¨æŒ‰é’®ç½‘æ ¼ */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        button.vote-btn {
            padding: 25px;
            font-size: 2rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button.vote-btn:active { transform: scale(0.96); }
        
        /* ç¦ç”¨çŠ¶æ€ï¼ˆæŠ•å®Œç¥¨åï¼‰ */
        button.vote-btn:disabled {
            background-color: #cbd5e1 !important; /* ç°è‰² */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-a { background-color: #FF6384; }
        .btn-b { background-color: #36A2EB; }
        .btn-c { background-color: #FFCE56; }
        .btn-d { background-color: #4BC0C0; }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* è€å¸ˆç®¡ç†åŒº */
        .admin-area {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
            text-align: right;
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <div class="user-info">
        <span id="welcome-msg">æœªç™»å½•</span>
        <span id="vote-status">æ£€æµ‹ä¸­...</span>
    </div>

    <h1>ğŸ¤” è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</h1>

    <div class="options-grid">
        <button class="vote-btn btn-a" onclick="submitVote('A')">A</button>
        <button class="vote-btn btn-b" onclick="submitVote('B')">B</button>
        <button class="vote-btn btn-c" onclick="submitVote('C')">C</button>
        <button class="vote-btn btn-d" onclick="submitVote('D')">D</button>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <div class="admin-area">
        <button class="btn-small btn-export" onclick="exportDetails()">ğŸ“¥ å¯¼å‡ºæ˜ç»†Excel</button>
        <button class="btn-small btn-reset" onclick="resetAll()">ğŸ”„ æ¸…ç©ºé‡ç½®</button>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co' 
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h'
        // ===========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)
        
        // å…¨å±€å˜é‡
        let myName = localStorage.getItem('my_name');
        let myId = localStorage.getItem('my_id');
        let hasVoted = false;
        let allVotes = []; // å­˜æ‰€æœ‰æŠ•ç¥¨æ•°æ®ï¼Œç”¨äºç”»å›¾å’Œå¯¼å‡º

        // 0. èº«ä»½æ£€æŸ¥ (æ ¸å¿ƒå‡çº§)
        function checkIdentity() {
            if (!myName || !myId) {
                alert("âš ï¸ è¯·å…ˆè¿›è¡Œè¯¾å ‚ç­¾åˆ°ï¼\nå³å°†è·³è½¬åˆ°ç­¾åˆ°é¡µé¢...");
                window.location.href = 'sign.html'; // å¼ºåˆ¶è·³è½¬
                return;
            }
            document.getElementById('welcome-msg').innerHTML = `æˆ‘æ˜¯: <span class="user-name">${myName}</span>`;
        }
        checkIdentity();

        // 1. å›¾è¡¨åˆå§‹åŒ– (Chart.js)
        Chart.register(ChartDataLabels);
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A', 'B', 'C', 'D'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { color: 'white', font: { weight: 'bold', size: 24 }, anchor: 'center', align: 'center', formatter: (v) => v > 0 ? v : '' }
                },
                scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 16, weight: 'bold' } } } }
            }
        });

        // 2. åŠ è½½æ•°æ® & æ£€æŸ¥æˆ‘æ˜¯å¦æŠ•è¿‡
        async function loadVotes() {
            // æŸ¥å‡ºæ‰€æœ‰æŠ•ç¥¨è®°å½•
            const { data, error } = await supabaseClient.from('vote_logs').select('*');
            
            if (data) {
                allVotes = data;
                updateChart(data);
                checkIfIVoted(data);
            }
        }

        // 3. æ›´æ–°å›¾è¡¨ (çº¯å‰ç«¯è®¡ç®—ï¼Œä¸å†ä¾èµ– counter è¡¨)
        function updateChart(data) {
            // ç»Ÿè®¡ A, B, C, D çš„æ•°é‡
            const counts = { A: 0, B: 0, C: 0, D: 0 };
            data.forEach(row => {
                if (counts[row.option] !== undefined) {
                    counts[row.option]++;
                }
            });
            
            myChart.data.datasets[0].data = [counts.A, counts.B, counts.C, counts.D];
            myChart.update();
        }

        // 4. æ£€æŸ¥æ˜¯å¦å·²æŠ•
        function checkIfIVoted(data) {
            // åœ¨æ‰€æœ‰è®°å½•é‡Œæ‰¾æœ‰æ²¡æœ‰æˆ‘çš„å­¦å·
            const myVote = data.find(row => row.student_id === myId);
            
            if (myVote) {
                hasVoted = true;
                disableButtons(myVote.option);
                document.getElementById('vote-status').innerText = `å·²æŠ•: ${myVote.option}`;
                document.getElementById('vote-status').style.color = "#10b981";
            } else {
                hasVoted = false;
                enableButtons();
                document.getElementById('vote-status').innerText = "è¯·æŠ•ç¥¨";
            }
        }

        // 5. æäº¤æŠ•ç¥¨ (å®åå†™å…¥)
        async function submitVote(option) {
            if (hasVoted) return alert("ğŸš« ä½ å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½é‡å¤æŠ•ï¼");

            // ç¦ç”¨æŒ‰é’®é˜²æ­¢è¿ç‚¹
            disableButtons(option);

            const { error } = await supabaseClient
                .from('vote_logs')
                .insert([
                    { 
                        student_name: myName, 
                        student_id: myId, 
                        option: option 
                    }
                ]);

            if (error) {
                alert("æŠ•ç¥¨å¤±è´¥: " + error.message);
                enableButtons(); // æ¢å¤æŒ‰é’®
            } else {
                // æˆåŠŸåï¼Œä¸éœ€è¦æ‰‹åŠ¨åˆ·æ–°ï¼Œä¸‹é¢çš„ Realtime ç›‘å¬ä¼šè‡ªåŠ¨æ›´æ–°å›¾è¡¨
                document.getElementById('vote-status').innerText = `å·²æŠ•: ${option}`;
            }
        }

        // 6. å®æ—¶ç›‘å¬ (Realtime)
        supabaseClient
            .channel('vote-room')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vote_logs' }, payload => {
                // æ— è®ºè°æŠ•äº†ï¼Œæˆ–è€…é‡ç½®äº†ï¼Œç®€å•ç²—æš´ï¼šé‡æ–°æ‹‰å–æœ€æ–°æ•°æ®
                loadVotes();
            })
            .subscribe();

        // è¾…åŠ©å·¥å…·ï¼šç¦ç”¨æŒ‰é’®
        function disableButtons(selectedOption) {
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                // é«˜äº®é€‰ä¸­çš„é‚£ä¸ª
                if (selectedOption && btn.innerText === selectedOption) {
                    btn.style.opacity = "1";
                    btn.style.border = "4px solid #333";
                    btn.style.transform = "scale(1.05)";
                }
            });
        }

        function enableButtons() {
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.border = "none";
                btn.style.transform = "none";
            });
        }

        // 7. è€å¸ˆåŠŸèƒ½ï¼šæ¸…ç©ºæ•°æ®
        async function resetAll() {
            let pwd = prompt("ğŸ” è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç è¿›è¡Œæ¸…ç©ºï¼š");
            if (pwd !== "888888") return alert("å¯†ç é”™è¯¯");

            if(!confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨è®°å½•å—ï¼Ÿ")) return;

            const { error } = await supabaseClient
                .from('vote_logs')
                .delete()
                .neq('id', 0); // åˆ é™¤æ‰€æœ‰

            if (error) alert("æ¸…ç©ºå¤±è´¥");
        }

        // 8. è€å¸ˆåŠŸèƒ½ï¼šå¯¼å‡º Excel
        function exportDetails() {
            if(allVotes.length === 0) return alert("æš‚æ— æ•°æ®");
            
            let pwd = prompt("ğŸ” å¯¼å‡ºåŒ…å«å­¦ç”Ÿå®åä¿¡æ¯ï¼Œè¯·è¾“å…¥å¯†ç ï¼š");
            if (pwd !== "888888") return alert("å¯†ç é”™è¯¯");

            const excelData = allVotes.map(row => ({
                "å­¦å·": row.student_id,
                "å§“å": row.student_name,
                "é€‰æ‹©": row.option,
                "æ—¶é—´": new Date(row.created_at).toLocaleTimeString()
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æŠ•ç¥¨æ˜ç»†");
            XLSX.writeFile(wb, `æŠ•ç¥¨ç»Ÿè®¡_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // å¯åŠ¨åŠ è½½
        loadVotes();

    </script>
</body>
</html>