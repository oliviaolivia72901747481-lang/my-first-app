<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ è¯¾å ‚æŠ¢ç­”å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: #2c3e50;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }

        /* åå­—è¾“å…¥åŒº */
        #login-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        input {
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 200px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* æ ¸å¿ƒæŠ¢ç­”æŒ‰é’® */
        #btn-buzz {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: none;
            font-size: 3rem;
            font-weight: bold;
            color: white;
            background: #95a5a6; /* é»˜è®¤ç°è‰²ï¼ˆæœªå¼€å§‹ï¼‰ */
            box-shadow: 0 15px 0 #7f8c8d;
            cursor: not-allowed;
            transition: all 0.1s;
            display: none; /* ç™»é™†åæ˜¾ç¤º */
            
            /* ğŸ› ï¸ ä¿®å¤ç‚¹ 2ï¼šå¢åŠ  Safari å…¼å®¹æ€§å‰ç¼€ï¼Œé˜²æ­¢ç‹‚æŒ‰æ—¶é€‰ä¸­æ–‡æœ¬ */
            -webkit-user-select: none; /* Safari / Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE */
            user-select: none;         /* æ ‡å‡† */

            /* æ¶ˆé™¤ç‚¹å‡»é«˜äº®é¢œè‰² */
            -webkit-tap-highlight-color: transparent;

            /* ğŸ› ï¸ ä¿®å¤ç‚¹ 3ï¼šå…³é”®ï¼å‘Šè¯‰æµè§ˆå™¨è¿™ä¸ªæŒ‰é’®åªå¤„ç†ç‚¹å‡»ï¼Œç¦æ­¢åŒå‡»ç¼©æ”¾ã€‚
               è¿™æ ·æ—¢å»æ‰äº† viewport è­¦å‘Šï¼Œåˆä¿ç•™äº†åŸç”Ÿ App èˆ¬çš„æé€Ÿå“åº” */
            touch-action: manipulation; 
        }

        /* æ¿€æ´»çŠ¶æ€ï¼ˆè€å¸ˆç‚¹äº†å¼€å§‹ï¼‰ */
        #btn-buzz.active {
            background: #e74c3c; /* çº¢è‰² */
            box-shadow: 0 15px 0 #c0392b;
            cursor: pointer;
            transform: translateY(0);
        }
        #btn-buzz.active:active {
            transform: translateY(15px);
            box-shadow: 0 0 0 #c0392b;
        }

        /* çŠ¶æ€æç¤ºæ–‡å­— */
        #status-text {
            margin-top: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            height: 50px;
        }

        .btn-confirm {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            
            /* æŒ‰é’®ä¹ŸåŠ ä¸Šè¿™ä¸ªï¼Œé˜²æ­¢è¯¯è§¦ç¼©æ”¾ */
            touch-action: manipulation;
        }
    </style>
</head>
<body>

    <div id="login-box">
        <h2>ğŸ”¥ è°æ‰‹æœ€å¿«ï¼Ÿ</h2>
        <input type="text" id="username" placeholder="è¾“å…¥ä½ çš„åå­—">
        <br>
        <button class="btn-confirm" onclick="enterGame()">è¿›å…¥æ•™å®¤</button>
    </div>

    <button id="btn-buzz" onclick="doBuzz()">æŠ¢!</button>

    <div id="status-text"></div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // âš ï¸ è¯·åŠ¡å¿…ç¡®è®¤è¿™é‡Œå¡«å…¥çš„æ˜¯æ­£ç¡®çš„ URL å’Œ Key
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co' 
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h'
        // ===========================================

        const supabase = supabase.createClient(supabaseUrl, supabaseKey)
        
        let myName = "";
        const btn = document.getElementById('btn-buzz');
        const status = document.getElementById('status-text');
        const loginBox = document.getElementById('login-box');

        // éŸ³æ•ˆ
        const soundClick = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_736886e06b.mp3");

        // 1. è¿›å…¥æ¸¸æˆ
        function enterGame() {
            const input = document.getElementById('username');
            if(!input.value.trim()) return alert("åå­—ä¸èƒ½ä¸ºç©º");
            
            myName = input.value.trim();
            loginBox.style.display = 'none';
            btn.style.display = 'block';
            status.innerText = "ç­‰å¾…è€å¸ˆå¼€å§‹...";
            
            localStorage.setItem('student_name', myName);
            
            initSupabase();
        }

        if(localStorage.getItem('student_name')) {
            document.getElementById('username').value = localStorage.getItem('student_name');
        }

        // 2. æ ¸å¿ƒç›‘å¬é€»è¾‘
        function initSupabase() {
            checkStatus();

            supabase
                .channel('buzzer-room')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'buzzer' }, payload => {
                    handleStateChange(payload.new);
                })
                .subscribe();
        }

        async function checkStatus() {
            const { data } = await supabase.from('buzzer').select('*').eq('id', 1).single();
            if(data) handleStateChange(data);
        }

        function handleStateChange(data) {
            if (data.winner) {
                btn.className = ''; 
                if (data.winner === myName) {
                    document.body.style.background = "#27ae60"; 
                    status.innerText = "ğŸ‰ æ­å–œä½ ï¼æŠ¢åˆ°äº†ï¼";
                    status.style.fontSize = "2rem";
                } else {
                    document.body.style.background = "#c0392b"; 
                    status.innerText = `æ…¢äº†ï¼è¢« ${data.winner} æŠ¢èµ°äº†`;
                }
            } else if (data.is_active) {
                btn.className = 'active'; 
                document.body.style.background = "#2c3e50"; 
                status.innerText = "å¿«æŠ¢ï¼ï¼ï¼";
                btn.disabled = false;
            } else {
                btn.className = ''; 
                document.body.style.background = "#2c3e50";
                status.innerText = "ç­‰å¾…ä¸‹ä¸€è½®...";
                btn.disabled = true;
            }
        }

        // 3. æŠ¢ç­”åŠ¨ä½œ
        async function doBuzz() {
            if (!btn.classList.contains('active')) return;

            soundClick.currentTime = 0; // è®©éŸ³æ•ˆå¯ä»¥è¿å‘ï¼ˆè™½ç„¶æŠ¢ç­”åªç‚¹ä¸€æ¬¡ï¼‰
            soundClick.play(); 

            btn.className = '';
            status.innerText = "æŠ¢ç­”ä¸­...";

            const { data, error } = await supabase
                .from('buzzer')
                .update({ winner: myName, is_active: false }) 
                .eq('id', 1)
                .is('winner', null) 
                .select();
        }
    </script>
</body>
</html>