<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“‹ ç­¾åˆ°æ•°æ®ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: #f8f9fa; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; color: #333; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; text-decoration: none; }
        .btn-green { background: #10b981; } /* å¯¼å‡ºæŒ‰é’® */
        .btn-red { background: #ef4444; } /* æ¸…ç©ºæŒ‰é’® */
        
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f3f4f6; color: #666; }
        tr:hover { background: #f9fafb; }
        
        .count-badge { background: #e0f2fe; color: #0284c7; padding: 5px 10px; border-radius: 20px; font-size: 14px; }
    </style>
</head>

<body>

    <div class="header">
        <div>
            <h1>ğŸ“‹ ç­¾åˆ°è®°å½•</h1>
            <span class="count-badge">ä»Šæ—¥å·²ç­¾: <span id="count">0</span> äºº</span>
        </div>
        <div class="btn-group"></div>
            <button class="btn btn-green" onclick="exportExcel()">ğŸ“¥ å¯¼å‡º Excel</button>
            <button class="btn btn-red" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
        </div>
    </div>

    <table id="data-table">
        <thead>
            <tr>
                <th>å­¦å·</th>
                <th>å§“å</th>
                <th>ç­¾åˆ°æ—¶é—´</th>
            </tr>
        </thead>
        <tbody id="tbody">
            </tbody>
    </table>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co' 
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h'
        // ===========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)
        let allData = []; // å­˜ä¸€ä»½åŸå§‹æ•°æ®æ–¹ä¾¿å¯¼å‡º

        // 1. åŠ è½½æ•°æ®
        async function loadData() {
            // æŒ‰æ—¶é—´å€’åºæŸ¥ï¼Œæœ€æ–°çš„åœ¨å‰é¢
            const { data, error } = await supabaseClient
                .from('attendance')
                .select('*')
                .order('created_at', { ascending: false });

            if(data) {
                allData = data;
                renderTable(data);
            }
        }

        // 2. æ¸²æŸ“è¡¨æ ¼
        function renderTable(data) {
            const tbody = document.getElementById('tbody');
            document.getElementById('count').innerText = data.length;
            tbody.innerHTML = '';

            data.forEach(row => {
                // æ ¼å¼åŒ–æ—¶é—´ (æŠŠ UTC æ—¶é—´è½¬ä¸ºæœ¬åœ°æ—¶é—´)
                const date = new Date(row.created_at);
                const timeStr = date.toLocaleString(); // "2023/10/1 08:00:00"

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.student_id}</td>
                    <td><strong>${row.student_name}</strong></td>
                    <td style="color:#666; font-size:14px;">${timeStr}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. å®æ—¶ç›‘å¬ (æœ‰äººç­¾åˆ°ç«‹åˆ»åˆ·æ–°)
        supabaseClient
            .channel('sign-room')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendance' }, payload => {
                loadData(); // ç®€å•ç²—æš´ï¼Œæœ‰æ–°æ•°æ®å°±é‡è½½ä¸€æ¬¡
            })
            .subscribe();

        // 4. å¯¼å‡º Excel (æ ¸å¿ƒåŠŸèƒ½)
        function exportExcel() {
            if(allData.length === 0) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼");

            // å‡†å¤‡ Excel æ•°æ®æ ¼å¼
            const excelData = allData.map(row => ({
                "å­¦å·": row.student_id,
                "å§“å": row.student_name,
                "ç­¾åˆ°æ—¶é—´": new Date(row.created_at).toLocaleString()
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç­¾åˆ°è¡¨");

            // ç”Ÿæˆæ–‡ä»¶å (å½“å‰æ—¥æœŸ)
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `è¯¾å ‚ç­¾åˆ°_${today}.xlsx`);
        }

        // 5. æ¸…ç©ºæ•°æ®
        async function clearData() {
            if(!confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç­¾åˆ°è®°å½•å—ï¼Ÿ\nå¯¼å‡º Excel äº†å—ï¼Ÿ")) return;

            // è¿™é‡Œçš„é€»è¾‘æœ‰ç‚¹ç‰¹æ®Šï¼ŒSupabase åˆ é™¤æ‰€æœ‰è¡Œéœ€è¦ä¸€ç‚¹æŠ€å·§ï¼Œ
            // é€šå¸¸å»ºè®® Delete where id > 0
            const { error } = await supabaseClient
                .from('attendance')
                .delete()
                .neq('id', 0); // åˆ é™¤ id ä¸ç­‰äº 0 çš„ï¼ˆä¹Ÿå°±æ˜¯æ‰€æœ‰ï¼‰

            if(!error) {
                alert("å·²æ¸…ç©ºï¼");
                loadData();
            } else {
                alert("åˆ é™¤å¤±è´¥: " + error.message);
            }
        }

        loadData();
    </script>
</body>
</html>