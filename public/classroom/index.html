<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¯¾å ‚ Â· å­¦ç”Ÿç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/classroom/js/common.js"></script>
    <script src="/classroom/js/navigation.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #f3f4f6; color: #333; text-align: center;
        }
        
        /* ç­‰å¾…çŠ¶æ€çš„æ ·å¼ */
        .wait-box {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 80%; max-width: 400px;
        }
        .icon-spin { font-size: 4rem; margin-bottom: 20px; display: inline-block; animation: spin 3s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        h2 { margin: 0 0 10px 0; color: #2563eb; }
        p { color: #666; }

        /* å¿«æ·å…¥å£ (ä»…å½“è€å¸ˆæœªæ§åˆ¶æ—¶æ˜¾ç¤º) */
        .quick-links { margin-top: 30px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .link-btn {
            text-decoration: none; color: #666; font-size: 0.9rem; padding: 5px 10px;
            border: 1px solid #ddd; border-radius: 15px; background: white;
        }
    </style>
</head>
<body>

    <div class="wait-box">
        <div class="icon-spin">â³</div>
        <h2>ç­‰å¾…ä¸Šè¯¾æŒ‡ä»¤...</h2>
        <p id="status-text">è¯·ä¿æŒæ­¤é¡µé¢æ‰“å¼€<br>è€å¸ˆå¼€å¯åŠŸèƒ½åå°†è‡ªåŠ¨è·³è½¬</p>
        
        <div class="quick-links">
            <a href="/sign" class="link-btn">è¡¥ç­¾åˆ°</a>
            <a href="/vote" class="link-btn">çœ‹é”™é¢˜</a>
        </div>
    </div>

    <script>
        // ç­‰å¾…æ‰€æœ‰åº“åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½å®Œæˆ
            if (typeof ClassroomCommon === 'undefined' || typeof NavigationComponent === 'undefined') {
                console.error('Dependencies not loaded');
                return;
            }
            
            // ä½¿ç”¨å…¬å…±é…ç½®
            const supabaseClient = ClassroomCommon.createSupabaseClient();
            
            if (!supabaseClient) {
                console.error('Failed to create Supabase client');
                return;
            }

            // æ ¸å¿ƒï¼šç›‘å¬å…¨å±€çŠ¶æ€
            console.log("æ­£åœ¨è¿æ¥è¯¾å ‚ä¸­æ§...");

            // 1. å®æ—¶ç›‘å¬
            supabaseClient
                .channel('global-control')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state' }, payload => {
                    handleRedirect(payload.new);
                })
                .subscribe();

            // 2. åˆå§‹åŒ–æ£€æŸ¥ (é˜²æ­¢åˆ·æ–°åä¸çŸ¥é“å»å“ª)
            supabaseClient.from('global_state').select('*').eq('id', 1).single().then(({data}) => {
                if(data) handleRedirect(data);
            });

            function handleRedirect(data) {
                if (data.status === 'active' && data.current_page !== 'idle') {
                    // ğŸš€ æ”¶åˆ°æŒ‡ä»¤ï¼Œè·³è½¬ï¼
                    document.getElementById('status-text').innerText = "æ­£åœ¨è·³è½¬...";
                    // è¿™é‡Œçš„ replace æ˜¯ä¸ºäº†é˜²æ­¢å­¦ç”ŸæŒ‰"åé€€"é”®é€€å›æ¥
                    window.location.replace(data.current_page); 
                } else {
                    // ğŸ’¤ é—²ç½®çŠ¶æ€ï¼Œä¿æŒåœ¨é¦–é¡µ
                    console.log("è¯¾å ‚ç©ºé—²ä¸­");
                }
            }
            
            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
            NavigationComponent.init();
        });
    </script>
</body>
</html>