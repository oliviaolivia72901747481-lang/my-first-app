<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è¯¾å ‚ Â· å­¦ç”Ÿç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/classroom/js/common.js"></script>
    <script src="/classroom/js/navigation.js"></script>
    <script src="/classroom/js/stats.js"></script>
    <script src="/classroom/js/points.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center;
            background: #f3f4f6; color: #333; text-align: center;
            padding: 20px; padding-bottom: 80px; box-sizing: border-box;
        }
        
        /* ç­‰å¾…çŠ¶æ€çš„æ ·å¼ */
        .wait-box {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
            margin-top: 20px;
        }
        .icon-spin { font-size: 3rem; margin-bottom: 15px; display: inline-block; animation: spin 3s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        h2 { margin: 0 0 10px 0; color: #2563eb; font-size: 1.3rem; }
        p { color: #666; font-size: 0.9rem; }

        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 15px;
            width: 100%; max-width: 400px; box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .user-card .greeting { font-size: 0.9rem; opacity: 0.9; }
        .user-card .user-name { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
        .user-card .user-id { font-size: 0.8rem; opacity: 0.8; }

        /* ç®€è¦ç»Ÿè®¡ */
        .stats-row {
            display: flex; justify-content: space-around; margin-top: 15px;
            padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; }
        .stat-label { font-size: 0.75rem; opacity: 0.8; }

        /* å¿«æ·å…¥å£ */
        .quick-section {
            width: 100%; max-width: 400px; margin-top: 20px;
        }
        .section-title {
            font-size: 0.9rem; color: #666; text-align: left; margin-bottom: 10px;
        }
        .quick-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .quick-btn {
            background: white; border: none; border-radius: 12px;
            padding: 15px 10px; text-decoration: none; color: #333;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quick-btn:active { transform: scale(0.95); }
        .quick-btn .icon { font-size: 1.5rem; margin-bottom: 5px; }
        .quick-btn .label { font-size: 0.75rem; color: #666; }
    </style>
</head>
<body>

    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <div class="user-card" id="user-card" style="display: none;">
        <div class="greeting">ğŸ‘‹ æ¬¢è¿å›æ¥</div>
        <div class="user-name" id="user-name">--</div>
        <div class="user-id">å­¦å·: <span id="user-id">--</span></div>
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="today-count">0</div>
                <div class="stat-label">ä»Šæ—¥ç­”é¢˜</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="today-accuracy">0%</div>
                <div class="stat-label">æ­£ç¡®ç‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-points">0</div>
                <div class="stat-label">æ€»ç§¯åˆ†</div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·å…¥å£ -->
    <div class="quick-section" id="quick-section" style="display: none;">
        <div class="section-title">ğŸ“Œ å¿«æ·å…¥å£</div>
        <div class="quick-grid">
            <a href="/classroom/history.html" class="quick-btn">
                <span class="icon">ğŸ“š</span>
                <span class="label">ç­”é¢˜å†å²</span>
            </a>
            <a href="/classroom/rank.html" class="quick-btn">
                <span class="icon">ğŸ†</span>
                <span class="label">æ’è¡Œæ¦œ</span>
            </a>
            <a href="/classroom/profile.html" class="quick-btn">
                <span class="icon">ğŸ‘¤</span>
                <span class="label">ä¸ªäººä¸­å¿ƒ</span>
            </a>
            <a href="/sign" class="quick-btn">
                <span class="icon">âœï¸</span>
                <span class="label">ç­¾åˆ°</span>
            </a>
        </div>
        
        <!-- è™šæ‹Ÿå·¥ä½å…¥å£ -->
        <div class="section-title" style="margin-top: 20px;">ğŸ­ ä¸“ä¸šå®è®­</div>
        <a href="/classroom/virtual-station.html" class="quick-btn" style="grid-column: span 4; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; padding: 20px;">
            <span class="icon" style="font-size: 2rem;">ğŸ”¬</span>
            <span class="label" style="color: white; font-size: 0.9rem; font-weight: bold;">è¿›å…¥è™šæ‹Ÿå·¥ä½å¹³å°</span>
            <span style="font-size: 0.7rem; opacity: 0.8; margin-top: 5px;">æ·±åº¦åœºæ™¯åŒ–å®è®­ Â· AIåŠ©æ•™ Â· èŒä¸šæˆé•¿</span>
        </a>
    </div>

    <!-- ç­‰å¾…çŠ¶æ€ -->
    <div class="wait-box" id="wait-box">
        <div class="icon-spin">â³</div>
        <h2>ç­‰å¾…ä¸Šè¯¾æŒ‡ä»¤...</h2>
        <p id="status-text">è¯·ä¿æŒæ­¤é¡µé¢æ‰“å¼€<br>è€å¸ˆå¼€å¯åŠŸèƒ½åå°†è‡ªåŠ¨è·³è½¬</p>
    </div>

    <script>
        // ç­‰å¾…æ‰€æœ‰åº“åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½å®Œæˆ
            if (typeof ClassroomCommon === 'undefined' || typeof NavigationComponent === 'undefined') {
                console.error('Dependencies not loaded');
                return;
            }
            
            // ä½¿ç”¨å…¬å…±é…ç½®
            const supabaseClient = ClassroomCommon.createSupabaseClient();
            
            if (!supabaseClient) {
                console.error('Failed to create Supabase client');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç­¾åˆ°ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const myName = localStorage.getItem('my_name');
            const myId = localStorage.getItem('my_id');
            
            if (myName && myId) {
                // æ˜¾ç¤ºç”¨æˆ·å¡ç‰‡å’Œå¿«æ·å…¥å£
                document.getElementById('user-card').style.display = 'block';
                document.getElementById('quick-section').style.display = 'block';
                document.getElementById('user-name').textContent = myName;
                document.getElementById('user-id').textContent = myId;
                
                // åŠ è½½ç®€è¦ç»Ÿè®¡ä¿¡æ¯
                loadBriefStats(supabaseClient, myId);
            }

            // æ ¸å¿ƒï¼šç›‘å¬å…¨å±€çŠ¶æ€
            console.log("æ­£åœ¨è¿æ¥è¯¾å ‚ä¸­æ§...");

            // 1. å®æ—¶ç›‘å¬
            supabaseClient
                .channel('global-control')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state' }, payload => {
                    handleRedirect(payload.new);
                })
                .subscribe();

            // 2. åˆå§‹åŒ–æ£€æŸ¥ (é˜²æ­¢åˆ·æ–°åä¸çŸ¥é“å»å“ª)
            supabaseClient.from('global_state').select('*').eq('id', 1).single().then(({data}) => {
                if(data) handleRedirect(data);
            });

            function handleRedirect(data) {
                if (data.status === 'active' && data.current_page !== 'idle') {
                    // ğŸš€ æ”¶åˆ°æŒ‡ä»¤ï¼Œè·³è½¬ï¼
                    document.getElementById('status-text').innerText = "æ­£åœ¨è·³è½¬...";
                    
                    // é¡µé¢è·¯å¾„æ˜ å°„è¡¨ - æ”¯æŒä¸¤ç§æ ¼å¼
                    const pageMap = {
                        // æ–‡ä»¶åæ ¼å¼ (presentation.html ä½¿ç”¨)
                        'vote.html': '/vote',
                        'danmu.html': '/danmu',
                        'buzzer.html': '/buzzer',
                        'sign.html': '/sign',
                        'lucky.html': '/lucky',
                        // URLè·¯å¾„æ ¼å¼ (admin.html ä½¿ç”¨) - ç›´æ¥æ˜ å°„
                        '/vote': '/vote',
                        '/danmu': '/danmu',
                        '/buzzer': '/buzzer',
                        '/sign': '/sign',
                        '/lucky': '/lucky'
                    };
                    
                    let targetPage = data.current_page;
                    
                    // å¦‚æœåœ¨æ˜ å°„è¡¨ä¸­ï¼Œä½¿ç”¨æ˜ å°„å€¼
                    if (pageMap[data.current_page]) {
                        targetPage = pageMap[data.current_page];
                    } 
                    // å¦‚æœæ˜¯ .html æ–‡ä»¶åä½†ä¸åœ¨æ˜ å°„è¡¨ä¸­ï¼Œæ·»åŠ  /classroom/ å‰ç¼€
                    else if (data.current_page.endsWith('.html')) {
                        targetPage = `/classroom/${data.current_page}`;
                    }
                    // å¦‚æœå·²ç»æ˜¯ / å¼€å¤´çš„è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
                    // å¦åˆ™æ·»åŠ  / å‰ç¼€
                    else if (!data.current_page.startsWith('/')) {
                        targetPage = `/${data.current_page}`;
                    }
                    
                    // è¿™é‡Œçš„ replace æ˜¯ä¸ºäº†é˜²æ­¢å­¦ç”ŸæŒ‰"åé€€"é”®é€€å›æ¥
                    window.location.replace(targetPage); 
                } else {
                    // ğŸ’¤ é—²ç½®çŠ¶æ€ï¼Œä¿æŒåœ¨é¦–é¡µ
                    console.log("è¯¾å ‚ç©ºé—²ä¸­");
                }
            }
            
            /**
             * åŠ è½½ç®€è¦ç»Ÿè®¡ä¿¡æ¯
             * Requirements: 5.1 - é¦–é¡µæ˜¾ç¤ºç®€è¦ç»Ÿè®¡ä¿¡æ¯
             */
            async function loadBriefStats(supabase, studentId) {
                try {
                    // è·å–ä»Šæ—¥ç­”é¢˜è®°å½•
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const { data: todayRecords } = await supabase
                        .from('vote_logs')
                        .select('is_correct, created_at')
                        .eq('student_id', studentId)
                        .gte('created_at', today.toISOString());
                    
                    // è®¡ç®—ä»Šæ—¥ç»Ÿè®¡
                    if (todayRecords && todayRecords.length > 0) {
                        const todayCount = todayRecords.length;
                        const todayCorrect = todayRecords.filter(r => r.is_correct === true).length;
                        const todayAccuracy = todayCount > 0 ? Math.round((todayCorrect / todayCount) * 100) : 0;
                        
                        document.getElementById('today-count').textContent = todayCount;
                        document.getElementById('today-accuracy').textContent = todayAccuracy + '%';
                    }
                    
                    // è·å–æ€»ç§¯åˆ†
                    if (typeof PointsSystem !== 'undefined') {
                        const totalPoints = await PointsSystem.getStudentPoints(supabase, studentId);
                        document.getElementById('total-points').textContent = totalPoints;
                    }
                } catch (e) {
                    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', e);
                }
            }
            
            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
            NavigationComponent.init();
        });
    </script>
</body>
</html>