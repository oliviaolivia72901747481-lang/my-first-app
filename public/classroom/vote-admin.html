<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘©â€ğŸ« æ™ºèƒ½ç­”é¢˜æ€»æ§å°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- ğŸ‰ Confetti ç¤¼èŠ±ç‰¹æ•ˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; text-align: center; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        .header { margin-bottom: 20px; width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; }
        .round-display { font-size: 2rem; font-weight: bold; color: #2563eb; }
        .question-card { background: white; width: 100%; max-width: 1000px; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: left; position: relative; }
        .q-title { font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 20px; }
        .q-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 1.5rem; color: #555; }
        .q-opt-item { padding: 10px; border-radius: 8px; border: 2px solid transparent; }
        .highlight-answer { border-color: #10b981; background: #ecfdf5; color: #047857; font-weight: bold; }
        .chart-box { width: 100%; max-width: 1000px; height: 350px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 20px; margin-bottom: 30px; }
        button { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; transition: all 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-next { background: #2563eb; } .btn-stop { background: #f59e0b; } .btn-import { background: #8b5cf6; }
        #import-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:999; }
        .modal-content { background:white; padding:40px; border-radius:15px; width:500px; text-align: center; }
        .file-drop-area { border: 2px dashed #ccc; padding: 40px; margin: 20px 0; border-radius: 10px; cursor: pointer; background: #fafafa; }
        input[type=file] { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="round-display">ç¬¬ <span id="current-round">1</span> é¢˜</div>
        <div id="status-text" style="color:#666; font-size: 1.2rem;">å‡†å¤‡ä¸­...</div>
    </div>

    <div class="question-card">
        <div id="q-title" class="q-title">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
        <div class="q-options" id="q-options"></div>
        <div id="correct-ans-display" style="position:absolute; bottom:20px; right:30px; font-size:3rem; color:#10b981; font-weight:bold; display:none; transform: rotate(-10deg); border: 4px solid #10b981; padding: 5px 20px; border-radius: 10px;">A</div>
    </div>

    <div class="chart-box"><canvas id="myChart"></canvas></div>

    <div class="controls">
        <button class="btn-stop" onclick="toggleActive()" aria-label="æš‚åœæˆ–å…¬å¸ƒç­”æ¡ˆ">â¯ï¸ æš‚åœ/å…¬å¸ƒç­”æ¡ˆ</button>
        <button class="btn-next" onclick="nextRound()" aria-label="ä¸‹ä¸€é¢˜">â¡ï¸ ä¸‹ä¸€é¢˜</button>
        <button class="btn-import" onclick="openImport()" aria-label="å¯¼å…¥ Excel é¢˜åº“">ğŸ“¥ å¯¼å…¥ Excel é¢˜åº“</button>
    </div>

    <div style="margin-top:20px;">
        <button onclick="clearAll()" style="background:transparent; color:#999; border:1px solid #ddd; padding:8px 15px;" aria-label="é‡ç½®è¯¾å ‚ï¼Œæ¸…é™¤æ‰€æœ‰æ•°æ®">âš ï¸ é‡ç½®è¯¾å ‚</button>
        <button onclick="exportFullReport()" style="background:transparent; color:#10b981; border:1px solid #10b981; padding:8px 15px; margin-left: 10px; font-weight:bold;" aria-label="å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Š">ğŸ“Š å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Š</button>
    </div>
    
    <!-- ğŸ¹ å¿«æ·é”®æç¤º -->
    <div id="hotkey-hint" style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:10px; color:#64748b; font-size:0.9rem;">
        <strong>âŒ¨ï¸ å¿«æ·é”®æç¤º (æ”¯æŒç¿»é¡µç¬”):</strong><br>
        <span style="display:inline-block; margin-top:8px;">
            <kbd style="background:#e2e8f0; padding:3px 8px; border-radius:4px; margin:0 5px;">â†’</kbd> æˆ– <kbd style="background:#e2e8f0; padding:3px 8px; border-radius:4px; margin:0 5px;">PageDown</kbd> ä¸‹ä¸€é¢˜ &nbsp;|&nbsp;
            <kbd style="background:#e2e8f0; padding:3px 8px; border-radius:4px; margin:0 5px;">â†</kbd> æˆ– <kbd style="background:#e2e8f0; padding:3px 8px; border-radius:4px; margin:0 5px;">PageUp</kbd> ä¸Šä¸€é¢˜ &nbsp;|&nbsp;
            <kbd style="background:#e2e8f0; padding:3px 8px; border-radius:4px; margin:0 5px;">Space</kbd> æš‚åœ/å…¬å¸ƒç­”æ¡ˆ
        </span>
    </div>
    
    <!-- ğŸ‰ æ­£ç¡®ç‡æ˜¾ç¤º -->
    <div id="accuracy-display" style="margin-top:15px; font-size:1.5rem; font-weight:bold; color:#64748b; display:none;">
        æ­£ç¡®ç‡: <span id="accuracy-value">0%</span>
    </div>
    
    <!-- ğŸ“Š æ’è¡Œæ¦œ & ğŸ¯ æè¯å™¨ å¹¶æ’æ˜¾ç¤º -->
    <div style="display:flex; gap:20px; margin-top:20px; width:100%; max-width:1000px;">
        <!-- ğŸ† å®æ—¶æ’è¡Œæ¦œ -->
        <div id="leaderboard-panel" style="flex:1; background:white; border-radius:15px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#2563eb;">ğŸ† ä»Šæ—¥å­¦éœ¸æ¦œ</h3>
                <button onclick="showLeaderboardFullscreen()" style="background:#2563eb; color:white; padding:5px 15px; font-size:0.9rem; border-radius:5px;">
                    ğŸ“º å…¨å±å±•ç¤º
                </button>
            </div>
            <div id="leaderboard-list" style="max-height:200px; overflow-y:auto;">
                <div style="color:#999; text-align:center; padding:20px;">åŠ è½½ä¸­...</div>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; color:#999;">
                ç­”å¯¹ +10åˆ† | æŠ¢ç­”è·èƒœ +20åˆ†
            </div>
        </div>
        
        <!-- ğŸ¯ è€å¸ˆæè¯å™¨ (ç”»ä¸­ç”») -->
        <div id="teleprompter-panel" style="flex:1; background:linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius:15px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.2); color:white;">
            <h3 style="margin:0 0 15px 0; color:#fbbf24;">ğŸ¯ è€å¸ˆæè¯å™¨ <span style="font-size:0.7rem; color:#94a3b8;">(ä»…è€å¸ˆå¯è§)</span></h3>
            
            <!-- å½“å‰é¢˜ç›®è§£æ -->
            <div style="background:rgba(255,255,255,0.1); border-radius:10px; padding:12px; margin-bottom:10px;">
                <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:5px;">ğŸ“ æœ¬é¢˜è§£æ</div>
                <div id="current-explanation" style="font-size:0.95rem; line-height:1.5;">æš‚æ— è§£æ</div>
            </div>
            
            <!-- ä¸‹ä¸€é¢˜é¢„è§ˆ -->
            <div style="background:rgba(255,255,255,0.1); border-radius:10px; padding:12px;">
                <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:5px;">ğŸ‘€ ä¸‹ä¸€é¢˜é¢„è§ˆ</div>
                <div id="next-question-preview" style="font-size:0.95rem; line-height:1.5;">æš‚æ— ä¸‹ä¸€é¢˜</div>
                <div id="next-answer-hint" style="font-size:0.8rem; color:#10b981; margin-top:5px;"></div>
            </div>
        </div>
    </div>

    <div id="import-modal" aria-modal="true" aria-labelledby="modal-title" role="dialog">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“‚ ä¸Šä¼  Excel é¢˜åº“</h3>
            <p style="color:#666; font-size:0.9rem;">è¯·ä¸Šä¼  .xlsx æ–‡ä»¶ï¼Œè¡¨å¤´éœ€åŒ…å«ï¼šè½®æ¬¡ã€é¢˜ç›®ã€é€‰é¡¹Aã€é€‰é¡¹Bã€é€‰é¡¹Cã€é€‰é¡¹Dã€ç­”æ¡ˆã€ç±»å‹(å¯é€‰)</p>
            <p style="color:#999; font-size:0.8rem; margin-top:5px;">ç±»å‹å¯å¡«ï¼šsingle(å•é€‰)ã€multi(å¤šé€‰)ã€judge(åˆ¤æ–­)<br>åˆ¤æ–­é¢˜åªéœ€å¡«é€‰é¡¹A=æ­£ç¡®ï¼Œé€‰é¡¹B=é”™è¯¯</p>
            <label class="file-drop-area" for="file-input" aria-label="ç‚¹å‡»é€‰æ‹©æ–‡ä»¶">
                <span style="font-size:3rem;">ğŸ“„</span><br><span id="file-name">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                <input type="file" id="file-input" accept=".xlsx, .xls" onchange="handleFileSelect(this)" aria-describedby="file-upload-desc">
            </label>
            <button onclick="closeImport()" style="background:#ccc; color:#333; padding:10px 30px;" aria-label="å…³é—­æ¨¡æ€æ¡†">å…³é—­</button>
            <button onclick="uploadExcel()" style="background:#8b5cf6; padding:10px 30px;" aria-label="ç¡®è®¤ä¸Šä¼ æ–‡ä»¶">ç¡®è®¤ä¸Šä¼ </button>
        </div>
    </div>

    <script>
        // Supabaseé…ç½® - æ³¨æ„ï¼šè¿™æ˜¯å‘å¸ƒå¯†é’¥ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentRound = 1;
        let isActive = true;
        let currentQuestion = null;
        let selectedFile = null;

        Chart.register(ChartDataLabels);
        const myChart = new Chart(document.getElementById('myChart'), {
            type: 'bar',
            data: { labels: ['A', 'B', 'C', 'D'], datasets: [{ data: [0, 0, 0, 0], backgroundColor: ['#94a3b8', '#94a3b8', '#94a3b8', '#94a3b8'], borderRadius: 10 }] },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    datalabels: { color: 'white', font: { size: 24, weight: 'bold' } } 
                }, 
                scales: { 
                    y: { display: false }, 
                    x: { grid: { display: false }, ticks: { font: { size: 20 } } } 
                } 
            }
        });

        async function init() {
            try {
                const { data: config } = await supabaseClient.from('vote_config').select('*').eq('id', 1).maybeSingle();
                if (config) {
                    updateState(config);
                }

                supabaseClient.channel('admin-config')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => updateState(payload.new))
                    .subscribe();
                supabaseClient.channel('admin-logs')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'vote_logs' }, loadChartData)
                    .subscribe();
                await loadChartData();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        async function updateState(config) {
            try {
                currentRound = config.current_round;
                isActive = config.is_active;
                document.getElementById('current-round').innerText = currentRound;
                document.getElementById('status-text').innerText = isActive ? "æ­£åœ¨æ¥æ”¶ç­”æ¡ˆ..." : "â›” å·²åœæ­¢ä½œç­” (æ˜¾ç¤ºç­”æ¡ˆ)";
                document.getElementById('status-text').style.color = isActive ? "#10b981" : "#ef4444";
                await loadQuestion(currentRound);
                document.getElementById('correct-ans-display').style.display = isActive ? 'none' : 'block';
                await loadChartData();
            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function loadQuestion(round) {
            try {
                const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
                currentQuestion = data;
                if (data) {
                    // åˆ¤æ–­é¢˜ç›®ç±»å‹
                    let questionType = data.type || 'single';
                    if (!data.type && data.answer && data.answer.length > 1) {
                        questionType = 'multi';
                    }
                    if (data.option_a === 'æ­£ç¡®' && data.option_b === 'é”™è¯¯' && !data.option_c && !data.option_d) {
                        questionType = 'judge';
                    }
                    
                    // é¢˜ç›®ç±»å‹æ ‡ç­¾
                    const typeLabels = {
                        'single': '<span style="background:#dbeafe;color:#1d4ed8;padding:3px 10px;border-radius:5px;font-size:0.9rem;margin-left:10px;">å•é€‰é¢˜</span>',
                        'multi': '<span style="background:#fef3c7;color:#b45309;padding:3px 10px;border-radius:5px;font-size:0.9rem;margin-left:10px;">å¤šé€‰é¢˜</span>',
                        'judge': '<span style="background:#d1fae5;color:#047857;padding:3px 10px;border-radius:5px;font-size:0.9rem;margin-left:10px;">åˆ¤æ–­é¢˜</span>'
                    };
                    
                    document.getElementById('q-title').innerHTML = `${round}. ${data.title} ${typeLabels[questionType] || ''}`;
                    
                    // æ ¹æ®é¢˜ç›®ç±»å‹æ¸²æŸ“é€‰é¡¹
                    if (questionType === 'judge') {
                        document.getElementById('q-options').innerHTML = `
                            <div class="q-opt-item" id="opt-A">A. âœ… æ­£ç¡®</div>
                            <div class="q-opt-item" id="opt-B">B. âŒ é”™è¯¯</div>
                        `;
                    } else {
                        document.getElementById('q-options').innerHTML = `
                            <div class="q-opt-item" id="opt-A">A. ${data.option_a || ''}</div>
                            <div class="q-opt-item" id="opt-B">B. ${data.option_b || ''}</div>
                            <div class="q-opt-item" id="opt-C">C. ${data.option_c || ''}</div>
                            <div class="q-opt-item" id="opt-D">D. ${data.option_d || ''}</div>
                        `;
                    }
                    
                    document.getElementById('correct-ans-display').innerText = data.answer;
                    if (!isActive) {
                        highlightCorrectOption(data.answer, questionType);
                    }
                } else {
                    document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜ (æ— æ•°æ®)`;
                    document.getElementById('q-options').innerHTML = "";
                }
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
            }
        }

        function highlightCorrectOption(answer, questionType = 'single') {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.q-opt-item').forEach(el => el.classList.remove('highlight-answer'));
            
            // å¤šé€‰é¢˜ï¼šé«˜äº®å¤šä¸ªé€‰é¡¹
            const correctOptions = answer.toUpperCase().split('');
            correctOptions.forEach(opt => {
                const optDiv = document.getElementById(`opt-${opt}`);
                if (optDiv) {
                    optDiv.classList.add('highlight-answer');
                }
            });
            
            // æ›´æ–°å›¾è¡¨é¢œè‰²
            const colors = myChart.data.labels.map(label => 
                correctOptions.includes(label) ? '#10b981' : '#ef4444'
            );
            myChart.data.datasets[0].backgroundColor = colors;
            myChart.update();
        }

        async function loadChartData() {
            try {
                const { data } = await supabaseClient.from('vote_logs').select('option').eq('round', currentRound);
                if (data) {
                    const counts = { A: 0, B: 0, C: 0, D: 0 };
                    data.forEach(row => {
                        if (counts[row.option] !== undefined) {
                            counts[row.option]++;
                        }
                    });
                    myChart.data.datasets[0].data = [counts.A, counts.B, counts.C, counts.D];
                    if (isActive) {
                        myChart.data.datasets[0].backgroundColor = ['#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'];
                    } else if (currentQuestion) {
                        highlightCorrectOption(currentQuestion.answer);
                    }
                    myChart.update();
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        async function nextRound() {
            try {
                await supabaseClient.from('vote_config').update({ current_round: currentRound + 1, is_active: true }).eq('id', 1);
            } catch (error) {
                console.error('ä¸‹ä¸€é¢˜å¤±è´¥:', error);
                alert('ä¸‹ä¸€é¢˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function toggleActive() {
            try {
                await supabaseClient.from('vote_config').update({ is_active: !isActive }).eq('id', 1);
            } catch (error) {
                console.error('æš‚åœ/å…¬å¸ƒç­”æ¡ˆå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function clearAll() {
            try {
                if (confirm('é‡ç½®æ‰€æœ‰ï¼Ÿ')) {
                    await supabaseClient.from('vote_logs').delete().neq('id', 0);
                    await supabaseClient.from('vote_config').update({ current_round: 1, is_active: true }).eq('id', 1);
                }
            } catch (error) {
                console.error('é‡ç½®è¯¾å ‚å¤±è´¥:', error);
                alert('é‡ç½®è¯¾å ‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ================== ğŸŸ¢ æ ¸å¿ƒå‡çº§ï¼šå­¦æƒ…åˆ†æå¯¼å‡º ==================
        async function exportFullReport() {
            try {
                // 1. è·å–å…¨ç­åå• (ä»ç­¾åˆ°è¡¨)
                const { data: students } = await supabaseClient.from('attendance').select('student_name, student_id');
                if (!students || students.length === 0) {
                    alert('æš‚æ— ç­¾åˆ°å­¦ç”Ÿï¼Œæ— æ³•ç»Ÿè®¡ç¼ºç­”æƒ…å†µ');
                    return;
                }

                // 2. è·å–æ‰€æœ‰ç­”é¢˜è®°å½•
                const { data: logs } = await supabaseClient.from('vote_logs').select('*');
                
                // 3. æ•°æ®èåˆ (äº¤å‰å¯¹æ¯”)
                // å‡è®¾æˆ‘ä»¬åªç»Ÿè®¡å‰ currentRound é“é¢˜
                let reportData = [];
                
                // éå†æ¯ä¸€è½®é¢˜ç›® (ä»1åˆ°currentRound)
                for (let r = 1; r <= currentRound; r++) {
                    students.forEach(stu => {
                        // æŸ¥æ‰¾è¯¥å­¦ç”Ÿåœ¨ç¬¬ r è½®çš„ç­”é¢˜è®°å½•
                        const log = logs.find(l => l.student_id === stu.student_id && l.round === r);
                        
                        let status = 'âŒ æœªå›ç­”';
                        let choice = '-';
                        let correctness = '-';

                        if (log) {
                            status = 'âœ… å·²å›ç­”';
                            choice = log.option;
                            // åˆ¤æ–­æ­£è¯¯ (true è½¬æˆæ–‡å­—)
                            if (log.is_correct === true) {
                                correctness = 'âœ… æ­£ç¡®';
                            } else if (log.is_correct === false) {
                                correctness = 'âŒ é”™è¯¯';
                            } else {
                                correctness = 'æœªçŸ¥';
                            }
                        }

                        reportData.push({
                            'é¢˜ç›®è½®æ¬¡': `ç¬¬ ${r} é¢˜`,
                            'å­¦å·': stu.student_id,
                            'å§“å': stu.student_name,
                            'çŠ¶æ€': status,
                            'å­¦ç”Ÿé€‰æ‹©': choice,
                            'æ­£è¯¯åˆ¤æ–­': correctness
                        });
                    });
                }

                // 4. å¯¼å‡º Excel
                const ws = XLSX.utils.json_to_sheet(reportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'å­¦æƒ…åˆ†ææŠ¥å‘Š');
                XLSX.writeFile(wb, `å­¦æƒ…åˆ†æ_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Šå¤±è´¥:', error);
                alert('å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        // ==============================================================

        // å¯¼å…¥åŠŸèƒ½ä¿æŒä¸å˜
        function openImport() {
            document.getElementById('import-modal').style.display = 'flex';
        }

        function closeImport() {
            document.getElementById('import-modal').style.display = 'none';
        }

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('file-name').innerText = selectedFile.name;
            }
        }

        async function uploadExcel() {
            try {
                if (!selectedFile) {
                    alert('è¯·é€‰æ‹©æ–‡ä»¶');
                    return;
                }
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        const dbData = json.map(row => ({
                            round: row['è½®æ¬¡'],
                            title: row['é¢˜ç›®'],
                            option_a: row['é€‰é¡¹A'] || '',
                            option_b: row['é€‰é¡¹B'] || '',
                            option_c: row['é€‰é¡¹C'] || '',
                            option_d: row['é€‰é¡¹D'] || '',
                            answer: String(row['ç­”æ¡ˆ'] || '').toUpperCase(),
                            type: row['ç±»å‹'] || 'single'
                        }));
                        await supabaseClient.from('questions').delete().neq('id', 0);
                        const { error } = await supabaseClient.from('questions').insert(dbData);
                        if (error) {
                            throw error;
                        }
                        alert('å¯¼å…¥æˆåŠŸï¼Œåˆ·æ–°é¡µé¢ç”Ÿæ•ˆ');
                        location.reload();
                    } catch (err) {
                        console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', err);
                        alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(selectedFile);
            } catch (error) {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ================== ğŸ‰ ç¤¼èŠ±ç‰¹æ•ˆç³»ç»Ÿ ==================
        let lastAccuracy = 0;
        let confettiTriggered = false;
        
        // è®¡ç®—æ­£ç¡®ç‡å¹¶è§¦å‘ç¤¼èŠ±
        async function calculateAccuracyAndCelebrate() {
            try {
                const { data } = await supabaseClient
                    .from('vote_logs')
                    .select('is_correct')
                    .eq('round', currentRound);
                
                if (!data || data.length === 0) {
                    document.getElementById('accuracy-display').style.display = 'none';
                    return;
                }
                
                const correctCount = data.filter(d => d.is_correct === true).length;
                const accuracy = Math.round((correctCount / data.length) * 100);
                
                // æ˜¾ç¤ºæ­£ç¡®ç‡
                document.getElementById('accuracy-display').style.display = 'block';
                document.getElementById('accuracy-value').innerText = `${accuracy}%`;
                document.getElementById('accuracy-value').style.color = 
                    accuracy >= 80 ? '#10b981' : 
                    accuracy >= 60 ? '#f59e0b' : '#ef4444';
                
                // ğŸ‰ æ­£ç¡®ç‡è¶…è¿‡80%ä¸”ç­”é¢˜ç»“æŸæ—¶è§¦å‘ç¤¼èŠ±
                if (!isActive && accuracy >= 80 && !confettiTriggered) {
                    triggerConfetti();
                    confettiTriggered = true;
                }
                
                lastAccuracy = accuracy;
            } catch (error) {
                console.error('è®¡ç®—æ­£ç¡®ç‡å¤±è´¥:', error);
            }
        }
        
        // è§¦å‘ç¤¼èŠ±ç‰¹æ•ˆ
        function triggerConfetti() {
            // å¤šæ¬¡å‘å°„ï¼Œè¥é€ æŒç»­åº†ç¥æ•ˆæœ
            const duration = 3000;
            const end = Date.now() + duration;
            
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: colors
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: colors
                });
                
                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
            
            // ä¸­å¤®å¤§çˆ†å‘
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: colors
                });
            }, 500);
        }
        
        // æ‰‹åŠ¨è§¦å‘ç¤¼èŠ± (æµ‹è¯•ç”¨)
        function manualConfetti() {
            triggerConfetti();
        }
        
        // ================== âŒ¨ï¸ é”®ç›˜å¿«æ·é”®ç³»ç»Ÿ ==================
        document.addEventListener('keydown', function(e) {
            // å¦‚æœæ­£åœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å“åº”å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(e.key) {
                case 'ArrowRight':
                case 'PageDown':
                    // â†’ æˆ– PageDown: ä¸‹ä¸€é¢˜
                    e.preventDefault();
                    nextRound();
                    break;
                    
                case 'ArrowLeft':
                case 'PageUp':
                    // â† æˆ– PageUp: ä¸Šä¸€é¢˜
                    e.preventDefault();
                    prevRound();
                    break;
                    
                case ' ':
                    // ç©ºæ ¼: æš‚åœ/å…¬å¸ƒç­”æ¡ˆ
                    e.preventDefault();
                    toggleActive();
                    break;
                    
                case 'Escape':
                    // ESC: å…³é—­å¼¹çª—
                    closeImport();
                    break;
            }
        });
        
        // ä¸Šä¸€é¢˜åŠŸèƒ½
        async function prevRound() {
            if (currentRound <= 1) {
                console.log('å·²ç»æ˜¯ç¬¬ä¸€é¢˜äº†');
                return;
            }
            try {
                await supabaseClient.from('vote_config').update({ 
                    current_round: currentRound - 1, 
                    is_active: true 
                }).eq('id', 1);
            } catch (error) {
                console.error('ä¸Šä¸€é¢˜å¤±è´¥:', error);
            }
        }
        
        // ä¿®æ”¹ updateState ä»¥æ”¯æŒæ­£ç¡®ç‡è®¡ç®—
        const originalUpdateState = updateState;
        updateState = async function(config) {
            confettiTriggered = false; // é‡ç½®ç¤¼èŠ±çŠ¶æ€
            await originalUpdateState(config);
            await calculateAccuracyAndCelebrate();
            await loadTeleprompter(); // åŠ è½½æè¯å™¨
        };
        
        // ä¿®æ”¹ loadChartData ä»¥æ›´æ–°æ­£ç¡®ç‡
        const originalLoadChartData = loadChartData;
        loadChartData = async function() {
            await originalLoadChartData();
            await calculateAccuracyAndCelebrate();
            await loadLeaderboard(); // æ›´æ–°æ’è¡Œæ¦œ
        };
        
        // ================== ğŸ† å®æ—¶æ’è¡Œæ¦œç³»ç»Ÿ ==================
        async function loadLeaderboard() {
            try {
                // è·å–æ‰€æœ‰ç­”é¢˜è®°å½•
                const { data: voteLogs } = await supabaseClient
                    .from('vote_logs')
                    .select('student_id, student_name, is_correct');
                
                // è·å–æŠ¢ç­”è·èƒœè®°å½•
                const { data: buzzerWins } = await supabaseClient
                    .from('buzzer')
                    .select('winner');
                
                // è®¡ç®—ç§¯åˆ†
                const scores = {};
                
                // ç­”å¯¹ +10åˆ†
                if (voteLogs) {
                    voteLogs.forEach(log => {
                        if (!scores[log.student_id]) {
                            scores[log.student_id] = { 
                                name: log.student_name, 
                                score: 0,
                                correct: 0,
                                buzzer: 0
                            };
                        }
                        if (log.is_correct === true) {
                            scores[log.student_id].score += 10;
                            scores[log.student_id].correct++;
                        }
                    });
                }
                
                // æŠ¢ç­”è·èƒœ +20åˆ† (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è®°å½•å†å²)
                // æ³¨æ„ï¼šéœ€è¦åœ¨æ•°æ®åº“ä¸­æ·»åŠ  buzzer_history è¡¨æ¥è®°å½•å†å²è·èƒœè€…
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                const leaderboard = Object.entries(scores)
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10); // åªæ˜¾ç¤ºå‰10å
                
                // æ¸²æŸ“æ’è¡Œæ¦œ
                const listEl = document.getElementById('leaderboard-list');
                if (leaderboard.length === 0) {
                    listEl.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                listEl.innerHTML = leaderboard.map((item, index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                    const bgColor = index === 0 ? '#fef3c7' : index === 1 ? '#f1f5f9' : index === 2 ? '#fed7aa' : 'transparent';
                    return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:${bgColor}; border-radius:8px; margin-bottom:5px;">
                            <span style="font-weight:${index < 3 ? 'bold' : 'normal'};">
                                ${medal} ${item.name}
                            </span>
                            <span style="color:#2563eb; font-weight:bold;">${item.score}åˆ†</span>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
            }
        }
        
        // å…¨å±å±•ç¤ºæ’è¡Œæ¦œ
        function showLeaderboardFullscreen() {
            const modal = document.createElement('div');
            modal.id = 'leaderboard-fullscreen';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;';
            modal.innerHTML = `
                <h1 style="font-size:4rem; margin-bottom:30px; text-shadow:0 4px 10px rgba(0,0,0,0.3);">ğŸ† ä»Šæ—¥å­¦éœ¸æ¦œ ğŸ†</h1>
                <div id="fullscreen-list" style="font-size:2rem; width:80%; max-width:800px;"></div>
                <button onclick="this.parentElement.remove()" style="margin-top:40px; padding:15px 40px; font-size:1.5rem; background:rgba(255,255,255,0.2); border:2px solid white; color:white; border-radius:10px; cursor:pointer;">
                    å…³é—­ (ESC)
                </button>
            `;
            document.body.appendChild(modal);
            
            // å¤åˆ¶æ’è¡Œæ¦œå†…å®¹
            const listContent = document.getElementById('leaderboard-list').innerHTML;
            document.getElementById('fullscreen-list').innerHTML = listContent;
            
            // ESCå…³é—­
            const closeHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', closeHandler);
                }
            };
            document.addEventListener('keydown', closeHandler);
            
            // è§¦å‘ç¤¼èŠ±
            triggerConfetti();
        }
        
        // ================== ğŸ¯ è€å¸ˆæè¯å™¨ç³»ç»Ÿ ==================
        async function loadTeleprompter() {
            try {
                // åŠ è½½å½“å‰é¢˜ç›®è§£æ
                if (currentQuestion && currentQuestion.explanation) {
                    document.getElementById('current-explanation').innerText = currentQuestion.explanation;
                } else if (currentQuestion) {
                    document.getElementById('current-explanation').innerHTML = `
                        <span style="color:#94a3b8;">æ­£ç¡®ç­”æ¡ˆ: </span>
                        <span style="color:#10b981; font-weight:bold;">${currentQuestion.answer}</span>
                    `;
                } else {
                    document.getElementById('current-explanation').innerText = 'æš‚æ— è§£æ';
                }
                
                // åŠ è½½ä¸‹ä¸€é¢˜é¢„è§ˆ
                const nextRound = currentRound + 1;
                const { data: nextQ } = await supabaseClient
                    .from('questions')
                    .select('*')
                    .eq('round', nextRound)
                    .maybeSingle();
                
                if (nextQ) {
                    document.getElementById('next-question-preview').innerText = `${nextRound}. ${nextQ.title}`;
                    document.getElementById('next-answer-hint').innerHTML = `ç­”æ¡ˆ: <strong>${nextQ.answer}</strong>`;
                } else {
                    document.getElementById('next-question-preview').innerText = 'å·²æ˜¯æœ€åä¸€é¢˜';
                    document.getElementById('next-answer-hint').innerText = '';
                }
                
            } catch (error) {
                console.error('åŠ è½½æè¯å™¨å¤±è´¥:', error);
            }
        }

        init();
        loadLeaderboard(); // åˆå§‹åŠ è½½æ’è¡Œæ¦œ
    </script>
</body>
</html>