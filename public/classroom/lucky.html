<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ éšæœºç‚¹åç¥å™¨ (éŸ³æ•ˆå¢å¼ºç‰ˆ)</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }

        /* é¡¶éƒ¨åŠŸèƒ½æ  */
        .top-bar {
            position: absolute;
            top: 20px;
            display: flex;
            gap: 15px;
            z-index: 10;
            align-items: center;
        }

        select {
            padding: 10px 20px;
            font-size: 1.2rem;
            border-radius: 25px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            cursor: pointer;
            outline: none;
            font-weight: bold;
        }
        select option { background: #333; color: white; }

        /* é¡¶éƒ¨æŒ‰é’®é€šç”¨æ ·å¼ */
        .icon-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.4); }

        /* æ ¸å¿ƒæ˜¾ç¤ºåŒº */
        #display-area {
            font-size: 8rem;
            font-weight: bold;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
            margin-bottom: 50px;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .highlight {
            color: #FFD700;
            transform: scale(1.2);
            transition: all 0.2s;
            text-shadow: 0 0 20px #FFD700;
        }

        /* å¼€å§‹æŒ‰é’® */
        #action-btn {
            padding: 20px 60px;
            font-size: 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            background: white;
            color: #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            font-weight: bold;
        }
        #action-btn:active { transform: scale(0.95); }
        #action-btn.stop { background: #ff4757; color: white; }

        /* è®¾ç½®é¢æ¿ */
        #settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            color: #333;
            display: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 100;
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; box-shadow: none; }
        
        .class-manager { display: flex; gap: 5px; margin-bottom: 15px; }
        .class-manager input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .btn-small { padding: 8px 12px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer; background: #2563eb; color: white; }
        .btn-danger { background: #ff4757; margin-top: 10px; width: 100%; }

        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 99; }
    </style>
</head>
<style>
    /* è…¾å‡ºåº•éƒ¨ç©ºé—´ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ */
    body { padding-bottom: 70px; } 

    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%;
        height: 60px; background: white;
        border-top: 1px solid #eee;
        display: flex; justify-content: space-around; align-items: center;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999;
    }
    .nav-item {
        text-decoration: none; color: #94a3b8; font-size: 12px;
        display: flex; flex-direction: column; align-items: center;
    }
    .nav-item.active { color: #2563eb; font-weight: bold; }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }
</style>

<div class="bottom-nav">
    <a href="/sign" class="nav-item" id="nav-sign">
        <span class="nav-icon">ğŸ“…</span>
        <span>ç­¾åˆ°</span>
    </a>
    <a href="/vote" class="nav-item" id="nav-vote">
        <span class="nav-icon">ğŸ“Š</span>
        <span>ç­”é¢˜</span>
    </a>
    <a href="/danmu" class="nav-item" id="nav-danmu">
        <span class="nav-icon">ğŸ’¬</span>
        <span>å¼¹å¹•</span>
    </a>
    <a href="/buzzer" class="nav-item" id="nav-buzzer">
        <span class="nav-icon">âš¡</span>
        <span>æŠ¢ç­”</span>
    </a>
</div>

<script>
    // è‡ªåŠ¨é«˜äº®å½“å‰é¡µé¢çš„å›¾æ ‡
    const path = window.location.pathname;
    if(path.includes('sign')) document.getElementById('nav-sign').classList.add('active');
    if(path.includes('vote')) document.getElementById('nav-vote').classList.add('active');
    if(path.includes('danmu')) document.getElementById('nav-danmu').classList.add('active');
    if(path.includes('buzzer')) document.getElementById('nav-buzzer').classList.add('active');
</script>
<body>

    <div class="top-bar">
        <select id="class-select" onchange="switchClass()" aria-label="é€‰æ‹©ç­çº§" title="é€‰æ‹©ç­çº§"></select>
        
        <button id="mute-btn" class="icon-btn" onclick="toggleMute()" title="å¼€å…³å£°éŸ³">ğŸ”Š</button>
        
        <button class="icon-btn" onclick="toggleSettings()" title="ç­çº§ç®¡ç†">âš™ï¸</button>
    </div>

    <div id="display-area">å‡†å¤‡ç‚¹å</div>

    <button id="action-btn" onclick="toggleRoll()">å¼€å§‹</button>

    <div id="overlay" onclick="toggleSettings()"></div>
    <div id="settings-panel">
        <div class="panel-header">
            <h3>ğŸ« ç­çº§åå•ç®¡ç†</h3>
            <button class="close-btn" onclick="toggleSettings()">Ã—</button>
        </div>
        <div class="class-manager">
            <input type="text" id="new-class-name" placeholder="æ–°ç­çº§åç§° (å¦‚: ç¯å·¥2301)">
            <button class="btn-small" onclick="addNewClass()">æ–°å»º</button>
        </div>
        <hr class="divider">
        <p class="editing-label">æ­£åœ¨ç¼–è¾‘ï¼š<strong id="editing-class-name">--</strong></p>
        <textarea id="name-input" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´åå•ï¼Œä¸€è¡Œä¸€ä¸ªåå­—"></textarea>
        <button class="btn-small" onclick="saveCurrentList()">ğŸ’¾ ä¿å­˜åå•</button>
        <button class="btn-small btn-danger" onclick="deleteCurrentClass()">ğŸ—‘ï¸ åˆ é™¤æ­¤ç­çº§</button>
    </div>

    <script>
        // ================= éŸ³æ•ˆé…ç½®åŒºåŸŸ =================
        // ğŸ¥ æ»šåŠ¨æ—¶çš„å£°éŸ³ (é¼“ç‚¹) - åœ¨çº¿åœ°å€
        const soundRoll = new Audio("https://cdn.pixabay.com/audio/2022/03/10/audio_510344b080.mp3");
        soundRoll.loop = true; // è®©é¼“ç‚¹å¾ªç¯æ’­æ”¾
        soundRoll.volume = 0.8; // éŸ³é‡ 80%

        // ğŸ‰ é€‰ä¸­æ—¶çš„å£°éŸ³ (æˆåŠŸ) - åœ¨çº¿åœ°å€
        const soundWin = new Audio("https://cdn.pixabay.com/audio/2021/08/04/audio_0625c1539c.mp3");
        soundWin.volume = 1.0; 
        // ===============================================

        let allData = {}; 
        let currentClassKey = ""; 
        let currentNames = [];    
        let timer = null;
        let isRunning = false;
        let isMuted = false; // æ˜¯å¦é™éŸ³

        // DOM å…ƒç´ 
        const classSelect = document.getElementById('class-select');
        const display = document.getElementById('display-area');
        const btn = document.getElementById('action-btn');
        const panel = document.getElementById('settings-panel');
        const overlay = document.getElementById('overlay');
        const nameInput = document.getElementById('name-input');
        const editingNameLabel = document.getElementById('editing-class-name');
        const muteBtn = document.getElementById('mute-btn');

        // éŸ³æ•ˆæ§åˆ¶å‡½æ•°
        function toggleMute() {
            isMuted = !isMuted;
            muteBtn.innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œç«‹å³é™éŸ³
            soundRoll.muted = isMuted;
            soundWin.muted = isMuted;
        }

        function playSound(type) {
            if (isMuted) return;
            // ç”¨æˆ·ç”±äºæµè§ˆå™¨ç­–ç•¥ï¼Œå¿…é¡»å…ˆäº¤äº’æ‰èƒ½æ’­æ”¾ï¼Œç‚¹å‡»"å¼€å§‹"æŒ‰é’®æ­£å¥½æ»¡è¶³äº¤äº’è¦æ±‚
            if (type === 'roll') {
                soundRoll.currentTime = 0; // ä»å¤´å¼€å§‹
                soundRoll.play().catch(e => console.log("ç­‰å¾…ç”¨æˆ·äº¤äº’åæ’­æ”¾"));
            } else if (type === 'win') {
                soundRoll.pause(); // åœæ­¢é¼“ç‚¹
                soundWin.currentTime = 0;
                soundWin.play();
            }
        }

        function stopSound() {
            soundRoll.pause();
        }

        // åˆå§‹åŒ–
        function init() {
            const saved = localStorage.getItem('lucky_classes_v2');
            if (saved) {
                allData = JSON.parse(saved);
            } else {
                allData = { "æ¼”ç¤ºç­çº§": ["å¼ ä¸‰", "æå››", "ç‹äº”", "èµµå…­", "å­™ä¸ƒ"] };
            }
            renderSelect();
        }

        function renderSelect() {
            classSelect.innerHTML = "";
            const keys = Object.keys(allData);
            if (keys.length === 0) {
                allData["é»˜è®¤ç­çº§"] = [];
                keys.push("é»˜è®¤ç­çº§");
            }
            keys.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                classSelect.appendChild(opt);
            });
            if (currentClassKey && allData[currentClassKey]) {
                classSelect.value = currentClassKey;
            } else {
                classSelect.value = keys[0];
                currentClassKey = keys[0];
            }
            switchClass();
        }

        function switchClass() {
            currentClassKey = classSelect.value;
            currentNames = allData[currentClassKey] || [];
            display.innerText = "å‡†å¤‡ç‚¹å";
            display.classList.remove("highlight");
            editingNameLabel.innerText = currentClassKey;
            nameInput.value = currentNames.join('\n');
        }

        function addNewClass() {
            const newName = document.getElementById('new-class-name').value.trim();
            if (!newName) return alert("è¯·è¾“å…¥ç­çº§åç§°ï¼");
            if (allData[newName]) return alert("è¿™ä¸ªç­çº§å·²ç»å­˜åœ¨äº†ï¼");
            allData[newName] = [];
            currentClassKey = newName;
            saveToDisk();
            renderSelect();
            document.getElementById('new-class-name').value = "";
            nameInput.focus();
            alert(`âœ… å·²åˆ›å»º "${newName}"ï¼Œè¯·åœ¨ä¸‹æ–¹ç²˜è´´åå•`);
        }

        function saveCurrentList() {
            const rawText = nameInput.value;
            const namesArr = rawText.split('\n').filter(n => n.trim() !== '');
            if (namesArr.length === 0) return alert("åå•ä¸èƒ½ä¸ºç©ºï¼");
            allData[currentClassKey] = namesArr;
            currentNames = namesArr;
            saveToDisk();
            alert(`âœ… å·²æ›´æ–°ï¼Œå…± ${namesArr.length} äºº`);
            toggleSettings();
        }

        function deleteCurrentClass() {
            if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ç­çº§ "${currentClassKey}" å—ï¼Ÿ`)) return;
            delete allData[currentClassKey];
            currentClassKey = ""; 
            saveToDisk();
            renderSelect();
            toggleSettings();
        }

        function saveToDisk() {
            localStorage.setItem('lucky_classes_v2', JSON.stringify(allData));
        }

        // æ ¸å¿ƒç‚¹åé€»è¾‘ (å¸¦éŸ³æ•ˆ)
        function toggleRoll() {
            if (!currentNames || currentNames.length === 0) {
                alert(`ç­çº§ "${currentClassKey}" æ˜¯ç©ºçš„ï¼è¯·ç‚¹å‡»âš™ï¸ç®¡ç†æ·»åŠ åå•ã€‚`);
                return;
            }

            if (isRunning) {
                // ğŸ‘‰ åœæ­¢
                clearInterval(timer);
                isRunning = false;
                btn.innerText = "å¼€å§‹";
                btn.classList.remove("stop");
                display.classList.add("highlight");
                
                // ğŸµ æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                playSound('win');
                
            } else {
                // ğŸ‘‰ å¼€å§‹
                display.classList.remove("highlight");
                isRunning = true;
                btn.innerText = "åœæ­¢";
                btn.classList.add("stop");
                
                // ğŸµ æ’­æ”¾é¼“ç‚¹éŸ³æ•ˆ
                playSound('roll');

                timer = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * currentNames.length);
                    display.innerText = currentNames[randomIndex];
                }, 50);
            }
        }

        function toggleSettings() {
            const isOpen = panel.style.display === 'block';
            panel.style.display = isOpen ? 'none' : 'block';
            overlay.style.display = isOpen ? 'none' : 'block';
            if (!isOpen) {
                nameInput.value = currentNames.join('\n');
                document.getElementById('new-class-name').value = "";
            }
        }

        init();
    </script>
</body>
</html>