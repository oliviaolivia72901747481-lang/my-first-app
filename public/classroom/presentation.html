<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ æ™ºæ…§è¯¾ä»¶æ’­æ”¾å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #1a1a2e; 
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¸»å®¹å™¨ */
        .presentation-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* PPT èƒŒæ™¯å±‚ */
        #slide-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #000;
            z-index: 1;
        }
        
        /* äº’åŠ¨å·¥å…·æ‚¬æµ®å±‚ */
        #overlay-tools {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        #overlay-tools > * {
            pointer-events: auto;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .presentation-container:hover .top-bar {
            opacity: 1;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .presentation-container:hover .bottom-bar {
            opacity: 1;
        }
        
        /* é¡µç æ˜¾ç¤º */
        .page-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .ctrl-btn {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ctrl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn-nav { background: rgba(255,255,255,0.2); color: white; }
        .btn-nav:hover { background: rgba(255,255,255,0.3); }
        .btn-vote { background: #3b82f6; color: white; }
        .btn-danmu { background: #8b5cf6; color: white; }
        .btn-buzzer { background: #ef4444; color: white; }
        .btn-upload { background: #10b981; color: white; }
        
        /* å¼¹å¹•å±‚ */
        #danmu-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 50;
        }
        
        .danmu-item {
            position: absolute;
            white-space: nowrap;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: danmuMove linear forwards;
        }
        
        @keyframes danmuMove {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }
        
        /* æŠ•ç¥¨æ‚¬æµ®çª— */
        #vote-overlay {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            z-index: 200;
            color: #333;
        }
        
        .vote-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2563eb;
        }
        
        .vote-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .vote-stat-item {
            text-align: center;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        
        .vote-stat-label { font-size: 1.2rem; font-weight: bold; }
        .vote-stat-count { font-size: 0.9rem; color: #666; }
        
        /* ä¸Šä¼ æ¨¡æ€æ¡† */
        #upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .upload-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            color: #333;
            text-align: center;
        }
        
        .drop-zone {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 60px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .slide-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .slide-thumb {
            width: 100px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .slide-thumb.active {
            border-color: #3b82f6;
        }
        
        /* è§¦å‘ç‚¹è®¾ç½® */
        .trigger-settings {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .trigger-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        /* å¿«æ·é”®æç¤º */
        .hotkey-hint {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        .presentation-container:hover .hotkey-hint {
            opacity: 1;
        }
        
        kbd {
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 4px;
            margin: 0 3px;
        }
        
        /* ä¾§è¾¹æ å®¹å™¨ */
        .sidebar {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            box-shadow: -5px 0 30px rgba(0,0,0,0.5);
            z-index: 300;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .sidebar.open { right: 0; }
        
        .sidebar-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #94a3b8;
            border: none;
            background: transparent;
            transition: all 0.2s;
        }
        .sidebar-tab:hover { background: rgba(255,255,255,0.05); }
        .sidebar-tab.active {
            color: white;
            background: rgba(59, 130, 246, 0.3);
            border-bottom: 2px solid #3b82f6;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .sidebar-panel { display: none; }
        .sidebar-panel.active { display: block; }
        
        .sidebar-close {
            position: absolute;
            top: 15px;
            left: -50px;
            width: 40px;
            height: 40px;
            background: rgba(15, 23, 42, 0.98);
            border: none;
            border-radius: 10px 0 0 10px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* ä¾§è¾¹æ æ’è¡Œæ¦œæ ·å¼ */
        .sidebar-leaderboard .rank-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 6px;
            transition: all 0.3s;
        }
        .sidebar-leaderboard .rank-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-leaderboard .rank-item.top-1 { background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1)); }
        .sidebar-leaderboard .rank-item.top-2 { background: linear-gradient(135deg, rgba(192,192,192,0.3), rgba(192,192,192,0.1)); }
        .sidebar-leaderboard .rank-item.top-3 { background: linear-gradient(135deg, rgba(205,127,50,0.3), rgba(205,127,50,0.1)); }
        .sidebar-leaderboard .rank-item.highlight { animation: pointsFlash 1s ease; }
        @keyframes pointsFlash {
            0%, 100% { background: rgba(255,255,255,0.05); }
            50% { background: rgba(16, 185, 129, 0.4); }
        }
        .sidebar-leaderboard .rank-pos {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9rem;
        }
        .sidebar-leaderboard .rank-info { flex: 1; }
        .sidebar-leaderboard .rank-name { font-weight: 600; font-size: 0.9rem; color: white; }
        .sidebar-leaderboard .rank-today { font-size: 0.7rem; color: #10b981; margin-top: 2px; }
        .sidebar-leaderboard .rank-points-wrap { text-align: right; }
        .sidebar-leaderboard .rank-total { font-weight: bold; color: #f59e0b; font-size: 1rem; }
        .sidebar-leaderboard .rank-today-pts { font-size: 0.7rem; color: #94a3b8; }
        
        /* é¢˜åº“é¢æ¿ - æ”¹ä¸ºä¾§è¾¹æ å†…åµŒ */
        #question-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            max-width: 90vw;
            max-height: 80vh;
            background: rgba(30, 41, 59, 0.98);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            display: none;
            z-index: 250;
            overflow-y: auto;
        }
        .qp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .qp-title { font-size: 1.3rem; font-weight: bold; }
        .qp-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .qp-question {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .qp-q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .qp-round { font-size: 1.5rem; font-weight: bold; color: #3b82f6; }
        .qp-mode-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .qp-mode-vote { background: #3b82f6; }
        .qp-mode-buzzer { background: #ef4444; }
        .qp-mode-lucky { background: #f59e0b; }
        .qp-q-title { font-size: 1.2rem; margin-bottom: 15px; line-height: 1.5; }
        .qp-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .qp-opt {
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            font-size: 0.95rem;
        }
        .qp-opt.correct { background: rgba(16, 185, 129, 0.3); border: 2px solid #10b981; }
        .qp-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .qp-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .qp-btn:hover { transform: translateY(-2px); }
        .qp-btn-start { background: #10b981; color: white; }
        .qp-btn-stop { background: #f59e0b; color: white; }
        .qp-btn-prev { background: rgba(255,255,255,0.1); color: white; }
        .qp-btn-next { background: #3b82f6; color: white; }
        
        /* æŠ¢ç­”ç»“æœæ˜¾ç¤º */
        #buzzer-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            display: none;
            z-index: 260;
            min-width: 400px;
        }
        .buzzer-countdown {
            font-size: 8rem;
            font-weight: bold;
            color: #ef4444;
            text-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }
        .buzzer-winner {
            font-size: 4rem;
            font-weight: bold;
            color: #10b981;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="presentation-container">
        <!-- PPT èƒŒæ™¯ -->
        <div id="slide-background">
            <!-- åˆå§‹å ä½å†…å®¹å·²éšè— -->
        </div>
        
        <!-- å¼¹å¹•å±‚ -->
        <div id="danmu-layer"></div>
        
        <!-- äº’åŠ¨å·¥å…·å±‚ -->
        <div id="overlay-tools"></div>
        
        <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
        <div class="top-bar">
            <div class="page-indicator">
                <span id="current-page">0</span> / <span id="total-pages">0</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="ctrl-btn btn-upload" onclick="openUploadModal()">ğŸ“¤ ä¸Šä¼ è¯¾ä»¶</button>
                <button class="ctrl-btn" style="background:#10b981; color:white;" onclick="openQuestionBankManager()">ğŸ“ é¢˜åº“</button>
                <button class="ctrl-btn" style="background:#3b82f6; color:white;" onclick="openAnalytics()">ğŸ“Š æ•°æ®</button>
                <button class="ctrl-btn" style="background:#8b5cf6; color:white;" onclick="openHistoryPanel()">ğŸ“š å†å²</button>
                <button class="ctrl-btn" style="background:#06b6d4; color:white;" onclick="openSamplingSandbox()">ğŸ¯ é‡‡æ ·æ²™ç›˜</button>
                <button class="ctrl-btn" style="background:#f97316; color:white;" onclick="openHazwasteDetective()">ğŸ” å±åºŸé‰´åˆ«</button>
                <button class="ctrl-btn" style="background:linear-gradient(135deg, #7c3aed, #8b5cf6); color:white;" onclick="openVirtualStationCompetition()">ğŸ­ å·¥ä½ç«èµ›</button>
                <button class="ctrl-btn" style="background:#f59e0b; color:white;" onclick="toggleFullscreen()">â›¶ å…¨å±</button>
            </div>
        </div>
        
        <!-- åº•éƒ¨æ§åˆ¶æ  -->
        <div class="bottom-bar">
            <button class="ctrl-btn btn-nav" onclick="prevSlide()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <button class="ctrl-btn" style="background:#10b981;" onclick="toggleQuestionPanel()">ğŸ“š é¢˜åº“</button>
            <button class="ctrl-btn btn-danmu" onclick="toggleDanmu()">ğŸ’¬ å¼¹å¹•</button>
            <button class="ctrl-btn" style="background:linear-gradient(135deg, #8b5cf6, #6366f1);" onclick="showLeaderboard()">ğŸ† æ’è¡Œ</button>
            <button class="ctrl-btn" style="background:linear-gradient(135deg, #06b6d4, #0891b2);" onclick="toggleSidebar()" id="sidebar-toggle-btn">ğŸ“‹ ä¾§æ </button>
            <button class="ctrl-btn" style="background:#ef4444;" onclick="clearContent()" id="clear-content-btn">ğŸ—‘ï¸ æ¸…é™¤</button>
            <button class="ctrl-btn" style="background:linear-gradient(135deg, #64748b 0%, #475569 100%);" onclick="openAdminPanel()">ğŸ›ï¸ ä¸­æ§</button>
            <button class="ctrl-btn btn-nav" onclick="nextSlide()">ä¸‹ä¸€é¡µ â¡ï¸</button>
        </div>
        
        <!-- å¿«æ·é”®æç¤º -->
        <div class="hotkey-hint">
            <div><kbd>â†</kbd><kbd>â†’</kbd> ç¿»é¡µ</div>
            <div><kbd>Q</kbd> é¢˜åº“ <kbd>D</kbd> å¼¹å¹• <kbd>S</kbd> ä¾§æ </div>
            <div><kbd>C</kbd> æ¸…é™¤ <kbd>F</kbd> å…¨å± <kbd>A</kbd> ä¸­æ§</div>
        </div>
    </div>
    
    <!-- ä¾§è¾¹æ  - æ•´åˆé¢˜åº“äº’åŠ¨å’Œæ’è¡Œæ¦œ -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-close" onclick="toggleSidebar()">âœ•</button>
        <div class="sidebar-header" style="background:linear-gradient(135deg, #3b82f6, #8b5cf6); padding:15px 20px; text-align:center;">
            <div style="font-size:1.2rem; font-weight:bold;">ğŸ“š è¯¾å ‚äº’åŠ¨ä¸­å¿ƒ</div>
        </div>
        <div class="sidebar-content" style="padding:15px;">
            <!-- é¢˜ç›®åŒºåŸŸ -->
            <div class="qp-question" style="margin-bottom:12px; padding:15px;">
                <div class="qp-q-header" style="margin-bottom:10px;">
                    <div class="qp-round" style="font-size:1.2rem;">ç¬¬ <span id="sb-qp-round">1</span> é¢˜</div>
                    <div class="qp-mode-badge qp-mode-vote" id="sb-qp-mode-badge" style="padding:3px 10px; font-size:0.75rem;">ğŸ“Š ç­”é¢˜</div>
                </div>
                <div class="qp-q-title" id="sb-qp-title" style="font-size:1rem; margin-bottom:10px;">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
                <div class="qp-options" id="sb-qp-options" style="gap:6px;"></div>
            </div>
            
            <!-- æŠ¢ç­”/ç‚¹åå›ç­”ç»“æœ -->
            <div id="sb-qp-answer-result" style="background:linear-gradient(135deg, rgba(16,185,129,0.3), rgba(59,130,246,0.3)); border-radius:12px; padding:15px; margin-bottom:12px; display:none; text-align:center;">
                <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:5px;" id="sb-qp-answer-mode-label">ğŸ† æŠ¢ç­”å›ç­”</div>
                <div style="font-size:1.3rem; font-weight:bold; color:white; margin-bottom:5px;" id="sb-qp-answer-student">--</div>
                <div style="display:flex; justify-content:center; gap:15px; align-items:center;">
                    <div style="font-size:2rem; font-weight:bold;" id="sb-qp-answer-option">--</div>
                    <div id="sb-qp-answer-correct" style="font-size:1.5rem;">--</div>
                </div>
            </div>
            
            <!-- å®æ—¶ç»Ÿè®¡ -->
            <div id="sb-qp-stats" style="background:rgba(255,255,255,0.08); border-radius:12px; padding:12px; margin-bottom:12px;">
                <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:8px;">ğŸ“Š å®æ—¶ç»Ÿè®¡</div>
                <div class="vote-stats" style="gap:6px;">
                    <div class="vote-stat-item" style="padding:8px;"><div class="vote-stat-label" style="color:#FF6384; font-size:1rem;">A</div><div class="vote-stat-count" id="sb-qp-stat-a" style="font-size:0.85rem;">0</div></div>
                    <div class="vote-stat-item" style="padding:8px;"><div class="vote-stat-label" style="color:#36A2EB; font-size:1rem;">B</div><div class="vote-stat-count" id="sb-qp-stat-b" style="font-size:0.85rem;">0</div></div>
                    <div class="vote-stat-item" style="padding:8px;"><div class="vote-stat-label" style="color:#FFCE56; font-size:1rem;">C</div><div class="vote-stat-count" id="sb-qp-stat-c" style="font-size:0.85rem;">0</div></div>
                    <div class="vote-stat-item" style="padding:8px;"><div class="vote-stat-label" style="color:#4BC0C0; font-size:1rem;">D</div><div class="vote-stat-count" id="sb-qp-stat-d" style="font-size:0.85rem;">0</div></div>
                </div>
            </div>
            
            <!-- æ¨¡å¼é€‰æ‹©å’Œæ§åˆ¶æŒ‰é’® -->
            <div style="display:flex; gap:6px; margin-bottom:12px;">
                <button class="sb-qp-mode-select active" data-mode="vote" onclick="setQPMode('vote')" style="flex:1; padding:8px 5px; border:2px solid #3b82f6; background:#3b82f6; color:white; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.75rem;">ğŸ“Š ç­”é¢˜</button>
                <button class="sb-qp-mode-select" data-mode="buzzer" onclick="setQPMode('buzzer')" style="flex:1; padding:8px 5px; border:2px solid rgba(255,255,255,0.2); background:transparent; color:#94a3b8; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.75rem;">âš¡ æŠ¢ç­”</button>
                <button class="sb-qp-mode-select" data-mode="lucky" onclick="setQPMode('lucky')" style="flex:1; padding:8px 5px; border:2px solid rgba(255,255,255,0.2); background:transparent; color:#94a3b8; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.75rem;">ğŸ° ç‚¹å</button>
            </div>
            <div style="display:flex; gap:6px; margin-bottom:15px;">
                <button class="qp-btn qp-btn-start" onclick="startQuestion()" style="flex:2; padding:10px; min-width:auto; font-size:0.85rem;">â–¶ï¸ å¼€å§‹</button>
                <button class="qp-btn qp-btn-stop" onclick="stopQuestion()" style="flex:2; padding:10px; min-width:auto; font-size:0.85rem;">â¹ï¸ åœæ­¢</button>
                <button class="qp-btn qp-btn-prev" onclick="prevQuestion()" style="flex:1; padding:10px; min-width:auto; font-size:0.85rem;">â¬…ï¸</button>
                <button class="qp-btn qp-btn-next" onclick="nextQuestion()" style="flex:1; padding:10px; min-width:auto; font-size:0.85rem;">â¡ï¸</button>
            </div>
            
            <!-- åˆ†éš”çº¿ -->
            <div style="border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;"></div>
            
            <!-- ç§¯åˆ†æ’è¡Œæ¦œæ ‡é¢˜ -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-size:1rem; font-weight:bold; color:white;">ğŸ† æœ¬èŠ‚è¯¾æ’è¡Œ</span>
                <button onclick="refreshSidebarLeaderboard()" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:4px 8px; border-radius:5px; cursor:pointer; font-size:0.75rem;">ğŸ”„</button>
            </div>
            
            <!-- ç§¯åˆ†æ’è¡Œæ¦œ -->
            <div class="sidebar-leaderboard" id="sidebar-rank-list">
                <div style="text-align:center; color:#666; padding:20px;">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- é¢˜åº“é¢æ¿ï¼ˆä¿ç•™åŸæœ‰å¼¹çª—æ¨¡å¼ï¼‰ -->
    <div id="question-panel">
        <div class="qp-header">
            <div class="qp-title">ğŸ“š é¢˜åº“äº’åŠ¨</div>
            <button class="qp-close" onclick="closeQuestionPanel()">âœ•</button>
        </div>
        <div class="qp-question">
            <div class="qp-q-header">
                <div class="qp-round">ç¬¬ <span id="qp-round">1</span> é¢˜</div>
                <div class="qp-mode-badge qp-mode-vote" id="qp-mode-badge">ğŸ“Š ç­”é¢˜</div>
            </div>
            <div class="qp-q-title" id="qp-title">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
            <div class="qp-options" id="qp-options"></div>
        </div>
        <!-- æŠ¢ç­”/ç‚¹åå›ç­”ç»“æœ -->
        <div id="qp-answer-result" style="background:linear-gradient(135deg, rgba(16,185,129,0.2), rgba(59,130,246,0.2)); border-radius:15px; padding:20px; margin-bottom:15px; display:none; text-align:center;">
            <div style="font-size:0.9rem; color:#94a3b8; margin-bottom:10px;" id="qp-answer-mode-label">ğŸ† æŠ¢ç­”å›ç­”</div>
            <div style="font-size:1.5rem; font-weight:bold; color:white; margin-bottom:10px;" id="qp-answer-student">--</div>
            <div style="display:flex; justify-content:center; gap:20px; align-items:center;">
                <div style="font-size:3rem; font-weight:bold;" id="qp-answer-option">--</div>
                <div id="qp-answer-correct" style="font-size:2rem;">--</div>
            </div>
        </div>
        <!-- å®æ—¶ç»Ÿè®¡ -->
        <div id="qp-stats" style="background:rgba(255,255,255,0.1); border-radius:15px; padding:15px; margin-bottom:15px;">
            <div style="font-size:0.9rem; color:#94a3b8; margin-bottom:10px;">ğŸ“Š å®æ—¶ç»Ÿè®¡</div>
            <div class="vote-stats">
                <div class="vote-stat-item"><div class="vote-stat-label" style="color:#FF6384;">A</div><div class="vote-stat-count" id="qp-stat-a">0</div></div>
                <div class="vote-stat-item"><div class="vote-stat-label" style="color:#36A2EB;">B</div><div class="vote-stat-count" id="qp-stat-b">0</div></div>
                <div class="vote-stat-item"><div class="vote-stat-label" style="color:#FFCE56;">C</div><div class="vote-stat-count" id="qp-stat-c">0</div></div>
                <div class="vote-stat-item"><div class="vote-stat-label" style="color:#4BC0C0;">D</div><div class="vote-stat-count" id="qp-stat-d">0</div></div>
            </div>
        </div>
        <!-- æ¨¡å¼é€‰æ‹© -->
        <div style="background:rgba(255,255,255,0.05); border-radius:10px; padding:15px; margin-bottom:15px;">
            <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:10px;">é€‰æ‹©äº’åŠ¨æ¨¡å¼ï¼š</div>
            <div style="display:flex; gap:10px;">
                <button class="qp-mode-select active" data-mode="vote" onclick="setQPMode('vote')" style="flex:1; padding:10px; border:2px solid #3b82f6; background:#3b82f6; color:white; border-radius:10px; cursor:pointer; font-weight:bold;">ğŸ“Š ç­”é¢˜</button>
                <button class="qp-mode-select" data-mode="buzzer" onclick="setQPMode('buzzer')" style="flex:1; padding:10px; border:2px solid rgba(255,255,255,0.2); background:transparent; color:#94a3b8; border-radius:10px; cursor:pointer; font-weight:bold;">âš¡ æŠ¢ç­”</button>
                <button class="qp-mode-select" data-mode="lucky" onclick="setQPMode('lucky')" style="flex:1; padding:10px; border:2px solid rgba(255,255,255,0.2); background:transparent; color:#94a3b8; border-radius:10px; cursor:pointer; font-weight:bold;">ğŸ° ç‚¹å</button>
            </div>
        </div>
        <div class="qp-controls">
            <button class="qp-btn qp-btn-start" id="qp-start-btn" onclick="startQuestion()">â–¶ï¸ å¼€å§‹æœ¬é¢˜</button>
            <button class="qp-btn qp-btn-stop" onclick="stopQuestion()">â¹ï¸ åœæ­¢/å…¬å¸ƒ</button>
            <button class="qp-btn qp-btn-prev" onclick="prevQuestion()">â¬…ï¸ ä¸Šä¸€é¢˜</button>
            <button class="qp-btn qp-btn-next" onclick="nextQuestion()">â¡ï¸ ä¸‹ä¸€é¢˜</button>
        </div>
    </div>
    
    <!-- æŠ¢ç­”ç»“æœæ˜¾ç¤º -->
    <div id="buzzer-result">
        <div id="buzzer-display" class="buzzer-countdown">3</div>
        <div style="margin-top:20px;">
            <button onclick="closeBuzzerResult()" style="padding:15px 40px; background:#64748b; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1rem;">å…³é—­</button>
        </div>
    </div>
    
    <!-- éšæœºç‚¹åæ‚¬æµ®çª— -->
    <div id="lucky-overlay" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:550px; background:linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); border-radius:20px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,0.5); display:none; z-index:200; text-align:center;">
        <!-- å½“å‰é¢˜ç›®ä¿¡æ¯ -->
        <div id="lucky-question-info" style="background:rgba(0,0,0,0.3); border-radius:10px; padding:12px; margin-bottom:15px; text-align:left;">
            <div style="font-size:0.85rem; color:rgba(255,255,255,0.7); margin-bottom:5px;">ğŸ“ å½“å‰é¢˜ç›®</div>
            <div id="lucky-question-title" style="font-size:1rem; color:white; font-weight:bold;">ç¬¬ 1 é¢˜ï¼šç­‰å¾…åŠ è½½...</div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <select id="lucky-class-select" onchange="switchLuckyClass()" style="padding:8px 15px; font-size:0.9rem; border-radius:20px; border:none; background:rgba(255,255,255,0.2); color:white; cursor:pointer; max-width:200px;">
            </select>
            <div id="lucky-count-info" style="font-size:0.9rem; color:#10b981; font-weight:bold;">å·²ç­¾åˆ° 0 äºº</div>
            <div style="display:flex; gap:8px;">
                <button onclick="loadAttendanceStudents()" title="åˆ·æ–°ç­¾åˆ°åˆ—è¡¨" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1rem;">ğŸ”„</button>
                <button onclick="toggleLuckyMute()" id="lucky-mute-btn" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1rem;">ğŸ”Š</button>
                <button onclick="openLuckySettings()" title="è‡ªå®šä¹‰åå•" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1rem;">âš™ï¸</button>
                <button onclick="closeLuckyOverlay()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1rem;">âœ•</button>
            </div>
        </div>
        <div id="lucky-display" style="font-size:5rem; font-weight:bold; color:white; text-shadow:0 5px 15px rgba(0,0,0,0.5); min-height:100px; display:flex; align-items:center; justify-content:center; margin:20px 0;">
            å‡†å¤‡ç‚¹å
        </div>
        <button id="lucky-action-btn" onclick="toggleLuckyRoll()" style="padding:15px 50px; font-size:1.5rem; border:none; border-radius:50px; cursor:pointer; background:white; color:#333; box-shadow:0 10px 20px rgba(0,0,0,0.3); font-weight:bold;">
            å¼€å§‹
        </button>
        <div style="margin-top:15px; font-size:0.8rem; color:rgba(255,255,255,0.6);">
            ğŸ’¡ ç‚¹ååï¼Œè¢«é€‰ä¸­çš„åŒå­¦å°†å›ç­”å½“å‰é¢˜ç›®
        </div>
    </div>
    
    <!-- ç‚¹åè®¾ç½®é¢æ¿ -->
    <div id="lucky-settings-panel" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:15px; color:#333; display:none; box-shadow:0 20px 50px rgba(0,0,0,0.5); z-index:300; width:350px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">ğŸ« ç­çº§åå•ç®¡ç†</h3>
            <button onclick="closeLuckySettings()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">Ã—</button>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="lucky-new-class-name" placeholder="æ–°ç­çº§åç§°" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:5px;">
            <button onclick="addLuckyClass()" style="padding:8px 12px; font-size:14px; border:none; border-radius:5px; cursor:pointer; background:#2563eb; color:white;">æ–°å»º</button>
        </div>
        <hr style="border:none; border-top:1px solid #eee; margin:15px 0;">
        <p style="margin:10px 0; font-size:0.9rem;">æ­£åœ¨ç¼–è¾‘ï¼š<strong id="lucky-editing-class">--</strong></p>
        <textarea id="lucky-name-input" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´åå•ï¼Œä¸€è¡Œä¸€ä¸ªåå­—" style="width:100%; height:200px; padding:10px; border:1px solid #ccc; border-radius:5px; font-size:14px; box-sizing:border-box;"></textarea>
        <button onclick="saveLuckyList()" style="margin-top:10px; padding:8px 12px; font-size:14px; border:none; border-radius:5px; cursor:pointer; background:#10b981; color:white; width:100%;">ğŸ’¾ ä¿å­˜åå•</button>
        <button onclick="deleteLuckyClass()" style="margin-top:10px; padding:8px 12px; font-size:14px; border:none; border-radius:5px; cursor:pointer; background:#ef4444; color:white; width:100%;">ğŸ—‘ï¸ åˆ é™¤æ­¤ç­çº§</button>
    </div>
    
    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="upload-modal">
        <div class="upload-content">
            <h2 style="margin-bottom:10px;">ğŸ“¤ åŠ è½½è¯¾ä»¶</h2>
            
            <!-- è¯¾ä»¶ç±»å‹æ ‡ç­¾é¡µ -->
            <div style="display:flex; gap:5px; margin-bottom:20px; justify-content:center; flex-wrap:wrap;">
                <button class="content-tab active" data-type="image" onclick="switchContentTab('image')" style="padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; background:#3b82f6; color:white; font-size:0.9rem;">ğŸ–¼ï¸ å›¾ç‰‡</button>
                <button class="content-tab" data-type="video" onclick="switchContentTab('video')" style="padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; background:#e5e7eb; color:#333; font-size:0.9rem;">ğŸ¬ è§†é¢‘</button>
                <button class="content-tab" data-type="audio" onclick="switchContentTab('audio')" style="padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; background:#e5e7eb; color:#333; font-size:0.9rem;">ğŸµ éŸ³é¢‘</button>
                <button class="content-tab" data-type="pdf" onclick="switchContentTab('pdf')" style="padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; background:#e5e7eb; color:#333; font-size:0.9rem;">ğŸ“„ PDF</button>
                <button class="content-tab" data-type="office" onclick="switchContentTab('office')" style="padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; background:#e5e7eb; color:#333; font-size:0.9rem;">ğŸ“Š Office</button>
                <button class="content-tab" data-type="url" onclick="switchContentTab('url')" style="padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; background:#e5e7eb; color:#333; font-size:0.9rem;">ğŸŒ ç½‘é¡µ</button>
            </div>
            
            <!-- å›¾ç‰‡ä¸Šä¼ åŒº -->
            <div id="content-image" class="content-panel">
                <p style="color:#666; margin-bottom:15px;">å°† PPT å¯¼å‡ºä¸ºå›¾ç‰‡åä¸Šä¼ ï¼Œæ”¯æŒ JPG/PNG æ ¼å¼</p>
                <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div style="font-size:3rem; margin-bottom:10px;">ğŸ“</div>
                    <div>æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                    <div style="color:#999; font-size:0.9rem; margin-top:10px;">æ”¯æŒå¤šé€‰ï¼ŒæŒ‰æ–‡ä»¶åæ’åº</div>
                    <input type="file" id="file-input" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
                </div>
                <div class="slide-preview" id="slide-preview"></div>
            </div>
            
            <!-- ç½‘é¡µURLåŒº -->
            <div id="content-url" class="content-panel" style="display:none;">
                <p style="color:#666; margin-bottom:15px;">è¾“å…¥ç½‘é¡µåœ°å€ï¼Œç›´æ¥åµŒå…¥æ˜¾ç¤ºï¼ˆæ”¯æŒå¤§éƒ¨åˆ†ç½‘ç«™ï¼‰</p>
                <input type="url" id="web-url-input" placeholder="https://example.com" style="width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; box-sizing:border-box;">
                <div style="margin-top:10px; color:#999; font-size:0.85rem;">
                    ğŸ’¡ æç¤ºï¼šéƒ¨åˆ†ç½‘ç«™å¯èƒ½ç¦æ­¢åµŒå…¥ï¼Œå¦‚é‡é—®é¢˜è¯·å°è¯•å…¶ä»–é“¾æ¥
                </div>
            </div>
            
            <!-- PDFåŒº -->
            <div id="content-pdf" class="content-panel" style="display:none;">
                <p style="color:#666; margin-bottom:15px;">ä¸Šä¼ PDFæ–‡ä»¶æˆ–è¾“å…¥PDFé“¾æ¥</p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button id="pdf-file-btn" onclick="document.getElementById('pdf-file-input').click()" style="flex:1; padding:15px; border:2px dashed #ddd; border-radius:10px; cursor:pointer; background:white;">
                        ğŸ“ é€‰æ‹©PDFæ–‡ä»¶
                    </button>
                    <input type="file" id="pdf-file-input" accept=".pdf" style="display:none;" onchange="handlePdfFile(this.files[0])">
                </div>
                <div style="text-align:center; color:#999; margin:10px 0;">æˆ–</div>
                <input type="url" id="pdf-url-input" placeholder="https://example.com/document.pdf" style="width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; box-sizing:border-box;">
                <div id="pdf-preview" style="margin-top:15px; display:none; padding:10px; background:#f0f0f0; border-radius:8px;">
                    <span id="pdf-filename">ğŸ“„ å·²é€‰æ‹©æ–‡ä»¶</span>
                </div>
            </div>
            
            <!-- è§†é¢‘åŒº -->
            <div id="content-video" class="content-panel" style="display:none;">
                <p style="color:#666; margin-bottom:15px;">è¾“å…¥åœ¨çº¿è§†é¢‘é“¾æ¥</p>
                <input type="url" id="video-url-input" placeholder="https://www.youtube.com/watch?v=... æˆ– https://www.bilibili.com/video/BV..." style="width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; box-sizing:border-box;">
                <div style="margin-top:10px; color:#999; font-size:0.85rem;">
                    ğŸ’¡ æ”¯æŒï¼šYouTubeã€Bilibiliã€ä¼˜é…·ã€MP4ç›´é“¾
                </div>
            </div>
            
            <!-- éŸ³é¢‘åŒº -->
            <div id="content-audio" class="content-panel" style="display:none;">
                <p style="color:#666; margin-bottom:15px;">ä¸Šä¼ æœ¬åœ°éŸ³é¢‘æ–‡ä»¶</p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button onclick="document.getElementById('audio-file-input').click()" style="flex:1; padding:15px; border:2px dashed #ddd; border-radius:10px; cursor:pointer; background:white;">
                        ğŸ“ é€‰æ‹©éŸ³é¢‘æ–‡ä»¶
                    </button>
                    <input type="file" id="audio-file-input" accept="audio/*" style="display:none;" onchange="handleAudioFile(this.files[0])">
                </div>
                <div id="audio-preview" style="margin-top:15px; display:none; padding:10px; background:#f0f0f0; border-radius:8px;">
                    <span id="audio-filename">ğŸµ å·²é€‰æ‹©æ–‡ä»¶</span>
                </div>
                <div style="margin-top:10px; color:#999; font-size:0.85rem;">
                    ğŸ’¡ æ”¯æŒï¼šMP3ã€WAVã€OGGã€AAC ç­‰æ ¼å¼
                </div>
            </div>
            
            <!-- Officeæ–‡æ¡£åŒº -->
            <div id="content-office" class="content-panel" style="display:none;">
                <p style="color:#666; margin-bottom:15px;">ä¸Šä¼ Officeæ–‡æ¡£ï¼ˆPPTã€Wordã€Excelï¼‰æˆ–è¾“å…¥åœ¨çº¿é“¾æ¥</p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button onclick="document.getElementById('office-file-input').click()" style="flex:1; padding:15px; border:2px dashed #ddd; border-radius:10px; cursor:pointer; background:white;">
                        ğŸ“ é€‰æ‹©Officeæ–‡ä»¶
                    </button>
                    <input type="file" id="office-file-input" accept=".ppt,.pptx,.doc,.docx,.xls,.xlsx" style="display:none;" onchange="handleOfficeFile(this.files[0])">
                </div>
                <div style="text-align:center; color:#999; margin:10px 0;">æˆ–</div>
                <input type="url" id="office-url-input" placeholder="https://example.com/presentation.pptx" style="width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; box-sizing:border-box;">
                <div id="office-preview" style="margin-top:15px; display:none; padding:10px; background:#f0f0f0; border-radius:8px;">
                    <span id="office-filename">ğŸ“Š å·²é€‰æ‹©æ–‡ä»¶</span>
                </div>
                <div style="margin-top:10px; color:#999; font-size:0.85rem;">
                    ğŸ’¡ æ”¯æŒï¼šPPT/PPTXã€DOC/DOCXã€XLS/XLSXï¼ˆé€šè¿‡Office Onlineé¢„è§ˆï¼‰
                </div>
            </div>
            
            <div class="trigger-settings" id="trigger-settings" style="display:none;">
                <h4 style="margin-bottom:10px;">âš¡ è‡ªåŠ¨è§¦å‘è®¾ç½®</h4>
                <div id="trigger-list"></div>
                <button onclick="addTrigger()" style="margin-top:10px; padding:8px 15px; background:#10b981; color:white; border:none; border-radius:5px; cursor:pointer;">
                    + æ·»åŠ è§¦å‘ç‚¹
                </button>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button onclick="closeUploadModal()" style="padding:12px 30px; background:#ccc; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                    å–æ¶ˆ
                </button>
                <button onclick="applyContent()" style="padding:12px 30px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                    åº”ç”¨è¯¾ä»¶
                </button>
            </div>
        </div>
    </div>

    <!-- å†å²æ•°æ®ç®¡ç†æ¨¡å— -->
    <script src="/classroom/js/history.js"></script>
    <!-- é¢˜åº“ç®¡ç†æ¨¡å— -->
    <script src="/classroom/js/questionbank.js"></script>
    
    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // çŠ¶æ€
        let slides = [];
        let currentSlide = 0;
        let triggers = []; // è‡ªåŠ¨è§¦å‘ç‚¹
        let isDanmuEnabled = false;
        let isVoteVisible = false;
        let contentType = 'image'; // å½“å‰å†…å®¹ç±»å‹: image, url, pdf, video
        let pdfDataUrl = null; // PDFæ–‡ä»¶çš„DataURL
        
        // ================== å†…å®¹ç±»å‹åˆ‡æ¢ ==================
        function switchContentTab(type) {
            contentType = type;
            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            document.querySelectorAll('.content-tab').forEach(tab => {
                const isActive = tab.dataset.type === type;
                tab.style.background = isActive ? '#3b82f6' : '#e5e7eb';
                tab.style.color = isActive ? 'white' : '#333';
            });
            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            document.getElementById('content-' + type).style.display = 'block';
        }
        
        // å¤„ç†PDFæ–‡ä»¶
        function handlePdfFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                pdfDataUrl = e.target.result;
                document.getElementById('pdf-preview').style.display = 'block';
                document.getElementById('pdf-filename').innerText = 'ğŸ“„ ' + file.name;
            };
            reader.readAsDataURL(file);
        }
        
        // æœ¬åœ°éŸ³é¢‘æ–‡ä»¶
        let audioDataUrl = null;
        function handleAudioFile(file) {
            if (!file) return;
            audioDataUrl = URL.createObjectURL(file);
            document.getElementById('audio-preview').style.display = 'block';
            document.getElementById('audio-filename').innerText = 'ğŸµ ' + file.name;
        }
        
        // Officeæ–‡ä»¶
        let officeFile = null;
        function handleOfficeFile(file) {
            if (!file) return;
            officeFile = file;
            document.getElementById('office-preview').style.display = 'block';
            const icon = file.name.match(/\.ppt/i) ? 'ğŸ“Š' : file.name.match(/\.doc/i) ? 'ğŸ“' : 'ğŸ“ˆ';
            document.getElementById('office-filename').innerText = icon + ' ' + file.name;
        }
        
        // åº”ç”¨å†…å®¹ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
        function applyContent() {
            switch (contentType) {
                case 'image':
                    applySlides();
                    break;
                case 'url':
                    applyWebUrl();
                    break;
                case 'pdf':
                    applyPdf();
                    break;
                case 'video':
                    applyVideo();
                    break;
                case 'audio':
                    applyAudio();
                    break;
                case 'office':
                    applyOffice();
                    break;
            }
        }
        
        // åº”ç”¨ç½‘é¡µURL
        function applyWebUrl() {
            const url = document.getElementById('web-url-input').value.trim();
            if (!url) { alert('è¯·è¾“å…¥ç½‘é¡µåœ°å€'); return; }
            showIframeContent(url);
            closeUploadModal();
        }
        
        // åº”ç”¨PDF
        function applyPdf() {
            const urlInput = document.getElementById('pdf-url-input').value.trim();
            if (pdfDataUrl) {
                // ä½¿ç”¨ä¸Šä¼ çš„PDFæ–‡ä»¶
                showIframeContent(pdfDataUrl);
            } else if (urlInput) {
                // ä½¿ç”¨PDFé“¾æ¥ï¼ˆé€šè¿‡Google Docs Vieweræˆ–ç›´æ¥åµŒå…¥ï¼‰
                const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(urlInput)}&embedded=true`;
                showIframeContent(viewerUrl);
            } else {
                alert('è¯·é€‰æ‹©PDFæ–‡ä»¶æˆ–è¾“å…¥PDFé“¾æ¥');
                return;
            }
            closeUploadModal();
        }
        
        // åº”ç”¨è§†é¢‘
        function applyVideo() {
            const urlInput = document.getElementById('video-url-input').value.trim();
            if (!urlInput) {
                alert('è¯·è¾“å…¥è§†é¢‘é“¾æ¥');
                return;
            }
            // è½¬æ¢è§†é¢‘é“¾æ¥ä¸ºåµŒå…¥æ ¼å¼
            const embedUrl = convertToEmbedUrl(urlInput);
            showIframeContent(embedUrl);
            closeUploadModal();
        }
        
        // åº”ç”¨éŸ³é¢‘
        function applyAudio() {
            if (!audioDataUrl) { alert('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶'); return; }
            showAudioPlayer(audioDataUrl);
            closeUploadModal();
        }
        
        // åº”ç”¨Officeæ–‡æ¡£
        function applyOffice() {
            const urlInput = document.getElementById('office-url-input').value.trim();
            if (officeFile) {
                // æœ¬åœ°Officeæ–‡ä»¶éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨æ‰èƒ½é¢„è§ˆï¼Œè¿™é‡Œæç¤ºç”¨æˆ·
                alert('æœ¬åœ°Officeæ–‡ä»¶æš‚ä¸æ”¯æŒç›´æ¥é¢„è§ˆï¼Œè¯·å°†æ–‡ä»¶ä¸Šä¼ åˆ°äº‘ç«¯åä½¿ç”¨é“¾æ¥æ–¹å¼ã€‚\n\nå»ºè®®ï¼šå°†PPTå¯¼å‡ºä¸ºå›¾ç‰‡æˆ–PDFæ ¼å¼ä½¿ç”¨ã€‚');
                return;
            } else if (urlInput) {
                // ä½¿ç”¨Office Online Viewer
                const viewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(urlInput)}`;
                showIframeContent(viewerUrl);
            } else {
                alert('è¯·è¾“å…¥Officeæ–‡æ¡£é“¾æ¥');
                return;
            }
            closeUploadModal();
        }
        
        // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
        function showAudioPlayer(src) {
            const bg = document.getElementById('slide-background');
            bg.style.backgroundImage = 'none';
            hideIframeContent();
            
            // ç§»é™¤æ—§çš„æ’­æ”¾å™¨
            const oldPlayer = document.getElementById('media-player');
            if (oldPlayer) oldPlayer.remove();
            
            // åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨ï¼ˆæ”¾åœ¨presentation-containerä¸­ï¼‰
            const parentContainer = document.querySelector('.presentation-container');
            const container = document.createElement('div');
            container.id = 'media-player';
            container.style.cssText = 'width:100%; height:100%; position:absolute; top:0; left:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index:5;';
            
            container.innerHTML = `
                <div style="font-size:8rem; margin-bottom:30px;">ğŸµ</div>
                <audio controls autoplay style="width:80%; max-width:500px;">
                    <source src="${src}" type="audio/mpeg">
                </audio>
                <div style="margin-top:20px; color:white; font-size:1.2rem;">æ­£åœ¨æ’­æ”¾éŸ³é¢‘</div>
            `;
            parentContainer.appendChild(container);
            
            document.getElementById('current-page').innerText = '1';
            document.getElementById('total-pages').innerText = '1';
            slides = [];
        }
        
        // è½¬æ¢è§†é¢‘é“¾æ¥ä¸ºåµŒå…¥æ ¼å¼
        function convertToEmbedUrl(url) {
            // YouTube
            if (url.includes('youtube.com/watch')) {
                const videoId = new URL(url).searchParams.get('v');
                return `https://www.youtube.com/embed/${videoId}`;
            }
            if (url.includes('youtu.be/')) {
                const videoId = url.split('youtu.be/')[1].split('?')[0];
                return `https://www.youtube.com/embed/${videoId}`;
            }
            // Bilibili
            if (url.includes('bilibili.com/video/')) {
                const bvMatch = url.match(/BV[\w]+/);
                if (bvMatch) {
                    return `https://player.bilibili.com/player.html?bvid=${bvMatch[0]}&high_quality=1`;
                }
            }
            // ä¼˜é…·
            if (url.includes('youku.com')) {
                const idMatch = url.match(/id_([\w=]+)/);
                if (idMatch) {
                    return `https://player.youku.com/embed/${idMatch[1]}`;
                }
            }
            // ç›´æ¥è¿”å›ï¼ˆå¯èƒ½æ˜¯MP4ç›´é“¾ï¼‰
            return url;
        }
        
        // æ˜¾ç¤ºiframeå†…å®¹
        function showIframeContent(url) {
            const bg = document.getElementById('slide-background');
            // æ¸…é™¤èƒŒæ™¯å›¾
            bg.style.backgroundImage = 'none';
            // ç§»é™¤æ—§çš„åª’ä½“æ’­æ”¾å™¨
            const oldPlayer = document.getElementById('media-player');
            if (oldPlayer) oldPlayer.remove();
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰iframeï¼ˆæ”¾åœ¨presentation-containerä¸­ï¼‰
            const container = document.querySelector('.presentation-container');
            let iframe = document.getElementById('content-iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'content-iframe';
                iframe.style.cssText = 'width:100%; height:100%; border:none; position:absolute; top:0; left:0; z-index:5;';
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                container.appendChild(iframe);
            }
            iframe.src = url;
            iframe.style.display = 'block';
            
            // æ›´æ–°é¡µç æ˜¾ç¤º
            document.getElementById('current-page').innerText = '1';
            document.getElementById('total-pages').innerText = '1';
            slides = []; // æ¸…ç©ºå›¾ç‰‡å¹»ç¯ç‰‡
        }
        
        // éšè—iframeï¼ˆåˆ‡æ¢å›å›¾ç‰‡æ¨¡å¼æ—¶ï¼‰
        function hideIframeContent() {
            const iframe = document.getElementById('content-iframe');
            if (iframe) {
                iframe.style.display = 'none';
                iframe.src = '';
            }
            // åŒæ—¶ç§»é™¤åª’ä½“æ’­æ”¾å™¨
            const mediaPlayer = document.getElementById('media-player');
            if (mediaPlayer) mediaPlayer.remove();
        }
        
        // æ¸…é™¤æ‰€æœ‰å†…å®¹
        function clearContent() {
            // æ¸…é™¤èƒŒæ™¯å›¾
            const bg = document.getElementById('slide-background');
            bg.style.backgroundImage = 'none';
            
            // éšè—iframe
            hideIframeContent();
            
            // ç§»é™¤åª’ä½“æ’­æ”¾å™¨
            const mediaPlayer = document.getElementById('media-player');
            if (mediaPlayer) mediaPlayer.remove();
            
            // æ¸…ç©ºå¹»ç¯ç‰‡æ•°ç»„
            slides = [];
            currentSlide = 0;
            
            // é‡ç½®é¡µç 
            document.getElementById('current-page').innerText = '0';
            document.getElementById('total-pages').innerText = '0';
            
            // æ¸…ç©ºé¢„è§ˆ
            document.getElementById('slide-preview').innerHTML = '';
            
            // é‡ç½®ä¸Šä¼ è¡¨å•ä¸­çš„æ•°æ®
            pdfDataUrl = null;
            audioDataUrl = null;
            officeFile = null;
            document.getElementById('pdf-preview').style.display = 'none';
            document.getElementById('audio-preview').style.display = 'none';
            document.getElementById('office-preview').style.display = 'none';
            
            console.log('âœ… å†…å®¹å·²æ¸…é™¤');
        }
        
        // ================== å¹»ç¯ç‰‡ç®¡ç† ==================
        function handleFiles(files) {
            const fileArray = Array.from(files).sort((a, b) => a.name.localeCompare(b.name));
            slides = [];
            
            const preview = document.getElementById('slide-preview');
            preview.innerHTML = '';
            
            fileArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    slides[index] = e.target.result;
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'slide-thumb';
                    img.onclick = () => goToSlide(index);
                    preview.appendChild(img);
                    
                    if (slides.filter(s => s).length === fileArray.length) {
                        document.getElementById('trigger-settings').style.display = 'block';
                        updateTriggerList();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        function goToSlide(index) {
            if (index < 0 || index >= slides.length) return;
            currentSlide = index;
            
            document.getElementById('slide-background').style.backgroundImage = `url(${slides[index]})`;
            document.getElementById('current-page').innerText = index + 1;
            document.getElementById('total-pages').innerText = slides.length;
            
            // æ›´æ–°ç¼©ç•¥å›¾é«˜äº®
            document.querySelectorAll('.slide-thumb').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
            
            // æ£€æŸ¥è§¦å‘ç‚¹
            checkTriggers(index);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç»‘å®šé¢˜ç›®
            checkSlideQuestion();
        }
        
        function prevSlide() {
            goToSlide(currentSlide - 1);
        }
        
        function nextSlide() {
            goToSlide(currentSlide + 1);
        }
        
        function applySlides() {
            if (slides.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }
            // éšè—iframeï¼ˆå¦‚æœä¹‹å‰æ˜¾ç¤ºçš„æ˜¯ç½‘é¡µ/PDF/è§†é¢‘ï¼‰
            hideIframeContent();
            goToSlide(0);
            closeUploadModal();
        }
        
        // ================== è§¦å‘ç‚¹ç®¡ç† ==================
        function addTrigger() {
            triggers.push({
                page: 1,
                action: 'vote',
                round: 1
            });
            updateTriggerList();
        }
        
        function removeTrigger(index) {
            triggers.splice(index, 1);
            updateTriggerList();
        }
        
        function updateTriggerList() {
            const list = document.getElementById('trigger-list');
            list.innerHTML = triggers.map((t, i) => `
                <div class="trigger-item">
                    <span>ç¬¬</span>
                    <input type="number" value="${t.page}" min="1" max="${slides.length}" 
                           style="width:50px; padding:5px; border:1px solid #ddd; border-radius:4px;"
                           onchange="triggers[${i}].page = parseInt(this.value)">
                    <span>é¡µè§¦å‘</span>
                    <select style="padding:5px; border:1px solid #ddd; border-radius:4px;"
                            onchange="triggers[${i}].action = this.value">
                        <option value="vote" ${t.action === 'vote' ? 'selected' : ''}>ğŸ“Š ç­”é¢˜</option>
                        <option value="danmu" ${t.action === 'danmu' ? 'selected' : ''}>ğŸ’¬ å¼¹å¹•</option>
                        <option value="buzzer" ${t.action === 'buzzer' ? 'selected' : ''}>âš¡ æŠ¢ç­”</option>
                    </select>
                    <input type="number" value="${t.round || 1}" min="1" placeholder="é¢˜å·"
                           style="width:50px; padding:5px; border:1px solid #ddd; border-radius:4px; ${t.action !== 'vote' ? 'display:none' : ''}"
                           onchange="triggers[${i}].round = parseInt(this.value)">
                    <button onclick="removeTrigger(${i})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ•</button>
                </div>
            `).join('');
        }
        
        function checkTriggers(pageIndex) {
            const pageTriggers = triggers.filter(t => t.page === pageIndex + 1);
            pageTriggers.forEach(t => {
                switch(t.action) {
                    case 'vote':
                        showVoteOverlay(t.round);
                        break;
                    case 'danmu':
                        enableDanmu();
                        break;
                    case 'buzzer':
                        startBuzzer();
                        break;
                }
            });
        }
        
        // ================== é¢˜åº“åŠŸèƒ½ ==================
        let qpRound = 1;
        let qpQuestion = null;
        let qpMode = 'vote';
        let isQPActive = false;
        let isQuestionPanelVisible = false;
        
        function toggleQuestionPanel() {
            isQuestionPanelVisible = !isQuestionPanelVisible;
            document.getElementById('question-panel').style.display = isQuestionPanelVisible ? 'block' : 'none';
            if (isQuestionPanelVisible) {
                loadQPQuestion();
            }
        }
        
        function closeQuestionPanel() {
            isQuestionPanelVisible = false;
            document.getElementById('question-panel').style.display = 'none';
        }
        
        let showAnswerRevealed = false; // æ˜¯å¦å·²å…¬å¸ƒç­”æ¡ˆ
        
        async function loadQPQuestion() {
            try {
                // éšè—ä¸Šä¸€é¢˜çš„å›ç­”ç»“æœ
                document.getElementById('qp-answer-result').style.display = 'none';
                
                const { data } = await supabaseClient.from('questions').select('*').eq('round', qpRound).maybeSingle();
                qpQuestion = data;
                document.getElementById('qp-round').innerText = qpRound;
                
                if (data) {
                    document.getElementById('qp-title').innerText = data.title;
                    const opts = document.getElementById('qp-options');
                    // åªæœ‰åœ¨æ•™å¸ˆç‚¹å‡»"å…¬å¸ƒç­”æ¡ˆ"åæ‰æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    opts.innerHTML = `
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('A') ? 'correct' : ''}">A. ${data.option_a || ''}</div>
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('B') ? 'correct' : ''}">B. ${data.option_b || ''}</div>
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('C') ? 'correct' : ''}">C. ${data.option_c || ''}</div>
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('D') ? 'correct' : ''}">D. ${data.option_d || ''}</div>
                    `;
                    // è®¾ç½®æ¨¡å¼
                    qpMode = data.mode || 'vote';
                    updateQPModeDisplay();
                } else {
                    document.getElementById('qp-title').innerText = '(æ— é¢˜ç›®æ•°æ®)';
                    document.getElementById('qp-options').innerHTML = '';
                }
                loadQPStats();
                // åŒæ­¥æ›´æ–°ä¾§è¾¹æ 
                if (isSidebarOpen) loadSidebarQuestion();
            } catch (e) { console.error(e); }
        }
        
        async function loadQPStats() {
            try {
                const { data } = await supabaseClient.from('vote_logs').select('option').eq('round', qpRound);
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                if (data) data.forEach(row => { if (counts[row.option] !== undefined) counts[row.option]++; });
                document.getElementById('qp-stat-a').innerText = counts.A;
                document.getElementById('qp-stat-b').innerText = counts.B;
                document.getElementById('qp-stat-c').innerText = counts.C;
                document.getElementById('qp-stat-d').innerText = counts.D;
                // åŒæ­¥æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡
                if (isSidebarOpen) loadSidebarStats();
            } catch (e) { console.error(e); }
        }
        
        function updateQPModeDisplay() {
            const badge = document.getElementById('qp-mode-badge');
            const stats = document.getElementById('qp-stats');
            const modeConfig = {
                'vote': { text: 'ğŸ“Š ç­”é¢˜', class: 'qp-mode-vote' },
                'buzzer': { text: 'âš¡ æŠ¢ç­”', class: 'qp-mode-buzzer' },
                'lucky': { text: 'ğŸ° ç‚¹å', class: 'qp-mode-lucky' }
            };
            const config = modeConfig[qpMode] || modeConfig['vote'];
            badge.innerText = config.text;
            badge.className = 'qp-mode-badge ' + config.class;
            
            // åªæœ‰ç­”é¢˜æ¨¡å¼æ˜¾ç¤ºç»Ÿè®¡
            stats.style.display = qpMode === 'vote' ? 'block' : 'none';
            
            // æ›´æ–°æ¨¡å¼é€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.qp-mode-select').forEach(btn => {
                const isActive = btn.dataset.mode === qpMode;
                btn.style.background = isActive ? (qpMode === 'vote' ? '#3b82f6' : qpMode === 'buzzer' ? '#ef4444' : '#f59e0b') : 'transparent';
                btn.style.borderColor = isActive ? btn.style.background : 'rgba(255,255,255,0.2)';
                btn.style.color = isActive ? 'white' : '#94a3b8';
            });
            
            // åŒæ­¥æ›´æ–°ä¾§è¾¹æ æ¨¡å¼æ˜¾ç¤º
            if (isSidebarOpen) updateSidebarModeDisplay();
        }
        
        async function setQPMode(mode) {
            qpMode = mode;
            updateQPModeDisplay();
            if (qpQuestion) {
                await supabaseClient.from('questions').update({ mode: mode }).eq('round', qpQuestion.round);
            }
        }
        
        async function startQuestion() {
            if (!qpQuestion) { alert('å½“å‰æ²¡æœ‰é¢˜ç›®'); return; }
            isQPActive = true;
            showAnswerRevealed = false; // é‡ç½®ç­”æ¡ˆæ˜¾ç¤ºçŠ¶æ€
            
            // æ¸…é™¤å½“å‰é¢˜ç›®çš„ç­”é¢˜è®°å½•ï¼Œè®©å­¦ç”Ÿå¯ä»¥é‡æ–°å›ç­”
            await supabaseClient.from('vote_logs').delete().eq('round', qpRound);
            
            // éšè—ä¸Šä¸€æ¬¡çš„å›ç­”ç»“æœ
            document.getElementById('qp-answer-result').style.display = 'none';
            
            switch (qpMode) {
                case 'vote':
                    // æ™®é€šç­”é¢˜æ¨¡å¼ï¼šæ‰€æœ‰å­¦ç”Ÿéƒ½å¯ä»¥å›ç­”
                    // å…ˆå°è¯•æ›´æ–°åŒ…å«æ–°å­—æ®µï¼Œå¦‚æœå¤±è´¥åˆ™åªæ›´æ–°åŸºæœ¬å­—æ®µ
                    const voteUpdate = await supabaseClient.from('vote_config').update({ 
                        current_round: qpRound, 
                        is_active: true,
                        allowed_student: null,
                        answer_mode: 'vote'
                    }).eq('id', 1);
                    if (voteUpdate.error) {
                        // å¦‚æœæ–°å­—æ®µä¸å­˜åœ¨ï¼Œåªæ›´æ–°åŸºæœ¬å­—æ®µ
                        await supabaseClient.from('vote_config').update({ 
                            current_round: qpRound, 
                            is_active: true
                        }).eq('id', 1);
                    }
                    await supabaseClient.from('global_state').update({ status: 'active', current_page: 'vote.html' }).eq('id', 1);
                    break;
                case 'buzzer':
                    // æŠ¢ç­”æ¨¡å¼ï¼šå…ˆè·³è½¬åˆ°æŠ¢ç­”é¡µé¢
                    await supabaseClient.from('buzzer').update({ is_active: false, winner: null }).eq('id', 1);
                    await supabaseClient.from('global_state').update({ status: 'active', current_page: 'buzzer.html' }).eq('id', 1);
                    showBuzzerCountdown();
                    break;
                case 'lucky':
                    // ç‚¹åæ¨¡å¼ï¼šæ‰“å¼€ç‚¹åé¢æ¿
                    toggleLuckyOverlay();
                    break;
            }
            loadQPQuestion();
        }
        
        async function stopQuestion() {
            isQPActive = false;
            showAnswerRevealed = true; // å…¬å¸ƒç­”æ¡ˆ
            // åœæ­¢ç­”é¢˜å¹¶æ¸…é™¤æƒé™é™åˆ¶
            const stopUpdate = await supabaseClient.from('vote_config').update({ 
                is_active: false,
                allowed_student: null,
                answer_mode: 'vote'
            }).eq('id', 1);
            if (stopUpdate.error) {
                // å¦‚æœæ–°å­—æ®µä¸å­˜åœ¨ï¼Œåªæ›´æ–°åŸºæœ¬å­—æ®µ
                await supabaseClient.from('vote_config').update({ is_active: false }).eq('id', 1);
            }
            if (qpMode === 'buzzer') {
                await supabaseClient.from('buzzer').update({ is_active: false }).eq('id', 1);
            }
            loadQPQuestion();
        }
        
        async function prevQuestion() {
            if (qpRound <= 1) return;
            qpRound--;
            isQPActive = false;
            showAnswerRevealed = false; // åˆ‡æ¢é¢˜ç›®æ—¶éšè—ç­”æ¡ˆ
            // æ¸…é™¤æ–°é¢˜ç›®çš„ç­”é¢˜è®°å½•ï¼Œè®©å­¦ç”Ÿå¯ä»¥é‡æ–°å›ç­”
            await supabaseClient.from('vote_logs').delete().eq('round', qpRound);
            // æ¸…é™¤æŠ¢ç­”/ç‚¹åæƒé™ï¼Œä¸‹ä¸€é¢˜éœ€è¦é‡æ–°æŠ¢ç­”
            await supabaseClient.from('vote_config').update({ 
                current_round: qpRound, 
                is_active: false,
                allowed_student: null,
                answer_mode: 'vote'
            }).eq('id', 1);
            loadQPQuestion();
        }
        
        async function nextQuestion() {
            qpRound++;
            isQPActive = false;
            showAnswerRevealed = false; // åˆ‡æ¢é¢˜ç›®æ—¶éšè—ç­”æ¡ˆ
            // æ¸…é™¤æ–°é¢˜ç›®çš„ç­”é¢˜è®°å½•ï¼Œè®©å­¦ç”Ÿå¯ä»¥é‡æ–°å›ç­”
            await supabaseClient.from('vote_logs').delete().eq('round', qpRound);
            // æ¸…é™¤æŠ¢ç­”/ç‚¹åæƒé™ï¼Œä¸‹ä¸€é¢˜éœ€è¦é‡æ–°æŠ¢ç­”
            await supabaseClient.from('vote_config').update({ 
                current_round: qpRound, 
                is_active: false,
                allowed_student: null,
                answer_mode: 'vote'
            }).eq('id', 1);
            loadQPQuestion();
        }
        
        // æŠ¢ç­”å€’è®¡æ—¶
        async function showBuzzerCountdown() {
            const result = document.getElementById('buzzer-result');
            const display = document.getElementById('buzzer-display');
            result.style.display = 'block';
            
            for (let i = 3; i >= 1; i--) {
                display.innerText = i;
                display.className = 'buzzer-countdown';
                await new Promise(r => setTimeout(r, 800));
            }
            display.innerText = 'GO!';
            await supabaseClient.from('buzzer').update({ is_active: true, winner: null }).eq('id', 1);
        }
        
        function closeBuzzerResult() {
            document.getElementById('buzzer-result').style.display = 'none';
        }
        
        // ç›‘å¬æŠ¢ç­”ç»“æœ
        supabaseClient.channel('presentation-buzzer')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'buzzer' }, payload => {
                if (payload.new.winner) {
                    const display = document.getElementById('buzzer-display');
                    display.innerText = payload.new.winner + ' ğŸ†';
                    display.className = 'buzzer-winner';
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    
                    // æŠ¢ç­”æˆåŠŸåï¼Œè®¾ç½®è¯¥å­¦ç”Ÿä¸ºæœ‰æƒå›ç­”è€…ï¼Œå¹¶è·³è½¬åˆ°ç­”é¢˜é¡µé¢
                    setTimeout(async () => {
                        await supabaseClient.from('vote_config').update({ 
                            current_round: qpRound, 
                            is_active: true,
                            allowed_student: payload.new.winner,
                            answer_mode: 'buzzer'
                        }).eq('id', 1);
                        await supabaseClient.from('global_state').update({ status: 'active', current_page: 'vote.html' }).eq('id', 1);
                    }, 1500);
                }
            })
            .subscribe();
        
        // å®æ—¶ç›‘å¬ç­”é¢˜
        // å®æ—¶ç›‘å¬ç­”é¢˜ç»“æœ
        supabaseClient.channel('presentation-vote')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'vote_logs' }, payload => {
                if (isQuestionPanelVisible) {
                    loadQPStats();
                    // å¦‚æœæ˜¯æŠ¢ç­”æˆ–ç‚¹åæ¨¡å¼ï¼Œæ˜¾ç¤ºå›ç­”ç»“æœ
                    if (qpMode === 'buzzer' || qpMode === 'lucky') {
                        showAnswerResult(payload.new);
                    }
                }
            })
            .subscribe();
        
        // æ˜¾ç¤ºæŠ¢ç­”/ç‚¹åå­¦ç”Ÿçš„å›ç­”ç»“æœ
        async function showAnswerResult(voteLog) {
            const resultDiv = document.getElementById('qp-answer-result');
            const modeLabel = document.getElementById('qp-answer-mode-label');
            const studentName = document.getElementById('qp-answer-student');
            const answerOption = document.getElementById('qp-answer-option');
            const correctDiv = document.getElementById('qp-answer-correct');
            
            // è®¾ç½®æ¨¡å¼æ ‡ç­¾
            modeLabel.innerText = qpMode === 'buzzer' ? 'ğŸ† æŠ¢ç­”å›ç­”' : 'ğŸ¯ ç‚¹åå›ç­”';
            
            // è®¾ç½®å­¦ç”Ÿå§“å
            studentName.innerText = voteLog.student_name;
            
            // è®¾ç½®å›ç­”é€‰é¡¹
            answerOption.innerText = voteLog.option;
            
            // è®¾ç½®æ­£ç¡®/é”™è¯¯æ ‡è¯†
            if (voteLog.is_correct) {
                correctDiv.innerHTML = 'âœ… æ­£ç¡®';
                correctDiv.style.color = '#10b981';
                resultDiv.style.background = 'linear-gradient(135deg, rgba(16,185,129,0.3), rgba(16,185,129,0.1))';
            } else {
                correctDiv.innerHTML = 'âŒ é”™è¯¯';
                correctDiv.style.color = '#ef4444';
                resultDiv.style.background = 'linear-gradient(135deg, rgba(239,68,68,0.3), rgba(239,68,68,0.1))';
            }
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultDiv.style.display = 'block';
            
            // åŒæ­¥æ›´æ–°ä¾§è¾¹æ çš„å›ç­”ç»“æœ
            if (isSidebarOpen) {
                const sbResultDiv = document.getElementById('sb-qp-answer-result');
                document.getElementById('sb-qp-answer-mode-label').innerText = modeLabel.innerText;
                document.getElementById('sb-qp-answer-student').innerText = voteLog.student_name;
                document.getElementById('sb-qp-answer-option').innerText = voteLog.option;
                const sbCorrectDiv = document.getElementById('sb-qp-answer-correct');
                sbCorrectDiv.innerHTML = correctDiv.innerHTML;
                sbCorrectDiv.style.color = correctDiv.style.color;
                sbResultDiv.style.background = resultDiv.style.background;
                sbResultDiv.style.display = 'block';
            }
            
            // æ’­æ”¾éŸ³æ•ˆå’Œç‰¹æ•ˆ
            if (voteLog.is_correct) {
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                // åˆ·æ–°æ’è¡Œæ¦œ
                if (isSidebarOpen) loadSidebarLeaderboard();
            }
            
            // æŠ¢ç­”/ç‚¹åæ¨¡å¼ï¼šå­¦ç”Ÿå›ç­”åè‡ªåŠ¨åœæ­¢æœ¬é¢˜ï¼Œä¸‹ä¸€é¢˜éœ€è¦è€å¸ˆé‡æ–°å¼€å§‹
            isQPActive = false;
            showAnswerRevealed = true; // å…¬å¸ƒç­”æ¡ˆ
            await supabaseClient.from('vote_config').update({ 
                is_active: false,
                allowed_student: null
            }).eq('id', 1);
            // é‡æ–°åŠ è½½é¢˜ç›®ä»¥æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
            loadQPQuestion();
        }
        
        // ================== å¼¹å¹•åŠŸèƒ½ ==================
        let danmuSubscribed = false;
        
        function toggleDanmu() {
            isDanmuEnabled = !isDanmuEnabled;
            if (isDanmuEnabled) {
                enableDanmu();
            }
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateDanmuButton();
        }
        
        function updateDanmuButton() {
            const btn = document.querySelector('.btn-danmu');
            if (btn) {
                btn.style.opacity = isDanmuEnabled ? '1' : '0.6';
                btn.innerHTML = isDanmuEnabled ? 'ğŸ’¬ å¼¹å¹• âœ“' : 'ğŸ’¬ å¼¹å¹•';
            }
        }
        
        async function enableDanmu() {
            isDanmuEnabled = true;
            
            // ğŸ”¥ å…³é”®ï¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼Œè®©å­¦ç”Ÿç«¯è·³è½¬åˆ°å¼¹å¹•é¡µé¢
            await supabaseClient.from('global_state').update({ 
                status: 'active', 
                current_page: 'danmu.html' 
            }).eq('id', 1);
            
            // åªè®¢é˜…ä¸€æ¬¡
            if (!danmuSubscribed) {
                supabaseClient.channel('presentation-danmu')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        if (isDanmuEnabled) {
                            createDanmu(payload.new.content);
                        }
                    })
                    .subscribe();
                danmuSubscribed = true;
            }
            
            updateDanmuButton();
        }
        
        function createDanmu(text) {
            const layer = document.getElementById('danmu-layer');
            const div = document.createElement('div');
            div.className = 'danmu-item';
            div.innerText = text;
            
            const colors = ['#FFF', '#FFE4E1', '#7FFFD4', '#FFD700', '#00BFFF', '#FF69B4'];
            div.style.color = colors[Math.floor(Math.random() * colors.length)];
            div.style.top = Math.floor(Math.random() * 80) + 5 + '%';
            div.style.animationDuration = (Math.random() * 5 + 8) + 's';
            
            layer.appendChild(div);
            div.addEventListener('animationend', () => div.remove());
        }
        
        // ================== æŠ¢ç­”åŠŸèƒ½ ==================
        async function startBuzzer() {
            // ğŸ”¥ å…³é”®ï¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼Œè®©å­¦ç”Ÿç«¯è·³è½¬åˆ°æŠ¢ç­”é¡µé¢
            await supabaseClient.from('global_state').update({ 
                status: 'active', 
                current_page: 'buzzer.html' 
            }).eq('id', 1);
            
            // é‡ç½®å¹¶å¯åŠ¨æŠ¢ç­”
            await supabaseClient.from('buzzer').update({ 
                is_active: true, 
                winner: null 
            }).eq('id', 1);
            
            // æ‰“å¼€æŠ¢ç­”æ§åˆ¶å°
            window.open('/buzzer-admin', '_blank', 'width=800,height=600');
        }
        
        // ================== é‡Šæ”¾æ§åˆ¶ ==================
        async function releaseControl() {
            // é‡Šæ”¾å­¦ç”Ÿç«¯æ§åˆ¶ï¼Œè®©å­¦ç”Ÿå›åˆ°é¦–é¡µ
            await supabaseClient.from('global_state').update({ 
                status: 'idle', 
                current_page: 'idle' 
            }).eq('id', 1);
            
            isDanmuEnabled = false;
            isVoteVisible = false;
            document.getElementById('vote-overlay').style.display = 'none';
            updateDanmuButton();
        }
        
        // ================== ä¸‹è¯¾åŠŸèƒ½ ==================
        async function endClass() {
            // æ˜¾ç¤ºä¸‹è¯¾ç¡®è®¤å¼¹çª—
            showEndClassModal();
        }
        
        function showEndClassModal() {
            // åˆ›å»ºä¸‹è¯¾å¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'end-class-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:2000;';
            modal.innerHTML = `
                <div style="background:white; border-radius:20px; padding:30px; width:90%; max-width:550px; color:#333; text-align:center;">
                    <h2 style="margin-bottom:20px; color:#ef4444;">ğŸ”” ä¸‹è¯¾ç¡®è®¤</h2>
                    <p style="color:#666; margin-bottom:15px;">ä¸‹è¯¾å°†è‡ªåŠ¨å­˜æ¡£æ•°æ®åˆ°å†å²è®°å½•ï¼Œç„¶åæ¸…ç©ºä»Šæ—¥æ•°æ®</p>
                    
                    <!-- è¯¾ç¨‹ä¿¡æ¯è¾“å…¥ -->
                    <div style="background:#f0f9ff; border-radius:10px; padding:15px; margin-bottom:15px; text-align:left;">
                        <div style="font-weight:bold; margin-bottom:10px; color:#0369a1;">ğŸ“ è¯¾ç¨‹ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <input type="text" id="end-class-name" placeholder="ç­çº§åç§°" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.9rem;">
                            <input type="text" id="end-course-name" placeholder="è¯¾ç¨‹åç§°" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.9rem;">
                        </div>
                    </div>
                    
                    <div style="background:#f8fafc; border-radius:10px; padding:15px; margin-bottom:20px; text-align:left;">
                        <div style="font-weight:bold; margin-bottom:10px;">ğŸ“Š æœ¬èŠ‚è¯¾æ•°æ®ç»Ÿè®¡</div>
                        <div id="end-class-stats" style="font-size:0.9rem; color:#666;">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <button onclick="exportClassData()" style="padding:15px; background:linear-gradient(135deg, #3b82f6, #8b5cf6); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1rem;">
                            ğŸ’¾ å¯¼å‡ºCSVæ–‡ä»¶
                        </button>
                        <button onclick="archiveAndEndClass()" id="archive-end-btn" style="padding:15px; background:linear-gradient(135deg, #10b981, #059669); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1rem;">
                            ğŸ“¦ å­˜æ¡£å¹¶ä¸‹è¯¾
                        </button>
                        <div style="display:flex; gap:10px;">
                            <button onclick="openHistoryPanel()" style="flex:1; padding:12px; background:#f59e0b; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">
                                ğŸ“š æŸ¥çœ‹å†å²
                            </button>
                            <button onclick="closeEndClassModal()" style="flex:1; padding:12px; background:#e5e7eb; color:#333; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // åŠ è½½ç»Ÿè®¡æ•°æ®
            loadEndClassStats();
        }
        
        async function loadEndClassStats() {
            const statsDiv = document.getElementById('end-class-stats');
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // è·å–ç­¾åˆ°äººæ•°
                const { data: attendance } = await supabaseClient.from('attendance').select('id').gte('created_at', today);
                const attendanceCount = attendance?.length || 0;
                
                // è·å–ç­”é¢˜è®°å½•
                const { data: voteLogs } = await supabaseClient.from('vote_logs').select('is_correct').gte('created_at', today);
                const answerCount = voteLogs?.length || 0;
                const correctCount = voteLogs?.filter(v => v.is_correct).length || 0;
                
                // è·å–ç§¯åˆ†è®°å½•
                const { data: pointsLogs } = await supabaseClient.from('points_log').select('points').gte('created_at', today);
                const totalPoints = pointsLogs?.reduce((sum, p) => sum + p.points, 0) || 0;
                
                statsDiv.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div>ğŸ‘¥ ç­¾åˆ°äººæ•°ï¼š<strong>${attendanceCount}</strong> äºº</div>
                        <div>ğŸ“ ç­”é¢˜æ¬¡æ•°ï¼š<strong>${answerCount}</strong> æ¬¡</div>
                        <div>âœ… æ­£ç¡®ç‡ï¼š<strong>${answerCount > 0 ? Math.round(correctCount/answerCount*100) : 0}%</strong></div>
                        <div>ğŸ† å‘æ”¾ç§¯åˆ†ï¼š<strong>${totalPoints}</strong> åˆ†</div>
                    </div>
                `;
            } catch (e) {
                statsDiv.innerHTML = '<div style="color:#ef4444;">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function closeEndClassModal() {
            const modal = document.getElementById('end-class-modal');
            if (modal) modal.remove();
        }
        
        async function exportClassData() {
            const today = new Date().toISOString().split('T')[0];
            const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-');
            
            try {
                // è·å–æ‰€æœ‰æ•°æ®
                const { data: attendance } = await supabaseClient.from('attendance').select('*').gte('created_at', today);
                const { data: voteLogs } = await supabaseClient.from('vote_logs').select('*').gte('created_at', today);
                const { data: pointsLogs } = await supabaseClient.from('points_log').select('*').gte('created_at', today);
                const { data: studentPoints } = await supabaseClient.from('student_points').select('*');
                
                // æ±‡æ€»å­¦ç”Ÿæ•°æ®
                const studentMap = {};
                
                // ä»ç­¾åˆ°è®°å½•è·å–å­¦ç”Ÿä¿¡æ¯
                (attendance || []).forEach(a => {
                    if (!studentMap[a.student_id]) {
                        studentMap[a.student_id] = {
                            student_id: a.student_id,
                            student_name: a.student_name,
                            signed: true,
                            sign_time: a.created_at,
                            answer_count: 0,
                            correct_count: 0,
                            today_points: 0,
                            total_points: 0
                        };
                    }
                });
                
                // ä»ç­”é¢˜è®°å½•ç»Ÿè®¡
                (voteLogs || []).forEach(v => {
                    if (studentMap[v.student_id]) {
                        studentMap[v.student_id].answer_count++;
                        if (v.is_correct) studentMap[v.student_id].correct_count++;
                    }
                });
                
                // ä»ç§¯åˆ†è®°å½•ç»Ÿè®¡ä»Šæ—¥ç§¯åˆ†
                (pointsLogs || []).forEach(p => {
                    if (studentMap[p.student_id]) {
                        studentMap[p.student_id].today_points += p.points;
                    }
                });
                
                // ä»æ€»ç§¯åˆ†è¡¨è·å–æ€»ç§¯åˆ†
                (studentPoints || []).forEach(s => {
                    if (studentMap[s.student_id]) {
                        studentMap[s.student_id].total_points = s.total_points;
                    }
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                const students = Object.values(studentMap).sort((a, b) => b.total_points - a.total_points);
                
                // ç”ŸæˆExcel CSVå†…å®¹ï¼ˆå¸¦BOMä»¥æ”¯æŒä¸­æ–‡ï¼‰
                const BOM = '\uFEFF';
                const headers = ['æ’å', 'å­¦å·', 'å§“å', 'ç­¾åˆ°æ—¶é—´', 'ç­”é¢˜æ¬¡æ•°', 'æ­£ç¡®æ¬¡æ•°', 'æ­£ç¡®ç‡', 'ä»Šæ—¥ç§¯åˆ†', 'æ€»ç§¯åˆ†'];
                const rows = students.map((s, i) => [
                    i + 1,
                    s.student_id,
                    s.student_name,
                    s.sign_time ? new Date(s.sign_time).toLocaleString('zh-CN') : '',
                    s.answer_count,
                    s.correct_count,
                    s.answer_count > 0 ? Math.round(s.correct_count / s.answer_count * 100) + '%' : '0%',
                    s.today_points,
                    s.total_points
                ]);
                
                // æ·»åŠ æ±‡æ€»è¡Œ
                const totalAnswers = students.reduce((sum, s) => sum + s.answer_count, 0);
                const totalCorrect = students.reduce((sum, s) => sum + s.correct_count, 0);
                const totalTodayPts = students.reduce((sum, s) => sum + s.today_points, 0);
                rows.push([]);
                rows.push(['æ±‡æ€»', '', `å…±${students.length}äºº`, '', totalAnswers, totalCorrect, 
                    totalAnswers > 0 ? Math.round(totalCorrect / totalAnswers * 100) + '%' : '0%', 
                    totalTodayPts, '']);
                
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                const csvContent = BOM + [headers, ...rows].map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                // ä¸‹è½½CSVæ–‡ä»¶ï¼ˆExcelå¯ç›´æ¥æ‰“å¼€ï¼‰
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `è¯¾å ‚æ•°æ®_${timestamp}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å·²ä¿å­˜ä¸ºCSVæ ¼å¼ï¼Œå¯ç”¨Excelç›´æ¥æ‰“å¼€ã€‚');
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                alert('âŒ å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
        
        // å­˜æ¡£å¹¶ä¸‹è¯¾
        async function archiveAndEndClass() {
            const btn = document.getElementById('archive-end-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³ æ­£åœ¨å­˜æ¡£...';
            
            try {
                // è·å–è¯¾ç¨‹ä¿¡æ¯
                const className = document.getElementById('end-class-name')?.value || '';
                const courseName = document.getElementById('end-course-name')?.value || '';
                
                // 1. å­˜æ¡£æ•°æ®åˆ°å†å²è®°å½•
                const archiveResult = await ClassHistory.archiveSession(supabaseClient, {
                    class_name: className,
                    course_name: courseName
                });
                
                if (archiveResult.success) {
                    console.log('âœ… æ•°æ®å­˜æ¡£æˆåŠŸ:', archiveResult.sessionId);
                }
                
                // 2. æ‰§è¡Œä¸‹è¯¾æ¸…ç†
                await doEndClassCleanup();
                
                // å…³é—­å¼¹çª—
                closeEndClassModal();
                
                if (archiveResult.success) {
                    alert(`âœ… ä¸‹è¯¾æˆåŠŸï¼\n\nğŸ“¦ æ•°æ®å·²å­˜æ¡£åˆ°å†å²è®°å½•\nâ€¢ ç­¾åˆ°äººæ•°: ${archiveResult.stats.attendanceCount}\nâ€¢ ç­”é¢˜æ¬¡æ•°: ${archiveResult.stats.answerCount}\nâ€¢ æ­£ç¡®ç‡: ${archiveResult.stats.correctRate}%\nâ€¢ å‘æ”¾ç§¯åˆ†: ${archiveResult.stats.pointsDistributed}\n\nå¯åœ¨"æŸ¥çœ‹å†å²"ä¸­æŸ¥çœ‹è¯¦æƒ…`);
                } else {
                    alert('âœ… ä¸‹è¯¾æˆåŠŸï¼\n\nâš ï¸ æ•°æ®å­˜æ¡£è·³è¿‡ï¼ˆæ— æ•°æ®æˆ–å­˜æ¡£å¤±è´¥ï¼‰\næ‰€æœ‰åŠŸèƒ½å·²é‡ç½®');
                }
            } catch (err) {
                console.error('å­˜æ¡£ä¸‹è¯¾å¤±è´¥:', err);
                alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“¦ å­˜æ¡£å¹¶ä¸‹è¯¾';
            }
        }
        
        // ä¸‹è¯¾æ¸…ç†æ“ä½œ
        async function doEndClassCleanup() {
            const today = new Date().toISOString().split('T')[0];
            
            // 1. é‡Šæ”¾å…¨å±€æ§åˆ¶
            await supabaseClient.from('global_state').update({
                current_page: 'idle',
                status: 'idle'
            }).eq('id', 1);
            
            // 2. é‡ç½®ç­”é¢˜é…ç½®
            await supabaseClient.from('vote_config').update({
                current_round: 1,
                is_active: false,
                allowed_student: null,
                answer_mode: 'vote'
            }).eq('id', 1);
            
            // 3. å…³é—­æŠ¢ç­”
            await supabaseClient.from('buzzer').update({
                is_active: false,
                winner: null
            }).eq('id', 1);
            
            // 4. æ¸…ç©ºä»Šæ—¥ç­”é¢˜è®°å½•
            await supabaseClient.from('vote_logs').delete().gte('created_at', today);
            
            // 5. æ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•
            await supabaseClient.from('attendance').delete().gte('created_at', today);
            
            // 6. æ¸…ç©ºä»Šæ—¥ç§¯åˆ†è®°å½•
            await supabaseClient.from('points_log').delete().gte('created_at', today);
            
            // é‡ç½®æœ¬åœ°çŠ¶æ€
            isDanmuEnabled = false;
            isQuestionPanelVisible = false;
            qpRound = 1;
            isQPActive = false;
            showAnswerRevealed = false;
            document.getElementById('question-panel').style.display = 'none';
            updateDanmuButton();
            
            // å…³é—­ä¾§è¾¹æ 
            if (isSidebarOpen) {
                isSidebarOpen = false;
                document.getElementById('sidebar').classList.remove('open');
            }
            
            // å…³é—­ç‚¹åé¢æ¿
            if (isLuckyVisible) {
                closeLuckyOverlay();
            }
        }
        
        async function confirmEndClass() {
            if (!confirm('âš ï¸ ç¡®å®šä¸å­˜æ¡£ç›´æ¥ä¸‹è¯¾å—ï¼Ÿ\n\nè¿™å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ä¸”ä¸ä¿å­˜åˆ°å†å²è®°å½•ï¼')) {
                return;
            }
            try {
                await doEndClassCleanup();
                closeEndClassModal();
                alert('âœ… ä¸‹è¯¾æˆåŠŸï¼\n\nâ€¢ æ‰€æœ‰åŠŸèƒ½å·²é‡ç½®\nâ€¢ æ•°æ®å·²æ¸…ç©ºï¼ˆæœªå­˜æ¡£ï¼‰');
            } catch (err) {
                console.error('ä¸‹è¯¾æ“ä½œå¤±è´¥:', err);
                alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
            }
        }
        
        // ================== å†å²è®°å½•é¢æ¿ ==================
        function openHistoryPanel() {
            closeEndClassModal();
            
            const panel = document.createElement('div');
            panel.id = 'history-panel';
            panel.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:2000;';
            panel.innerHTML = `
                <div style="background:#1e293b; border-radius:20px; padding:25px; width:95%; max-width:900px; max-height:85vh; color:white; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="margin:0;">ğŸ“š è¯¾å ‚å†å²è®°å½•</h2>
                        <button onclick="closeHistoryPanel()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">âœ•</button>
                    </div>
                    
                    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                    <div id="history-overview" style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-bottom:20px;">
                        <div style="background:rgba(59,130,246,0.2); padding:15px; border-radius:10px; text-align:center;">
                            <div style="font-size:1.8rem; font-weight:bold; color:#3b82f6;" id="hist-total-sessions">-</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">æ€»è¯¾æ¬¡</div>
                        </div>
                        <div style="background:rgba(16,185,129,0.2); padding:15px; border-radius:10px; text-align:center;">
                            <div style="font-size:1.8rem; font-weight:bold; color:#10b981;" id="hist-total-students">-</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">æ€»äººæ¬¡</div>
                        </div>
                        <div style="background:rgba(245,158,11,0.2); padding:15px; border-radius:10px; text-align:center;">
                            <div style="font-size:1.8rem; font-weight:bold; color:#f59e0b;" id="hist-avg-attendance">-</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">å¹³å‡å‡ºå‹¤</div>
                        </div>
                        <div style="background:rgba(139,92,246,0.2); padding:15px; border-radius:10px; text-align:center;">
                            <div style="font-size:1.8rem; font-weight:bold; color:#8b5cf6;" id="hist-avg-correct">-</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">å¹³å‡æ­£ç¡®ç‡</div>
                        </div>
                        <div style="background:rgba(239,68,68,0.2); padding:15px; border-radius:10px; text-align:center;">
                            <div style="font-size:1.8rem; font-weight:bold; color:#ef4444;" id="hist-total-points">-</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">æ€»ç§¯åˆ†</div>
                        </div>
                    </div>
                    
                    <!-- å†å²åˆ—è¡¨ -->
                    <div style="flex:1; overflow-y:auto;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:rgba(255,255,255,0.1);">
                                    <th style="padding:12px; text-align:left; font-size:0.85rem;">æ—¥æœŸæ—¶é—´</th>
                                    <th style="padding:12px; text-align:left; font-size:0.85rem;">ç­çº§</th>
                                    <th style="padding:12px; text-align:left; font-size:0.85rem;">è¯¾ç¨‹</th>
                                    <th style="padding:12px; text-align:center; font-size:0.85rem;">å‡ºå‹¤</th>
                                    <th style="padding:12px; text-align:center; font-size:0.85rem;">ç­”é¢˜</th>
                                    <th style="padding:12px; text-align:center; font-size:0.85rem;">æ­£ç¡®ç‡</th>
                                    <th style="padding:12px; text-align:center; font-size:0.85rem;">ç§¯åˆ†</th>
                                    <th style="padding:12px; text-align:center; font-size:0.85rem;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-list">
                                <tr><td colspan="8" style="padding:30px; text-align:center; color:#666;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.body.appendChild(panel);
            
            loadHistoryData();
        }
        
        function closeHistoryPanel() {
            const panel = document.getElementById('history-panel');
            if (panel) panel.remove();
        }
        
        async function loadHistoryData() {
            try {
                // åŠ è½½ç»Ÿè®¡æ¦‚è§ˆ
                const stats = await ClassHistory.getOverviewStats(supabaseClient, 30);
                document.getElementById('hist-total-sessions').textContent = stats.totalSessions;
                document.getElementById('hist-total-students').textContent = stats.totalStudents;
                document.getElementById('hist-avg-attendance').textContent = stats.avgAttendance;
                document.getElementById('hist-avg-correct').textContent = stats.avgCorrectRate + '%';
                document.getElementById('hist-total-points').textContent = stats.totalPoints;
                
                // åŠ è½½å†å²åˆ—è¡¨
                const sessions = await ClassHistory.getSessionList(supabaseClient, 50);
                const tbody = document.getElementById('history-list');
                
                if (sessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding:30px; text-align:center; color:#666;">æš‚æ— å†å²è®°å½•</td></tr>';
                    return;
                }
                
                tbody.innerHTML = sessions.map(s => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                        <td style="padding:12px; font-size:0.85rem;">${new Date(s.start_time).toLocaleString('zh-CN')}</td>
                        <td style="padding:12px; font-size:0.85rem;">${s.class_name || '-'}</td>
                        <td style="padding:12px; font-size:0.85rem;">${s.course_name || '-'}</td>
                        <td style="padding:12px; text-align:center; font-size:0.85rem;">${s.attendance_count}äºº</td>
                        <td style="padding:12px; text-align:center; font-size:0.85rem;">${s.answer_count}æ¬¡</td>
                        <td style="padding:12px; text-align:center; font-size:0.85rem;">${s.correct_rate || 0}%</td>
                        <td style="padding:12px; text-align:center; font-size:0.85rem;">${s.points_distributed}åˆ†</td>
                        <td style="padding:12px; text-align:center;">
                            <button onclick="viewSessionDetail('${s.session_id}')" style="padding:5px 10px; background:#3b82f6; color:white; border:none; border-radius:5px; cursor:pointer; font-size:0.75rem; margin-right:5px;">è¯¦æƒ…</button>
                            <button onclick="deleteSession('${s.session_id}')" style="padding:5px 10px; background:#ef4444; color:white; border:none; border-radius:5px; cursor:pointer; font-size:0.75rem;">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', e);
                document.getElementById('history-list').innerHTML = '<tr><td colspan="8" style="padding:30px; text-align:center; color:#ef4444;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        async function viewSessionDetail(sessionId) {
            try {
                const detail = await ClassHistory.getSessionDetail(supabaseClient, sessionId);
                if (!detail.session) {
                    alert('æœªæ‰¾åˆ°è¯¥è®°å½•');
                    return;
                }
                
                const s = detail.session;
                const students = detail.students;
                
                // åˆ›å»ºè¯¦æƒ…å¼¹çª—
                const detailPanel = document.createElement('div');
                detailPanel.id = 'session-detail-panel';
                detailPanel.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:2100;';
                detailPanel.innerHTML = `
                    <div style="background:#1e293b; border-radius:20px; padding:25px; width:95%; max-width:800px; max-height:85vh; color:white; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <div>
                                <h2 style="margin:0 0 5px 0;">ğŸ“‹ è¯¾å ‚è¯¦æƒ…</h2>
                                <div style="font-size:0.85rem; color:#94a3b8;">${new Date(s.start_time).toLocaleString('zh-CN')} | ${s.class_name || 'æœªå‘½å'} | ${s.course_name || 'æœªå‘½åè¯¾ç¨‹'}</div>
                            </div>
                            <button onclick="document.getElementById('session-detail-panel').remove()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">âœ•</button>
                        </div>
                        
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px;">
                            <div style="background:rgba(59,130,246,0.2); padding:12px; border-radius:10px; text-align:center;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#3b82f6;">${s.attendance_count}</div>
                                <div style="font-size:0.75rem; color:#94a3b8;">ç­¾åˆ°äººæ•°</div>
                            </div>
                            <div style="background:rgba(16,185,129,0.2); padding:12px; border-radius:10px; text-align:center;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#10b981;">${s.answer_count}</div>
                                <div style="font-size:0.75rem; color:#94a3b8;">ç­”é¢˜æ¬¡æ•°</div>
                            </div>
                            <div style="background:rgba(245,158,11,0.2); padding:12px; border-radius:10px; text-align:center;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#f59e0b;">${s.correct_rate || 0}%</div>
                                <div style="font-size:0.75rem; color:#94a3b8;">æ­£ç¡®ç‡</div>
                            </div>
                            <div style="background:rgba(139,92,246,0.2); padding:12px; border-radius:10px; text-align:center;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#8b5cf6;">${s.points_distributed}</div>
                                <div style="font-size:0.75rem; color:#94a3b8;">å‘æ”¾ç§¯åˆ†</div>
                            </div>
                        </div>
                        
                        <!-- å­¦ç”Ÿåˆ—è¡¨ -->
                        <div style="flex:1; overflow-y:auto;">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:rgba(255,255,255,0.1);">
                                        <th style="padding:10px; text-align:left; font-size:0.8rem;">æ’å</th>
                                        <th style="padding:10px; text-align:left; font-size:0.8rem;">å­¦å·</th>
                                        <th style="padding:10px; text-align:left; font-size:0.8rem;">å§“å</th>
                                        <th style="padding:10px; text-align:center; font-size:0.8rem;">ç­¾åˆ°</th>
                                        <th style="padding:10px; text-align:center; font-size:0.8rem;">ç­”é¢˜</th>
                                        <th style="padding:10px; text-align:center; font-size:0.8rem;">æ­£ç¡®</th>
                                        <th style="padding:10px; text-align:center; font-size:0.8rem;">æ­£ç¡®ç‡</th>
                                        <th style="padding:10px; text-align:center; font-size:0.8rem;">æœ¬èŠ‚ç§¯åˆ†</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map((st, i) => `
                                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                            <td style="padding:10px; font-size:0.85rem;">${i + 1}</td>
                                            <td style="padding:10px; font-size:0.85rem;">${st.student_id}</td>
                                            <td style="padding:10px; font-size:0.85rem;">${st.student_name}</td>
                                            <td style="padding:10px; text-align:center; font-size:0.85rem;">${st.signed ? 'âœ…' : 'âŒ'}</td>
                                            <td style="padding:10px; text-align:center; font-size:0.85rem;">${st.answer_count}</td>
                                            <td style="padding:10px; text-align:center; font-size:0.85rem;">${st.correct_count}</td>
                                            <td style="padding:10px; text-align:center; font-size:0.85rem;">${st.correct_rate || 0}%</td>
                                            <td style="padding:10px; text-align:center; font-size:0.85rem; color:#f59e0b; font-weight:bold;">${st.session_points}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(detailPanel);
            } catch (e) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', e);
                alert('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + e.message);
            }
        }
        
        async function deleteSession(sessionId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            const success = await ClassHistory.deleteSession(supabaseClient, sessionId);
            if (success) {
                alert('âœ… åˆ é™¤æˆåŠŸ');
                loadHistoryData();
            } else {
                alert('âŒ åˆ é™¤å¤±è´¥');
            }
        }
        
        // ================== æ’è¡Œæ¦œ ==================
        async function showLeaderboard() {
            // è®©å­¦ç”Ÿç«¯è·³è½¬åˆ°æ’è¡Œæ¦œé¡µé¢
            await supabaseClient.from('global_state').update({ 
                status: 'active', 
                current_page: 'leaderboard.html' 
            }).eq('id', 1);
            
            // åŒæ—¶åœ¨æ–°çª—å£æ‰“å¼€æ•™å¸ˆç«¯æ’è¡Œæ¦œ
            window.open('/classroom/leaderboard.html', '_blank', 'width=500,height=700');
        }
        
        // ================== æ•°æ®åˆ†æ ==================
        function openAnalytics() {
            window.open('/classroom/analytics.html', '_blank', 'width=1000,height=800');
        }
        
        // ================== é‡‡æ ·å¸ƒç‚¹æ²™ç›˜ ==================
        function openSamplingSandbox() {
            window.open('/classroom/sampling-sandbox.html?mode=demo', '_blank');
        }
        
        // ================== å±åºŸé‰´åˆ«å‰§æœ¬æ€ ==================
        function openHazwasteDetective() {
            window.open('/classroom/hazwaste-detective.html', '_blank');
        }
        
        // ================== è™šæ‹Ÿå·¥ä½ç«èµ› ==================
        function openVirtualStationCompetition() {
            window.open('/classroom/virtual-station-admin.html?mode=competition', '_blank');
        }
        
        // ================== æ¨¡æ€æ¡† ==================
        function openUploadModal() {
            document.getElementById('upload-modal').style.display = 'flex';
        }
        
        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
        }
        
        // ================== å…¨å± ==================
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // ================== é”®ç›˜å¿«æ·é”® ==================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                case 'PageUp':
                    e.preventDefault();
                    prevSlide();
                    break;
                case 'ArrowRight':
                case 'PageDown':
                case ' ':
                    e.preventDefault();
                    nextSlide();
                    break;
                case 'q':
                case 'Q':
                    toggleQuestionPanel();
                    break;
                case 'd':
                case 'D':
                    toggleDanmu();
                    break;
                case 'l':
                case 'L':
                    toggleLuckyOverlay();
                    break;
                case 'f':
                case 'F':
                    toggleFullscreen();
                    break;
                case 'r':
                case 'R':
                    releaseControl();
                    break;
                case 'c':
                case 'C':
                    clearContent();
                    break;
                case 's':
                case 'S':
                    toggleSidebar();
                    break;
                case 'a':
                case 'A':
                    openAdminPanel();
                    break;
                case 'Escape':
                    closeUploadModal();
                    closeQuestionPanel();
                    closeBuzzerResult();
                    document.getElementById('lucky-overlay').style.display = 'none';
                    document.getElementById('lucky-settings-panel').style.display = 'none';
                    isLuckyVisible = false;
                    // å…³é—­ä¾§è¾¹æ 
                    if (isSidebarOpen) {
                        isSidebarOpen = false;
                        document.getElementById('sidebar').classList.remove('open');
                    }
                    break;
            }
        });
        
        // ================== æ‹–æ‹½ä¸Šä¼  ==================
        const dropZone = document.getElementById('drop-zone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        // ================== éšæœºç‚¹ååŠŸèƒ½ ==================
        let isLuckyVisible = false;
        let luckyData = {};
        let luckyCurrentClass = '';
        let luckyNames = [];
        let luckyTimer = null;
        let isLuckyRunning = false;
        let isLuckyMuted = false;
        
        // éŸ³æ•ˆ - ä½¿ç”¨ Web Audio API ç”Ÿæˆ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let rollInterval = null;
        
        const luckyRollSound = {
            play: function() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                rollInterval = setInterval(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = 200 + Math.random() * 100;
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    gain.gain.value = 0.1;
                    osc.start();
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                    osc.stop(audioCtx.currentTime + 0.1);
                }, 80);
                return Promise.resolve();
            },
            pause: function() { clearInterval(rollInterval); },
            muted: false
        };
        
        const luckyWinSound = {
            play: function() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                [523, 659, 784, 1047].forEach((freq, i) => {
                    setTimeout(() => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        gain.gain.value = 0.2;
                        osc.start();
                        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                        osc.stop(audioCtx.currentTime + 0.3);
                    }, i * 100);
                });
            },
            currentTime: 0,
            muted: false
        };
        
        function toggleLuckyOverlay() {
            isLuckyVisible = !isLuckyVisible;
            document.getElementById('lucky-overlay').style.display = isLuckyVisible ? 'block' : 'none';
            if (isLuckyVisible) {
                initLuckyData();
                updateLuckyQuestionInfo();
            }
        }
        
        // æ›´æ–°ç‚¹åé¢æ¿ä¸­çš„å½“å‰é¢˜ç›®ä¿¡æ¯
        function updateLuckyQuestionInfo() {
            const titleEl = document.getElementById('lucky-question-title');
            if (qpQuestion) {
                titleEl.innerText = `ç¬¬ ${qpRound} é¢˜ï¼š${qpQuestion.title}`;
            } else {
                titleEl.innerText = `ç¬¬ ${qpRound} é¢˜ï¼šæš‚æ— é¢˜ç›®`;
            }
        }
        
        function closeLuckyOverlay() {
            isLuckyVisible = false;
            document.getElementById('lucky-overlay').style.display = 'none';
            if (isLuckyRunning) {
                clearInterval(luckyTimer);
                isLuckyRunning = false;
                luckyRollSound.pause();
            }
        }
        
        // ç‚¹åæ•°æ®æºç±»å‹ï¼š'attendance' = å·²ç­¾åˆ°å­¦ç”Ÿ, 'custom' = è‡ªå®šä¹‰åå•
        let luckyDataSource = 'attendance';
        let attendanceStudents = []; // å·²ç­¾åˆ°å­¦ç”Ÿåˆ—è¡¨
        
        async function initLuckyData() {
            // é»˜è®¤ä»å·²ç­¾åˆ°å­¦ç”Ÿä¸­ç‚¹å
            await loadAttendanceStudents();
            
            // åŒæ—¶åŠ è½½è‡ªå®šä¹‰åå•ä½œä¸ºå¤‡é€‰
            const saved = localStorage.getItem('lucky_classes_v2');
            if (saved) {
                luckyData = JSON.parse(saved);
            } else {
                luckyData = { "è‡ªå®šä¹‰åå•": [] };
            }
            renderLuckySelect();
        }
        
        // åŠ è½½ä»Šæ—¥å·²ç­¾åˆ°å­¦ç”Ÿ
        async function loadAttendanceStudents() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data } = await supabaseClient.from('attendance')
                    .select('student_name, student_id')
                    .gte('created_at', today)
                    .order('created_at', { ascending: true });
                attendanceStudents = data || [];
                updateLuckyDisplay();
            } catch (e) {
                console.error('åŠ è½½ç­¾åˆ°å­¦ç”Ÿå¤±è´¥:', e);
                attendanceStudents = [];
            }
        }
        
        function updateLuckyDisplay() {
            const display = document.getElementById('lucky-display');
            const countInfo = document.getElementById('lucky-count-info');
            
            if (luckyDataSource === 'attendance') {
                luckyNames = attendanceStudents.map(s => s.student_name);
                if (countInfo) {
                    countInfo.innerText = `å·²ç­¾åˆ° ${luckyNames.length} äºº`;
                    countInfo.style.color = luckyNames.length > 0 ? '#10b981' : '#ef4444';
                }
            } else {
                luckyNames = luckyData[luckyCurrentClass] || [];
                if (countInfo) {
                    countInfo.innerText = `${luckyCurrentClass}: ${luckyNames.length} äºº`;
                    countInfo.style.color = luckyNames.length > 0 ? '#10b981' : '#ef4444';
                }
            }
            
            display.innerText = luckyNames.length > 0 ? 'å‡†å¤‡ç‚¹å' : 'æš‚æ— å­¦ç”Ÿ';
            display.style.color = 'white';
        }
        
        function renderLuckySelect() {
            const select = document.getElementById('lucky-class-select');
            select.innerHTML = '';
            
            // æ·»åŠ "å·²ç­¾åˆ°å­¦ç”Ÿ"é€‰é¡¹
            const attendanceOpt = document.createElement('option');
            attendanceOpt.value = '__attendance__';
            attendanceOpt.innerText = `ğŸ“‹ å·²ç­¾åˆ°å­¦ç”Ÿ (${attendanceStudents.length}äºº)`;
            select.appendChild(attendanceOpt);
            
            // æ·»åŠ åˆ†éš”çº¿
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.innerText = 'â”€â”€ è‡ªå®šä¹‰åå• â”€â”€';
            select.appendChild(separator);
            
            // æ·»åŠ è‡ªå®šä¹‰ç­çº§
            const keys = Object.keys(luckyData);
            keys.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = `${key} (${luckyData[key].length}äºº)`;
                select.appendChild(opt);
            });
            
            // é»˜è®¤é€‰æ‹©å·²ç­¾åˆ°å­¦ç”Ÿ
            select.value = '__attendance__';
            luckyDataSource = 'attendance';
            switchLuckyClass();
        }
        
        function switchLuckyClass() {
            const selectedValue = document.getElementById('lucky-class-select').value;
            
            if (selectedValue === '__attendance__') {
                luckyDataSource = 'attendance';
                luckyNames = attendanceStudents.map(s => s.student_name);
            } else {
                luckyDataSource = 'custom';
                luckyCurrentClass = selectedValue;
                luckyNames = luckyData[luckyCurrentClass] || [];
            }
            
            updateLuckyDisplay();
        }
        
        function toggleLuckyMute() {
            isLuckyMuted = !isLuckyMuted;
            document.getElementById('lucky-mute-btn').innerText = isLuckyMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            luckyRollSound.muted = isLuckyMuted;
            luckyWinSound.muted = isLuckyMuted;
        }
        
        function toggleLuckyRoll() {
            if (!luckyNames || luckyNames.length === 0) {
                if (luckyDataSource === 'attendance') {
                    alert('âš ï¸ æš‚æ— å·²ç­¾åˆ°å­¦ç”Ÿï¼\n\nè¯·å…ˆè®©å­¦ç”Ÿå®Œæˆç­¾åˆ°ï¼Œæˆ–åˆ‡æ¢åˆ°è‡ªå®šä¹‰åå•ã€‚');
                } else {
                    alert(`ç­çº§ "${luckyCurrentClass}" æ˜¯ç©ºçš„ï¼è¯·ç‚¹å‡»âš™ï¸æ·»åŠ åå•ã€‚`);
                }
                return;
            }
            
            const btn = document.getElementById('lucky-action-btn');
            const display = document.getElementById('lucky-display');
            
            if (isLuckyRunning) {
                // åœæ­¢
                clearInterval(luckyTimer);
                isLuckyRunning = false;
                btn.innerText = 'å¼€å§‹';
                btn.style.background = 'white';
                btn.style.color = '#333';
                display.style.color = '#FFD700';
                display.style.textShadow = '0 0 20px #FFD700';
                
                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                if (!isLuckyMuted) {
                    luckyRollSound.pause();
                    luckyWinSound.currentTime = 0;
                    luckyWinSound.play();
                }
                
                // ç‚¹åæˆåŠŸåï¼Œè®¾ç½®è¯¥å­¦ç”Ÿä¸ºæœ‰æƒå›ç­”è€…
                const selectedName = display.innerText;
                if (selectedName && qpQuestion) {
                    // è§¦å‘å½©å¸¦æ•ˆæœ
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    
                    setTimeout(async () => {
                        // è®¾ç½®è¯¥å­¦ç”Ÿä¸ºæœ‰æƒå›ç­”è€…ï¼Œå¹¶è·³è½¬åˆ°ç­”é¢˜é¡µé¢
                        await supabaseClient.from('vote_config').update({ 
                            current_round: qpRound, 
                            is_active: true,
                            allowed_student: selectedName,
                            answer_mode: 'lucky'
                        }).eq('id', 1);
                        await supabaseClient.from('global_state').update({ status: 'active', current_page: 'vote.html' }).eq('id', 1);
                        
                        // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                        document.getElementById('sb-qp-answer-mode-label').innerText = 'ğŸ° ç‚¹åå›ç­”';
                        document.getElementById('sb-qp-answer-student').innerText = selectedName;
                        document.getElementById('sb-qp-answer-result').style.display = 'block';
                        
                        closeLuckyOverlay();
                    }, 1500);
                }
            } else {
                // å¼€å§‹
                display.style.color = 'white';
                display.style.textShadow = '0 5px 15px rgba(0,0,0,0.5)';
                isLuckyRunning = true;
                btn.innerText = 'åœæ­¢';
                btn.style.background = '#ff4757';
                btn.style.color = 'white';
                
                // æ’­æ”¾æ»šåŠ¨éŸ³æ•ˆ
                if (!isLuckyMuted) {
                    luckyRollSound.currentTime = 0;
                    luckyRollSound.play().catch(e => console.log('ç­‰å¾…ç”¨æˆ·äº¤äº’'));
                }
                
                luckyTimer = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * luckyNames.length);
                    display.innerText = luckyNames[randomIndex];
                }, 50);
            }
        }
        
        function openLuckySettings() {
            document.getElementById('lucky-settings-panel').style.display = 'block';
            document.getElementById('lucky-editing-class').innerText = luckyCurrentClass;
            document.getElementById('lucky-name-input').value = luckyNames.join('\n');
        }
        
        function closeLuckySettings() {
            document.getElementById('lucky-settings-panel').style.display = 'none';
        }
        
        function addLuckyClass() {
            const newName = document.getElementById('lucky-new-class-name').value.trim();
            if (!newName) return alert('è¯·è¾“å…¥ç­çº§åç§°ï¼');
            if (luckyData[newName]) return alert('è¿™ä¸ªç­çº§å·²ç»å­˜åœ¨äº†ï¼');
            luckyData[newName] = [];
            luckyCurrentClass = newName;
            saveLuckyData();
            renderLuckySelect();
            document.getElementById('lucky-new-class-name').value = '';
            alert(`âœ… å·²åˆ›å»º "${newName}"ï¼Œè¯·åœ¨ä¸‹æ–¹ç²˜è´´åå•`);
        }
        
        function saveLuckyList() {
            const rawText = document.getElementById('lucky-name-input').value;
            const namesArr = rawText.split('\n').filter(n => n.trim() !== '');
            if (namesArr.length === 0) return alert('åå•ä¸èƒ½ä¸ºç©ºï¼');
            luckyData[luckyCurrentClass] = namesArr;
            luckyNames = namesArr;
            saveLuckyData();
            alert(`âœ… å·²æ›´æ–°ï¼Œå…± ${namesArr.length} äºº`);
            closeLuckySettings();
        }
        
        function deleteLuckyClass() {
            if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ç­çº§ "${luckyCurrentClass}" å—ï¼Ÿ`)) return;
            delete luckyData[luckyCurrentClass];
            luckyCurrentClass = '';
            saveLuckyData();
            renderLuckySelect();
            closeLuckySettings();
        }
        
        function saveLuckyData() {
            localStorage.setItem('lucky_classes_v2', JSON.stringify(luckyData));
        }
        
        // ================== ä¾§è¾¹æ åŠŸèƒ½ ==================
        let isSidebarOpen = false;
        
        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            document.getElementById('sidebar').classList.toggle('open', isSidebarOpen);
            if (isSidebarOpen) {
                loadSidebarQuestion();
                loadSidebarLeaderboard();
            }
        }
        
        // ä¾§è¾¹æ å·²æ•´åˆï¼Œä¸å†éœ€è¦æ ‡ç­¾é¡µåˆ‡æ¢
        
        // ä¾§è¾¹æ é¢˜åº“åŠ è½½
        async function loadSidebarQuestion() {
            try {
                document.getElementById('sb-qp-answer-result').style.display = 'none';
                const { data } = await supabaseClient.from('questions').select('*').eq('round', qpRound).maybeSingle();
                qpQuestion = data;
                document.getElementById('sb-qp-round').innerText = qpRound;
                
                if (data) {
                    document.getElementById('sb-qp-title').innerText = data.title;
                    const opts = document.getElementById('sb-qp-options');
                    opts.innerHTML = `
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('A') ? 'correct' : ''}">A. ${data.option_a || ''}</div>
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('B') ? 'correct' : ''}">B. ${data.option_b || ''}</div>
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('C') ? 'correct' : ''}">C. ${data.option_c || ''}</div>
                        <div class="qp-opt ${showAnswerRevealed && data.answer.includes('D') ? 'correct' : ''}">D. ${data.option_d || ''}</div>
                    `;
                    qpMode = data.mode || 'vote';
                    updateSidebarModeDisplay();
                } else {
                    document.getElementById('sb-qp-title').innerText = '(æ— é¢˜ç›®æ•°æ®)';
                    document.getElementById('sb-qp-options').innerHTML = '';
                }
                loadSidebarStats();
            } catch (e) { console.error(e); }
        }
        
        async function loadSidebarStats() {
            try {
                const { data } = await supabaseClient.from('vote_logs').select('option').eq('round', qpRound);
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                if (data) data.forEach(row => { if (counts[row.option] !== undefined) counts[row.option]++; });
                document.getElementById('sb-qp-stat-a').innerText = counts.A;
                document.getElementById('sb-qp-stat-b').innerText = counts.B;
                document.getElementById('sb-qp-stat-c').innerText = counts.C;
                document.getElementById('sb-qp-stat-d').innerText = counts.D;
            } catch (e) { console.error(e); }
        }
        
        function updateSidebarModeDisplay() {
            const badge = document.getElementById('sb-qp-mode-badge');
            const stats = document.getElementById('sb-qp-stats');
            const modeConfig = {
                'vote': { text: 'ğŸ“Š ç­”é¢˜', class: 'qp-mode-vote' },
                'buzzer': { text: 'âš¡ æŠ¢ç­”', class: 'qp-mode-buzzer' },
                'lucky': { text: 'ğŸ° ç‚¹å', class: 'qp-mode-lucky' }
            };
            const config = modeConfig[qpMode] || modeConfig['vote'];
            badge.innerText = config.text;
            badge.className = 'qp-mode-badge ' + config.class;
            stats.style.display = qpMode === 'vote' ? 'block' : 'none';
            
            document.querySelectorAll('.sb-qp-mode-select').forEach(btn => {
                const isActive = btn.dataset.mode === qpMode;
                btn.style.background = isActive ? (qpMode === 'vote' ? '#3b82f6' : qpMode === 'buzzer' ? '#ef4444' : '#f59e0b') : 'transparent';
                btn.style.borderColor = isActive ? btn.style.background : 'rgba(255,255,255,0.2)';
                btn.style.color = isActive ? 'white' : '#94a3b8';
            });
        }
        
        // ä¾§è¾¹æ æ’è¡Œæ¦œåŠ è½½ï¼ˆå«å½“æ—¥ç§¯åˆ†å’Œæ€»ç§¯åˆ†ï¼‰
        let lastLeaderboardData = [];
        
        async function loadSidebarLeaderboard() {
            const list = document.getElementById('sidebar-rank-list');
            if (lastLeaderboardData.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">åŠ è½½ä¸­...</div>';
            }
            
            try {
                // ä» points_log è·å–ä»Šæ—¥ï¼ˆæœ¬èŠ‚è¯¾ï¼‰ç§¯åˆ†
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const { data: todayLogs, error: logsError } = await supabaseClient
                    .from('points_log')
                    .select('student_id, student_name, points')
                    .gte('created_at', today.toISOString());
                
                if (logsError) throw logsError;
                
                // æ±‡æ€»ä»Šæ—¥ç§¯åˆ†
                const todayPoints = {};
                const studentNames = {};
                if (todayLogs) {
                    todayLogs.forEach(log => {
                        todayPoints[log.student_id] = (todayPoints[log.student_id] || 0) + log.points;
                        studentNames[log.student_id] = log.student_name;
                    });
                }
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰ä»Šæ—¥ç§¯åˆ†æ’åº
                const todayRanking = Object.keys(todayPoints).map(studentId => ({
                    student_id: studentId,
                    student_name: studentNames[studentId],
                    today_points: todayPoints[studentId]
                })).sort((a, b) => b.today_points - a.today_points).slice(0, 15);
                
                if (todayRanking.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">æœ¬èŠ‚è¯¾æš‚æ— ç§¯åˆ†è®°å½•</div>';
                    return;
                }
                
                // è·å–æ€»ç§¯åˆ†ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const { data: totalData } = await supabaseClient
                    .from('student_points')
                    .select('student_id, total_points');
                
                const totalPointsMap = {};
                if (totalData) {
                    totalData.forEach(s => {
                        totalPointsMap[s.student_id] = s.total_points;
                    });
                }
                
                // æ£€æµ‹ç§¯åˆ†å˜åŒ–ï¼Œæ·»åŠ é«˜äº®åŠ¨ç”»
                const changedIds = [];
                todayRanking.forEach(student => {
                    const old = lastLeaderboardData.find(s => s.student_id === student.student_id);
                    if (old && old.today_points !== student.today_points) {
                        changedIds.push(student.student_id);
                    }
                });
                lastLeaderboardData = todayRanking;
                
                list.innerHTML = todayRanking.map((student, index) => {
                    const rank = index + 1;
                    const topClass = rank <= 3 ? `top-${rank}` : '';
                    const highlightClass = changedIds.includes(student.student_id) ? 'highlight' : '';
                    const totalPts = totalPointsMap[student.student_id] || student.today_points;
                    let medal = '';
                    if (rank === 1) medal = 'ğŸ¥‡';
                    else if (rank === 2) medal = 'ğŸ¥ˆ';
                    else if (rank === 3) medal = 'ğŸ¥‰';
                    
                    return `
                        <div class="rank-item ${topClass} ${highlightClass}">
                            <div class="rank-pos">${medal || rank}</div>
                            <div class="rank-info">
                                <div class="rank-name">${student.student_name}</div>
                                <div class="rank-today" style="color:#94a3b8;">æ€»ç§¯åˆ†: ${totalPts}</div>
                            </div>
                            <div class="rank-points-wrap">
                                <div class="rank-total" style="color:#10b981;">+${student.today_points}</div>
                                <div class="rank-today-pts">æœ¬èŠ‚è¯¾</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', e);
                list.innerHTML = '<div style="text-align:center; color:#ef4444; padding:20px;">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function refreshSidebarLeaderboard() {
            loadSidebarLeaderboard();
        }
        
        // åŒæ­¥æ›´æ–°ä¾§è¾¹æ å’Œå¼¹çª—çš„é¢˜ç›®æ˜¾ç¤º
        function syncQuestionDisplay() {
            if (isSidebarOpen) {
                loadSidebarQuestion();
            }
            if (isQuestionPanelVisible) {
                loadQPQuestion();
            }
        }
        
        // ================== é¢˜åº“ç®¡ç†åŠŸèƒ½ ==================
        let slideQuestionBindings = {}; // è¯¾ä»¶é¡µé¢ä¸é¢˜ç›®çš„ç»‘å®šå…³ç³»
        
        function openQuestionBankManager() {
            // æ‰“å¼€ç‹¬ç«‹çš„é¢˜åº“ç®¡ç†é¡µé¢
            window.open('/classroom/questionbank.html', '_blank', 'width=1400,height=900');
        }
        
        // ================== æ‰“å¼€ä¸­æ§å° ==================
        function openAdminPanel() {
            // æ‰“å¼€æ™ºæ…§è¯¾å ‚ä¸­æ§å°
            window.open('/classroom/admin.html', '_blank', 'width=1400,height=900');
        }
        
        function openQuestionBankManagerOld() {
            const panel = document.createElement('div');
            panel.id = 'qb-manager-panel';
            panel.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:2000;';
            panel.innerHTML = `
                <div style="background:#1e293b; border-radius:20px; padding:25px; width:95%; max-width:1000px; max-height:90vh; color:white; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="margin:0;">ğŸ“ é¢˜åº“ç®¡ç†</h2>
                        <button onclick="closeQBManager()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">âœ•</button>
                    </div>
                    
                    <!-- æ ‡ç­¾é¡µ -->
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button onclick="switchQBTab('list')" class="qb-tab active" data-tab="list" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“‹ é¢˜ç›®åˆ—è¡¨</button>
                        <button onclick="switchQBTab('import')" class="qb-tab" data-tab="import" style="padding:10px 20px; background:rgba(255,255,255,0.1); color:#94a3b8; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“¥ å¯¼å…¥é¢˜ç›®</button>
                        <button onclick="switchQBTab('bind')" class="qb-tab" data-tab="bind" style="padding:10px 20px; background:rgba(255,255,255,0.1); color:#94a3b8; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ”— è¯¾ä»¶ç»‘å®š</button>
                    </div>
                    
                    <!-- é¢˜ç›®åˆ—è¡¨é¢æ¿ -->
                    <div id="qb-panel-list" class="qb-panel" style="flex:1; overflow-y:auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div id="qb-stats" style="font-size:0.9rem; color:#94a3b8;">åŠ è½½ä¸­...</div>
                            <button onclick="addNewQuestion()" style="padding:8px 15px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">â• æ·»åŠ é¢˜ç›®</button>
                        </div>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:rgba(255,255,255,0.1);">
                                    <th style="padding:10px; text-align:left; font-size:0.8rem; width:50px;">åºå·</th>
                                    <th style="padding:10px; text-align:left; font-size:0.8rem;">é¢˜ç›®</th>
                                    <th style="padding:10px; text-align:center; font-size:0.8rem; width:60px;">ç­”æ¡ˆ</th>
                                    <th style="padding:10px; text-align:center; font-size:0.8rem; width:80px;">çŸ¥è¯†ç‚¹</th>
                                    <th style="padding:10px; text-align:center; font-size:0.8rem; width:100px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="qb-question-list">
                                <tr><td colspan="5" style="padding:30px; text-align:center; color:#666;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- å¯¼å…¥é¢æ¿ -->
                    <div id="qb-panel-import" class="qb-panel" style="flex:1; overflow-y:auto; display:none;">
                        <div style="background:rgba(59,130,246,0.1); border:2px dashed #3b82f6; border-radius:15px; padding:30px; text-align:center; margin-bottom:20px;">
                            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“„</div>
                            <div style="font-size:1.1rem; margin-bottom:10px;">æ‹–æ‹½CSVæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                            <input type="file" id="qb-file-input" accept=".csv" onchange="handleQBFileSelect(event)" style="display:none;">
                            <button onclick="document.getElementById('qb-file-input').click()" style="padding:12px 25px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">é€‰æ‹©CSVæ–‡ä»¶</button>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); border-radius:10px; padding:15px; margin-bottom:15px;">
                            <div style="font-weight:bold; margin-bottom:10px;">ğŸ“‹ CSVæ ¼å¼è¯´æ˜</div>
                            <div style="font-size:0.85rem; color:#94a3b8; line-height:1.6;">
                                ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œï¼Œåç»­æ¯è¡Œä¸€é“é¢˜ç›®ï¼š<br>
                                <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">è½®æ¬¡,é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹(å¯é€‰),éš¾åº¦(å¯é€‰)</code><br><br>
                                ç¤ºä¾‹ï¼š<br>
                                <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">1,"1+1ç­‰äºå¤šå°‘ï¼Ÿ","1","2","3","4",B,æ•°å­¦åŸºç¡€,1</code>
                            </div>
                        </div>
                        <div id="qb-import-preview" style="display:none;">
                            <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ é¢„è§ˆ (<span id="qb-preview-count">0</span> é“é¢˜ç›®)</div>
                            <div id="qb-preview-list" style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px;"></div>
                            <div style="display:flex; gap:10px; margin-top:15px;">
                                <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                    <input type="checkbox" id="qb-clear-existing"> æ¸…ç©ºç°æœ‰é¢˜ç›®åå¯¼å…¥
                                </label>
                            </div>
                            <button onclick="confirmQBImport()" style="margin-top:15px; padding:12px 30px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; width:100%;">âœ… ç¡®è®¤å¯¼å…¥</button>
                        </div>
                    </div>
                    
                    <!-- è¯¾ä»¶ç»‘å®šé¢æ¿ -->
                    <div id="qb-panel-bind" class="qb-panel" style="flex:1; overflow-y:auto; display:none;">
                        <div style="background:rgba(245,158,11,0.1); border-radius:10px; padding:15px; margin-bottom:20px;">
                            <div style="font-weight:bold; margin-bottom:5px;">ğŸ’¡ è¯¾ä»¶ç»‘å®šè¯´æ˜</div>
                            <div style="font-size:0.85rem; color:#94a3b8;">å°†é¢˜ç›®ç»‘å®šåˆ°è¯¾ä»¶ç‰¹å®šé¡µé¢ï¼Œç¿»åˆ°è¯¥é¡µæ—¶å¯å¿«é€Ÿè°ƒå‡ºå¯¹åº”é¢˜ç›®</div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                            <div>
                                <div style="font-weight:bold; margin-bottom:10px;">ğŸ“‘ å½“å‰è¯¾ä»¶é¡µé¢</div>
                                <div style="background:rgba(255,255,255,0.05); border-radius:10px; padding:15px;">
                                    <div style="font-size:2rem; font-weight:bold; color:#3b82f6; margin-bottom:5px;">ç¬¬ <span id="qb-current-slide">${currentSlide + 1}</span> é¡µ</div>
                                    <div style="font-size:0.85rem; color:#94a3b8;">å…± ${slides.length || 0} é¡µ</div>
                                </div>
                                <div style="margin-top:15px;">
                                    <div style="font-weight:bold; margin-bottom:10px;">å·²ç»‘å®šé¢˜ç›®ï¼š</div>
                                    <div id="qb-bound-questions" style="min-height:100px; background:rgba(255,255,255,0.05); border-radius:8px; padding:10px;">æš‚æ— ç»‘å®š</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ é€‰æ‹©è¦ç»‘å®šçš„é¢˜ç›®</div>
                                <select id="qb-bind-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#1e293b; color:white; margin-bottom:10px;">
                                    <option value="">-- é€‰æ‹©é¢˜ç›® --</option>
                                </select>
                                <button onclick="bindQuestionToSlide()" style="width:100%; padding:12px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ”— ç»‘å®šåˆ°å½“å‰é¡µ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(panel);
            
            // è®¾ç½®æ‹–æ‹½äº‹ä»¶
            const dropArea = panel.querySelector('#qb-panel-import > div:first-child');
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = '#10b981'; });
            dropArea.addEventListener('dragleave', () => { dropArea.style.borderColor = '#3b82f6'; });
            dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.style.borderColor = '#3b82f6'; handleQBFileDrop(e); });
            
            loadQBQuestionList();
        }
        
        function closeQBManager() {
            const panel = document.getElementById('qb-manager-panel');
            if (panel) panel.remove();
        }
        
        function switchQBTab(tab) {
            document.querySelectorAll('.qb-tab').forEach(btn => {
                const isActive = btn.dataset.tab === tab;
                btn.style.background = isActive ? '#3b82f6' : 'rgba(255,255,255,0.1)';
                btn.style.color = isActive ? 'white' : '#94a3b8';
                btn.classList.toggle('active', isActive);
            });
            document.querySelectorAll('.qb-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`qb-panel-${tab}`).style.display = 'block';
            
            if (tab === 'bind') {
                loadQBBindPanel();
            }
        }
        
        async function loadQBQuestionList() {
            const tbody = document.getElementById('qb-question-list');
            const statsDiv = document.getElementById('qb-stats');
            
            try {
                const questions = await QuestionBank.getAllQuestions(supabaseClient);
                const stats = await QuestionBank.getStats(supabaseClient);
                
                statsDiv.innerHTML = `å…± <strong>${stats.totalCount}</strong> é“é¢˜ç›® | <strong>${stats.tagCount}</strong> ä¸ªçŸ¥è¯†ç‚¹`;
                
                if (questions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:30px; text-align:center; color:#666;">æš‚æ— é¢˜ç›®ï¼Œè¯·å¯¼å…¥æˆ–æ·»åŠ </td></tr>';
                    return;
                }
                
                tbody.innerHTML = questions.map(q => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                        <td style="padding:10px; font-size:0.85rem;">${q.round}</td>
                        <td style="padding:10px; font-size:0.85rem;">${q.title.length > 50 ? q.title.substring(0, 50) + '...' : q.title}</td>
                        <td style="padding:10px; text-align:center; font-size:0.85rem; color:#10b981; font-weight:bold;">${q.answer}</td>
                        <td style="padding:10px; text-align:center; font-size:0.75rem; color:#94a3b8;">${q.knowledge_tag || '-'}</td>
                        <td style="padding:10px; text-align:center;">
                            <button onclick="editQuestion(${q.round})" style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.7rem; margin-right:3px;">ç¼–è¾‘</button>
                            <button onclick="deleteQuestionItem(${q.round})" style="padding:4px 8px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.7rem;">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½é¢˜ç›®åˆ—è¡¨å¤±è´¥:', e);
                tbody.innerHTML = '<tr><td colspan="5" style="padding:30px; text-align:center; color:#ef4444;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        let qbPendingQuestions = [];
        
        function handleQBFileSelect(event) {
            const file = event.target.files[0];
            if (file) processQBFile(file);
        }
        
        function handleQBFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) processQBFile(file);
        }
        
        function processQBFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('è¯·é€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                qbPendingQuestions = QuestionBank.parseCSV(text);
                
                if (qbPendingQuestions.length === 0) {
                    alert('æœªèƒ½è§£æå‡ºæœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼');
                    return;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('qb-import-preview').style.display = 'block';
                document.getElementById('qb-preview-count').textContent = qbPendingQuestions.length;
                document.getElementById('qb-preview-list').innerHTML = qbPendingQuestions.slice(0, 5).map(q => `
                    <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.85rem;">
                        <strong>${q.round}.</strong> ${q.title.substring(0, 60)}${q.title.length > 60 ? '...' : ''} <span style="color:#10b981;">[${q.answer}]</span>
                    </div>
                `).join('') + (qbPendingQuestions.length > 5 ? `<div style="padding:8px; color:#94a3b8; font-size:0.8rem;">... è¿˜æœ‰ ${qbPendingQuestions.length - 5} é“é¢˜ç›®</div>` : '');
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        async function confirmQBImport() {
            if (qbPendingQuestions.length === 0) {
                alert('æ²¡æœ‰å¾…å¯¼å…¥çš„é¢˜ç›®');
                return;
            }
            
            const clearExisting = document.getElementById('qb-clear-existing').checked;
            const result = await QuestionBank.importQuestions(supabaseClient, qbPendingQuestions, { clearExisting });
            
            if (result.success) {
                alert(`âœ… æˆåŠŸå¯¼å…¥ ${result.count} é“é¢˜ç›®`);
                qbPendingQuestions = [];
                document.getElementById('qb-import-preview').style.display = 'none';
                switchQBTab('list');
                loadQBQuestionList();
                // åˆ·æ–°é¢˜åº“é¢æ¿
                loadQPQuestion();
            } else {
                alert('âŒ å¯¼å…¥å¤±è´¥: ' + (result.error?.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }
        
        async function loadQBBindPanel() {
            // æ›´æ–°å½“å‰é¡µç 
            document.getElementById('qb-current-slide').textContent = currentSlide + 1;
            
            // åŠ è½½é¢˜ç›®é€‰æ‹©åˆ—è¡¨
            const questions = await QuestionBank.getAllQuestions(supabaseClient);
            const select = document.getElementById('qb-bind-select');
            select.innerHTML = '<option value="">-- é€‰æ‹©é¢˜ç›® --</option>' + 
                questions.map(q => `<option value="${q.round}">${q.round}. ${q.title.substring(0, 40)}${q.title.length > 40 ? '...' : ''}</option>`).join('');
            
            // åŠ è½½å½“å‰é¡µå·²ç»‘å®šçš„é¢˜ç›®
            loadBoundQuestions();
        }
        
        async function loadBoundQuestions() {
            const container = document.getElementById('qb-bound-questions');
            const bindings = await QuestionBank.getSlideQuestions(supabaseClient, currentSlide);
            
            if (bindings.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">æš‚æ— ç»‘å®šé¢˜ç›®</div>';
                return;
            }
            
            container.innerHTML = bindings.map(b => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px; margin-bottom:5px;">
                    <span style="font-size:0.85rem;">${b.question_round}. ${b.questions?.title?.substring(0, 30) || 'æœªçŸ¥é¢˜ç›®'}...</span>
                    <button onclick="unbindQuestion(${currentSlide}, ${b.question_round})" style="padding:3px 8px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.7rem;">è§£ç»‘</button>
                </div>
            `).join('');
        }
        
        async function bindQuestionToSlide() {
            const select = document.getElementById('qb-bind-select');
            const questionRound = parseInt(select.value);
            if (!questionRound) {
                alert('è¯·é€‰æ‹©è¦ç»‘å®šçš„é¢˜ç›®');
                return;
            }
            
            const success = await QuestionBank.bindToSlide(supabaseClient, currentSlide, questionRound);
            if (success) {
                alert('âœ… ç»‘å®šæˆåŠŸ');
                loadBoundQuestions();
                loadSlideBindings();
            } else {
                alert('âŒ ç»‘å®šå¤±è´¥');
            }
        }
        
        async function unbindQuestion(slideIndex, questionRound) {
            const success = await QuestionBank.unbindFromSlide(supabaseClient, slideIndex, questionRound);
            if (success) {
                loadBoundQuestions();
                loadSlideBindings();
            }
        }
        
        async function loadSlideBindings() {
            const bindings = await QuestionBank.getAllSlideBindings(supabaseClient);
            slideQuestionBindings = {};
            bindings.forEach(b => {
                if (!slideQuestionBindings[b.slide_index]) {
                    slideQuestionBindings[b.slide_index] = [];
                }
                slideQuestionBindings[b.slide_index].push(b.question_round);
            });
        }
        
        // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦æœ‰ç»‘å®šé¢˜ç›®
        function checkSlideQuestion() {
            const boundQuestions = slideQuestionBindings[currentSlide];
            if (boundQuestions && boundQuestions.length > 0) {
                // è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªç»‘å®šçš„é¢˜ç›®
                qpRound = boundQuestions[0];
                loadQPQuestion();
                // æ˜¾ç¤ºæç¤º
                showSlideQuestionHint(boundQuestions.length);
            }
        }
        
        function showSlideQuestionHint(count) {
            // åˆ›å»ºæç¤ºæ°”æ³¡
            let hint = document.getElementById('slide-question-hint');
            if (!hint) {
                hint = document.createElement('div');
                hint.id = 'slide-question-hint';
                hint.style.cssText = 'position:fixed; bottom:100px; right:20px; background:linear-gradient(135deg, #10b981, #059669); color:white; padding:12px 20px; border-radius:10px; font-weight:bold; z-index:150; cursor:pointer; box-shadow:0 5px 20px rgba(0,0,0,0.3); animation:slideIn 0.3s ease;';
                hint.onclick = () => { toggleSidebar(); hint.remove(); };
                document.body.appendChild(hint);
            }
            hint.innerHTML = `ğŸ“ æœ¬é¡µæœ‰ ${count} é“é¢˜ç›® <span style="font-size:0.8rem; opacity:0.8;">ç‚¹å‡»æŸ¥çœ‹</span>`;
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => { if (hint) hint.remove(); }, 3000);
        }
        
        function addNewQuestion() {
            const round = prompt('è¯·è¾“å…¥é¢˜ç›®åºå·ï¼ˆæ•°å­—ï¼‰:');
            if (!round || isNaN(round)) return;
            editQuestion(parseInt(round), true);
        }
        
        async function editQuestion(round, isNew = false) {
            let question = isNew ? { round, title: '', option_a: '', option_b: '', option_c: '', option_d: '', answer: '', knowledge_tag: '' } : await QuestionBank.getQuestion(supabaseClient, round);
            if (!question && !isNew) {
                alert('é¢˜ç›®ä¸å­˜åœ¨');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'qb-edit-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:2100;';
            modal.innerHTML = `
                <div style="background:#1e293b; border-radius:15px; padding:25px; width:90%; max-width:600px; color:white;">
                    <h3 style="margin:0 0 20px 0;">${isNew ? 'â• æ·»åŠ é¢˜ç›®' : 'âœï¸ ç¼–è¾‘é¢˜ç›®'} #${round}</h3>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <div>
                            <label style="font-size:0.85rem; color:#94a3b8;">é¢˜ç›®å†…å®¹</label>
                            <textarea id="qe-title" style="width:100%; padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:80px; resize:vertical;">${question.title || ''}</textarea>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div><label style="font-size:0.85rem; color:#94a3b8;">é€‰é¡¹A</label><input id="qe-a" value="${question.option_a || ''}" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                            <div><label style="font-size:0.85rem; color:#94a3b8;">é€‰é¡¹B</label><input id="qe-b" value="${question.option_b || ''}" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                            <div><label style="font-size:0.85rem; color:#94a3b8;">é€‰é¡¹C</label><input id="qe-c" value="${question.option_c || ''}" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                            <div><label style="font-size:0.85rem; color:#94a3b8;">é€‰é¡¹D</label><input id="qe-d" value="${question.option_d || ''}" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div><label style="font-size:0.85rem; color:#94a3b8;">æ­£ç¡®ç­”æ¡ˆ</label><input id="qe-answer" value="${question.answer || ''}" placeholder="A/B/C/D" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                            <div><label style="font-size:0.85rem; color:#94a3b8;">çŸ¥è¯†ç‚¹æ ‡ç­¾</label><input id="qe-tag" value="${question.knowledge_tag || ''}" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="saveQuestionEdit(${round})" style="flex:1; padding:12px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="document.getElementById('qb-edit-modal').remove()" style="flex:1; padding:12px; background:rgba(255,255,255,0.1); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveQuestionEdit(round) {
            const question = {
                round: round,
                title: document.getElementById('qe-title').value,
                option_a: document.getElementById('qe-a').value,
                option_b: document.getElementById('qe-b').value,
                option_c: document.getElementById('qe-c').value,
                option_d: document.getElementById('qe-d').value,
                answer: document.getElementById('qe-answer').value.toUpperCase(),
                knowledge_tag: document.getElementById('qe-tag').value || null
            };
            
            if (!question.title || !question.answer) {
                alert('é¢˜ç›®å†…å®¹å’Œç­”æ¡ˆä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const result = await QuestionBank.saveQuestion(supabaseClient, question);
            if (result) {
                alert('âœ… ä¿å­˜æˆåŠŸ');
                document.getElementById('qb-edit-modal').remove();
                loadQBQuestionList();
                loadQPQuestion();
            } else {
                alert('âŒ ä¿å­˜å¤±è´¥');
            }
        }
        
        async function deleteQuestionItem(round) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${round} é¢˜å—ï¼Ÿ`)) return;
            const success = await QuestionBank.deleteQuestion(supabaseClient, round);
            if (success) {
                alert('âœ… åˆ é™¤æˆåŠŸ');
                loadQBQuestionList();
            } else {
                alert('âŒ åˆ é™¤å¤±è´¥');
            }
        }
        
        // ================== é¡µé¢åˆå§‹åŒ– ==================
        (function init() {
            // ğŸ”¥ å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶å°±è®¢é˜…å¼¹å¹•é¢‘é“ï¼Œç¡®ä¿å¼¹å¹•èƒ½å®æ—¶æ˜¾ç¤º
            supabaseClient.channel('presentation-danmu-init')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                    if (isDanmuEnabled) {
                        createDanmu(payload.new.content);
                    }
                })
                .subscribe();
            danmuSubscribed = true;
            
            // è®¢é˜…ç§¯åˆ†å˜åŒ–ï¼Œå®æ—¶æ›´æ–°ä¾§è¾¹æ æ’è¡Œæ¦œ
            supabaseClient.channel('presentation-points')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'student_points' }, () => {
                    if (isSidebarOpen) {
                        loadSidebarLeaderboard();
                    }
                })
                .subscribe();
            
            // åŠ è½½è¯¾ä»¶-é¢˜ç›®ç»‘å®šå…³ç³»
            loadSlideBindings();
            
            console.log('ğŸ¬ è¯¾ä»¶æ’­æ”¾å™¨å·²åˆå§‹åŒ–');
            console.log('ğŸ“¡ å¼¹å¹•é¢‘é“å·²è®¢é˜…');
            console.log('ğŸ“¡ ç§¯åˆ†é¢‘é“å·²è®¢é˜…');
            console.log('ğŸ“š é¢˜åº“ç»‘å®šå·²åŠ è½½');
        })();
    </script>
</body>
</html>
