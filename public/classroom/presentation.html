<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ æ™ºæ…§è¯¾ä»¶æ’­æ”¾å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #1a1a2e; 
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¸»å®¹å™¨ */
        .presentation-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* PPT èƒŒæ™¯å±‚ */
        #slide-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #000;
            z-index: 1;
        }
        
        /* äº’åŠ¨å·¥å…·æ‚¬æµ®å±‚ */
        #overlay-tools {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        #overlay-tools > * {
            pointer-events: auto;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .presentation-container:hover .top-bar {
            opacity: 1;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .presentation-container:hover .bottom-bar {
            opacity: 1;
        }
        
        /* é¡µç æ˜¾ç¤º */
        .page-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .ctrl-btn {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ctrl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn-nav { background: rgba(255,255,255,0.2); color: white; }
        .btn-nav:hover { background: rgba(255,255,255,0.3); }
        .btn-vote { background: #3b82f6; color: white; }
        .btn-danmu { background: #8b5cf6; color: white; }
        .btn-buzzer { background: #ef4444; color: white; }
        .btn-upload { background: #10b981; color: white; }
        
        /* å¼¹å¹•å±‚ */
        #danmu-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 50;
        }
        
        .danmu-item {
            position: absolute;
            white-space: nowrap;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: danmuMove linear forwards;
        }
        
        @keyframes danmuMove {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }
        
        /* æŠ•ç¥¨æ‚¬æµ®çª— */
        #vote-overlay {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            z-index: 200;
            color: #333;
        }
        
        .vote-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2563eb;
        }
        
        .vote-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .vote-stat-item {
            text-align: center;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        
        .vote-stat-label { font-size: 1.2rem; font-weight: bold; }
        .vote-stat-count { font-size: 0.9rem; color: #666; }
        
        /* ä¸Šä¼ æ¨¡æ€æ¡† */
        #upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .upload-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            color: #333;
            text-align: center;
        }
        
        .drop-zone {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 60px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .slide-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .slide-thumb {
            width: 100px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .slide-thumb.active {
            border-color: #3b82f6;
        }
        
        /* è§¦å‘ç‚¹è®¾ç½® */
        .trigger-settings {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .trigger-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        /* å¿«æ·é”®æç¤º */
        .hotkey-hint {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        .presentation-container:hover .hotkey-hint {
            opacity: 1;
        }
        
        kbd {
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 4px;
            margin: 0 3px;
        }
    </style>
</head>
<body>
    <div class="presentation-container">
        <!-- PPT èƒŒæ™¯ -->
        <div id="slide-background">
            <!-- åˆå§‹å ä½å†…å®¹å·²éšè— -->
        </div>
        
        <!-- å¼¹å¹•å±‚ -->
        <div id="danmu-layer"></div>
        
        <!-- äº’åŠ¨å·¥å…·å±‚ -->
        <div id="overlay-tools"></div>
        
        <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
        <div class="top-bar">
            <div class="page-indicator">
                <span id="current-page">0</span> / <span id="total-pages">0</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="ctrl-btn btn-upload" onclick="openUploadModal()">ğŸ“¤ ä¸Šä¼ è¯¾ä»¶</button>
                <button class="ctrl-btn" style="background:#f59e0b; color:white;" onclick="toggleFullscreen()">â›¶ å…¨å±</button>
            </div>
        </div>
        
        <!-- åº•éƒ¨æ§åˆ¶æ  -->
        <div class="bottom-bar">
            <button class="ctrl-btn btn-nav" onclick="prevSlide()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <button class="ctrl-btn btn-vote" onclick="toggleVoteOverlay()">ğŸ“Š ç­”é¢˜</button>
            <button class="ctrl-btn btn-danmu" onclick="toggleDanmu()">ğŸ’¬ å¼¹å¹•</button>
            <button class="ctrl-btn btn-buzzer" onclick="startBuzzer()">âš¡ æŠ¢ç­”</button>
            <button class="ctrl-btn" style="background:#f59e0b;" onclick="toggleLuckyOverlay()">ğŸ° ç‚¹å</button>
            <button class="ctrl-btn" style="background:#64748b;" onclick="releaseControl()">â¸ï¸ é‡Šæ”¾</button>
            <button class="ctrl-btn" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="endClass()">ğŸ”” ä¸‹è¯¾</button>
            <button class="ctrl-btn btn-nav" onclick="nextSlide()">ä¸‹ä¸€é¡µ â¡ï¸</button>
        </div>
        
        <!-- å¿«æ·é”®æç¤º -->
        <div class="hotkey-hint">
            <div><kbd>â†</kbd><kbd>â†’</kbd> ç¿»é¡µ</div>
            <div><kbd>V</kbd> ç­”é¢˜ <kbd>D</kbd> å¼¹å¹• <kbd>B</kbd> æŠ¢ç­” <kbd>L</kbd> ç‚¹å</div>
            <div><kbd>R</kbd> é‡Šæ”¾æ§åˆ¶ <kbd>F</kbd> å…¨å± <kbd>ESC</kbd> é€€å‡º</div>
        </div>
    </div>
    
    <!-- æŠ•ç¥¨æ‚¬æµ®çª— -->
    <div id="vote-overlay">
        <div class="vote-title">ğŸ“Š ç¬¬ <span id="vote-round">1</span> é¢˜ å®æ—¶ç»Ÿè®¡</div>
        <div id="vote-question" style="margin-bottom:10px; font-size:0.95rem;"></div>
        <div class="vote-stats">
            <div class="vote-stat-item">
                <div class="vote-stat-label" style="color:#FF6384;">A</div>
                <div class="vote-stat-count" id="stat-a">0</div>
            </div>
            <div class="vote-stat-item">
                <div class="vote-stat-label" style="color:#36A2EB;">B</div>
                <div class="vote-stat-count" id="stat-b">0</div>
            </div>
            <div class="vote-stat-item">
                <div class="vote-stat-label" style="color:#FFCE56;">C</div>
                <div class="vote-stat-count" id="stat-c">0</div>
            </div>
            <div class="vote-stat-item">
                <div class="vote-stat-label" style="color:#4BC0C0;">D</div>
                <div class="vote-stat-count" id="stat-d">0</div>
            </div>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="toggleVoteActive()" style="flex:1; padding:10px; background:#f59e0b; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                â¯ï¸ æš‚åœ/å…¬å¸ƒ
            </button>
            <button onclick="nextVoteRound()" style="flex:1; padding:10px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                â¡ï¸ ä¸‹ä¸€é¢˜
            </button>
        </div>
    </div>
    
    <!-- éšæœºç‚¹åæ‚¬æµ®çª— -->
    <div id="lucky-overlay" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:500px; background:linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); border-radius:20px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,0.5); display:none; z-index:200; text-align:center;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <select id="lucky-class-select" onchange="switchLuckyClass()" style="padding:8px 15px; font-size:1rem; border-radius:20px; border:none; background:rgba(255,255,255,0.2); color:white; cursor:pointer;">
            </select>
            <div style="display:flex; gap:10px;">
                <button onclick="toggleLuckyMute()" id="lucky-mute-btn" style="background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">ğŸ”Š</button>
                <button onclick="openLuckySettings()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">âš™ï¸</button>
                <button onclick="closeLuckyOverlay()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">âœ•</button>
            </div>
        </div>
        <div id="lucky-display" style="font-size:5rem; font-weight:bold; color:white; text-shadow:0 5px 15px rgba(0,0,0,0.5); min-height:100px; display:flex; align-items:center; justify-content:center; margin:20px 0;">
            å‡†å¤‡ç‚¹å
        </div>
        <button id="lucky-action-btn" onclick="toggleLuckyRoll()" style="padding:15px 50px; font-size:1.5rem; border:none; border-radius:50px; cursor:pointer; background:white; color:#333; box-shadow:0 10px 20px rgba(0,0,0,0.3); font-weight:bold;">
            å¼€å§‹
        </button>
    </div>
    
    <!-- ç‚¹åè®¾ç½®é¢æ¿ -->
    <div id="lucky-settings-panel" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:15px; color:#333; display:none; box-shadow:0 20px 50px rgba(0,0,0,0.5); z-index:300; width:350px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">ğŸ« ç­çº§åå•ç®¡ç†</h3>
            <button onclick="closeLuckySettings()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">Ã—</button>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="lucky-new-class-name" placeholder="æ–°ç­çº§åç§°" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:5px;">
            <button onclick="addLuckyClass()" style="padding:8px 12px; font-size:14px; border:none; border-radius:5px; cursor:pointer; background:#2563eb; color:white;">æ–°å»º</button>
        </div>
        <hr style="border:none; border-top:1px solid #eee; margin:15px 0;">
        <p style="margin:10px 0; font-size:0.9rem;">æ­£åœ¨ç¼–è¾‘ï¼š<strong id="lucky-editing-class">--</strong></p>
        <textarea id="lucky-name-input" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´åå•ï¼Œä¸€è¡Œä¸€ä¸ªåå­—" style="width:100%; height:200px; padding:10px; border:1px solid #ccc; border-radius:5px; font-size:14px; box-sizing:border-box;"></textarea>
        <button onclick="saveLuckyList()" style="margin-top:10px; padding:8px 12px; font-size:14px; border:none; border-radius:5px; cursor:pointer; background:#10b981; color:white; width:100%;">ğŸ’¾ ä¿å­˜åå•</button>
        <button onclick="deleteLuckyClass()" style="margin-top:10px; padding:8px 12px; font-size:14px; border:none; border-radius:5px; cursor:pointer; background:#ef4444; color:white; width:100%;">ğŸ—‘ï¸ åˆ é™¤æ­¤ç­çº§</button>
    </div>
    
    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="upload-modal">
        <div class="upload-content">
            <h2 style="margin-bottom:10px;">ğŸ“¤ ä¸Šä¼ è¯¾ä»¶å›¾ç‰‡</h2>
            <p style="color:#666; margin-bottom:20px;">å°† PPT å¯¼å‡ºä¸ºå›¾ç‰‡åä¸Šä¼ ï¼Œæ”¯æŒ JPG/PNG æ ¼å¼</p>
            
            <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                <div style="font-size:3rem; margin-bottom:10px;">ğŸ“</div>
                <div>æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                <div style="color:#999; font-size:0.9rem; margin-top:10px;">æ”¯æŒå¤šé€‰ï¼ŒæŒ‰æ–‡ä»¶åæ’åº</div>
                <input type="file" id="file-input" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
            </div>
            
            <div class="slide-preview" id="slide-preview"></div>
            
            <div class="trigger-settings" id="trigger-settings" style="display:none;">
                <h4 style="margin-bottom:10px;">âš¡ è‡ªåŠ¨è§¦å‘è®¾ç½®</h4>
                <div id="trigger-list"></div>
                <button onclick="addTrigger()" style="margin-top:10px; padding:8px 15px; background:#10b981; color:white; border:none; border-radius:5px; cursor:pointer;">
                    + æ·»åŠ è§¦å‘ç‚¹
                </button>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button onclick="closeUploadModal()" style="padding:12px 30px; background:#ccc; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                    å–æ¶ˆ
                </button>
                <button onclick="applySlides()" style="padding:12px 30px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                    åº”ç”¨è¯¾ä»¶
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // çŠ¶æ€
        let slides = [];
        let currentSlide = 0;
        let triggers = []; // è‡ªåŠ¨è§¦å‘ç‚¹
        let isDanmuEnabled = false;
        let isVoteVisible = false;
        
        // ================== å¹»ç¯ç‰‡ç®¡ç† ==================
        function handleFiles(files) {
            const fileArray = Array.from(files).sort((a, b) => a.name.localeCompare(b.name));
            slides = [];
            
            const preview = document.getElementById('slide-preview');
            preview.innerHTML = '';
            
            fileArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    slides[index] = e.target.result;
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'slide-thumb';
                    img.onclick = () => goToSlide(index);
                    preview.appendChild(img);
                    
                    if (slides.filter(s => s).length === fileArray.length) {
                        document.getElementById('trigger-settings').style.display = 'block';
                        updateTriggerList();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        function goToSlide(index) {
            if (index < 0 || index >= slides.length) return;
            currentSlide = index;
            
            document.getElementById('slide-background').style.backgroundImage = `url(${slides[index]})`;
            document.getElementById('current-page').innerText = index + 1;
            document.getElementById('total-pages').innerText = slides.length;
            
            // æ›´æ–°ç¼©ç•¥å›¾é«˜äº®
            document.querySelectorAll('.slide-thumb').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
            
            // æ£€æŸ¥è§¦å‘ç‚¹
            checkTriggers(index);
        }
        
        function prevSlide() {
            goToSlide(currentSlide - 1);
        }
        
        function nextSlide() {
            goToSlide(currentSlide + 1);
        }
        
        function applySlides() {
            if (slides.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }
            goToSlide(0);
            closeUploadModal();
        }
        
        // ================== è§¦å‘ç‚¹ç®¡ç† ==================
        function addTrigger() {
            triggers.push({
                page: 1,
                action: 'vote',
                round: 1
            });
            updateTriggerList();
        }
        
        function removeTrigger(index) {
            triggers.splice(index, 1);
            updateTriggerList();
        }
        
        function updateTriggerList() {
            const list = document.getElementById('trigger-list');
            list.innerHTML = triggers.map((t, i) => `
                <div class="trigger-item">
                    <span>ç¬¬</span>
                    <input type="number" value="${t.page}" min="1" max="${slides.length}" 
                           style="width:50px; padding:5px; border:1px solid #ddd; border-radius:4px;"
                           onchange="triggers[${i}].page = parseInt(this.value)">
                    <span>é¡µè§¦å‘</span>
                    <select style="padding:5px; border:1px solid #ddd; border-radius:4px;"
                            onchange="triggers[${i}].action = this.value">
                        <option value="vote" ${t.action === 'vote' ? 'selected' : ''}>ğŸ“Š ç­”é¢˜</option>
                        <option value="danmu" ${t.action === 'danmu' ? 'selected' : ''}>ğŸ’¬ å¼¹å¹•</option>
                        <option value="buzzer" ${t.action === 'buzzer' ? 'selected' : ''}>âš¡ æŠ¢ç­”</option>
                    </select>
                    <input type="number" value="${t.round || 1}" min="1" placeholder="é¢˜å·"
                           style="width:50px; padding:5px; border:1px solid #ddd; border-radius:4px; ${t.action !== 'vote' ? 'display:none' : ''}"
                           onchange="triggers[${i}].round = parseInt(this.value)">
                    <button onclick="removeTrigger(${i})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ•</button>
                </div>
            `).join('');
        }
        
        function checkTriggers(pageIndex) {
            const pageTriggers = triggers.filter(t => t.page === pageIndex + 1);
            pageTriggers.forEach(t => {
                switch(t.action) {
                    case 'vote':
                        showVoteOverlay(t.round);
                        break;
                    case 'danmu':
                        enableDanmu();
                        break;
                    case 'buzzer':
                        startBuzzer();
                        break;
                }
            });
        }
        
        // ================== ç­”é¢˜åŠŸèƒ½ ==================
        let voteRound = 1;
        let isVoteActive = true;
        
        async function toggleVoteOverlay() {
            isVoteVisible = !isVoteVisible;
            document.getElementById('vote-overlay').style.display = isVoteVisible ? 'block' : 'none';
            if (isVoteVisible) {
                loadVoteData();
                
                // ğŸ”¥ å…³é”®ï¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼Œè®©å­¦ç”Ÿç«¯è·³è½¬åˆ°ç­”é¢˜é¡µé¢
                await supabaseClient.from('global_state').update({ 
                    status: 'active', 
                    current_page: 'vote.html' 
                }).eq('id', 1);
                
                // åŒæ­¥ç­”é¢˜é…ç½®
                await supabaseClient.from('vote_config').update({ 
                    current_round: voteRound, 
                    is_active: true 
                }).eq('id', 1);
            }
        }
        
        async function showVoteOverlay(round) {
            voteRound = round || voteRound;
            document.getElementById('vote-round').innerText = voteRound;
            document.getElementById('vote-overlay').style.display = 'block';
            isVoteVisible = true;
            loadVoteData();
            
            // ğŸ”¥ å…³é”®ï¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼Œè®©å­¦ç”Ÿç«¯è·³è½¬åˆ°ç­”é¢˜é¡µé¢
            await supabaseClient.from('global_state').update({ 
                status: 'active', 
                current_page: 'vote.html' 
            }).eq('id', 1);
            
            // åŒæ­¥ç­”é¢˜é…ç½®
            await supabaseClient.from('vote_config').update({ 
                current_round: voteRound, 
                is_active: true 
            }).eq('id', 1);
        }
        
        async function loadVoteData() {
            try {
                const { data } = await supabaseClient
                    .from('vote_logs')
                    .select('option')
                    .eq('round', voteRound);
                
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                if (data) {
                    data.forEach(row => {
                        if (counts[row.option] !== undefined) counts[row.option]++;
                    });
                }
                
                document.getElementById('stat-a').innerText = counts.A;
                document.getElementById('stat-b').innerText = counts.B;
                document.getElementById('stat-c').innerText = counts.C;
                document.getElementById('stat-d').innerText = counts.D;
                
                // åŠ è½½é¢˜ç›®
                const { data: q } = await supabaseClient
                    .from('questions')
                    .select('title')
                    .eq('round', voteRound)
                    .maybeSingle();
                
                document.getElementById('vote-question').innerText = q ? q.title : '';
            } catch (e) {
                console.error('åŠ è½½ç­”é¢˜æ•°æ®å¤±è´¥:', e);
            }
        }
        
        async function toggleVoteActive() {
            isVoteActive = !isVoteActive;
            await supabaseClient.from('vote_config').update({ is_active: isVoteActive }).eq('id', 1);
        }
        
        async function nextVoteRound() {
            voteRound++;
            document.getElementById('vote-round').innerText = voteRound;
            await supabaseClient.from('vote_config').update({ 
                current_round: voteRound, 
                is_active: true 
            }).eq('id', 1);
            loadVoteData();
        }
        
        // å®æ—¶ç›‘å¬ç­”é¢˜
        supabaseClient.channel('presentation-vote')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vote_logs' }, () => {
                if (isVoteVisible) loadVoteData();
            })
            .subscribe();
        
        // ================== å¼¹å¹•åŠŸèƒ½ ==================
        let danmuSubscribed = false;
        
        function toggleDanmu() {
            isDanmuEnabled = !isDanmuEnabled;
            if (isDanmuEnabled) {
                enableDanmu();
            }
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateDanmuButton();
        }
        
        function updateDanmuButton() {
            const btn = document.querySelector('.btn-danmu');
            if (btn) {
                btn.style.opacity = isDanmuEnabled ? '1' : '0.6';
                btn.innerHTML = isDanmuEnabled ? 'ğŸ’¬ å¼¹å¹• âœ“' : 'ğŸ’¬ å¼¹å¹•';
            }
        }
        
        async function enableDanmu() {
            isDanmuEnabled = true;
            
            // ğŸ”¥ å…³é”®ï¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼Œè®©å­¦ç”Ÿç«¯è·³è½¬åˆ°å¼¹å¹•é¡µé¢
            await supabaseClient.from('global_state').update({ 
                status: 'active', 
                current_page: 'danmu.html' 
            }).eq('id', 1);
            
            // åªè®¢é˜…ä¸€æ¬¡
            if (!danmuSubscribed) {
                supabaseClient.channel('presentation-danmu')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        if (isDanmuEnabled) {
                            createDanmu(payload.new.content);
                        }
                    })
                    .subscribe();
                danmuSubscribed = true;
            }
            
            updateDanmuButton();
        }
        
        function createDanmu(text) {
            const layer = document.getElementById('danmu-layer');
            const div = document.createElement('div');
            div.className = 'danmu-item';
            div.innerText = text;
            
            const colors = ['#FFF', '#FFE4E1', '#7FFFD4', '#FFD700', '#00BFFF', '#FF69B4'];
            div.style.color = colors[Math.floor(Math.random() * colors.length)];
            div.style.top = Math.floor(Math.random() * 80) + 5 + '%';
            div.style.animationDuration = (Math.random() * 5 + 8) + 's';
            
            layer.appendChild(div);
            div.addEventListener('animationend', () => div.remove());
        }
        
        // ================== æŠ¢ç­”åŠŸèƒ½ ==================
        async function startBuzzer() {
            // ğŸ”¥ å…³é”®ï¼šæ›´æ–°å…¨å±€çŠ¶æ€ï¼Œè®©å­¦ç”Ÿç«¯è·³è½¬åˆ°æŠ¢ç­”é¡µé¢
            await supabaseClient.from('global_state').update({ 
                status: 'active', 
                current_page: 'buzzer.html' 
            }).eq('id', 1);
            
            // é‡ç½®å¹¶å¯åŠ¨æŠ¢ç­”
            await supabaseClient.from('buzzer').update({ 
                is_active: true, 
                winner: null 
            }).eq('id', 1);
            
            // æ‰“å¼€æŠ¢ç­”æ§åˆ¶å°
            window.open('/buzzer-admin', '_blank', 'width=800,height=600');
        }
        
        // ================== é‡Šæ”¾æ§åˆ¶ ==================
        async function releaseControl() {
            // é‡Šæ”¾å­¦ç”Ÿç«¯æ§åˆ¶ï¼Œè®©å­¦ç”Ÿå›åˆ°é¦–é¡µ
            await supabaseClient.from('global_state').update({ 
                status: 'idle', 
                current_page: 'idle' 
            }).eq('id', 1);
            
            isDanmuEnabled = false;
            isVoteVisible = false;
            document.getElementById('vote-overlay').style.display = 'none';
            updateDanmuButton();
        }
        
        // ================== ä¸‹è¯¾åŠŸèƒ½ ==================
        async function endClass() {
            if (!confirm('âš ï¸ ç¡®å®šè¦ä¸‹è¯¾å—ï¼Ÿ\n\nè¿™å°†ä¼šï¼š\nâ€¢ é‡Šæ”¾å­¦ç”Ÿç«¯æ§åˆ¶\nâ€¢ é‡ç½®ç­”é¢˜è½®æ¬¡\nâ€¢ å…³é—­æŠ¢ç­”åŠŸèƒ½\nâ€¢ æ¸…ç©ºä»Šæ—¥ç­”é¢˜è®°å½•')) {
                return;
            }
            
            const clearAttendance = confirm('æ˜¯å¦æ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"æ¸…ç©ºï¼Œç‚¹å‡»"å–æ¶ˆ"ä¿ç•™');
            
            try {
                // 1. é‡Šæ”¾å…¨å±€æ§åˆ¶
                await supabaseClient.from('global_state').update({
                    current_page: 'idle',
                    status: 'idle'
                }).eq('id', 1);
                
                // 2. é‡ç½®ç­”é¢˜é…ç½®
                await supabaseClient.from('vote_config').update({
                    current_round: 1,
                    is_active: false
                }).eq('id', 1);
                
                // 3. å…³é—­æŠ¢ç­”
                await supabaseClient.from('buzzer').update({
                    is_active: false,
                    winner: null
                }).eq('id', 1);
                
                // 4. æ¸…ç©ºä»Šæ—¥ç­”é¢˜è®°å½•
                const today = new Date().toISOString().split('T')[0];
                await supabaseClient.from('vote_logs').delete().gte('created_at', today);
                
                // 5. å¯é€‰ï¼šæ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•
                if (clearAttendance) {
                    await supabaseClient.from('attendance').delete().gte('created_at', today);
                }
                
                // é‡ç½®æœ¬åœ°çŠ¶æ€
                isDanmuEnabled = false;
                isVoteVisible = false;
                voteRound = 1;
                document.getElementById('vote-overlay').style.display = 'none';
                document.getElementById('vote-round').innerText = '1';
                updateDanmuButton();
                
                // å…³é—­ç‚¹åé¢æ¿
                if (isLuckyVisible) {
                    closeLuckyOverlay();
                }
                
                alert('âœ… ä¸‹è¯¾æˆåŠŸï¼æ‰€æœ‰åŠŸèƒ½å·²é‡ç½®ã€‚');
            } catch (err) {
                console.error('ä¸‹è¯¾æ“ä½œå¤±è´¥:', err);
                alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
            }
        }
        
        // ================== æ¨¡æ€æ¡† ==================
        function openUploadModal() {
            document.getElementById('upload-modal').style.display = 'flex';
        }
        
        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
        }
        
        // ================== å…¨å± ==================
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // ================== é”®ç›˜å¿«æ·é”® ==================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                case 'PageUp':
                    e.preventDefault();
                    prevSlide();
                    break;
                case 'ArrowRight':
                case 'PageDown':
                case ' ':
                    e.preventDefault();
                    nextSlide();
                    break;
                case 'v':
                case 'V':
                    toggleVoteOverlay();
                    break;
                case 'd':
                case 'D':
                    toggleDanmu();
                    break;
                case 'b':
                case 'B':
                    startBuzzer();
                    break;
                case 'l':
                case 'L':
                    toggleLuckyOverlay();
                    break;
                case 'f':
                case 'F':
                    toggleFullscreen();
                    break;
                case 'r':
                case 'R':
                    releaseControl();
                    break;
                case 'Escape':
                    closeUploadModal();
                    document.getElementById('vote-overlay').style.display = 'none';
                    document.getElementById('lucky-overlay').style.display = 'none';
                    document.getElementById('lucky-settings-panel').style.display = 'none';
                    isVoteVisible = false;
                    isLuckyVisible = false;
                    break;
            }
        });
        
        // ================== æ‹–æ‹½ä¸Šä¼  ==================
        const dropZone = document.getElementById('drop-zone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        // ================== éšæœºç‚¹ååŠŸèƒ½ ==================
        let isLuckyVisible = false;
        let luckyData = {};
        let luckyCurrentClass = '';
        let luckyNames = [];
        let luckyTimer = null;
        let isLuckyRunning = false;
        let isLuckyMuted = false;
        
        // éŸ³æ•ˆ - ä½¿ç”¨ Web Audio API ç”Ÿæˆ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let rollInterval = null;
        
        const luckyRollSound = {
            play: function() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                rollInterval = setInterval(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = 200 + Math.random() * 100;
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    gain.gain.value = 0.1;
                    osc.start();
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                    osc.stop(audioCtx.currentTime + 0.1);
                }, 80);
                return Promise.resolve();
            },
            pause: function() { clearInterval(rollInterval); },
            muted: false
        };
        
        const luckyWinSound = {
            play: function() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                [523, 659, 784, 1047].forEach((freq, i) => {
                    setTimeout(() => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        gain.gain.value = 0.2;
                        osc.start();
                        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                        osc.stop(audioCtx.currentTime + 0.3);
                    }, i * 100);
                });
            },
            currentTime: 0,
            muted: false
        };
        
        function toggleLuckyOverlay() {
            isLuckyVisible = !isLuckyVisible;
            document.getElementById('lucky-overlay').style.display = isLuckyVisible ? 'block' : 'none';
            if (isLuckyVisible) {
                initLuckyData();
            }
        }
        
        function closeLuckyOverlay() {
            isLuckyVisible = false;
            document.getElementById('lucky-overlay').style.display = 'none';
            if (isLuckyRunning) {
                clearInterval(luckyTimer);
                isLuckyRunning = false;
                luckyRollSound.pause();
            }
        }
        
        function initLuckyData() {
            const saved = localStorage.getItem('lucky_classes_v2');
            if (saved) {
                luckyData = JSON.parse(saved);
            } else {
                luckyData = { "æ¼”ç¤ºç­çº§": ["å¼ ä¸‰", "æå››", "ç‹äº”", "èµµå…­", "å­™ä¸ƒ"] };
            }
            renderLuckySelect();
        }
        
        function renderLuckySelect() {
            const select = document.getElementById('lucky-class-select');
            select.innerHTML = '';
            const keys = Object.keys(luckyData);
            if (keys.length === 0) {
                luckyData["é»˜è®¤ç­çº§"] = [];
                keys.push("é»˜è®¤ç­çº§");
            }
            keys.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = key;
                select.appendChild(opt);
            });
            if (luckyCurrentClass && luckyData[luckyCurrentClass]) {
                select.value = luckyCurrentClass;
            } else {
                select.value = keys[0];
                luckyCurrentClass = keys[0];
            }
            switchLuckyClass();
        }
        
        function switchLuckyClass() {
            luckyCurrentClass = document.getElementById('lucky-class-select').value;
            luckyNames = luckyData[luckyCurrentClass] || [];
            document.getElementById('lucky-display').innerText = 'å‡†å¤‡ç‚¹å';
            document.getElementById('lucky-display').style.color = 'white';
        }
        
        function toggleLuckyMute() {
            isLuckyMuted = !isLuckyMuted;
            document.getElementById('lucky-mute-btn').innerText = isLuckyMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            luckyRollSound.muted = isLuckyMuted;
            luckyWinSound.muted = isLuckyMuted;
        }
        
        function toggleLuckyRoll() {
            if (!luckyNames || luckyNames.length === 0) {
                alert(`ç­çº§ "${luckyCurrentClass}" æ˜¯ç©ºçš„ï¼è¯·ç‚¹å‡»âš™ï¸æ·»åŠ åå•ã€‚`);
                return;
            }
            
            const btn = document.getElementById('lucky-action-btn');
            const display = document.getElementById('lucky-display');
            
            if (isLuckyRunning) {
                // åœæ­¢
                clearInterval(luckyTimer);
                isLuckyRunning = false;
                btn.innerText = 'å¼€å§‹';
                btn.style.background = 'white';
                btn.style.color = '#333';
                display.style.color = '#FFD700';
                display.style.textShadow = '0 0 20px #FFD700';
                
                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                if (!isLuckyMuted) {
                    luckyRollSound.pause();
                    luckyWinSound.currentTime = 0;
                    luckyWinSound.play();
                }
            } else {
                // å¼€å§‹
                display.style.color = 'white';
                display.style.textShadow = '0 5px 15px rgba(0,0,0,0.5)';
                isLuckyRunning = true;
                btn.innerText = 'åœæ­¢';
                btn.style.background = '#ff4757';
                btn.style.color = 'white';
                
                // æ’­æ”¾æ»šåŠ¨éŸ³æ•ˆ
                if (!isLuckyMuted) {
                    luckyRollSound.currentTime = 0;
                    luckyRollSound.play().catch(e => console.log('ç­‰å¾…ç”¨æˆ·äº¤äº’'));
                }
                
                luckyTimer = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * luckyNames.length);
                    display.innerText = luckyNames[randomIndex];
                }, 50);
            }
        }
        
        function openLuckySettings() {
            document.getElementById('lucky-settings-panel').style.display = 'block';
            document.getElementById('lucky-editing-class').innerText = luckyCurrentClass;
            document.getElementById('lucky-name-input').value = luckyNames.join('\n');
        }
        
        function closeLuckySettings() {
            document.getElementById('lucky-settings-panel').style.display = 'none';
        }
        
        function addLuckyClass() {
            const newName = document.getElementById('lucky-new-class-name').value.trim();
            if (!newName) return alert('è¯·è¾“å…¥ç­çº§åç§°ï¼');
            if (luckyData[newName]) return alert('è¿™ä¸ªç­çº§å·²ç»å­˜åœ¨äº†ï¼');
            luckyData[newName] = [];
            luckyCurrentClass = newName;
            saveLuckyData();
            renderLuckySelect();
            document.getElementById('lucky-new-class-name').value = '';
            alert(`âœ… å·²åˆ›å»º "${newName}"ï¼Œè¯·åœ¨ä¸‹æ–¹ç²˜è´´åå•`);
        }
        
        function saveLuckyList() {
            const rawText = document.getElementById('lucky-name-input').value;
            const namesArr = rawText.split('\n').filter(n => n.trim() !== '');
            if (namesArr.length === 0) return alert('åå•ä¸èƒ½ä¸ºç©ºï¼');
            luckyData[luckyCurrentClass] = namesArr;
            luckyNames = namesArr;
            saveLuckyData();
            alert(`âœ… å·²æ›´æ–°ï¼Œå…± ${namesArr.length} äºº`);
            closeLuckySettings();
        }
        
        function deleteLuckyClass() {
            if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ç­çº§ "${luckyCurrentClass}" å—ï¼Ÿ`)) return;
            delete luckyData[luckyCurrentClass];
            luckyCurrentClass = '';
            saveLuckyData();
            renderLuckySelect();
            closeLuckySettings();
        }
        
        function saveLuckyData() {
            localStorage.setItem('lucky_classes_v2', JSON.stringify(luckyData));
        }
        
        // ================== é¡µé¢åˆå§‹åŒ– ==================
        (function init() {
            // ğŸ”¥ å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶å°±è®¢é˜…å¼¹å¹•é¢‘é“ï¼Œç¡®ä¿å¼¹å¹•èƒ½å®æ—¶æ˜¾ç¤º
            supabaseClient.channel('presentation-danmu-init')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                    if (isDanmuEnabled) {
                        createDanmu(payload.new.content);
                    }
                })
                .subscribe();
            danmuSubscribed = true;
            
            console.log('ğŸ¬ è¯¾ä»¶æ’­æ”¾å™¨å·²åˆå§‹åŒ–');
            console.log('ğŸ“¡ å¼¹å¹•é¢‘é“å·²è®¢é˜…');
        })();
    </script>
</body>
</html>
