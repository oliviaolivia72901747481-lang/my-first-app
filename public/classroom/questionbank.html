<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š é¢˜åº“ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 15px; }
        .header h1 { font-size: 1.8rem; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        
        .main-content { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* å·¦ä¾§åˆ†ç±»æ  */
        .sidebar { background: #1e293b; border-radius: 15px; padding: 20px; height: fit-content; }
        .sidebar h3 { margin-bottom: 15px; color: #94a3b8; font-size: 0.9rem; }
        .category-list { display: flex; flex-direction: column; gap: 8px; }
        .category-item { display: flex; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .category-item:hover { background: rgba(255,255,255,0.1); }
        .category-item.active { background: rgba(59,130,246,0.3); border-left: 3px solid #3b82f6; }
        .category-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .category-name { flex: 1; font-size: 0.95rem; }
        .category-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
        .add-category { margin-top: 15px; padding: 12px; background: rgba(16,185,129,0.2); border: 2px dashed #10b981; border-radius: 10px; text-align: center; cursor: pointer; color: #10b981; }
        .add-category:hover { background: rgba(16,185,129,0.3); }
        
        /* ä¸‰çº§æ ‘å½¢å¯¼èˆªæ ·å¼ */
        .hierarchy-tree { display: flex; flex-direction: column; gap: 4px; }
        .tree-node { user-select: none; }
        .tree-header { display: flex; align-items: center; padding: 10px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s; gap: 8px; }
        .tree-header:hover { background: rgba(255,255,255,0.1); }
        .tree-header.active { background: rgba(59,130,246,0.3); border-left: 3px solid #3b82f6; }
        .tree-toggle { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #94a3b8; transition: transform 0.2s; flex-shrink: 0; }
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-toggle.empty { visibility: hidden; }
        .tree-icon { font-size: 1rem; flex-shrink: 0; }
        .tree-name { flex: 1; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tree-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; flex-shrink: 0; }
        .tree-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .tree-header:hover .tree-actions { opacity: 1; }
        .tree-action-btn { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 2px 4px; font-size: 0.75rem; border-radius: 4px; }
        .tree-action-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tree-children { margin-left: 20px; display: flex; flex-direction: column; gap: 4px; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.2s; }
        .tree-children.collapsed { max-height: 0; opacity: 0; padding: 0; }
        .tree-children.expanded { max-height: 2000px; opacity: 1; padding-top: 4px; }
        /* å±‚çº§é¢œè‰²åŒºåˆ† */
        .tree-node.level-course > .tree-header { border-left: 3px solid transparent; }
        .tree-node.level-course > .tree-header .tree-icon { color: #3b82f6; }
        .tree-node.level-project > .tree-header { border-left: 3px solid transparent; }
        .tree-node.level-project > .tree-header .tree-icon { color: #10b981; }
        .tree-node.level-task > .tree-header { border-left: 3px solid transparent; }
        .tree-node.level-task > .tree-header .tree-icon { color: #f59e0b; }
        /* ç®¡ç†æŒ‰é’®åŒºåŸŸ */
        .hierarchy-actions { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .hierarchy-actions .btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.75rem; }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“š é¢˜åº“ç®¡ç†ä¸­å¿ƒ</h1>
                <p style="color:#94a3b8; margin-top:5px;">ç®¡ç†å¤šè¯¾ç¨‹é¢˜åº“ï¼Œæ”¯æŒå¤šç§é¢˜å‹</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥é¢˜ç›®</button>
                <button class="btn btn-primary" onclick="openAddQuestion()">â• æ·»åŠ é¢˜ç›®</button>
                <button class="btn btn-secondary" onclick="openFormatHelp()">â“ æ ¼å¼è¯´æ˜</button>
                <a href="/classroom/presentation.html" class="btn btn-warning">ğŸ¬ è¿”å›è¯¾ä»¶</a>
            </div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§åˆ†ç±»æ  -->
            <div class="sidebar">
                <!-- å±‚çº§å¯¼èˆªæ ‡é¢˜ -->
                <h3>ğŸ“š é¢˜åº“å±‚çº§</h3>
                
                <!-- å…¨éƒ¨é¢˜ç›®é€‰é¡¹ -->
                <div class="hierarchy-tree" id="hierarchy-tree">
                    <div class="tree-node">
                        <div class="tree-header active" onclick="selectHierarchyNode('all', 'all')" data-type="all" data-id="all">
                            <span class="tree-toggle empty"></span>
                            <span class="tree-icon">ğŸ“‹</span>
                            <span class="tree-name">å…¨éƒ¨é¢˜ç›®</span>
                            <span class="tree-count" id="total-count">0</span>
                        </div>
                    </div>
                    <!-- è¯¾ç¨‹æ ‘å°†åœ¨è¿™é‡ŒåŠ¨æ€æ¸²æŸ“ -->
                    <div id="courses-tree"></div>
                </div>
                
                <!-- å±‚çº§ç®¡ç†æŒ‰é’® -->
                <div class="hierarchy-actions">
                    <button onclick="openAddCourse()" class="btn btn-primary" title="æ–°å»ºè¯¾ç¨‹">â• è¯¾ç¨‹</button>
                    <button onclick="openAddProject()" class="btn btn-success" title="æ–°å»ºé¡¹ç›®">â• é¡¹ç›®</button>
                    <button onclick="openAddTask()" class="btn btn-warning" title="æ–°å»ºä»»åŠ¡">â• ä»»åŠ¡</button>
                </div>
                <div class="hierarchy-actions" style="margin-top:5px;">
                    <button onclick="manageCourses()" class="btn btn-secondary" title="ç®¡ç†è¯¾ç¨‹" style="flex:1;">ğŸ“‹ è¯¾ç¨‹</button>
                    <button onclick="manageProjects()" class="btn btn-secondary" title="ç®¡ç†é¡¹ç›®" style="flex:1;">ğŸ“ é¡¹ç›®</button>
                </div>
                
                <h3 style="margin-top:25px;">ğŸ“Š é¢˜å‹ç»Ÿè®¡</h3>
                <div id="type-stats" style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">å•é€‰é¢˜</span>
                        <span id="stat-single">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">å¤šé€‰é¢˜</span>
                        <span id="stat-multiple">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">åˆ¤æ–­é¢˜</span>
                        <span id="stat-truefalse">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span style="color:#94a3b8;">å¡«ç©ºé¢˜</span>
                        <span id="stat-fillblank">0</span>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢˜ç›®åˆ—è¡¨ -->
            <div class="content-area" style="background:#1e293b; border-radius:15px; padding:20px;">
                <!-- ç­›é€‰æ  -->
                <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
                    <input type="text" id="search-input" placeholder="ğŸ” æœç´¢é¢˜ç›®..." style="flex:1; min-width:200px; padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <select id="filter-type" style="padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">å…¨éƒ¨é¢˜å‹</option>
                        <option value="single">å•é€‰é¢˜</option>
                        <option value="multiple">å¤šé€‰é¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                    </select>
                    <select id="filter-difficulty" style="padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">å…¨éƒ¨éš¾åº¦</option>
                        <option value="1">â­ ç®€å•</option>
                        <option value="2">â­â­ è¾ƒæ˜“</option>
                        <option value="3">â­â­â­ ä¸­ç­‰</option>
                        <option value="4">â­â­â­â­ è¾ƒéš¾</option>
                        <option value="5">â­â­â­â­â­ å›°éš¾</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadQuestions()">ğŸ”„ åˆ·æ–°</button>
                </div>
                
                <!-- é¢˜ç›®åˆ—è¡¨ -->
                <div id="question-list" style="display:flex; flex-direction:column; gap:12px;">
                    <div style="text-align:center; padding:50px; color:#666;">åŠ è½½ä¸­...</div>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div id="pagination" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥é¢˜ç›®å¼¹çª— -->
    <div id="import-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“¥ å¯¼å…¥é¢˜ç›®</h2>
                <button onclick="closeImportModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é€‰æ‹©åˆ†ç±»</label>
                    <select id="import-category" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®ç±»å‹</label>
                    <select id="import-type" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">å•é€‰é¢˜</option>
                        <option value="multiple">å¤šé€‰é¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                    </select>
                </div>
            </div>
            
            <div style="background:rgba(59,130,246,0.1); border:2px dashed #3b82f6; border-radius:15px; padding:40px; text-align:center; margin-bottom:20px;" id="drop-area">
                <div style="font-size:3rem; margin-bottom:10px;">ğŸ“„</div>
                <div style="margin-bottom:15px;">æ‹–æ‹½CSVæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                <input type="file" id="file-input" accept=".csv" style="display:none;" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('file-input').click()" class="btn btn-primary">é€‰æ‹©CSVæ–‡ä»¶</button>
            </div>
            
            <div id="import-preview" style="display:none;">
                <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ é¢„è§ˆ (<span id="preview-count">0</span> é“é¢˜ç›®)</div>
                <div id="preview-list" style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; margin-bottom:15px;"></div>
                <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="clear-before-import"> æ¸…ç©ºè¯¥åˆ†ç±»ç°æœ‰é¢˜ç›®
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        èµ·å§‹åºå·: <input type="number" id="start-round" value="1" min="1" style="width:80px; padding:5px; border-radius:5px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    </label>
                </div>
                <button onclick="confirmImport()" class="btn btn-success" style="width:100%; padding:15px;">âœ… ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <!-- æ ¼å¼è¯´æ˜å¼¹çª— -->
    <div id="format-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“‹ CSVæ ¼å¼è¯´æ˜</h2>
                <button onclick="closeFormatHelp()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <div style="display:grid; gap:20px;">
                <!-- å•é€‰é¢˜æ ¼å¼ -->
                <div style="background:rgba(59,130,246,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#3b82f6; margin-bottom:10px;">ğŸ“Œ å•é€‰é¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"1+1ç­‰äºå¤šå°‘ï¼Ÿ","1","2","3","4",B,æ•°å­¦åŸºç¡€,1<br>
"æ°´çš„åŒ–å­¦å¼æ˜¯ï¼Ÿ","H2O","CO2","O2","N2",A,åŒ–å­¦åŸºç¡€,2
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">ç­”æ¡ˆå¡«å†™ï¼šA/B/C/Dï¼ˆå•ä¸ªå­—æ¯ï¼‰</p>
                </div>
                
                <!-- å¤šé€‰é¢˜æ ¼å¼ -->
                <div style="background:rgba(139,92,246,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#8b5cf6; margin-bottom:10px;">ğŸ“Œ å¤šé€‰é¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"ä»¥ä¸‹å“ªäº›æ˜¯ç¼–ç¨‹è¯­è¨€ï¼Ÿ","Python","Excel","Java","Word",AC,è®¡ç®—æœºåŸºç¡€,2<br>
"å“ªäº›å±äºå¯å†ç”Ÿèƒ½æºï¼Ÿ","å¤ªé˜³èƒ½","ç…¤ç‚­","é£èƒ½","çŸ³æ²¹",AC,ç¯å¢ƒç§‘å­¦,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">ç­”æ¡ˆå¡«å†™ï¼šå¤šä¸ªå­—æ¯è¿å†™ï¼Œå¦‚ ABã€ACDã€ABCD</p>
                </div>
                
                <!-- åˆ¤æ–­é¢˜æ ¼å¼ -->
                <div style="background:rgba(16,185,129,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#10b981; margin-bottom:10px;">ğŸ“Œ åˆ¤æ–­é¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"åœ°çƒæ˜¯å¤ªé˜³ç³»ä¸­æœ€å¤§çš„è¡Œæ˜Ÿ",é”™,å¤©æ–‡å­¦,1<br>
"æ°´åœ¨æ ‡å‡†å¤§æ°”å‹ä¸‹100â„ƒæ²¸è…¾",å¯¹,ç‰©ç†å­¦,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">ç­”æ¡ˆå¡«å†™ï¼šå¯¹/é”™ æˆ– T/F æˆ– true/false</p>
                </div>
                
                <!-- å¡«ç©ºé¢˜æ ¼å¼ -->
                <div style="background:rgba(245,158,11,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#f59e0b; margin-bottom:10px;">ğŸ“Œ å¡«ç©ºé¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"ä¸­å›½çš„é¦–éƒ½æ˜¯____",åŒ—äº¬,åœ°ç†å¸¸è¯†,1<br>
"1åƒå…‹ç­‰äº____å…‹",1000,å•ä½æ¢ç®—,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">é¢˜ç›®ä¸­ç”¨ ____ è¡¨ç¤ºå¡«ç©ºä½ç½®ï¼Œç­”æ¡ˆä¸ºæ ‡å‡†ç­”æ¡ˆ</p>
                </div>
            </div>
            
            <div style="margin-top:20px; padding:15px; background:rgba(239,68,68,0.1); border-radius:10px;">
                <h4 style="color:#ef4444; margin-bottom:8px;">âš ï¸ æ³¨æ„äº‹é¡¹</h4>
                <ul style="color:#94a3b8; font-size:0.85rem; padding-left:20px; line-height:1.8;">
                    <li>CSVæ–‡ä»¶éœ€ä½¿ç”¨UTF-8ç¼–ç ä¿å­˜</li>
                    <li>ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œï¼Œä¼šè¢«è‡ªåŠ¨è·³è¿‡</li>
                    <li>é¢˜ç›®å†…å®¹å¦‚åŒ…å«é€—å·ï¼Œéœ€ç”¨è‹±æ–‡åŒå¼•å·åŒ…è£¹</li>
                    <li>çŸ¥è¯†ç‚¹å’Œéš¾åº¦ä¸ºå¯é€‰å­—æ®µï¼Œå¯çœç•¥</li>
                    <li>éš¾åº¦èŒƒå›´ï¼š1-5ï¼ˆ1æœ€ç®€å•ï¼Œ5æœ€éš¾ï¼‰</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- è¯¾ç¨‹ç®¡ç†å¼¹çª— -->
    <div id="course-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="course-modal-title">â• æ–°å»ºè¯¾ç¨‹</h2>
            <input type="hidden" id="edit-course-id">
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">è¯¾ç¨‹åç§° *</label>
                    <input type="text" id="course-name" placeholder="å¦‚ï¼šç¯å¢ƒç›‘æµ‹æŠ€æœ¯" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">è¯¾ç¨‹ä»£ç </label>
                    <input type="text" id="course-code" placeholder="å¦‚ï¼šENV101" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">æˆè¯¾æ•™å¸ˆ</label>
                    <input type="text" id="course-teacher" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">å­¦æœŸ</label>
                    <input type="text" id="course-semester" placeholder="å¦‚ï¼š2024-2025-1" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">è¯¾ç¨‹æè¿°</label>
                <textarea id="course-desc" placeholder="è¯¾ç¨‹ç®€ä»‹ï¼ˆå¯é€‰ï¼‰" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ˜¾ç¤ºé¢œè‰²</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#3b82f6" checked style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#10b981" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#f59e0b" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#ef4444" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#8b5cf6" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#06b6d4" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#06b6d4; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveCourse()" class="btn btn-success" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="closeCourseModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- è¯¾ç¨‹åˆ—è¡¨ç®¡ç†å¼¹çª— -->
    <div id="courses-list-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“– è¯¾ç¨‹ç®¡ç†</h2>
                <button onclick="closeCoursesListModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            <div id="courses-list-content">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- é¡¹ç›®ç®¡ç†å¼¹çª— -->
    <div id="project-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="project-modal-title">â• æ–°å»ºé¡¹ç›®</h2>
            <input type="hidden" id="edit-project-id">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ‰€å±è¯¾ç¨‹ *</label>
                <select id="project-course" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¡¹ç›®åç§° *</label>
                <input type="text" id="project-name" placeholder="å¦‚ï¼šåœŸå£¤æ£€æµ‹ã€æ°´è´¨åˆ†æ" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¡¹ç›®æè¿°</label>
                <textarea id="project-desc" placeholder="é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ˜¾ç¤ºé¢œè‰²</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#10b981" checked style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#3b82f6" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#f59e0b" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#ef4444" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#8b5cf6" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#06b6d4" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#06b6d4; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveProject()" class="btn btn-success" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="closeProjectModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é¡¹ç›®åˆ—è¡¨ç®¡ç†å¼¹çª— -->
    <div id="projects-list-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“ é¡¹ç›®ç®¡ç†</h2>
                <button onclick="closeProjectsListModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            <div id="projects-list-content">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ†ç±»å¼¹çª— -->
    <div id="category-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="category-modal-title">â• æ–°å»ºåˆ†ç±»</h2>
            <input type="hidden" id="edit-category-id">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">åˆ†ç±»åç§° *</label>
                <input type="text" id="category-name" placeholder="å¦‚ï¼šåœŸå£¤æ°´åˆ†æµ‹å®šã€é‡é‡‘å±æ£€æµ‹" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ‰€å±è¯¾ç¨‹</label>
                <select id="category-course" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">ä¸å±äºä»»ä½•è¯¾ç¨‹</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">å­¦ç§‘</label>
                <input type="text" id="category-subject" placeholder="å¦‚ï¼šç¯å¢ƒç§‘å­¦" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æè¿°</label>
                <textarea id="category-desc" placeholder="åˆ†ç±»æè¿°ï¼ˆå¯é€‰ï¼‰" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:80px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ˜¾ç¤ºé¢œè‰²</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#3b82f6" checked style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#10b981" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#f59e0b" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#ef4444" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#8b5cf6" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#ec4899" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#ec4899; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveCategory()" class="btn btn-success" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="closeCategoryModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘é¢˜ç›®å¼¹çª— -->
    <div id="question-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto;">
            <h2 style="margin-bottom:20px;" id="question-modal-title">â• æ·»åŠ é¢˜ç›®</h2>
            <input type="hidden" id="edit-question-id">
            
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®åºå·</label>
                    <input type="number" id="q-round" min="1" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®ç±»å‹</label>
                    <select id="q-type" onchange="updateQuestionForm()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">å•é€‰é¢˜</option>
                        <option value="multiple">å¤šé€‰é¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ‰€å±åˆ†ç±»</label>
                    <select id="q-category" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></select>
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®å†…å®¹</label>
                <textarea id="q-title" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:80px; resize:vertical;"></textarea>
            </div>
            
            <div id="options-area">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹A</label><input id="q-opt-a" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹B</label><input id="q-opt-b" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹C</label><input id="q-opt-c" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹D</label><input id="q-opt-d" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ­£ç¡®ç­”æ¡ˆ</label>
                    <input id="q-answer" placeholder="å¦‚ A æˆ– AB" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">çŸ¥è¯†ç‚¹</label>
                    <input id="q-tag" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">éš¾åº¦</label>
                    <select id="q-difficulty" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="1">â­ ç®€å•</option>
                        <option value="2">â­â­ è¾ƒæ˜“</option>
                        <option value="3">â­â­â­ ä¸­ç­‰</option>
                        <option value="4">â­â­â­â­ è¾ƒéš¾</option>
                        <option value="5">â­â­â­â­â­ å›°éš¾</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">ç­”æ¡ˆè§£æï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="q-explanation" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button onclick="saveQuestion()" class="btn btn-success" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="closeQuestionModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // çŠ¶æ€
        let courses = [];
        let projects = [];
        let tasks = [];
        let currentCourse = 'all';
        let currentProject = 'all';
        let currentTask = 'all';
        let currentFilterType = 'all'; // 'all', 'course', 'project', 'task'
        let currentFilterId = 'all';
        let categories = [];
        let currentCategory = 'all';
        let questions = [];
        let pendingImport = [];
        // æ ‘å±•å¼€çŠ¶æ€
        let expandedNodes = { courses: {}, projects: {} };
        
        // é¢˜å‹é…ç½®
        const typeConfig = {
            single: { name: 'å•é€‰é¢˜', color: '#3b82f6', icon: 'ğŸ“Œ' },
            multiple: { name: 'å¤šé€‰é¢˜', color: '#8b5cf6', icon: 'ğŸ“‹' },
            truefalse: { name: 'åˆ¤æ–­é¢˜', color: '#10b981', icon: 'âœ…' },
            fillblank: { name: 'å¡«ç©ºé¢˜', color: '#f59e0b', icon: 'âœï¸' }
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadHierarchy();
            loadQuestions();
            setupColorPicker();
            setupDropArea();
        });
        
        // åŠ è½½å®Œæ•´å±‚çº§æ•°æ®
        async function loadHierarchy() {
            await loadCourses();
            await loadProjects();
            await loadTasks();
            renderHierarchyTree();
        }
        
        // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨
        function setupColorPicker() {
            // åˆ†ç±»é¢œè‰²é€‰æ‹©å™¨
            document.querySelectorAll('input[name="category-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.color-option').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            const firstColorOpt = document.querySelector('.color-option');
            if (firstColorOpt) firstColorOpt.style.borderColor = 'white';
            
            // è¯¾ç¨‹é¢œè‰²é€‰æ‹©å™¨
            document.querySelectorAll('input[name="course-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.course-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            const firstCourseColorOpt = document.querySelector('.course-color-opt');
            if (firstCourseColorOpt) firstCourseColorOpt.style.borderColor = 'white';
            
            // é¡¹ç›®é¢œè‰²é€‰æ‹©å™¨
            document.querySelectorAll('input[name="project-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.project-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            const firstProjectColorOpt = document.querySelector('.project-color-opt');
            if (firstProjectColorOpt) firstProjectColorOpt.style.borderColor = 'white';
        }
        
        // è®¾ç½®æ‹–æ‹½åŒºåŸŸ
        function setupDropArea() {
            const dropArea = document.getElementById('drop-area');
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = '#10b981'; });
            dropArea.addEventListener('dragleave', () => { dropArea.style.borderColor = '#3b82f6'; });
            dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.style.borderColor = '#3b82f6'; handleFileDrop(e); });
        }
        
        // ================== è¯¾ç¨‹ç®¡ç† ==================
        async function loadCourses() {
            const { data, error } = await supabaseClient.from('courses').select('*').order('sort_order');
            if (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                if (error.code === '42P01') {
                    console.warn('courses è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ‰§è¡Œ courses_table.sql');
                }
                return;
            }
            courses = data || [];
            renderCourseSelect();
            updateCourseSelects();
        }
        
        // æ›´æ–°è¯¾ç¨‹çš„é¡¹ç›®æ•°é‡å’Œé¢˜ç›®æ•°é‡
        async function updateCourseStats(courseId) {
            const courseProjects = projects.filter(p => p.course_id === courseId);
            const projectCount = courseProjects.length;
            const courseProjectIds = courseProjects.map(p => p.project_id);
            const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
            const questionCount = questions.filter(q => courseTaskIds.includes(q.task_id)).length;
            
            await supabaseClient.from('courses').update({
                project_count: projectCount,
                question_count: questionCount
            }).eq('course_id', courseId);
        }
        
        // æ›´æ–°æ‰€æœ‰è¯¾ç¨‹çš„ç»Ÿè®¡æ•°æ®
        async function updateAllCourseStats() {
            for (const course of courses) {
                await updateCourseStats(course.course_id);
            }
        }
        
        function renderCourseSelect() {
            const select = document.getElementById('course-select');
            if (select) {
                select.innerHTML = '<option value="all">ğŸ“š å…¨éƒ¨è¯¾ç¨‹</option>' + 
                    courses.map(c => `<option value="${c.course_id}" style="color:${c.color};">${c.icon || 'ğŸ“–'} ${c.name}</option>`).join('');
            }
        }
        
        function updateCourseSelects() {
            // æ›´æ–°åˆ†ç±»å¼¹çª—ä¸­çš„è¯¾ç¨‹é€‰æ‹©
            const catCourseSelect = document.getElementById('category-course');
            if (catCourseSelect) {
                catCourseSelect.innerHTML = '<option value="">ä¸å±äºä»»ä½•è¯¾ç¨‹</option>' + 
                    courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            }
            // æ›´æ–°é¡¹ç›®å¼¹çª—ä¸­çš„è¯¾ç¨‹é€‰æ‹©
            const projCourseSelect = document.getElementById('project-course');
            if (projCourseSelect) {
                projCourseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>' + 
                    courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            }
        }
        
        // ================== é¡¹ç›®ç®¡ç† ==================
        async function loadProjects() {
            const { data, error } = await supabaseClient.from('projects').select('*').order('sort_order');
            if (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                if (error.code === '42P01') {
                    console.warn('projects è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ‰§è¡Œ hierarchy_tables.sql');
                }
                return;
            }
            projects = data || [];
        }
        
        // ================== ä»»åŠ¡ç®¡ç† ==================
        async function loadTasks() {
            const { data, error } = await supabaseClient.from('tasks').select('*').order('sort_order');
            if (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                if (error.code === '42P01') {
                    console.warn('tasks è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ‰§è¡Œ hierarchy_tables.sql');
                }
                return;
            }
            tasks = data || [];
        }
        
        // ================== å±‚çº§æ ‘æ¸²æŸ“ ==================
        function renderHierarchyTree() {
            const container = document.getElementById('courses-tree');
            if (!container) return;
            
            let html = '';
            
            courses.forEach(course => {
                const courseProjects = projects.filter(p => p.course_id === course.course_id);
                const isExpanded = expandedNodes.courses[course.course_id];
                const hasChildren = courseProjects.length > 0;
                const courseQuestionCount = getCourseQuestionCount(course.course_id);
                const isActive = currentFilterType === 'course' && currentFilterId === course.course_id;
                
                html += `
                    <div class="tree-node level-course" data-course-id="${course.course_id}">
                        <div class="tree-header ${isActive ? 'active' : ''}" 
                             onclick="selectHierarchyNode('course', '${course.course_id}')"
                             data-type="course" data-id="${course.course_id}">
                            <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : '') : 'empty'}" 
                                  onclick="event.stopPropagation(); toggleCourseNode('${course.course_id}')">â–¶</span>
                            <span class="tree-icon">${course.icon || 'ğŸ“–'}</span>
                            <span class="tree-name" style="color:${course.color};">${course.name}</span>
                            <span class="tree-count">${courseQuestionCount}</span>
                            <div class="tree-actions">
                                <button class="tree-action-btn" onclick="event.stopPropagation(); editCourse('${course.course_id}')" title="ç¼–è¾‘">âœï¸</button>
                            </div>
                        </div>
                        <div class="tree-children ${isExpanded ? 'expanded' : 'collapsed'}">
                            ${renderProjectNodes(courseProjects)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateTotalCount();
        }
        
        function renderProjectNodes(projectList) {
            let html = '';
            
            projectList.forEach(project => {
                const projectTasks = tasks.filter(t => t.project_id === project.project_id);
                const isExpanded = expandedNodes.projects[project.project_id];
                const hasChildren = projectTasks.length > 0;
                const projectQuestionCount = getProjectQuestionCount(project.project_id);
                const isActive = currentFilterType === 'project' && currentFilterId === project.project_id;
                
                html += `
                    <div class="tree-node level-project" data-project-id="${project.project_id}">
                        <div class="tree-header ${isActive ? 'active' : ''}"
                             onclick="selectHierarchyNode('project', '${project.project_id}')"
                             data-type="project" data-id="${project.project_id}">
                            <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : '') : 'empty'}"
                                  onclick="event.stopPropagation(); toggleProjectNode('${project.project_id}')">â–¶</span>
                            <span class="tree-icon">${project.icon || 'ğŸ“'}</span>
                            <span class="tree-name" style="color:${project.color};">${project.name}</span>
                            <span class="tree-count">${projectQuestionCount}</span>
                            <div class="tree-actions">
                                <button class="tree-action-btn" onclick="event.stopPropagation(); editProject('${project.project_id}')" title="ç¼–è¾‘">âœï¸</button>
                            </div>
                        </div>
                        <div class="tree-children ${isExpanded ? 'expanded' : 'collapsed'}">
                            ${renderTaskNodes(projectTasks)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function renderTaskNodes(taskList) {
            let html = '';
            
            taskList.forEach(task => {
                const taskQuestionCount = getTaskQuestionCount(task.task_id);
                const isActive = currentFilterType === 'task' && currentFilterId === task.task_id;
                
                html += `
                    <div class="tree-node level-task" data-task-id="${task.task_id}">
                        <div class="tree-header ${isActive ? 'active' : ''}"
                             onclick="selectHierarchyNode('task', '${task.task_id}')"
                             data-type="task" data-id="${task.task_id}">
                            <span class="tree-toggle empty"></span>
                            <span class="tree-icon">${task.icon || 'ğŸ“‹'}</span>
                            <span class="tree-name" style="color:${task.color};">${task.name}</span>
                            <span class="tree-count">${taskQuestionCount}</span>
                            <div class="tree-actions">
                                <button class="tree-action-btn" onclick="event.stopPropagation(); editTask('${task.task_id}')" title="ç¼–è¾‘">âœï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // è·å–å„çº§é¢˜ç›®æ•°é‡
        function getCourseQuestionCount(courseId) {
            const courseProjectIds = projects.filter(p => p.course_id === courseId).map(p => p.project_id);
            const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
            return questions.filter(q => courseTaskIds.includes(q.task_id)).length;
        }
        
        function getProjectQuestionCount(projectId) {
            const projectTaskIds = tasks.filter(t => t.project_id === projectId).map(t => t.task_id);
            return questions.filter(q => projectTaskIds.includes(q.task_id)).length;
        }
        
        function getTaskQuestionCount(taskId) {
            return questions.filter(q => q.task_id === taskId).length;
        }
        
        function updateTotalCount() {
            const totalCountEl = document.getElementById('total-count');
            if (totalCountEl) {
                totalCountEl.textContent = questions.length;
            }
        }
        
        // å±•å¼€/æ”¶èµ·èŠ‚ç‚¹
        function toggleCourseNode(courseId) {
            expandedNodes.courses[courseId] = !expandedNodes.courses[courseId];
            renderHierarchyTree();
        }
        
        function toggleProjectNode(projectId) {
            expandedNodes.projects[projectId] = !expandedNodes.projects[projectId];
            renderHierarchyTree();
        }
        
        // é€‰æ‹©å±‚çº§èŠ‚ç‚¹
        function selectHierarchyNode(type, id) {
            currentFilterType = type;
            currentFilterId = id;
            
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tree-header').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.tree-header[data-type="${type}"][data-id="${id}"]`);
            if (activeEl) activeEl.classList.add('active');
            
            // å¦‚æœé€‰æ‹©äº†è¯¾ç¨‹æˆ–é¡¹ç›®ï¼Œè‡ªåŠ¨å±•å¼€
            if (type === 'course') {
                expandedNodes.courses[id] = true;
            } else if (type === 'project') {
                expandedNodes.projects[id] = true;
                // ä¹Ÿå±•å¼€çˆ¶è¯¾ç¨‹
                const project = projects.find(p => p.project_id === id);
                if (project) {
                    expandedNodes.courses[project.course_id] = true;
                }
            } else if (type === 'task') {
                // å±•å¼€çˆ¶é¡¹ç›®å’Œçˆ¶è¯¾ç¨‹
                const task = tasks.find(t => t.task_id === id);
                if (task) {
                    expandedNodes.projects[task.project_id] = true;
                    const project = projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        expandedNodes.courses[project.course_id] = true;
                    }
                }
            }
            
            renderHierarchyTree();
            loadQuestions();
        }
        
        // ================== é¡¹ç›®ç®¡ç† ==================
        function openAddProject() {
            document.getElementById('project-modal-title').textContent = 'â• æ–°å»ºé¡¹ç›®';
            document.getElementById('edit-project-id').value = '';
            document.getElementById('project-name').value = '';
            document.getElementById('project-desc').value = '';
            // æ›´æ–°è¯¾ç¨‹é€‰æ‹©åˆ—è¡¨
            updateCourseSelects();
            // å¦‚æœå½“å‰é€‰æ‹©äº†è¯¾ç¨‹ï¼Œé»˜è®¤é€‰ä¸­è¯¥è¯¾ç¨‹
            const projCourseSelect = document.getElementById('project-course');
            if (projCourseSelect) {
                if (currentFilterType === 'course' && currentFilterId !== 'all') {
                    projCourseSelect.value = currentFilterId;
                } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                    const project = projects.find(p => p.project_id === currentFilterId);
                    if (project) projCourseSelect.value = project.course_id;
                } else if (currentFilterType === 'task' && currentFilterId !== 'all') {
                    const task = tasks.find(t => t.task_id === currentFilterId);
                    if (task) {
                        const project = projects.find(p => p.project_id === task.project_id);
                        if (project) projCourseSelect.value = project.course_id;
                    }
                } else {
                    projCourseSelect.value = '';
                }
            }
            // é‡ç½®é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.project-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
            document.querySelector('.project-color-opt').style.borderColor = 'white';
            document.querySelector('input[name="project-color"]').checked = true;
            document.getElementById('project-modal').style.display = 'flex';
        }
        
        async function editProject(projectId) {
            const project = projects.find(p => p.project_id === projectId);
            if (!project) return;
            
            document.getElementById('project-modal-title').textContent = 'âœï¸ ç¼–è¾‘é¡¹ç›®';
            document.getElementById('edit-project-id').value = projectId;
            document.getElementById('project-name').value = project.name;
            document.getElementById('project-desc').value = project.description || '';
            
            // æ›´æ–°è¯¾ç¨‹é€‰æ‹©åˆ—è¡¨å¹¶é€‰ä¸­
            updateCourseSelects();
            const projCourseSelect = document.getElementById('project-course');
            if (projCourseSelect) {
                projCourseSelect.value = project.course_id || '';
            }
            
            // é€‰ä¸­å¯¹åº”é¢œè‰²
            document.querySelectorAll('input[name="project-color"]').forEach(input => {
                if (input.value === project.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('project-modal').style.display = 'flex';
        }
        
        function closeProjectModal() {
            document.getElementById('project-modal').style.display = 'none';
        }
        
        async function saveProject() {
            const id = document.getElementById('edit-project-id').value;
            const courseId = document.getElementById('project-course').value;
            const name = document.getElementById('project-name').value.trim();
            const description = document.getElementById('project-desc').value.trim();
            const color = document.querySelector('input[name="project-color"]:checked')?.value || '#10b981';
            
            if (!courseId) { alert('è¯·é€‰æ‹©æ‰€å±è¯¾ç¨‹'); return; }
            if (!name) { alert('è¯·è¾“å…¥é¡¹ç›®åç§°'); return; }
            
            const data = { course_id: courseId, name, description, color };
            
            if (id) {
                // æ›´æ–°é¡¹ç›®
                const { error } = await supabaseClient.from('projects').update(data).eq('project_id', id);
                if (error) { alert('æ›´æ–°å¤±è´¥: ' + error.message); return; }
            } else {
                // æ–°å»ºé¡¹ç›®æ—¶åˆå§‹åŒ– task_count å’Œ question_count ä¸º 0
                data.task_count = 0;
                data.question_count = 0;
                const { error } = await supabaseClient.from('projects').insert([data]);
                if (error) { alert('åˆ›å»ºå¤±è´¥: ' + error.message); return; }
            }
            
            closeProjectModal();
            await loadHierarchy();
            alert('âœ… ä¿å­˜æˆåŠŸ');
        }
        
        // é¡¹ç›®åˆ—è¡¨ç®¡ç†
        function manageProjects() {
            renderProjectsList();
            document.getElementById('projects-list-modal').style.display = 'flex';
        }
        
        function closeProjectsListModal() {
            document.getElementById('projects-list-modal').style.display = 'none';
        }
        
        function renderProjectsList() {
            const container = document.getElementById('projects-list-content');
            if (projects.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">æš‚æ— é¡¹ç›®ï¼Œè¯·å…ˆåˆ›å»ºé¡¹ç›®</div>';
                return;
            }
            
            // æŒ‰è¯¾ç¨‹åˆ†ç»„æ˜¾ç¤ºé¡¹ç›®
            let html = '';
            courses.forEach(course => {
                const courseProjects = projects.filter(p => p.course_id === course.course_id);
                if (courseProjects.length > 0) {
                    html += `<div style="font-size:0.85rem; color:${course.color}; margin:15px 0 10px 0; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">${course.icon || 'ğŸ“–'} ${course.name}</div>`;
                    courseProjects.forEach(p => {
                        // è®¡ç®—ä»»åŠ¡æ•°é‡
                        const taskCount = tasks.filter(t => t.project_id === p.project_id).length;
                        // è®¡ç®—é¢˜ç›®æ•°é‡
                        const projectTaskIds = tasks.filter(t => t.project_id === p.project_id).map(t => t.task_id);
                        const qCount = questions.filter(q => projectTaskIds.includes(q.task_id)).length;
                        
                        html += `
                            <div style="display:flex; align-items:center; padding:12px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:8px; border-left:4px solid ${p.color};">
                                <div style="font-size:1.5rem; margin-right:12px;">${p.icon || 'ğŸ“'}</div>
                                <div style="flex:1;">
                                    <div style="font-weight:bold;">${p.name}</div>
                                    <div style="font-size:0.8rem; color:#94a3b8; margin-top:2px;">
                                        ${taskCount} ä¸ªä»»åŠ¡ | ${qCount} é“é¢˜ç›®
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button onclick="editProject('${p.project_id}')" class="btn btn-secondary" style="padding:6px 10px; font-size:0.75rem;">âœï¸ ç¼–è¾‘</button>
                                    <button onclick="deleteProject('${p.project_id}')" class="btn btn-danger" style="padding:6px 10px; font-size:0.75rem;">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                    });
                }
            });
            
            if (!html) {
                html = '<div style="text-align:center; padding:30px; color:#666;">æš‚æ— é¡¹ç›®ï¼Œè¯·å…ˆåˆ›å»ºé¡¹ç›®</div>';
            }
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°é¡¹ç›®çš„ä»»åŠ¡æ•°é‡å’Œé¢˜ç›®æ•°é‡
        async function updateProjectStats(projectId) {
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            const taskCount = projectTasks.length;
            const projectTaskIds = projectTasks.map(t => t.task_id);
            const questionCount = questions.filter(q => projectTaskIds.includes(q.task_id)).length;
            
            await supabaseClient.from('projects').update({
                task_count: taskCount,
                question_count: questionCount
            }).eq('project_id', projectId);
        }
        
        // åˆ é™¤é¡¹ç›®ï¼ˆçº§è”åˆ é™¤ä»»åŠ¡å’Œé¢˜ç›®ï¼‰
        async function deleteProject(projectId) {
            // è®¡ç®—å°†è¢«åˆ é™¤çš„ä»»åŠ¡å’Œé¢˜ç›®æ•°é‡
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            const taskCount = projectTasks.length;
            const projectTaskIds = projectTasks.map(t => t.task_id);
            const questionCount = questions.filter(q => projectTaskIds.includes(q.task_id)).length;
            
            const project = projects.find(p => p.project_id === projectId);
            const projectName = project ? project.name : 'è¯¥é¡¹ç›®';
            const course = project ? courses.find(c => c.course_id === project.course_id) : null;
            const courseName = course ? course.name : '';
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ŒåŒ…å«å°†è¢«åˆ é™¤çš„ä»»åŠ¡å’Œé¢˜ç›®æ•°é‡
            const confirmMsg = `ç¡®å®šè¦åˆ é™¤é¡¹ç›®ã€Œ${projectName}ã€å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\nâ€¢ ${taskCount} ä¸ªä»»åŠ¡\nâ€¢ ${questionCount} é“é¢˜ç›®\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // çº§è”åˆ é™¤ï¼šå…ˆåˆ é™¤é¢˜ç›®ï¼Œå†åˆ é™¤ä»»åŠ¡ï¼Œæœ€ååˆ é™¤é¡¹ç›®
                
                // 1. åˆ é™¤è¯¥é¡¹ç›®ä¸‹æ‰€æœ‰ä»»åŠ¡çš„é¢˜ç›®
                if (projectTaskIds.length > 0) {
                    const { error: qError } = await supabaseClient
                        .from('questions')
                        .delete()
                        .in('task_id', projectTaskIds);
                    if (qError) {
                        console.error('åˆ é™¤é¢˜ç›®å¤±è´¥:', qError);
                    }
                }
                
                // 2. åˆ é™¤è¯¥é¡¹ç›®ä¸‹çš„æ‰€æœ‰ä»»åŠ¡
                const { error: tError } = await supabaseClient
                    .from('tasks')
                    .delete()
                    .eq('project_id', projectId);
                if (tError) {
                    console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', tError);
                }
                
                // 3. åˆ é™¤é¡¹ç›®
                const { error } = await supabaseClient.from('projects').delete().eq('project_id', projectId);
                if (error) { 
                    alert('åˆ é™¤é¡¹ç›®å¤±è´¥: ' + error.message); 
                    return; 
                }
                
                // é‡ç½®ç­›é€‰çŠ¶æ€
                if (currentFilterType === 'project' && currentFilterId === projectId) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                } else if (currentFilterType === 'task' && projectTaskIds.includes(currentFilterId)) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                }
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadHierarchy();
                await loadQuestions();
                
                // åˆ·æ–°é¡¹ç›®åˆ—è¡¨å¼¹çª—ï¼ˆå¦‚æœæ‰“å¼€çš„è¯ï¼‰
                if (document.getElementById('projects-list-modal').style.display === 'flex') {
                    renderProjectsList();
                }
                
                alert(`âœ… å·²åˆ é™¤é¡¹ç›®ã€Œ${projectName}ã€åŠå…¶ä¸‹å± ${taskCount} ä¸ªä»»åŠ¡ã€${questionCount} é“é¢˜ç›®`);
                
            } catch (err) {
                console.error('åˆ é™¤é¡¹ç›®æ—¶å‘ç”Ÿé”™è¯¯:', err);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä»»åŠ¡ç®¡ç†å ä½å‡½æ•°ï¼ˆå°†åœ¨ä»»åŠ¡5ä¸­å®Œæ•´å®ç°ï¼‰
        function openAddTask() {
            alert('ä»»åŠ¡ç®¡ç†åŠŸèƒ½å°†åœ¨åç»­ä»»åŠ¡ä¸­å®ç°');
        }
        
        function editTask(taskId) {
            alert('ä»»åŠ¡ç¼–è¾‘åŠŸèƒ½å°†åœ¨åç»­ä»»åŠ¡ä¸­å®ç°');
        }
        
        function selectCourse(courseId) {
            currentCourse = courseId;
            currentCategory = 'all';
            loadCategories();
            loadQuestions();
        }
        
        function openAddCourse() {
            document.getElementById('course-modal-title').textContent = 'â• æ–°å»ºè¯¾ç¨‹';
            document.getElementById('edit-course-id').value = '';
            document.getElementById('course-name').value = '';
            document.getElementById('course-code').value = '';
            document.getElementById('course-teacher').value = '';
            document.getElementById('course-semester').value = '';
            document.getElementById('course-desc').value = '';
            // é‡ç½®é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.course-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
            document.querySelector('.course-color-opt').style.borderColor = 'white';
            document.querySelector('input[name="course-color"]').checked = true;
            document.getElementById('course-modal').style.display = 'flex';
        }
        
        async function editCourse(id) {
            const course = courses.find(c => c.course_id === id);
            if (!course) return;
            
            document.getElementById('course-modal-title').textContent = 'âœï¸ ç¼–è¾‘è¯¾ç¨‹';
            document.getElementById('edit-course-id').value = id;
            document.getElementById('course-name').value = course.name;
            document.getElementById('course-code').value = course.code || '';
            document.getElementById('course-teacher').value = course.teacher || '';
            document.getElementById('course-semester').value = course.semester || '';
            document.getElementById('course-desc').value = course.description || '';
            
            // é€‰ä¸­å¯¹åº”é¢œè‰²
            document.querySelectorAll('input[name="course-color"]').forEach(input => {
                if (input.value === course.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('course-modal').style.display = 'flex';
        }
        
        function closeCourseModal() {
            document.getElementById('course-modal').style.display = 'none';
        }
        
        async function saveCourse() {
            const id = document.getElementById('edit-course-id').value;
            const name = document.getElementById('course-name').value.trim();
            const code = document.getElementById('course-code').value.trim();
            const teacher = document.getElementById('course-teacher').value.trim();
            const semester = document.getElementById('course-semester').value.trim();
            const description = document.getElementById('course-desc').value.trim();
            const color = document.querySelector('input[name="course-color"]:checked')?.value || '#3b82f6';
            
            if (!name) { alert('è¯·è¾“å…¥è¯¾ç¨‹åç§°'); return; }
            
            const data = { name, code, teacher, semester, description, color };
            
            if (id) {
                // æ›´æ–°è¯¾ç¨‹æ—¶ä¿ç•™ç°æœ‰çš„ project_count å’Œ question_count
                const { error } = await supabaseClient.from('courses').update(data).eq('course_id', id);
                if (error) { alert('æ›´æ–°å¤±è´¥: ' + error.message); return; }
            } else {
                // æ–°å»ºè¯¾ç¨‹æ—¶åˆå§‹åŒ– project_count å’Œ question_count ä¸º 0
                data.project_count = 0;
                data.question_count = 0;
                const { error } = await supabaseClient.from('courses').insert([data]);
                if (error) { alert('åˆ›å»ºå¤±è´¥: ' + error.message); return; }
            }
            
            closeCourseModal();
            await loadHierarchy();
            alert('âœ… ä¿å­˜æˆåŠŸ');
        }
        
        async function deleteCourse(id) {
            // è®¡ç®—å°†è¢«åˆ é™¤çš„é¡¹ç›®ã€ä»»åŠ¡å’Œé¢˜ç›®æ•°é‡
            const courseProjects = projects.filter(p => p.course_id === id);
            const projectCount = courseProjects.length;
            const courseProjectIds = courseProjects.map(p => p.project_id);
            const courseTasks = tasks.filter(t => courseProjectIds.includes(t.project_id));
            const taskCount = courseTasks.length;
            const courseTaskIds = courseTasks.map(t => t.task_id);
            const questionCount = questions.filter(q => courseTaskIds.includes(q.task_id)).length;
            
            const course = courses.find(c => c.course_id === id);
            const courseName = course ? course.name : 'è¯¥è¯¾ç¨‹';
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ŒåŒ…å«å°†è¢«åˆ é™¤çš„é¡¹ç›®æ•°é‡
            const confirmMsg = `ç¡®å®šè¦åˆ é™¤è¯¾ç¨‹ã€Œ${courseName}ã€å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\nâ€¢ ${projectCount} ä¸ªé¡¹ç›®\nâ€¢ ${taskCount} ä¸ªä»»åŠ¡\nâ€¢ ${questionCount} é“é¢˜ç›®\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // çº§è”åˆ é™¤ï¼šå…ˆåˆ é™¤é¢˜ç›®ï¼Œå†åˆ é™¤ä»»åŠ¡ï¼Œå†åˆ é™¤é¡¹ç›®ï¼Œæœ€ååˆ é™¤è¯¾ç¨‹
                // ç”±äºæ•°æ®åº“è®¾ç½®äº† ON DELETE CASCADEï¼Œåªéœ€åˆ é™¤è¯¾ç¨‹å³å¯
                // ä½†ä¸ºäº†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æŒ‰é¡ºåºåˆ é™¤
                
                // 1. åˆ é™¤è¯¥è¯¾ç¨‹ä¸‹æ‰€æœ‰ä»»åŠ¡çš„é¢˜ç›®
                if (courseTaskIds.length > 0) {
                    const { error: qError } = await supabaseClient
                        .from('questions')
                        .delete()
                        .in('task_id', courseTaskIds);
                    if (qError) {
                        console.error('åˆ é™¤é¢˜ç›®å¤±è´¥:', qError);
                    }
                }
                
                // 2. åˆ é™¤è¯¥è¯¾ç¨‹ä¸‹æ‰€æœ‰é¡¹ç›®çš„ä»»åŠ¡
                if (courseProjectIds.length > 0) {
                    const { error: tError } = await supabaseClient
                        .from('tasks')
                        .delete()
                        .in('project_id', courseProjectIds);
                    if (tError) {
                        console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', tError);
                    }
                }
                
                // 3. åˆ é™¤è¯¥è¯¾ç¨‹ä¸‹çš„æ‰€æœ‰é¡¹ç›®
                const { error: pError } = await supabaseClient
                    .from('projects')
                    .delete()
                    .eq('course_id', id);
                if (pError) {
                    console.error('åˆ é™¤é¡¹ç›®å¤±è´¥:', pError);
                }
                
                // 4. åˆ é™¤è¯¾ç¨‹
                const { error } = await supabaseClient.from('courses').delete().eq('course_id', id);
                if (error) { 
                    alert('åˆ é™¤è¯¾ç¨‹å¤±è´¥: ' + error.message); 
                    return; 
                }
                
                // é‡ç½®ç­›é€‰çŠ¶æ€
                if (currentFilterType === 'course' && currentFilterId === id) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                }
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadHierarchy();
                await loadQuestions();
                
                alert(`âœ… å·²åˆ é™¤è¯¾ç¨‹ã€Œ${courseName}ã€åŠå…¶ä¸‹å± ${projectCount} ä¸ªé¡¹ç›®ã€${taskCount} ä¸ªä»»åŠ¡ã€${questionCount} é“é¢˜ç›®`);
                
            } catch (err) {
                console.error('åˆ é™¤è¯¾ç¨‹æ—¶å‘ç”Ÿé”™è¯¯:', err);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function manageCourses() {
            // ç¡®ä¿æ•°æ®å·²åŠ è½½åå†æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
            renderCoursesList();
            document.getElementById('courses-list-modal').style.display = 'flex';
        }
        
        // æ‰“å¼€è¯¾ç¨‹ç®¡ç†åˆ—è¡¨å¼¹çª—
        function openCoursesListModal() {
            renderCoursesList();
            document.getElementById('courses-list-modal').style.display = 'flex';
        }
        
        function closeCoursesListModal() {
            document.getElementById('courses-list-modal').style.display = 'none';
        }
        
        function renderCoursesList() {
            const container = document.getElementById('courses-list-content');
            if (courses.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">æš‚æ— è¯¾ç¨‹ï¼Œè¯·å…ˆåˆ›å»ºè¯¾ç¨‹</div>';
                return;
            }
            
            container.innerHTML = courses.map(c => {
                // è®¡ç®—é¡¹ç›®æ•°é‡
                const projectCount = projects.filter(p => p.course_id === c.course_id).length;
                // è®¡ç®—ä»»åŠ¡æ•°é‡
                const courseProjectIds = projects.filter(p => p.course_id === c.course_id).map(p => p.project_id);
                const taskCount = tasks.filter(t => courseProjectIds.includes(t.project_id)).length;
                // è®¡ç®—é¢˜ç›®æ•°é‡
                const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
                const qCount = questions.filter(q => courseTaskIds.includes(q.task_id)).length;
                
                return `
                    <div style="display:flex; align-items:center; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:10px; border-left:4px solid ${c.color};">
                        <div style="font-size:2rem; margin-right:15px;">${c.icon || 'ğŸ“–'}</div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:1.1rem;">${c.name}</div>
                            <div style="font-size:0.85rem; color:#94a3b8; margin-top:3px;">
                                ${c.code ? `ä»£ç : ${c.code} | ` : ''}${c.teacher ? `æ•™å¸ˆ: ${c.teacher} | ` : ''}${projectCount} ä¸ªé¡¹ç›® | ${taskCount} ä¸ªä»»åŠ¡ | ${qCount} é“é¢˜ç›®
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="editCourse('${c.course_id}')" class="btn btn-secondary" style="padding:8px 12px; font-size:0.8rem;">âœï¸ ç¼–è¾‘</button>
                            <button onclick="deleteCourse('${c.course_id}')" class="btn btn-danger" style="padding:8px 12px; font-size:0.8rem;">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ================== åˆ†ç±»ç®¡ç† ==================
        async function loadCategories() {
            let query = supabaseClient.from('question_categories').select('*').order('sort_order');
            
            // å¦‚æœé€‰æ‹©äº†ç‰¹å®šè¯¾ç¨‹ï¼Œåªæ˜¾ç¤ºè¯¥è¯¾ç¨‹çš„åˆ†ç±»
            if (currentCourse !== 'all') {
                query = query.eq('course_id', currentCourse);
            }
            
            const { data, error } = await query;
            if (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                if (error.code === '42P01') {
                    alert('è¯·å…ˆæ‰§è¡Œ questionbank_v2.sql åˆ›å»ºæ•°æ®åº“è¡¨');
                }
                return;
            }
            categories = data || [];
            renderCategories();
            updateCategorySelects();
        }
        
        function renderCategories() {
            const list = document.getElementById('category-list');
            const totalCount = questions.length;
            
            // æŒ‰è¯¾ç¨‹åˆ†ç»„æ˜¾ç¤ºåˆ†ç±»
            let html = `
                <div class="category-item ${currentCategory === 'all' ? 'active' : ''}" data-id="all" onclick="selectCategory('all')">
                    <div class="category-color" style="background:#3b82f6;"></div>
                    <span class="category-name">å…¨éƒ¨é¢˜ç›®</span>
                    <span class="category-count" id="total-count">${totalCount}</span>
                </div>
            `;
            
            if (currentCourse === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰è¯¾ç¨‹çš„åˆ†ç±»ï¼ŒæŒ‰è¯¾ç¨‹åˆ†ç»„
                courses.forEach(course => {
                    const courseCats = categories.filter(c => c.course_id === course.course_id);
                    if (courseCats.length > 0) {
                        html += `<div style="font-size:0.75rem; color:${course.color}; margin:15px 0 8px 0; font-weight:bold;">${course.icon || 'ğŸ“–'} ${course.name}</div>`;
                        courseCats.forEach(cat => {
                            const count = questions.filter(q => q.category_id === cat.category_id).length;
                            html += renderCategoryItem(cat, count);
                        });
                    }
                });
                
                // æœªåˆ†ç±»çš„åˆ†ç±»
                const uncategorized = categories.filter(c => !c.course_id);
                if (uncategorized.length > 0) {
                    html += `<div style="font-size:0.75rem; color:#94a3b8; margin:15px 0 8px 0; font-weight:bold;">ğŸ“ æœªå½’ç±»</div>`;
                    uncategorized.forEach(cat => {
                        const count = questions.filter(q => q.category_id === cat.category_id).length;
                        html += renderCategoryItem(cat, count);
                    });
                }
            } else {
                // åªæ˜¾ç¤ºå½“å‰è¯¾ç¨‹çš„åˆ†ç±»
                categories.forEach(cat => {
                    const count = questions.filter(q => q.category_id === cat.category_id).length;
                    html += renderCategoryItem(cat, count);
                });
            }
            
            list.innerHTML = html;
        }
        
        function renderCategoryItem(cat, count) {
            return `
                <div class="category-item ${currentCategory === cat.category_id ? 'active' : ''}" data-id="${cat.category_id}" onclick="selectCategory('${cat.category_id}')">
                    <div class="category-color" style="background:${cat.color};"></div>
                    <span class="category-name">${cat.name}</span>
                    <span class="category-count">${count}</span>
                    <button onclick="event.stopPropagation(); editCategory('${cat.category_id}')" style="background:none; border:none; color:#94a3b8; cursor:pointer; padding:2px 5px;">âœï¸</button>
                </div>
            `;
        }
        
        function selectCategory(id) {
            currentCategory = id;
            renderCategories();
            loadQuestions();
        }
        
        function updateCategorySelects() {
            const selects = ['import-category', 'q-category'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">æœªåˆ†ç±»</option>' + 
                        categories.map(c => `<option value="${c.category_id}">${c.name}</option>`).join('');
                }
            });
        }
        
        function openAddCategory() {
            document.getElementById('category-modal-title').textContent = 'â• æ–°å»ºåˆ†ç±»';
            document.getElementById('edit-category-id').value = '';
            document.getElementById('category-name').value = '';
            document.getElementById('category-subject').value = '';
            document.getElementById('category-desc').value = '';
            // æ›´æ–°è¯¾ç¨‹é€‰æ‹©åˆ—è¡¨
            updateCourseSelects();
            // å¦‚æœå½“å‰é€‰æ‹©äº†è¯¾ç¨‹ï¼Œé»˜è®¤é€‰ä¸­è¯¥è¯¾ç¨‹
            const catCourseSelect = document.getElementById('category-course');
            if (catCourseSelect) {
                catCourseSelect.value = currentCourse !== 'all' ? currentCourse : '';
            }
            // é‡ç½®é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.color-option').forEach(opt => opt.style.borderColor = 'transparent');
            document.querySelector('.color-option').style.borderColor = 'white';
            document.querySelector('input[name="category-color"]').checked = true;
            document.getElementById('category-modal').style.display = 'flex';
        }
        
        async function editCategory(id) {
            // éœ€è¦ä»æ•°æ®åº“é‡æ–°è·å–ï¼Œå› ä¸ºå¯èƒ½ä¸åœ¨å½“å‰ç­›é€‰çš„categoriesä¸­
            const { data: cat } = await supabaseClient.from('question_categories').select('*').eq('category_id', id).single();
            if (!cat) return;
            
            document.getElementById('category-modal-title').textContent = 'âœï¸ ç¼–è¾‘åˆ†ç±»';
            document.getElementById('edit-category-id').value = id;
            document.getElementById('category-name').value = cat.name;
            document.getElementById('category-subject').value = cat.subject || '';
            document.getElementById('category-desc').value = cat.description || '';
            
            // æ›´æ–°è¯¾ç¨‹é€‰æ‹©åˆ—è¡¨å¹¶é€‰ä¸­
            updateCourseSelects();
            const catCourseSelect = document.getElementById('category-course');
            if (catCourseSelect) {
                catCourseSelect.value = cat.course_id || '';
            }
            
            // é€‰ä¸­å¯¹åº”é¢œè‰²
            document.querySelectorAll('input[name="category-color"]').forEach(input => {
                if (input.value === cat.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('category-modal').style.display = 'flex';
        }
        
        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
        }
        
        async function saveCategory() {
            const id = document.getElementById('edit-category-id').value;
            const name = document.getElementById('category-name').value.trim();
            const courseId = document.getElementById('category-course').value || null;
            const subject = document.getElementById('category-subject').value.trim();
            const description = document.getElementById('category-desc').value.trim();
            const color = document.querySelector('input[name="category-color"]:checked')?.value || '#3b82f6';
            
            if (!name) { alert('è¯·è¾“å…¥åˆ†ç±»åç§°'); return; }
            
            const data = { name, course_id: courseId, subject, description, color };
            
            if (id) {
                const { error } = await supabaseClient.from('question_categories').update(data).eq('category_id', id);
                if (error) { alert('æ›´æ–°å¤±è´¥: ' + error.message); return; }
            } else {
                const { error } = await supabaseClient.from('question_categories').insert([data]);
                if (error) { alert('åˆ›å»ºå¤±è´¥: ' + error.message); return; }
            }
            
            closeCategoryModal();
            loadCategories();
            loadCourses(); // åˆ·æ–°è¯¾ç¨‹ç»Ÿè®¡
            alert('âœ… ä¿å­˜æˆåŠŸ');
        }

        // ================== é¢˜ç›®ç®¡ç† ==================
        async function loadQuestions() {
            let query = supabaseClient.from('questions').select('*').order('round');
            
            // ç­›é€‰æ¡ä»¶
            const typeFilter = document.getElementById('filter-type')?.value;
            const difficultyFilter = document.getElementById('filter-difficulty')?.value;
            const searchText = document.getElementById('search-input')?.value?.toLowerCase();
            
            if (typeFilter) query = query.eq('question_type', typeFilter);
            if (difficultyFilter) query = query.eq('difficulty', parseInt(difficultyFilter));
            
            const { data, error } = await query;
            if (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                document.getElementById('question-list').innerHTML = '<div style="text-align:center; padding:50px; color:#ef4444;">åŠ è½½å¤±è´¥</div>';
                return;
            }
            
            questions = data || [];
            
            // æ ¹æ®å±‚çº§ç­›é€‰
            let filtered = questions;
            if (currentFilterType === 'task' && currentFilterId !== 'all') {
                filtered = questions.filter(q => q.task_id === currentFilterId);
            } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                const projectTaskIds = tasks.filter(t => t.project_id === currentFilterId).map(t => t.task_id);
                filtered = questions.filter(q => projectTaskIds.includes(q.task_id));
            } else if (currentFilterType === 'course' && currentFilterId !== 'all') {
                const courseProjectIds = projects.filter(p => p.course_id === currentFilterId).map(p => p.project_id);
                const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
                filtered = questions.filter(q => courseTaskIds.includes(q.task_id));
            }
            
            // æœç´¢è¿‡æ»¤
            if (searchText) {
                filtered = filtered.filter(q => q.title.toLowerCase().includes(searchText) || (q.knowledge_tag || '').toLowerCase().includes(searchText));
            }
            
            renderQuestions(filtered);
            updateStats();
            renderHierarchyTree();
        }
        
        function renderQuestions(list) {
            const container = document.getElementById('question-list');
            
            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#666;">æš‚æ— é¢˜ç›®</div>';
                return;
            }
            
            container.innerHTML = list.map(q => {
                const type = typeConfig[q.question_type] || typeConfig.single;
                const task = tasks.find(t => t.task_id === q.task_id);
                const project = task ? projects.find(p => p.project_id === task.project_id) : null;
                const course = project ? courses.find(c => c.course_id === project.course_id) : null;
                const difficulty = 'â­'.repeat(q.difficulty || 1);
                
                // æ„å»ºå±‚çº§è·¯å¾„æ˜¾ç¤º
                let hierarchyPath = '';
                if (task) {
                    hierarchyPath = `<span style="background:${task.color}20; color:${task.color}; padding:2px 8px; border-radius:4px; font-size:0.75rem;" title="${course?.name || ''} > ${project?.name || ''} > ${task.name}">${task.name}</span>`;
                }
                
                return `
                    <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; display:flex; gap:15px; align-items:flex-start;">
                        <div style="min-width:50px; text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#3b82f6;">${q.round}</div>
                            <div style="font-size:0.7rem; color:#94a3b8;">åºå·</div>
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
                                <span style="background:${type.color}; color:white; padding:2px 8px; border-radius:4px; font-size:0.75rem;">${type.icon} ${type.name}</span>
                                ${hierarchyPath}
                                ${q.knowledge_tag ? `<span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:0.75rem;">${q.knowledge_tag}</span>` : ''}
                                <span style="font-size:0.75rem; color:#f59e0b;">${difficulty}</span>
                            </div>
                            <div style="font-size:0.95rem; line-height:1.5; margin-bottom:8px;">${q.title}</div>
                            ${q.question_type !== 'fillblank' && q.question_type !== 'truefalse' ? `
                                <div style="display:flex; gap:15px; flex-wrap:wrap; font-size:0.85rem; color:#94a3b8;">
                                    ${q.option_a ? `<span>A. ${q.option_a.substring(0, 20)}${q.option_a.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_b ? `<span>B. ${q.option_b.substring(0, 20)}${q.option_b.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_c ? `<span>C. ${q.option_c.substring(0, 20)}${q.option_c.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_d ? `<span>D. ${q.option_d.substring(0, 20)}${q.option_d.length > 20 ? '...' : ''}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-end;">
                            <div style="background:#10b981; color:white; padding:5px 12px; border-radius:6px; font-weight:bold;">${q.answer}</div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="editQuestion(${q.round})" class="btn btn-secondary" style="padding:5px 10px; font-size:0.75rem;">âœï¸ ç¼–è¾‘</button>
                                <button onclick="deleteQuestion(${q.round})" class="btn btn-danger" style="padding:5px 10px; font-size:0.75rem;">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats() {
            const stats = { single: 0, multiple: 0, truefalse: 0, fillblank: 0 };
            questions.forEach(q => {
                const type = q.question_type || 'single';
                if (stats[type] !== undefined) stats[type]++;
            });
            
            document.getElementById('stat-single').textContent = stats.single;
            document.getElementById('stat-multiple').textContent = stats.multiple;
            document.getElementById('stat-truefalse').textContent = stats.truefalse;
            document.getElementById('stat-fillblank').textContent = stats.fillblank;
            document.getElementById('total-count').textContent = questions.length;
        }
        
        // æœç´¢å’Œç­›é€‰
        document.getElementById('search-input')?.addEventListener('input', debounce(loadQuestions, 300));
        document.getElementById('filter-type')?.addEventListener('change', loadQuestions);
        document.getElementById('filter-difficulty')?.addEventListener('change', loadQuestions);
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ================== æ·»åŠ /ç¼–è¾‘é¢˜ç›® ==================
        async function openAddQuestion() {
            // è·å–ä¸‹ä¸€ä¸ªå¯ç”¨åºå·
            const { data } = await supabaseClient.from('questions').select('round').order('round', { ascending: false }).limit(1);
            const nextRound = (data && data[0]) ? data[0].round + 1 : 1;
            
            document.getElementById('question-modal-title').textContent = 'â• æ·»åŠ é¢˜ç›®';
            document.getElementById('edit-question-id').value = '';
            document.getElementById('q-round').value = nextRound;
            document.getElementById('q-type').value = 'single';
            document.getElementById('q-category').value = currentCategory !== 'all' ? currentCategory : '';
            document.getElementById('q-title').value = '';
            document.getElementById('q-opt-a').value = '';
            document.getElementById('q-opt-b').value = '';
            document.getElementById('q-opt-c').value = '';
            document.getElementById('q-opt-d').value = '';
            document.getElementById('q-answer').value = '';
            document.getElementById('q-tag').value = '';
            document.getElementById('q-difficulty').value = '1';
            document.getElementById('q-explanation').value = '';
            
            updateQuestionForm();
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        async function editQuestion(round) {
            const { data: q } = await supabaseClient.from('questions').select('*').eq('round', round).single();
            if (!q) { alert('é¢˜ç›®ä¸å­˜åœ¨'); return; }
            
            document.getElementById('question-modal-title').textContent = 'âœï¸ ç¼–è¾‘é¢˜ç›®';
            document.getElementById('edit-question-id').value = q.id;
            document.getElementById('q-round').value = q.round;
            document.getElementById('q-type').value = q.question_type || 'single';
            document.getElementById('q-category').value = q.category_id || '';
            document.getElementById('q-title').value = q.title;
            document.getElementById('q-opt-a').value = q.option_a || '';
            document.getElementById('q-opt-b').value = q.option_b || '';
            document.getElementById('q-opt-c').value = q.option_c || '';
            document.getElementById('q-opt-d').value = q.option_d || '';
            document.getElementById('q-answer').value = q.answer;
            document.getElementById('q-tag').value = q.knowledge_tag || '';
            document.getElementById('q-difficulty').value = q.difficulty || 1;
            document.getElementById('q-explanation').value = q.explanation || '';
            
            updateQuestionForm();
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        function updateQuestionForm() {
            const type = document.getElementById('q-type').value;
            const optionsArea = document.getElementById('options-area');
            
            if (type === 'truefalse') {
                optionsArea.innerHTML = `
                    <div style="margin-bottom:15px; color:#94a3b8;">
                        åˆ¤æ–­é¢˜æ— éœ€å¡«å†™é€‰é¡¹ï¼Œç­”æ¡ˆè¯·å¡«å†™ï¼šå¯¹/é”™ æˆ– T/F
                    </div>
                `;
            } else if (type === 'fillblank') {
                optionsArea.innerHTML = `
                    <div style="margin-bottom:15px; color:#94a3b8;">
                        å¡«ç©ºé¢˜æ— éœ€å¡«å†™é€‰é¡¹ï¼Œé¢˜ç›®ä¸­ç”¨ ____ è¡¨ç¤ºå¡«ç©ºä½ç½®ï¼Œç­”æ¡ˆå¡«å†™æ ‡å‡†ç­”æ¡ˆ
                    </div>
                `;
            } else {
                optionsArea.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹A</label><input id="q-opt-a" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹B</label><input id="q-opt-b" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹C</label><input id="q-opt-c" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹D</label><input id="q-opt-d" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    </div>
                `;
            }
        }
        
        function closeQuestionModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        async function saveQuestion() {
            const round = parseInt(document.getElementById('q-round').value);
            const type = document.getElementById('q-type').value;
            const categoryId = document.getElementById('q-category').value || null;
            const title = document.getElementById('q-title').value.trim();
            const answer = document.getElementById('q-answer').value.trim().toUpperCase();
            const tag = document.getElementById('q-tag').value.trim() || null;
            const difficulty = parseInt(document.getElementById('q-difficulty').value);
            const explanation = document.getElementById('q-explanation').value.trim() || null;
            
            if (!round || !title || !answer) {
                alert('è¯·å¡«å†™åºå·ã€é¢˜ç›®å’Œç­”æ¡ˆ');
                return;
            }
            
            const data = {
                round,
                question_type: type,
                category_id: categoryId,
                title,
                option_a: document.getElementById('q-opt-a')?.value || null,
                option_b: document.getElementById('q-opt-b')?.value || null,
                option_c: document.getElementById('q-opt-c')?.value || null,
                option_d: document.getElementById('q-opt-d')?.value || null,
                answer,
                knowledge_tag: tag,
                difficulty,
                explanation,
                updated_at: new Date().toISOString()
            };
            
            const { error } = await supabaseClient.from('questions').upsert(data, { onConflict: 'round' });
            
            if (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                return;
            }
            
            closeQuestionModal();
            loadQuestions();
            alert('âœ… ä¿å­˜æˆåŠŸ');
        }
        
        async function deleteQuestion(round) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${round} é¢˜å—ï¼Ÿ`)) return;
            
            const { error } = await supabaseClient.from('questions').delete().eq('round', round);
            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
                return;
            }
            
            loadQuestions();
        }

        // ================== å¯¼å…¥åŠŸèƒ½ ==================
        function openImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
            document.getElementById('import-preview').style.display = 'none';
            pendingImport = [];
            updateCategorySelects();
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }
        
        function handleFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) processFile(file);
        }
        
        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('è¯·é€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const type = document.getElementById('import-type').value;
                pendingImport = parseCSV(text, type);
                
                if (pendingImport.length === 0) {
                    alert('æœªèƒ½è§£æå‡ºæœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼');
                    return;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('import-preview').style.display = 'block';
                document.getElementById('preview-count').textContent = pendingImport.length;
                document.getElementById('preview-list').innerHTML = pendingImport.slice(0, 5).map((q, i) => `
                    <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.85rem;">
                        <strong>${i + 1}.</strong> ${q.title.substring(0, 60)}${q.title.length > 60 ? '...' : ''} 
                        <span style="color:#10b981;">[${q.answer}]</span>
                    </div>
                `).join('') + (pendingImport.length > 5 ? `<div style="padding:8px; color:#94a3b8; font-size:0.8rem;">... è¿˜æœ‰ ${pendingImport.length - 5} é“é¢˜ç›®</div>` : '');
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        function parseCSV(text, type) {
            const lines = text.trim().split('\n');
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cells = parseCSVLine(line);
                if (cells.length < 2) continue;
                
                let q = { question_type: type };
                
                if (type === 'single' || type === 'multiple') {
                    // é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦
                    if (cells.length < 6) continue;
                    q.title = cells[0];
                    q.option_a = cells[1];
                    q.option_b = cells[2];
                    q.option_c = cells[3];
                    q.option_d = cells[4];
                    q.answer = cells[5].toUpperCase();
                    q.knowledge_tag = cells[6] || null;
                    q.difficulty = parseInt(cells[7]) || 1;
                } else if (type === 'truefalse') {
                    // é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦
                    q.title = cells[0];
                    let ans = cells[1].trim().toLowerCase();
                    q.answer = (ans === 'å¯¹' || ans === 't' || ans === 'true' || ans === 'æ­£ç¡®') ? 'å¯¹' : 'é”™';
                    q.knowledge_tag = cells[2] || null;
                    q.difficulty = parseInt(cells[3]) || 1;
                } else if (type === 'fillblank') {
                    // é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦
                    q.title = cells[0];
                    q.answer = cells[1];
                    q.knowledge_tag = cells[2] || null;
                    q.difficulty = parseInt(cells[3]) || 1;
                }
                
                questions.push(q);
            }
            
            return questions;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        async function confirmImport() {
            if (pendingImport.length === 0) {
                alert('æ²¡æœ‰å¾…å¯¼å…¥çš„é¢˜ç›®');
                return;
            }
            
            const categoryId = document.getElementById('import-category').value || null;
            const clearBefore = document.getElementById('clear-before-import').checked;
            const startRound = parseInt(document.getElementById('start-round').value) || 1;
            
            // å¦‚æœéœ€è¦æ¸…ç©º
            if (clearBefore && categoryId) {
                await supabaseClient.from('questions').delete().eq('category_id', categoryId);
            }
            
            // æ·»åŠ åºå·å’Œåˆ†ç±»
            const questionsToInsert = pendingImport.map((q, i) => ({
                ...q,
                round: startRound + i,
                category_id: categoryId
            }));
            
            const { error } = await supabaseClient.from('questions').upsert(questionsToInsert, { onConflict: 'round' });
            
            if (error) {
                alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                return;
            }
            
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${questionsToInsert.length} é“é¢˜ç›®`);
            closeImportModal();
            loadQuestions();
            loadCategories();
        }
        
        // ================== æ ¼å¼è¯´æ˜ ==================
        function openFormatHelp() {
            document.getElementById('format-modal').style.display = 'flex';
        }
        
        function closeFormatHelp() {
            document.getElementById('format-modal').style.display = 'none';
        }
    </script>
</body>
</html>
