<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š é¢˜åº“ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 15px; }
        .header h1 { font-size: 1.8rem; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        
        .main-content { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* å·¦ä¾§åˆ†ç±»æ  */
        .sidebar { background: #1e293b; border-radius: 15px; padding: 20px; height: fit-content; }
        .sidebar h3 { margin-bottom: 15px; color: #94a3b8; font-size: 0.9rem; }
        .category-list { display: flex; flex-direction: column; gap: 8px; }
        .category-item { display: flex; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .category-item:hover { background: rgba(255,255,255,0.1); }
        .category-item.active { background: rgba(59,130,246,0.3); border-left: 3px solid #3b82f6; }
        .category-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .category-name { flex: 1; font-size: 0.95rem; }
        .category-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
        .add-category { margin-top: 15px; padding: 12px; background: rgba(16,185,129,0.2); border: 2px dashed #10b981; border-radius: 10px; text-align: center; cursor: pointer; color: #10b981; }
        .add-category:hover { background: rgba(16,185,129,0.3); }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“š é¢˜åº“ç®¡ç†ä¸­å¿ƒ</h1>
                <p style="color:#94a3b8; margin-top:5px;">ç®¡ç†å¤šè¯¾ç¨‹é¢˜åº“ï¼Œæ”¯æŒå¤šç§é¢˜å‹</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥é¢˜ç›®</button>
                <button class="btn btn-primary" onclick="openAddQuestion()">â• æ·»åŠ é¢˜ç›®</button>
                <button class="btn btn-secondary" onclick="openFormatHelp()">â“ æ ¼å¼è¯´æ˜</button>
                <a href="/classroom/presentation.html" class="btn btn-warning">ğŸ¬ è¿”å›è¯¾ä»¶</a>
            </div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§åˆ†ç±»æ  -->
            <div class="sidebar">
                <h3>ğŸ“‚ é¢˜åº“åˆ†ç±»</h3>
                <div class="category-list" id="category-list">
                    <div class="category-item active" data-id="all">
                        <div class="category-color" style="background:#3b82f6;"></div>
                        <span class="category-name">å…¨éƒ¨é¢˜ç›®</span>
                        <span class="category-count" id="total-count">0</span>
                    </div>
                </div>
                <div class="add-category" onclick="openAddCategory()">â• æ–°å»ºåˆ†ç±»</div>
                
                <h3 style="margin-top:25px;">ğŸ“Š é¢˜å‹ç»Ÿè®¡</h3>
                <div id="type-stats" style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">å•é€‰é¢˜</span>
                        <span id="stat-single">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">å¤šé€‰é¢˜</span>
                        <span id="stat-multiple">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">åˆ¤æ–­é¢˜</span>
                        <span id="stat-truefalse">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span style="color:#94a3b8;">å¡«ç©ºé¢˜</span>
                        <span id="stat-fillblank">0</span>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢˜ç›®åˆ—è¡¨ -->
            <div class="content-area" style="background:#1e293b; border-radius:15px; padding:20px;">
                <!-- ç­›é€‰æ  -->
                <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
                    <input type="text" id="search-input" placeholder="ğŸ” æœç´¢é¢˜ç›®..." style="flex:1; min-width:200px; padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <select id="filter-type" style="padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">å…¨éƒ¨é¢˜å‹</option>
                        <option value="single">å•é€‰é¢˜</option>
                        <option value="multiple">å¤šé€‰é¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                    </select>
                    <select id="filter-difficulty" style="padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">å…¨éƒ¨éš¾åº¦</option>
                        <option value="1">â­ ç®€å•</option>
                        <option value="2">â­â­ è¾ƒæ˜“</option>
                        <option value="3">â­â­â­ ä¸­ç­‰</option>
                        <option value="4">â­â­â­â­ è¾ƒéš¾</option>
                        <option value="5">â­â­â­â­â­ å›°éš¾</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadQuestions()">ğŸ”„ åˆ·æ–°</button>
                </div>
                
                <!-- é¢˜ç›®åˆ—è¡¨ -->
                <div id="question-list" style="display:flex; flex-direction:column; gap:12px;">
                    <div style="text-align:center; padding:50px; color:#666;">åŠ è½½ä¸­...</div>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div id="pagination" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥é¢˜ç›®å¼¹çª— -->
    <div id="import-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“¥ å¯¼å…¥é¢˜ç›®</h2>
                <button onclick="closeImportModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é€‰æ‹©åˆ†ç±»</label>
                    <select id="import-category" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®ç±»å‹</label>
                    <select id="import-type" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">å•é€‰é¢˜</option>
                        <option value="multiple">å¤šé€‰é¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                    </select>
                </div>
            </div>
            
            <div style="background:rgba(59,130,246,0.1); border:2px dashed #3b82f6; border-radius:15px; padding:40px; text-align:center; margin-bottom:20px;" id="drop-area">
                <div style="font-size:3rem; margin-bottom:10px;">ğŸ“„</div>
                <div style="margin-bottom:15px;">æ‹–æ‹½CSVæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                <input type="file" id="file-input" accept=".csv" style="display:none;" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('file-input').click()" class="btn btn-primary">é€‰æ‹©CSVæ–‡ä»¶</button>
            </div>
            
            <div id="import-preview" style="display:none;">
                <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ é¢„è§ˆ (<span id="preview-count">0</span> é“é¢˜ç›®)</div>
                <div id="preview-list" style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; margin-bottom:15px;"></div>
                <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="clear-before-import"> æ¸…ç©ºè¯¥åˆ†ç±»ç°æœ‰é¢˜ç›®
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        èµ·å§‹åºå·: <input type="number" id="start-round" value="1" min="1" style="width:80px; padding:5px; border-radius:5px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    </label>
                </div>
                <button onclick="confirmImport()" class="btn btn-success" style="width:100%; padding:15px;">âœ… ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <!-- æ ¼å¼è¯´æ˜å¼¹çª— -->
    <div id="format-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ğŸ“‹ CSVæ ¼å¼è¯´æ˜</h2>
                <button onclick="closeFormatHelp()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <div style="display:grid; gap:20px;">
                <!-- å•é€‰é¢˜æ ¼å¼ -->
                <div style="background:rgba(59,130,246,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#3b82f6; margin-bottom:10px;">ğŸ“Œ å•é€‰é¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"1+1ç­‰äºå¤šå°‘ï¼Ÿ","1","2","3","4",B,æ•°å­¦åŸºç¡€,1<br>
"æ°´çš„åŒ–å­¦å¼æ˜¯ï¼Ÿ","H2O","CO2","O2","N2",A,åŒ–å­¦åŸºç¡€,2
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">ç­”æ¡ˆå¡«å†™ï¼šA/B/C/Dï¼ˆå•ä¸ªå­—æ¯ï¼‰</p>
                </div>
                
                <!-- å¤šé€‰é¢˜æ ¼å¼ -->
                <div style="background:rgba(139,92,246,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#8b5cf6; margin-bottom:10px;">ğŸ“Œ å¤šé€‰é¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"ä»¥ä¸‹å“ªäº›æ˜¯ç¼–ç¨‹è¯­è¨€ï¼Ÿ","Python","Excel","Java","Word",AC,è®¡ç®—æœºåŸºç¡€,2<br>
"å“ªäº›å±äºå¯å†ç”Ÿèƒ½æºï¼Ÿ","å¤ªé˜³èƒ½","ç…¤ç‚­","é£èƒ½","çŸ³æ²¹",AC,ç¯å¢ƒç§‘å­¦,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">ç­”æ¡ˆå¡«å†™ï¼šå¤šä¸ªå­—æ¯è¿å†™ï¼Œå¦‚ ABã€ACDã€ABCD</p>
                </div>
                
                <!-- åˆ¤æ–­é¢˜æ ¼å¼ -->
                <div style="background:rgba(16,185,129,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#10b981; margin-bottom:10px;">ğŸ“Œ åˆ¤æ–­é¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"åœ°çƒæ˜¯å¤ªé˜³ç³»ä¸­æœ€å¤§çš„è¡Œæ˜Ÿ",é”™,å¤©æ–‡å­¦,1<br>
"æ°´åœ¨æ ‡å‡†å¤§æ°”å‹ä¸‹100â„ƒæ²¸è…¾",å¯¹,ç‰©ç†å­¦,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">ç­”æ¡ˆå¡«å†™ï¼šå¯¹/é”™ æˆ– T/F æˆ– true/false</p>
                </div>
                
                <!-- å¡«ç©ºé¢˜æ ¼å¼ -->
                <div style="background:rgba(245,158,11,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#f59e0b; margin-bottom:10px;">ğŸ“Œ å¡«ç©ºé¢˜æ ¼å¼</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦<br>
"ä¸­å›½çš„é¦–éƒ½æ˜¯____",åŒ—äº¬,åœ°ç†å¸¸è¯†,1<br>
"1åƒå…‹ç­‰äº____å…‹",1000,å•ä½æ¢ç®—,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">é¢˜ç›®ä¸­ç”¨ ____ è¡¨ç¤ºå¡«ç©ºä½ç½®ï¼Œç­”æ¡ˆä¸ºæ ‡å‡†ç­”æ¡ˆ</p>
                </div>
            </div>
            
            <div style="margin-top:20px; padding:15px; background:rgba(239,68,68,0.1); border-radius:10px;">
                <h4 style="color:#ef4444; margin-bottom:8px;">âš ï¸ æ³¨æ„äº‹é¡¹</h4>
                <ul style="color:#94a3b8; font-size:0.85rem; padding-left:20px; line-height:1.8;">
                    <li>CSVæ–‡ä»¶éœ€ä½¿ç”¨UTF-8ç¼–ç ä¿å­˜</li>
                    <li>ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œï¼Œä¼šè¢«è‡ªåŠ¨è·³è¿‡</li>
                    <li>é¢˜ç›®å†…å®¹å¦‚åŒ…å«é€—å·ï¼Œéœ€ç”¨è‹±æ–‡åŒå¼•å·åŒ…è£¹</li>
                    <li>çŸ¥è¯†ç‚¹å’Œéš¾åº¦ä¸ºå¯é€‰å­—æ®µï¼Œå¯çœç•¥</li>
                    <li>éš¾åº¦èŒƒå›´ï¼š1-5ï¼ˆ1æœ€ç®€å•ï¼Œ5æœ€éš¾ï¼‰</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ†ç±»å¼¹çª— -->
    <div id="category-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="category-modal-title">â• æ–°å»ºåˆ†ç±»</h2>
            <input type="hidden" id="edit-category-id">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">åˆ†ç±»åç§°</label>
                <input type="text" id="category-name" placeholder="å¦‚ï¼šç¯å¢ƒç›‘æµ‹ã€åœŸå£¤å­¦" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">å­¦ç§‘</label>
                <input type="text" id="category-subject" placeholder="å¦‚ï¼šç¯å¢ƒç§‘å­¦" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æè¿°</label>
                <textarea id="category-desc" placeholder="åˆ†ç±»æè¿°ï¼ˆå¯é€‰ï¼‰" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:80px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ˜¾ç¤ºé¢œè‰²</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#3b82f6" checked style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#10b981" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#f59e0b" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#ef4444" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#8b5cf6" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="category-color" value="#ec4899" style="display:none;"><span class="color-option" style="display:block; width:30px; height:30px; border-radius:50%; background:#ec4899; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveCategory()" class="btn btn-success" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="closeCategoryModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘é¢˜ç›®å¼¹çª— -->
    <div id="question-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto;">
            <h2 style="margin-bottom:20px;" id="question-modal-title">â• æ·»åŠ é¢˜ç›®</h2>
            <input type="hidden" id="edit-question-id">
            
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®åºå·</label>
                    <input type="number" id="q-round" min="1" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®ç±»å‹</label>
                    <select id="q-type" onchange="updateQuestionForm()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">å•é€‰é¢˜</option>
                        <option value="multiple">å¤šé€‰é¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ‰€å±åˆ†ç±»</label>
                    <select id="q-category" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></select>
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">é¢˜ç›®å†…å®¹</label>
                <textarea id="q-title" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:80px; resize:vertical;"></textarea>
            </div>
            
            <div id="options-area">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹A</label><input id="q-opt-a" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹B</label><input id="q-opt-b" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹C</label><input id="q-opt-c" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹D</label><input id="q-opt-d" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">æ­£ç¡®ç­”æ¡ˆ</label>
                    <input id="q-answer" placeholder="å¦‚ A æˆ– AB" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">çŸ¥è¯†ç‚¹</label>
                    <input id="q-tag" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">éš¾åº¦</label>
                    <select id="q-difficulty" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="1">â­ ç®€å•</option>
                        <option value="2">â­â­ è¾ƒæ˜“</option>
                        <option value="3">â­â­â­ ä¸­ç­‰</option>
                        <option value="4">â­â­â­â­ è¾ƒéš¾</option>
                        <option value="5">â­â­â­â­â­ å›°éš¾</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">ç­”æ¡ˆè§£æï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="q-explanation" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button onclick="saveQuestion()" class="btn btn-success" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="closeQuestionModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // çŠ¶æ€
        let categories = [];
        let currentCategory = 'all';
        let questions = [];
        let pendingImport = [];
        
        // é¢˜å‹é…ç½®
        const typeConfig = {
            single: { name: 'å•é€‰é¢˜', color: '#3b82f6', icon: 'ğŸ“Œ' },
            multiple: { name: 'å¤šé€‰é¢˜', color: '#8b5cf6', icon: 'ğŸ“‹' },
            truefalse: { name: 'åˆ¤æ–­é¢˜', color: '#10b981', icon: 'âœ…' },
            fillblank: { name: 'å¡«ç©ºé¢˜', color: '#f59e0b', icon: 'âœï¸' }
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadQuestions();
            setupColorPicker();
            setupDropArea();
        });
        
        // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨
        function setupColorPicker() {
            document.querySelectorAll('input[name="category-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.color-option').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            document.querySelector('.color-option').style.borderColor = 'white';
        }
        
        // è®¾ç½®æ‹–æ‹½åŒºåŸŸ
        function setupDropArea() {
            const dropArea = document.getElementById('drop-area');
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = '#10b981'; });
            dropArea.addEventListener('dragleave', () => { dropArea.style.borderColor = '#3b82f6'; });
            dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.style.borderColor = '#3b82f6'; handleFileDrop(e); });
        }
        
        // ================== åˆ†ç±»ç®¡ç† ==================
        async function loadCategories() {
            const { data, error } = await supabaseClient.from('question_categories').select('*').order('sort_order');
            if (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæç¤º
                if (error.code === '42P01') {
                    alert('è¯·å…ˆæ‰§è¡Œ questionbank_v2.sql åˆ›å»ºæ•°æ®åº“è¡¨');
                }
                return;
            }
            categories = data || [];
            renderCategories();
            updateCategorySelects();
        }
        
        function renderCategories() {
            const list = document.getElementById('category-list');
            const totalCount = questions.length;
            
            let html = `
                <div class="category-item ${currentCategory === 'all' ? 'active' : ''}" data-id="all" onclick="selectCategory('all')">
                    <div class="category-color" style="background:#3b82f6;"></div>
                    <span class="category-name">å…¨éƒ¨é¢˜ç›®</span>
                    <span class="category-count" id="total-count">${totalCount}</span>
                </div>
            `;
            
            categories.forEach(cat => {
                const count = questions.filter(q => q.category_id === cat.category_id).length;
                html += `
                    <div class="category-item ${currentCategory === cat.category_id ? 'active' : ''}" data-id="${cat.category_id}" onclick="selectCategory('${cat.category_id}')">
                        <div class="category-color" style="background:${cat.color};"></div>
                        <span class="category-name">${cat.name}</span>
                        <span class="category-count">${count}</span>
                        <button onclick="event.stopPropagation(); editCategory('${cat.category_id}')" style="background:none; border:none; color:#94a3b8; cursor:pointer; padding:2px 5px;">âœï¸</button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function selectCategory(id) {
            currentCategory = id;
            renderCategories();
            loadQuestions();
        }
        
        function updateCategorySelects() {
            const selects = ['import-category', 'q-category'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">æœªåˆ†ç±»</option>' + 
                        categories.map(c => `<option value="${c.category_id}">${c.name}</option>`).join('');
                }
            });
        }
        
        function openAddCategory() {
            document.getElementById('category-modal-title').textContent = 'â• æ–°å»ºåˆ†ç±»';
            document.getElementById('edit-category-id').value = '';
            document.getElementById('category-name').value = '';
            document.getElementById('category-subject').value = '';
            document.getElementById('category-desc').value = '';
            document.getElementById('category-modal').style.display = 'flex';
        }
        
        async function editCategory(id) {
            const cat = categories.find(c => c.category_id === id);
            if (!cat) return;
            
            document.getElementById('category-modal-title').textContent = 'âœï¸ ç¼–è¾‘åˆ†ç±»';
            document.getElementById('edit-category-id').value = id;
            document.getElementById('category-name').value = cat.name;
            document.getElementById('category-subject').value = cat.subject || '';
            document.getElementById('category-desc').value = cat.description || '';
            
            // é€‰ä¸­å¯¹åº”é¢œè‰²
            document.querySelectorAll('input[name="category-color"]').forEach(input => {
                if (input.value === cat.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('category-modal').style.display = 'flex';
        }
        
        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
        }
        
        async function saveCategory() {
            const id = document.getElementById('edit-category-id').value;
            const name = document.getElementById('category-name').value.trim();
            const subject = document.getElementById('category-subject').value.trim();
            const description = document.getElementById('category-desc').value.trim();
            const color = document.querySelector('input[name="category-color"]:checked').value;
            
            if (!name) { alert('è¯·è¾“å…¥åˆ†ç±»åç§°'); return; }
            
            const data = { name, subject, description, color };
            
            if (id) {
                // æ›´æ–°
                const { error } = await supabaseClient.from('question_categories').update(data).eq('category_id', id);
                if (error) { alert('æ›´æ–°å¤±è´¥: ' + error.message); return; }
            } else {
                // æ–°å»º
                const { error } = await supabaseClient.from('question_categories').insert([data]);
                if (error) { alert('åˆ›å»ºå¤±è´¥: ' + error.message); return; }
            }
            
            closeCategoryModal();
            loadCategories();
        }

        // ================== é¢˜ç›®ç®¡ç† ==================
        async function loadQuestions() {
            let query = supabaseClient.from('questions').select('*').order('round');
            
            if (currentCategory !== 'all') {
                query = query.eq('category_id', currentCategory);
            }
            
            // ç­›é€‰æ¡ä»¶
            const typeFilter = document.getElementById('filter-type')?.value;
            const difficultyFilter = document.getElementById('filter-difficulty')?.value;
            const searchText = document.getElementById('search-input')?.value?.toLowerCase();
            
            if (typeFilter) query = query.eq('question_type', typeFilter);
            if (difficultyFilter) query = query.eq('difficulty', parseInt(difficultyFilter));
            
            const { data, error } = await query;
            if (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                document.getElementById('question-list').innerHTML = '<div style="text-align:center; padding:50px; color:#ef4444;">åŠ è½½å¤±è´¥</div>';
                return;
            }
            
            questions = data || [];
            
            // æœç´¢è¿‡æ»¤
            let filtered = questions;
            if (searchText) {
                filtered = questions.filter(q => q.title.toLowerCase().includes(searchText) || (q.knowledge_tag || '').toLowerCase().includes(searchText));
            }
            
            renderQuestions(filtered);
            updateStats();
            renderCategories();
        }
        
        function renderQuestions(list) {
            const container = document.getElementById('question-list');
            
            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#666;">æš‚æ— é¢˜ç›®</div>';
                return;
            }
            
            container.innerHTML = list.map(q => {
                const type = typeConfig[q.question_type] || typeConfig.single;
                const cat = categories.find(c => c.category_id === q.category_id);
                const difficulty = 'â­'.repeat(q.difficulty || 1);
                
                return `
                    <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; display:flex; gap:15px; align-items:flex-start;">
                        <div style="min-width:50px; text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#3b82f6;">${q.round}</div>
                            <div style="font-size:0.7rem; color:#94a3b8;">åºå·</div>
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
                                <span style="background:${type.color}; color:white; padding:2px 8px; border-radius:4px; font-size:0.75rem;">${type.icon} ${type.name}</span>
                                ${cat ? `<span style="background:${cat.color}20; color:${cat.color}; padding:2px 8px; border-radius:4px; font-size:0.75rem;">${cat.name}</span>` : ''}
                                ${q.knowledge_tag ? `<span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:0.75rem;">${q.knowledge_tag}</span>` : ''}
                                <span style="font-size:0.75rem; color:#f59e0b;">${difficulty}</span>
                            </div>
                            <div style="font-size:0.95rem; line-height:1.5; margin-bottom:8px;">${q.title}</div>
                            ${q.question_type !== 'fillblank' && q.question_type !== 'truefalse' ? `
                                <div style="display:flex; gap:15px; flex-wrap:wrap; font-size:0.85rem; color:#94a3b8;">
                                    ${q.option_a ? `<span>A. ${q.option_a.substring(0, 20)}${q.option_a.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_b ? `<span>B. ${q.option_b.substring(0, 20)}${q.option_b.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_c ? `<span>C. ${q.option_c.substring(0, 20)}${q.option_c.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_d ? `<span>D. ${q.option_d.substring(0, 20)}${q.option_d.length > 20 ? '...' : ''}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-end;">
                            <div style="background:#10b981; color:white; padding:5px 12px; border-radius:6px; font-weight:bold;">${q.answer}</div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="editQuestion(${q.round})" class="btn btn-secondary" style="padding:5px 10px; font-size:0.75rem;">âœï¸ ç¼–è¾‘</button>
                                <button onclick="deleteQuestion(${q.round})" class="btn btn-danger" style="padding:5px 10px; font-size:0.75rem;">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats() {
            const stats = { single: 0, multiple: 0, truefalse: 0, fillblank: 0 };
            questions.forEach(q => {
                const type = q.question_type || 'single';
                if (stats[type] !== undefined) stats[type]++;
            });
            
            document.getElementById('stat-single').textContent = stats.single;
            document.getElementById('stat-multiple').textContent = stats.multiple;
            document.getElementById('stat-truefalse').textContent = stats.truefalse;
            document.getElementById('stat-fillblank').textContent = stats.fillblank;
            document.getElementById('total-count').textContent = questions.length;
        }
        
        // æœç´¢å’Œç­›é€‰
        document.getElementById('search-input')?.addEventListener('input', debounce(loadQuestions, 300));
        document.getElementById('filter-type')?.addEventListener('change', loadQuestions);
        document.getElementById('filter-difficulty')?.addEventListener('change', loadQuestions);
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ================== æ·»åŠ /ç¼–è¾‘é¢˜ç›® ==================
        async function openAddQuestion() {
            // è·å–ä¸‹ä¸€ä¸ªå¯ç”¨åºå·
            const { data } = await supabaseClient.from('questions').select('round').order('round', { ascending: false }).limit(1);
            const nextRound = (data && data[0]) ? data[0].round + 1 : 1;
            
            document.getElementById('question-modal-title').textContent = 'â• æ·»åŠ é¢˜ç›®';
            document.getElementById('edit-question-id').value = '';
            document.getElementById('q-round').value = nextRound;
            document.getElementById('q-type').value = 'single';
            document.getElementById('q-category').value = currentCategory !== 'all' ? currentCategory : '';
            document.getElementById('q-title').value = '';
            document.getElementById('q-opt-a').value = '';
            document.getElementById('q-opt-b').value = '';
            document.getElementById('q-opt-c').value = '';
            document.getElementById('q-opt-d').value = '';
            document.getElementById('q-answer').value = '';
            document.getElementById('q-tag').value = '';
            document.getElementById('q-difficulty').value = '1';
            document.getElementById('q-explanation').value = '';
            
            updateQuestionForm();
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        async function editQuestion(round) {
            const { data: q } = await supabaseClient.from('questions').select('*').eq('round', round).single();
            if (!q) { alert('é¢˜ç›®ä¸å­˜åœ¨'); return; }
            
            document.getElementById('question-modal-title').textContent = 'âœï¸ ç¼–è¾‘é¢˜ç›®';
            document.getElementById('edit-question-id').value = q.id;
            document.getElementById('q-round').value = q.round;
            document.getElementById('q-type').value = q.question_type || 'single';
            document.getElementById('q-category').value = q.category_id || '';
            document.getElementById('q-title').value = q.title;
            document.getElementById('q-opt-a').value = q.option_a || '';
            document.getElementById('q-opt-b').value = q.option_b || '';
            document.getElementById('q-opt-c').value = q.option_c || '';
            document.getElementById('q-opt-d').value = q.option_d || '';
            document.getElementById('q-answer').value = q.answer;
            document.getElementById('q-tag').value = q.knowledge_tag || '';
            document.getElementById('q-difficulty').value = q.difficulty || 1;
            document.getElementById('q-explanation').value = q.explanation || '';
            
            updateQuestionForm();
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        function updateQuestionForm() {
            const type = document.getElementById('q-type').value;
            const optionsArea = document.getElementById('options-area');
            
            if (type === 'truefalse') {
                optionsArea.innerHTML = `
                    <div style="margin-bottom:15px; color:#94a3b8;">
                        åˆ¤æ–­é¢˜æ— éœ€å¡«å†™é€‰é¡¹ï¼Œç­”æ¡ˆè¯·å¡«å†™ï¼šå¯¹/é”™ æˆ– T/F
                    </div>
                `;
            } else if (type === 'fillblank') {
                optionsArea.innerHTML = `
                    <div style="margin-bottom:15px; color:#94a3b8;">
                        å¡«ç©ºé¢˜æ— éœ€å¡«å†™é€‰é¡¹ï¼Œé¢˜ç›®ä¸­ç”¨ ____ è¡¨ç¤ºå¡«ç©ºä½ç½®ï¼Œç­”æ¡ˆå¡«å†™æ ‡å‡†ç­”æ¡ˆ
                    </div>
                `;
            } else {
                optionsArea.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹A</label><input id="q-opt-a" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹B</label><input id="q-opt-b" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹C</label><input id="q-opt-c" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">é€‰é¡¹D</label><input id="q-opt-d" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    </div>
                `;
            }
        }
        
        function closeQuestionModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        async function saveQuestion() {
            const round = parseInt(document.getElementById('q-round').value);
            const type = document.getElementById('q-type').value;
            const categoryId = document.getElementById('q-category').value || null;
            const title = document.getElementById('q-title').value.trim();
            const answer = document.getElementById('q-answer').value.trim().toUpperCase();
            const tag = document.getElementById('q-tag').value.trim() || null;
            const difficulty = parseInt(document.getElementById('q-difficulty').value);
            const explanation = document.getElementById('q-explanation').value.trim() || null;
            
            if (!round || !title || !answer) {
                alert('è¯·å¡«å†™åºå·ã€é¢˜ç›®å’Œç­”æ¡ˆ');
                return;
            }
            
            const data = {
                round,
                question_type: type,
                category_id: categoryId,
                title,
                option_a: document.getElementById('q-opt-a')?.value || null,
                option_b: document.getElementById('q-opt-b')?.value || null,
                option_c: document.getElementById('q-opt-c')?.value || null,
                option_d: document.getElementById('q-opt-d')?.value || null,
                answer,
                knowledge_tag: tag,
                difficulty,
                explanation,
                updated_at: new Date().toISOString()
            };
            
            const { error } = await supabaseClient.from('questions').upsert(data, { onConflict: 'round' });
            
            if (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                return;
            }
            
            closeQuestionModal();
            loadQuestions();
            alert('âœ… ä¿å­˜æˆåŠŸ');
        }
        
        async function deleteQuestion(round) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${round} é¢˜å—ï¼Ÿ`)) return;
            
            const { error } = await supabaseClient.from('questions').delete().eq('round', round);
            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
                return;
            }
            
            loadQuestions();
        }

        // ================== å¯¼å…¥åŠŸèƒ½ ==================
        function openImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
            document.getElementById('import-preview').style.display = 'none';
            pendingImport = [];
            updateCategorySelects();
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }
        
        function handleFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) processFile(file);
        }
        
        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('è¯·é€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const type = document.getElementById('import-type').value;
                pendingImport = parseCSV(text, type);
                
                if (pendingImport.length === 0) {
                    alert('æœªèƒ½è§£æå‡ºæœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼');
                    return;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('import-preview').style.display = 'block';
                document.getElementById('preview-count').textContent = pendingImport.length;
                document.getElementById('preview-list').innerHTML = pendingImport.slice(0, 5).map((q, i) => `
                    <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.85rem;">
                        <strong>${i + 1}.</strong> ${q.title.substring(0, 60)}${q.title.length > 60 ? '...' : ''} 
                        <span style="color:#10b981;">[${q.answer}]</span>
                    </div>
                `).join('') + (pendingImport.length > 5 ? `<div style="padding:8px; color:#94a3b8; font-size:0.8rem;">... è¿˜æœ‰ ${pendingImport.length - 5} é“é¢˜ç›®</div>` : '');
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        function parseCSV(text, type) {
            const lines = text.trim().split('\n');
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cells = parseCSVLine(line);
                if (cells.length < 2) continue;
                
                let q = { question_type: type };
                
                if (type === 'single' || type === 'multiple') {
                    // é¢˜ç›®,é€‰é¡¹A,é€‰é¡¹B,é€‰é¡¹C,é€‰é¡¹D,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦
                    if (cells.length < 6) continue;
                    q.title = cells[0];
                    q.option_a = cells[1];
                    q.option_b = cells[2];
                    q.option_c = cells[3];
                    q.option_d = cells[4];
                    q.answer = cells[5].toUpperCase();
                    q.knowledge_tag = cells[6] || null;
                    q.difficulty = parseInt(cells[7]) || 1;
                } else if (type === 'truefalse') {
                    // é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦
                    q.title = cells[0];
                    let ans = cells[1].trim().toLowerCase();
                    q.answer = (ans === 'å¯¹' || ans === 't' || ans === 'true' || ans === 'æ­£ç¡®') ? 'å¯¹' : 'é”™';
                    q.knowledge_tag = cells[2] || null;
                    q.difficulty = parseInt(cells[3]) || 1;
                } else if (type === 'fillblank') {
                    // é¢˜ç›®,ç­”æ¡ˆ,çŸ¥è¯†ç‚¹,éš¾åº¦
                    q.title = cells[0];
                    q.answer = cells[1];
                    q.knowledge_tag = cells[2] || null;
                    q.difficulty = parseInt(cells[3]) || 1;
                }
                
                questions.push(q);
            }
            
            return questions;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        async function confirmImport() {
            if (pendingImport.length === 0) {
                alert('æ²¡æœ‰å¾…å¯¼å…¥çš„é¢˜ç›®');
                return;
            }
            
            const categoryId = document.getElementById('import-category').value || null;
            const clearBefore = document.getElementById('clear-before-import').checked;
            const startRound = parseInt(document.getElementById('start-round').value) || 1;
            
            // å¦‚æœéœ€è¦æ¸…ç©º
            if (clearBefore && categoryId) {
                await supabaseClient.from('questions').delete().eq('category_id', categoryId);
            }
            
            // æ·»åŠ åºå·å’Œåˆ†ç±»
            const questionsToInsert = pendingImport.map((q, i) => ({
                ...q,
                round: startRound + i,
                category_id: categoryId
            }));
            
            const { error } = await supabaseClient.from('questions').upsert(questionsToInsert, { onConflict: 'round' });
            
            if (error) {
                alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                return;
            }
            
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${questionsToInsert.length} é“é¢˜ç›®`);
            closeImportModal();
            loadQuestions();
            loadCategories();
        }
        
        // ================== æ ¼å¼è¯´æ˜ ==================
        function openFormatHelp() {
            document.getElementById('format-modal').style.display = 'flex';
        }
        
        function closeFormatHelp() {
            document.getElementById('format-modal').style.display = 'none';
        }
    </script>
</body>
</html>
