<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 题库管理中心</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="js/batch-operations.js"></script>
    <script src="js/question-search.js"></script>
    <script src="js/import-export.js"></script>
    <script src="js/version-history.js"></script>
    <script src="js/question-templates.js"></script>
    <script src="js/ai-assistant.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 15px; }
        .header h1 { font-size: 1.8rem; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* 批量操作工具栏样式 */
        .batch-toolbar { display: none; background: linear-gradient(135deg, #1e3a5f, #2d4a6f); border-radius: 12px; padding: 15px 20px; margin-bottom: 15px; align-items: center; gap: 15px; flex-wrap: wrap; border: 1px solid rgba(59,130,246,0.3); }
        .batch-toolbar.active { display: flex; }
        .batch-toolbar .selected-count { background: #3b82f6; padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        .batch-toolbar .batch-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .batch-toolbar .batch-btn { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .batch-toolbar .batch-btn:hover { transform: translateY(-1px); }
        .batch-btn-delete { background: #ef4444; color: white; }
        .batch-btn-move { background: #f59e0b; color: white; }
        .batch-btn-edit { background: #8b5cf6; color: white; }
        .batch-btn-copy { background: #10b981; color: white; }
        .batch-btn-cancel { background: rgba(255,255,255,0.1); color: white; }
        
        /* 题目复选框样式 */
        .question-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: #3b82f6; }
        .question-item { position: relative; }
        .question-item.selected { background: rgba(59,130,246,0.15) !important; border-left: 3px solid #3b82f6; }
        
        /* 高亮样式 */
        .highlight { background: #fbbf24; color: #000; padding: 1px 3px; border-radius: 3px; }
        
        .main-content { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* 左侧分类栏 */
        .sidebar { background: #1e293b; border-radius: 15px; padding: 20px; height: fit-content; }
        .sidebar h3 { margin-bottom: 15px; color: #94a3b8; font-size: 0.9rem; }
        /* 三级树形导航样式 */
        .hierarchy-tree { display: flex; flex-direction: column; gap: 4px; }
        .tree-node { user-select: none; }
        .tree-header { display: flex; align-items: center; padding: 10px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s; gap: 8px; }
        .tree-header:hover { background: rgba(255,255,255,0.1); }
        .tree-header.active { background: rgba(59,130,246,0.3); border-left: 3px solid #3b82f6; }
        .tree-toggle { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #94a3b8; transition: transform 0.2s; flex-shrink: 0; }
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-toggle.empty { visibility: hidden; }
        .tree-icon { font-size: 1rem; flex-shrink: 0; }
        .tree-name { flex: 1; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tree-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; flex-shrink: 0; }
        .tree-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .tree-header:hover .tree-actions { opacity: 1; }
        .tree-action-btn { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 2px 4px; font-size: 0.75rem; border-radius: 4px; }
        .tree-action-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tree-children { margin-left: 20px; display: flex; flex-direction: column; gap: 4px; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.2s; }
        .tree-children.collapsed { max-height: 0; opacity: 0; padding: 0; }
        .tree-children.expanded { max-height: 2000px; opacity: 1; padding-top: 4px; }
        /* 层级颜色区分 */
        .tree-node.level-course > .tree-header { border-left: 3px solid transparent; }
        .tree-node.level-course > .tree-header .tree-icon { color: #3b82f6; }
        .tree-node.level-project > .tree-header { border-left: 3px solid transparent; }
        .tree-node.level-project > .tree-header .tree-icon { color: #10b981; }
        .tree-node.level-task > .tree-header { border-left: 3px solid transparent; }
        .tree-node.level-task > .tree-header .tree-icon { color: #f59e0b; }
        /* 管理按钮区域 */
        .hierarchy-actions { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .hierarchy-actions .btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.75rem; }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>📚 题库管理中心</h1>
                <p style="color:#94a3b8; margin-top:5px;">管理多课程题库，支持多种题型</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openImportModal()">📥 导入题目</button>
                <button class="btn btn-warning" onclick="openExportModal()">📤 导出题目</button>
                <button class="btn btn-primary" onclick="openAddQuestion()">➕ 添加题目</button>
                <button class="btn" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;" onclick="openAIAssistant()">🤖 AI助手</button>
                <button class="btn btn-secondary" onclick="openFormatHelp()">❓ 格式说明</button>
                <a href="/classroom/presentation.html" class="btn btn-warning">🎬 返回课件</a>
            </div>
        </div>

        <div class="main-content">
            <!-- 左侧分类栏 -->
            <div class="sidebar">
                <!-- 层级导航标题 -->
                <h3>📚 题库层级</h3>
                
                <!-- 全部题目选项 -->
                <div class="hierarchy-tree" id="hierarchy-tree">
                    <div class="tree-node">
                        <div class="tree-header active" onclick="selectHierarchyNode('all', 'all')" data-type="all" data-id="all">
                            <span class="tree-toggle empty"></span>
                            <span class="tree-icon">📋</span>
                            <span class="tree-name">全部题目</span>
                            <span class="tree-count" id="total-count">0</span>
                        </div>
                    </div>
                    <!-- 课程树将在这里动态渲染 -->
                    <div id="courses-tree"></div>
                </div>
                
                <!-- 层级管理按钮 -->
                <div class="hierarchy-actions">
                    <button onclick="openAddCourse()" class="btn btn-primary" title="新建课程">➕ 课程</button>
                    <button onclick="openAddProject()" class="btn btn-success" title="新建项目">➕ 项目</button>
                    <button onclick="openAddTask()" class="btn btn-warning" title="新建任务">➕ 任务</button>
                </div>
                <div class="hierarchy-actions" style="margin-top:5px;">
                    <button onclick="manageCourses()" class="btn btn-secondary" title="管理课程" style="flex:1;">📋 课程</button>
                    <button onclick="manageProjects()" class="btn btn-secondary" title="管理项目" style="flex:1;">📁 项目</button>
                    <button onclick="manageTasks()" class="btn btn-secondary" title="管理任务" style="flex:1;">📋 任务</button>
                </div>
                
                <h3 style="margin-top:25px;">📊 题型统计</h3>
                <div id="type-stats" style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">单选题</span>
                        <span id="stat-single">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">多选题</span>
                        <span id="stat-multiple">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <span style="color:#94a3b8;">判断题</span>
                        <span id="stat-truefalse">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                        <span style="color:#94a3b8;">填空题</span>
                        <span id="stat-fillblank">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 右侧题目列表 -->
            <div class="content-area" style="background:#1e293b; border-radius:15px; padding:20px;">
                <!-- 筛选栏 -->
                <div style="display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap; align-items:center;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px;">
                        <input type="checkbox" id="select-all-checkbox" class="question-checkbox" onchange="toggleSelectAll()">
                        <span style="font-size:0.85rem;">全选</span>
                    </label>
                    <input type="text" id="search-input" placeholder="🔍 搜索题目..." style="flex:1; min-width:200px; padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <select id="filter-type" style="padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">全部题型</option>
                        <option value="single">单选题</option>
                        <option value="multiple">多选题</option>
                        <option value="truefalse">判断题</option>
                        <option value="fillblank">填空题</option>
                    </select>
                    <select id="filter-difficulty" style="padding:10px 15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">全部难度</option>
                        <option value="1">⭐ 简单</option>
                        <option value="2">⭐⭐ 较易</option>
                        <option value="3">⭐⭐⭐ 中等</option>
                        <option value="4">⭐⭐⭐⭐ 较难</option>
                        <option value="5">⭐⭐⭐⭐⭐ 困难</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadQuestions()">🔄 刷新</button>
                    <button class="btn btn-secondary" onclick="openAdvancedSearch()">🔎 高级搜索</button>
                </div>
                
                <!-- 批量操作工具栏 -->
                <div id="batch-toolbar" class="batch-toolbar">
                    <span class="selected-count">已选 <span id="selected-count">0</span> 题</span>
                    <div class="batch-actions">
                        <button class="batch-btn batch-btn-delete" onclick="batchDeleteQuestions()">🗑️ 批量删除</button>
                        <button class="batch-btn batch-btn-move" onclick="openBatchMoveModal()">📁 批量移动</button>
                        <button class="batch-btn batch-btn-edit" onclick="openBatchEditModal()">✏️ 批量编辑</button>
                        <button class="batch-btn batch-btn-copy" onclick="openBatchCopyModal()">📋 批量复制</button>
                        <button class="batch-btn batch-btn-cancel" onclick="cancelBatchSelection()">✕ 取消选择</button>
                    </div>
                </div>
                
                <!-- 题目列表 -->
                <div id="question-list" style="display:flex; flex-direction:column; gap:12px;">
                    <div style="text-align:center; padding:50px; color:#666;">加载中...</div>
                </div>
                
                <!-- 分页 -->
                <div id="pagination" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <!-- 导入题目弹窗 -->
    <div id="import-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📥 导入题目</h2>
                <button onclick="closeImportModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <!-- 三级层级选择器：课程 → 项目 → 任务 -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">选择课程 *</label>
                    <select id="import-course" onchange="updateImportProjectSelect()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请选择课程</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">选择项目 *</label>
                    <select id="import-project" onchange="updateImportTaskSelect()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请先选择课程</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">选择任务 *</label>
                    <select id="import-task" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请先选择项目</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">题目类型</label>
                    <select id="import-type" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">单选题</option>
                        <option value="multiple">多选题</option>
                        <option value="truefalse">判断题</option>
                        <option value="fillblank">填空题</option>
                    </select>
                </div>
            </div>
            
            <div style="background:rgba(59,130,246,0.1); border:2px dashed #3b82f6; border-radius:15px; padding:40px; text-align:center; margin-bottom:20px;" id="drop-area">
                <div style="font-size:3rem; margin-bottom:10px;">📄</div>
                <div style="margin-bottom:15px;">拖拽 CSV 或 Excel 文件到此处，或点击选择</div>
                <input type="file" id="file-input" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleFileSelect(event)">
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button onclick="document.getElementById('file-input').click()" class="btn btn-primary">选择文件</button>
                </div>
                <div style="font-size:0.8rem; color:#94a3b8; margin-top:10px;">支持 CSV、Excel (.xlsx, .xls) 格式</div>
            </div>
            
            <div id="import-preview" style="display:none;">
                <!-- 导入统计 -->
                <div style="display:flex; gap:15px; margin-bottom:15px;">
                    <div style="flex:1; background:rgba(16,185,129,0.2); padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#10b981;" id="import-valid-count">0</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">有效题目</div>
                    </div>
                    <div style="flex:1; background:rgba(239,68,68,0.2); padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#ef4444;" id="import-invalid-count">0</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">错误题目</div>
                    </div>
                </div>
                
                <div style="font-weight:bold; margin-bottom:10px;">📝 预览 (<span id="preview-count">0</span> 道有效题目)</div>
                <div id="preview-list" style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; margin-bottom:10px;"></div>
                
                <!-- 错误列表 -->
                <div id="import-errors" style="display:none; margin-bottom:15px;">
                    <div style="font-weight:bold; margin-bottom:10px; color:#ef4444;">⚠️ 错误详情</div>
                    <div id="import-errors-list" style="max-height:100px; overflow-y:auto; background:rgba(239,68,68,0.1); border-radius:8px; padding:10px; font-size:0.85rem;"></div>
                </div>
                
                <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px; flex-wrap:wrap;">
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="clear-before-import"> 清空该任务现有题目
                    </label>
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="overwrite-existing"> 覆盖已存在的题目
                    </label>
                    <label style="display:flex; align-items:center; gap:5px;">
                        起始序号: <input type="number" id="start-round" value="1" min="1" style="width:80px; padding:5px; border-radius:5px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    </label>
                </div>
                <button onclick="confirmImport()" class="btn btn-success" style="width:100%; padding:15px;">✅ 确认导入 (仅导入有效题目)</button>
            </div>
        </div>
    </div>

    <!-- 格式说明弹窗 -->
    <div id="format-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📋 CSV格式说明</h2>
                <button onclick="closeFormatHelp()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <div style="display:grid; gap:20px;">
                <!-- 单选题格式 -->
                <div style="background:rgba(59,130,246,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#3b82f6; margin-bottom:10px;">📌 单选题格式</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
题目,选项A,选项B,选项C,选项D,答案,知识点,难度<br>
"1+1等于多少？","1","2","3","4",B,数学基础,1<br>
"水的化学式是？","H2O","CO2","O2","N2",A,化学基础,2
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">答案填写：A/B/C/D（单个字母）</p>
                </div>
                
                <!-- 多选题格式 -->
                <div style="background:rgba(139,92,246,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#8b5cf6; margin-bottom:10px;">📌 多选题格式</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
题目,选项A,选项B,选项C,选项D,答案,知识点,难度<br>
"以下哪些是编程语言？","Python","Excel","Java","Word",AC,计算机基础,2<br>
"哪些属于可再生能源？","太阳能","煤炭","风能","石油",AC,环境科学,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">答案填写：多个字母连写，如 AB、ACD、ABCD</p>
                </div>
                
                <!-- 判断题格式 -->
                <div style="background:rgba(16,185,129,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#10b981; margin-bottom:10px;">📌 判断题格式</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
题目,答案,知识点,难度<br>
"地球是太阳系中最大的行星",错,天文学,1<br>
"水在标准大气压下100℃沸腾",对,物理学,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">答案填写：对/错 或 T/F 或 true/false</p>
                </div>
                
                <!-- 填空题格式 -->
                <div style="background:rgba(245,158,11,0.1); border-radius:12px; padding:20px;">
                    <h3 style="color:#f59e0b; margin-bottom:10px;">📌 填空题格式</h3>
                    <code style="display:block; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; font-size:0.85rem; overflow-x:auto;">
题目,答案,知识点,难度<br>
"中国的首都是____",北京,地理常识,1<br>
"1千克等于____克",1000,单位换算,1
                    </code>
                    <p style="color:#94a3b8; margin-top:10px; font-size:0.85rem;">题目中用 ____ 表示填空位置，答案为标准答案</p>
                </div>
            </div>
            
            <div style="margin-top:20px; padding:15px; background:rgba(239,68,68,0.1); border-radius:10px;">
                <h4 style="color:#ef4444; margin-bottom:8px;">⚠️ 注意事项</h4>
                <ul style="color:#94a3b8; font-size:0.85rem; padding-left:20px; line-height:1.8;">
                    <li>CSV文件需使用UTF-8编码保存</li>
                    <li>第一行为标题行，会被自动跳过</li>
                    <li>题目内容如包含逗号，需用英文双引号包裹</li>
                    <li>知识点和难度为可选字段，可省略</li>
                    <li>难度范围：1-5（1最简单，5最难）</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 模板管理弹窗 -->
    <div id="template-manager-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1001; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📋 模板管理</h2>
                <button onclick="closeTemplateManager()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <!-- 内置模板 -->
            <div style="margin-bottom:20px;">
                <h4 style="margin-bottom:10px; color:#94a3b8;">内置模板</h4>
                <div id="builtin-templates-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div style="padding:15px; background:rgba(59,130,246,0.1); border-radius:8px; border-left:3px solid #3b82f6;">
                        <div style="font-weight:bold;">📌 单选题模板</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">标准四选一单选题</div>
                    </div>
                    <div style="padding:15px; background:rgba(139,92,246,0.1); border-radius:8px; border-left:3px solid #8b5cf6;">
                        <div style="font-weight:bold;">📋 多选题模板</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">可选2-4个正确答案</div>
                    </div>
                    <div style="padding:15px; background:rgba(16,185,129,0.1); border-radius:8px; border-left:3px solid #10b981;">
                        <div style="font-weight:bold;">✅ 判断题模板</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">对错判断题</div>
                    </div>
                    <div style="padding:15px; background:rgba(245,158,11,0.1); border-radius:8px; border-left:3px solid #f59e0b;">
                        <div style="font-weight:bold;">✏️ 填空题模板</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">用___标记填空位置</div>
                    </div>
                </div>
            </div>
            
            <!-- 自定义模板 -->
            <div style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="color:#94a3b8;">自定义模板</h4>
                    <button onclick="openCreateTemplate()" class="btn btn-primary" style="padding:6px 12px; font-size:0.8rem;">➕ 新建模板</button>
                </div>
                <div id="custom-templates-list">
                    <div style="text-align:center; padding:20px; color:#666;">暂无自定义模板</div>
                </div>
            </div>
            
            <!-- 创建模板表单 -->
            <div id="create-template-form" style="display:none; background:rgba(0,0,0,0.2); border-radius:8px; padding:15px; margin-bottom:15px;">
                <h4 style="margin-bottom:15px;">创建新模板</h4>
                <div style="margin-bottom:10px;">
                    <label style="display:block; margin-bottom:5px; color:#94a3b8; font-size:0.9rem;">模板名称</label>
                    <input type="text" id="new-template-name" placeholder="如：环境监测单选题" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block; margin-bottom:5px; color:#94a3b8; font-size:0.9rem;">基于题型</label>
                    <select id="new-template-type" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">单选题</option>
                        <option value="multiple">多选题</option>
                        <option value="truefalse">判断题</option>
                        <option value="fillblank">填空题</option>
                    </select>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="display:block; margin-bottom:5px; color:#94a3b8; font-size:0.9rem;">默认难度</label>
                    <select id="new-template-difficulty" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="1">⭐ 简单</option>
                        <option value="2">⭐⭐ 较易</option>
                        <option value="3" selected>⭐⭐⭐ 中等</option>
                        <option value="4">⭐⭐⭐⭐ 较难</option>
                        <option value="5">⭐⭐⭐⭐⭐ 困难</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:5px; color:#94a3b8; font-size:0.9rem;">默认知识点</label>
                    <input type="text" id="new-template-tag" placeholder="如：土壤检测" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveNewTemplate()" class="btn btn-success" style="flex:1;">💾 保存模板</button>
                    <button onclick="cancelCreateTemplate()" class="btn btn-secondary" style="flex:1;">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 版本历史弹窗 -->
    <div id="version-history-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📜 版本历史</h2>
                <button onclick="closeVersionHistory()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <!-- 当前题目信息 -->
            <div id="version-current-question" style="background:rgba(59,130,246,0.1); border-radius:8px; padding:15px; margin-bottom:20px;">
                <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:5px;">当前版本</div>
                <div id="version-current-title" style="font-weight:bold;"></div>
            </div>
            
            <!-- 版本列表 -->
            <div style="margin-bottom:15px;">
                <div style="font-weight:bold; margin-bottom:10px;">历史版本</div>
                <div id="version-list" style="max-height:300px; overflow-y:auto;">
                    <div style="text-align:center; padding:30px; color:#666;">加载中...</div>
                </div>
            </div>
            
            <!-- 版本对比区域 -->
            <div id="version-compare" style="display:none; background:rgba(0,0,0,0.2); border-radius:8px; padding:15px; margin-bottom:15px;">
                <div style="font-weight:bold; margin-bottom:10px;">📊 版本对比</div>
                <div id="version-compare-content"></div>
            </div>
            
            <div id="version-actions" style="display:none; display:flex; gap:10px;">
                <button onclick="restoreSelectedVersion()" class="btn btn-warning" style="flex:1;">🔄 恢复此版本</button>
                <button onclick="closeVersionCompare()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 导出题目弹窗 -->
    <div id="export-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📤 导出题目</h2>
                <button onclick="closeExportModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">导出范围</label>
                <select id="export-scope" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="current">当前筛选结果 (<span id="export-current-count">0</span> 道)</option>
                    <option value="selected">选中的题目 (<span id="export-selected-count">0</span> 道)</option>
                    <option value="all">全部题目</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">导出格式</label>
                <div style="display:flex; gap:10px;">
                    <label style="flex:1; display:flex; align-items:center; gap:8px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; cursor:pointer; border:2px solid transparent;" class="export-format-option" data-format="csv">
                        <input type="radio" name="export-format" value="csv" checked style="display:none;">
                        <span style="font-size:1.5rem;">📄</span>
                        <div>
                            <div style="font-weight:bold;">CSV</div>
                            <div style="font-size:0.75rem; color:#94a3b8;">通用格式</div>
                        </div>
                    </label>
                    <label style="flex:1; display:flex; align-items:center; gap:8px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; cursor:pointer; border:2px solid transparent;" class="export-format-option" data-format="excel">
                        <input type="radio" name="export-format" value="excel" style="display:none;">
                        <span style="font-size:1.5rem;">📊</span>
                        <div>
                            <div style="font-weight:bold;">Excel</div>
                            <div style="font-size:0.75rem; color:#94a3b8;">.xlsx格式</div>
                        </div>
                    </label>
                    <label style="flex:1; display:flex; align-items:center; gap:8px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; cursor:pointer; border:2px solid transparent;" class="export-format-option" data-format="json">
                        <input type="radio" name="export-format" value="json" style="display:none;">
                        <span style="font-size:1.5rem;">{ }</span>
                        <div>
                            <div style="font-weight:bold;">JSON</div>
                            <div style="font-size:0.75rem; color:#94a3b8;">完整数据</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <button onclick="executeExport()" class="btn btn-success" style="width:100%; padding:15px;">📥 开始导出</button>
        </div>
    </div>

    <!-- AI助手弹窗 -->
    <div id="ai-assistant-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>🤖 AI 智能助手</h2>
                <button onclick="closeAIAssistant()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <!-- AI功能选项卡 -->
            <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                <button id="ai-tab-generate" class="btn btn-primary" onclick="switchAITab('generate')">✨ 生成题目</button>
                <button id="ai-tab-optimize" class="btn btn-secondary" onclick="switchAITab('optimize')">🔧 优化题目</button>
                <button id="ai-tab-config" class="btn btn-secondary" onclick="switchAITab('config')">⚙️ API配置</button>
            </div>
            
            <!-- 生成题目面板 -->
            <div id="ai-panel-generate">
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">知识点/主题 *</label>
                    <input type="text" id="ai-gen-topic" placeholder="如：环境监测、土壤检测、水质分析..." style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label style="display:block; margin-bottom:8px; color:#94a3b8;">题型</label>
                        <select id="ai-gen-type" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                            <option value="single">单选题</option>
                            <option value="multiple">多选题</option>
                            <option value="truefalse">判断题</option>
                            <option value="fillblank">填空题</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:8px; color:#94a3b8;">难度</label>
                        <select id="ai-gen-difficulty" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                            <option value="1">⭐ 简单</option>
                            <option value="2">⭐⭐ 较易</option>
                            <option value="3" selected>⭐⭐⭐ 中等</option>
                            <option value="4">⭐⭐⭐⭐ 较难</option>
                            <option value="5">⭐⭐⭐⭐⭐ 困难</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:8px; color:#94a3b8;">数量 (1-10)</label>
                        <input type="number" id="ai-gen-count" value="5" min="1" max="10" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    </div>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">额外说明（可选）</label>
                    <textarea id="ai-gen-context" placeholder="提供更多背景信息或特殊要求..." style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
                </div>
                
                <button onclick="generateQuestionsWithAI()" class="btn btn-primary" style="width:100%; padding:15px; font-size:1rem;">
                    ✨ 开始生成
                </button>
                
                <!-- 生成结果预览 -->
                <div id="ai-gen-result" style="display:none; margin-top:20px;">
                    <h4 style="margin-bottom:10px;">📝 生成结果 (<span id="ai-gen-result-count">0</span> 道题目)</h4>
                    <div id="ai-gen-result-list" style="max-height:300px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; padding:10px;"></div>
                    <div style="margin-top:15px;">
                        <label style="display:block; margin-bottom:8px; color:#94a3b8;">保存到任务</label>
                        <select id="ai-gen-target-task" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; margin-bottom:10px;">
                            <option value="">请选择目标任务...</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="saveGeneratedQuestions()" class="btn btn-success" style="flex:1;">💾 保存到题库</button>
                        <button onclick="clearGeneratedQuestions()" class="btn btn-secondary" style="flex:1;">🗑️ 清空</button>
                    </div>
                </div>
            </div>
            
            <!-- 优化题目面板 -->
            <div id="ai-panel-optimize" style="display:none;">
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">选择要优化的题目</label>
                    <select id="ai-opt-question" onchange="loadQuestionForOptimize()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请选择题目...</option>
                    </select>
                </div>
                
                <div id="ai-opt-preview" style="display:none; background:rgba(0,0,0,0.2); border-radius:8px; padding:15px; margin-bottom:15px;">
                    <h4 style="margin-bottom:10px; color:#94a3b8;">当前题目</h4>
                    <div id="ai-opt-preview-content"></div>
                </div>
                
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button onclick="optimizeQuestionWithAI()" class="btn btn-primary" style="flex:1;">🔧 优化题目</button>
                    <button onclick="generateExplanationWithAI()" class="btn btn-success" style="flex:1;">📝 生成解析</button>
                    <button onclick="checkQualityWithAI()" class="btn btn-warning" style="flex:1;">📊 质量检查</button>
                </div>
                
                <!-- 优化结果 -->
                <div id="ai-opt-result" style="display:none; background:rgba(139,92,246,0.1); border-radius:8px; padding:15px;">
                    <h4 style="margin-bottom:10px; color:#8b5cf6;">优化结果</h4>
                    <div id="ai-opt-result-content"></div>
                    <button onclick="applyOptimization()" class="btn btn-success" style="width:100%; margin-top:15px;">✅ 应用优化</button>
                </div>
            </div>
            
            <!-- API配置面板 -->
            <div id="ai-panel-config" style="display:none;">
                <div style="background:rgba(245,158,11,0.1); border-radius:8px; padding:15px; margin-bottom:20px;">
                    <p style="color:#f59e0b; font-size:0.9rem;">⚠️ API密钥仅保存在本地浏览器中，不会上传到服务器。</p>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">API 提供商</label>
                    <select id="ai-config-provider" onchange="updateAPIEndpoint()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">API 密钥 *</label>
                    <input type="password" id="ai-config-key" placeholder="sk-..." style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">API 端点</label>
                    <input type="text" id="ai-config-endpoint" value="https://api.openai.com/v1/chat/completions" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">模型</label>
                    <select id="ai-config-model" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="deepseek-chat">DeepSeek Chat</option>
                        <option value="deepseek-coder">DeepSeek Coder</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner (R1)</option>
                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    </select>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <button onclick="saveAIConfig()" class="btn btn-success" style="flex:1;">💾 保存配置</button>
                    <button onclick="testAIConnection()" class="btn btn-primary" style="flex:1;">🔗 测试连接</button>
                </div>
                
                <div id="ai-config-status" style="margin-top:15px; padding:10px; border-radius:8px; display:none;"></div>
            </div>
        </div>
    </div>

    <!-- 高级搜索弹窗 -->
    <div id="advanced-search-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>🔎 高级搜索</h2>
                <button onclick="closeAdvancedSearch()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">关键词搜索</label>
                <input type="text" id="adv-search-keyword" placeholder="搜索题目、选项、解析..." style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">题型</label>
                    <select id="adv-search-type" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">全部题型</option>
                        <option value="single">单选题</option>
                        <option value="multiple">多选题</option>
                        <option value="truefalse">判断题</option>
                        <option value="fillblank">填空题</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">难度</label>
                    <select id="adv-search-difficulty" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">全部难度</option>
                        <option value="1">⭐ 简单</option>
                        <option value="2">⭐⭐ 较易</option>
                        <option value="3">⭐⭐⭐ 中等</option>
                        <option value="4">⭐⭐⭐⭐ 较难</option>
                        <option value="5">⭐⭐⭐⭐⭐ 困难</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">知识点标签</label>
                <input type="text" id="adv-search-tag" placeholder="输入知识点关键词" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">创建时间起始</label>
                    <input type="date" id="adv-search-date-start" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">创建时间结束</label>
                    <input type="date" id="adv-search-date-end" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
            </div>
            
            <!-- 已保存的筛选条件 -->
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">已保存的筛选条件</label>
                <div id="saved-filters-list" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; max-height:120px; overflow-y:auto;">
                    <div style="color:#666; text-align:center; padding:10px;">暂无保存的筛选条件</div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="executeAdvancedSearch()" class="btn btn-primary" style="flex:1;">🔍 搜索</button>
                <button onclick="saveCurrentFilter()" class="btn btn-success" style="flex:1;">💾 保存筛选</button>
                <button onclick="resetAdvancedSearch()" class="btn btn-secondary" style="flex:1;">🔄 重置</button>
            </div>
        </div>
    </div>

    <!-- 批量移动弹窗 -->
    <div id="batch-move-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📁 批量移动题目</h2>
                <button onclick="closeBatchMoveModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            <p style="color:#94a3b8; margin-bottom:20px;">将 <span id="batch-move-count" style="color:#3b82f6; font-weight:bold;">0</span> 道题目移动到：</p>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">目标课程</label>
                <select id="batch-move-course" onchange="updateBatchMoveProjectSelect()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">目标项目</label>
                <select id="batch-move-project" onchange="updateBatchMoveTaskSelect()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请先选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">目标任务</label>
                <select id="batch-move-task" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请先选择项目</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="confirmBatchMove()" class="btn btn-success" style="flex:1;">✅ 确认移动</button>
                <button onclick="closeBatchMoveModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 批量编辑弹窗 -->
    <div id="batch-edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>✏️ 批量编辑题目</h2>
                <button onclick="closeBatchEditModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            <p style="color:#94a3b8; margin-bottom:20px;">批量修改 <span id="batch-edit-count" style="color:#8b5cf6; font-weight:bold;">0</span> 道题目的属性（留空表示不修改）：</p>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">难度</label>
                <select id="batch-edit-difficulty" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">不修改</option>
                    <option value="1">⭐ 简单</option>
                    <option value="2">⭐⭐ 较易</option>
                    <option value="3">⭐⭐⭐ 中等</option>
                    <option value="4">⭐⭐⭐⭐ 较难</option>
                    <option value="5">⭐⭐⭐⭐⭐ 困难</option>
                </select>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">知识点标签</label>
                <input type="text" id="batch-edit-tag" placeholder="留空表示不修改" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="confirmBatchEdit()" class="btn btn-success" style="flex:1;">✅ 确认修改</button>
                <button onclick="closeBatchEditModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 批量复制弹窗 -->
    <div id="batch-copy-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📋 批量复制题目</h2>
                <button onclick="closeBatchCopyModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            <p style="color:#94a3b8; margin-bottom:20px;">将 <span id="batch-copy-count" style="color:#10b981; font-weight:bold;">0</span> 道题目复制到：</p>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">目标课程</label>
                <select id="batch-copy-course" onchange="updateBatchCopyProjectSelect()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">目标项目</label>
                <select id="batch-copy-project" onchange="updateBatchCopyTaskSelect()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请先选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">目标任务</label>
                <select id="batch-copy-task" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请先选择项目</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="confirmBatchCopy()" class="btn btn-success" style="flex:1;">✅ 确认复制</button>
                <button onclick="closeBatchCopyModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 课程管理弹窗 -->
    <div id="course-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="course-modal-title">➕ 新建课程</h2>
            <input type="hidden" id="edit-course-id">
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">课程名称 *</label>
                    <input type="text" id="course-name" placeholder="如：环境监测技术" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">课程代码</label>
                    <input type="text" id="course-code" placeholder="如：ENV101" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">授课教师</label>
                    <input type="text" id="course-teacher" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">学期</label>
                    <input type="text" id="course-semester" placeholder="如：2024-2025-1" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">课程描述</label>
                <textarea id="course-desc" placeholder="课程简介（可选）" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">显示颜色</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#3b82f6" checked style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#10b981" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#f59e0b" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#ef4444" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#8b5cf6" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="course-color" value="#06b6d4" style="display:none;"><span class="course-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#06b6d4; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveCourse()" class="btn btn-success" style="flex:1;">💾 保存</button>
                <button onclick="closeCourseModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 课程列表管理弹窗 -->
    <div id="courses-list-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📖 课程管理</h2>
                <button onclick="closeCoursesListModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            <div id="courses-list-content">加载中...</div>
        </div>
    </div>

    <!-- 项目管理弹窗 -->
    <div id="project-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="project-modal-title">➕ 新建项目</h2>
            <input type="hidden" id="edit-project-id">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">所属课程 *</label>
                <select id="project-course" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">项目名称 *</label>
                <input type="text" id="project-name" placeholder="如：土壤检测、水质分析" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">项目描述</label>
                <textarea id="project-desc" placeholder="项目描述（可选）" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">显示颜色</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#10b981" checked style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#3b82f6" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#f59e0b" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#ef4444" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#8b5cf6" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="project-color" value="#06b6d4" style="display:none;"><span class="project-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#06b6d4; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveProject()" class="btn btn-success" style="flex:1;">💾 保存</button>
                <button onclick="closeProjectModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 项目列表管理弹窗 -->
    <div id="projects-list-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📁 项目管理</h2>
                <button onclick="closeProjectsListModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            <div id="projects-list-content">加载中...</div>
        </div>
    </div>

    <!-- 任务管理弹窗 -->
    <div id="task-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:500px;">
            <h2 style="margin-bottom:20px;" id="task-modal-title">➕ 新建任务</h2>
            <input type="hidden" id="edit-task-id">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">所属课程 *</label>
                <select id="task-course" onchange="updateTaskProjectSelect()" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">所属项目 *</label>
                <select id="task-project" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                    <option value="">请先选择课程</option>
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">任务名称 *</label>
                <input type="text" id="task-name" placeholder="如：土壤水分测定、重金属检测" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">任务描述</label>
                <textarea id="task-desc" placeholder="任务描述（可选）" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">显示颜色</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label style="cursor:pointer;"><input type="radio" name="task-color" value="#f59e0b" checked style="display:none;"><span class="task-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#f59e0b; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="task-color" value="#3b82f6" style="display:none;"><span class="task-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#3b82f6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="task-color" value="#10b981" style="display:none;"><span class="task-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#10b981; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="task-color" value="#ef4444" style="display:none;"><span class="task-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#ef4444; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="task-color" value="#8b5cf6" style="display:none;"><span class="task-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#8b5cf6; border:3px solid transparent;"></span></label>
                    <label style="cursor:pointer;"><input type="radio" name="task-color" value="#06b6d4" style="display:none;"><span class="task-color-opt" style="display:block; width:30px; height:30px; border-radius:50%; background:#06b6d4; border:3px solid transparent;"></span></label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveTask()" class="btn btn-success" style="flex:1;">💾 保存</button>
                <button onclick="closeTaskModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <!-- 任务列表管理弹窗 -->
    <div id="tasks-list-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>📋 任务管理</h2>
                <button onclick="closeTasksListModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
            </div>
            <div id="tasks-list-content">加载中...</div>
        </div>
    </div>

    <!-- 添加/编辑题目弹窗 -->
    <div id="question-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px; padding:30px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="question-modal-title">➕ 添加题目</h2>
                <button onclick="openTemplateManager()" class="btn btn-secondary" style="padding:8px 12px; font-size:0.8rem;">📋 管理模板</button>
            </div>
            <input type="hidden" id="edit-question-id">
            
            <!-- 模板选择 -->
            <div style="margin-bottom:15px; padding:12px; background:rgba(139,92,246,0.1); border-radius:8px; border:1px solid rgba(139,92,246,0.3);">
                <label style="display:block; margin-bottom:8px; color:#8b5cf6; font-weight:bold;">📋 使用模板快速创建</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="q-template" onchange="applyQuestionTemplate()" style="flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">选择模板...</option>
                        <option value="single">📌 单选题模板</option>
                        <option value="multiple">📋 多选题模板</option>
                        <option value="truefalse">✅ 判断题模板</option>
                        <option value="fillblank">✏️ 填空题模板</option>
                    </select>
                    <span style="font-size:0.8rem; color:#94a3b8;">或手动填写</span>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">题目序号</label>
                    <input type="number" id="q-round" min="1" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">题目类型</label>
                    <select id="q-type" onchange="updateQuestionForm()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="single">单选题</option>
                        <option value="multiple">多选题</option>
                        <option value="truefalse">判断题</option>
                        <option value="fillblank">填空题</option>
                    </select>
                </div>
            </div>
            
            <!-- 三级层级选择器：课程 → 项目 → 任务 -->
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">所属课程 *</label>
                    <select id="q-course" onchange="updateQuestionProjectSelect()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请选择课程</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">所属项目 *</label>
                    <select id="q-project" onchange="updateQuestionTaskSelect()" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请先选择课程</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">所属任务 *</label>
                    <select id="q-task" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="">请先选择项目</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">题目内容</label>
                <textarea id="q-title" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:80px; resize:vertical;"></textarea>
            </div>
            
            <div id="options-area">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div><label style="color:#94a3b8; font-size:0.85rem;">选项A</label><input id="q-opt-a" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">选项B</label><input id="q-opt-b" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">选项C</label><input id="q-opt-c" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    <div><label style="color:#94a3b8; font-size:0.85rem;">选项D</label><input id="q-opt-d" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">正确答案</label>
                    <input id="q-answer" placeholder="如 A 或 AB" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">知识点</label>
                    <input id="q-tag" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; color:#94a3b8;">难度</label>
                    <select id="q-difficulty" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;">
                        <option value="1">⭐ 简单</option>
                        <option value="2">⭐⭐ 较易</option>
                        <option value="3">⭐⭐⭐ 中等</option>
                        <option value="4">⭐⭐⭐⭐ 较难</option>
                        <option value="5">⭐⭐⭐⭐⭐ 困难</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#94a3b8;">答案解析（可选）</label>
                <textarea id="q-explanation" style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white; min-height:60px; resize:vertical;"></textarea>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button onclick="saveQuestion()" class="btn btn-success" style="flex:1;">💾 保存</button>
                <button onclick="closeQuestionModal()" class="btn btn-secondary" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase 配置
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // 状态
        let courses = [];
        let projects = [];
        let tasks = [];
        let currentCourse = 'all';
        let currentProject = 'all';
        let currentTask = 'all';
        let currentFilterType = 'all'; // 'all', 'course', 'project', 'task'
        let currentFilterId = 'all';
        let questions = [];
        let pendingImport = [];
        // 树展开状态
        let expandedNodes = { courses: {}, projects: {} };
        
        // 题型配置
        const typeConfig = {
            single: { name: '单选题', color: '#3b82f6', icon: '📌' },
            multiple: { name: '多选题', color: '#8b5cf6', icon: '📋' },
            truefalse: { name: '判断题', color: '#10b981', icon: '✅' },
            fillblank: { name: '填空题', color: '#f59e0b', icon: '✏️' }
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadHierarchy();
            loadQuestions();
            setupColorPicker();
            setupDropArea();
        });
        
        // 加载完整层级数据
        async function loadHierarchy() {
            await loadCourses();
            await loadProjects();
            await loadTasks();
            renderHierarchyTree();
        }
        
        // 设置颜色选择器
        function setupColorPicker() {
            // 课程颜色选择器
            document.querySelectorAll('input[name="course-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.course-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            const firstCourseColorOpt = document.querySelector('.course-color-opt');
            if (firstCourseColorOpt) firstCourseColorOpt.style.borderColor = 'white';
            
            // 项目颜色选择器
            document.querySelectorAll('input[name="project-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.project-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            const firstProjectColorOpt = document.querySelector('.project-color-opt');
            if (firstProjectColorOpt) firstProjectColorOpt.style.borderColor = 'white';
            
            // 任务颜色选择器
            document.querySelectorAll('input[name="task-color"]').forEach(input => {
                input.addEventListener('change', () => {
                    document.querySelectorAll('.task-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
                    input.nextElementSibling.style.borderColor = 'white';
                });
            });
            const firstTaskColorOpt = document.querySelector('.task-color-opt');
            if (firstTaskColorOpt) firstTaskColorOpt.style.borderColor = 'white';
        }
        
        // 设置拖拽区域
        function setupDropArea() {
            const dropArea = document.getElementById('drop-area');
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = '#10b981'; });
            dropArea.addEventListener('dragleave', () => { dropArea.style.borderColor = '#3b82f6'; });
            dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.style.borderColor = '#3b82f6'; handleFileDrop(e); });
        }
        
        // ================== 课程管理 ==================
        async function loadCourses() {
            const { data, error } = await supabaseClient.from('courses').select('*').order('sort_order');
            if (error) {
                console.error('加载课程失败:', error);
                if (error.code === '42P01') {
                    console.warn('courses 表不存在，请执行 courses_table.sql');
                }
                return;
            }
            courses = data || [];
            renderCourseSelect();
            updateCourseSelects();
        }
        
        // 更新课程的项目数量和题目数量（使用新的统一函数）
        async function updateCourseStats(courseId) {
            await updateCourseQuestionCount(courseId);
        }
        
        // 更新所有课程的统计数据
        async function updateAllCourseStats() {
            await updateAllHierarchyCounts();
        }
        
        function renderCourseSelect() {
            const select = document.getElementById('course-select');
            if (select) {
                select.innerHTML = '<option value="all">📚 全部课程</option>' + 
                    courses.map(c => `<option value="${c.course_id}" style="color:${c.color};">${c.icon || '📖'} ${c.name}</option>`).join('');
            }
        }
        
        function updateCourseSelects() {
            // 更新项目弹窗中的课程选择
            const projCourseSelect = document.getElementById('project-course');
            if (projCourseSelect) {
                projCourseSelect.innerHTML = '<option value="">请选择课程</option>' + 
                    courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            }
        }
        
        // ================== 项目管理 ==================
        async function loadProjects() {
            const { data, error } = await supabaseClient.from('projects').select('*').order('sort_order');
            if (error) {
                console.error('加载项目失败:', error);
                if (error.code === '42P01') {
                    console.warn('projects 表不存在，请执行 hierarchy_tables.sql');
                }
                return;
            }
            projects = data || [];
        }
        
        // ================== 任务管理 ==================
        async function loadTasks() {
            const { data, error } = await supabaseClient.from('tasks').select('*').order('sort_order');
            if (error) {
                console.error('加载任务失败:', error);
                if (error.code === '42P01') {
                    console.warn('tasks 表不存在，请执行 hierarchy_tables.sql');
                }
                return;
            }
            tasks = data || [];
        }
        
        // ================== 层级树渲染 ==================
        function renderHierarchyTree() {
            const container = document.getElementById('courses-tree');
            if (!container) return;
            
            let html = '';
            
            courses.forEach(course => {
                const courseProjects = projects.filter(p => p.course_id === course.course_id);
                const isExpanded = expandedNodes.courses[course.course_id];
                const hasChildren = courseProjects.length > 0;
                const courseQuestionCount = getCourseQuestionCount(course.course_id);
                const isActive = currentFilterType === 'course' && currentFilterId === course.course_id;
                
                html += `
                    <div class="tree-node level-course" data-course-id="${course.course_id}">
                        <div class="tree-header ${isActive ? 'active' : ''}" 
                             onclick="selectHierarchyNode('course', '${course.course_id}')"
                             data-type="course" data-id="${course.course_id}">
                            <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : '') : 'empty'}" 
                                  onclick="event.stopPropagation(); toggleCourseNode('${course.course_id}')">▶</span>
                            <span class="tree-icon">${course.icon || '📖'}</span>
                            <span class="tree-name" style="color:${course.color};">${course.name}</span>
                            <span class="tree-count">${courseQuestionCount}</span>
                            <div class="tree-actions">
                                <button class="tree-action-btn" onclick="event.stopPropagation(); editCourse('${course.course_id}')" title="编辑">✏️</button>
                            </div>
                        </div>
                        <div class="tree-children ${isExpanded ? 'expanded' : 'collapsed'}">
                            ${renderProjectNodes(courseProjects)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateTotalCount();
        }
        
        function renderProjectNodes(projectList) {
            let html = '';
            
            projectList.forEach(project => {
                const projectTasks = tasks.filter(t => t.project_id === project.project_id);
                const isExpanded = expandedNodes.projects[project.project_id];
                const hasChildren = projectTasks.length > 0;
                const projectQuestionCount = getProjectQuestionCount(project.project_id);
                const isActive = currentFilterType === 'project' && currentFilterId === project.project_id;
                
                html += `
                    <div class="tree-node level-project" data-project-id="${project.project_id}">
                        <div class="tree-header ${isActive ? 'active' : ''}"
                             onclick="selectHierarchyNode('project', '${project.project_id}')"
                             data-type="project" data-id="${project.project_id}">
                            <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : '') : 'empty'}"
                                  onclick="event.stopPropagation(); toggleProjectNode('${project.project_id}')">▶</span>
                            <span class="tree-icon">${project.icon || '📁'}</span>
                            <span class="tree-name" style="color:${project.color};">${project.name}</span>
                            <span class="tree-count">${projectQuestionCount}</span>
                            <div class="tree-actions">
                                <button class="tree-action-btn" onclick="event.stopPropagation(); editProject('${project.project_id}')" title="编辑">✏️</button>
                            </div>
                        </div>
                        <div class="tree-children ${isExpanded ? 'expanded' : 'collapsed'}">
                            ${renderTaskNodes(projectTasks)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function renderTaskNodes(taskList) {
            let html = '';
            
            taskList.forEach(task => {
                const taskQuestionCount = getTaskQuestionCount(task.task_id);
                const isActive = currentFilterType === 'task' && currentFilterId === task.task_id;
                
                html += `
                    <div class="tree-node level-task" data-task-id="${task.task_id}">
                        <div class="tree-header ${isActive ? 'active' : ''}"
                             onclick="selectHierarchyNode('task', '${task.task_id}')"
                             data-type="task" data-id="${task.task_id}">
                            <span class="tree-toggle empty"></span>
                            <span class="tree-icon">${task.icon || '📋'}</span>
                            <span class="tree-name" style="color:${task.color};">${task.name}</span>
                            <span class="tree-count">${taskQuestionCount}</span>
                            <div class="tree-actions">
                                <button class="tree-action-btn" onclick="event.stopPropagation(); editTask('${task.task_id}')" title="编辑">✏️</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // 获取各级题目数量
        function getCourseQuestionCount(courseId) {
            const courseProjectIds = projects.filter(p => p.course_id === courseId).map(p => p.project_id);
            const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
            return questions.filter(q => courseTaskIds.includes(q.task_id)).length;
        }
        
        function getProjectQuestionCount(projectId) {
            const projectTaskIds = tasks.filter(t => t.project_id === projectId).map(t => t.task_id);
            return questions.filter(q => projectTaskIds.includes(q.task_id)).length;
        }
        
        function getTaskQuestionCount(taskId) {
            return questions.filter(q => q.task_id === taskId).length;
        }
        
        function updateTotalCount() {
            const totalCountEl = document.getElementById('total-count');
            if (totalCountEl) {
                totalCountEl.textContent = questions.length;
            }
        }
        
        // 展开/收起节点
        function toggleCourseNode(courseId) {
            expandedNodes.courses[courseId] = !expandedNodes.courses[courseId];
            renderHierarchyTree();
        }
        
        function toggleProjectNode(projectId) {
            expandedNodes.projects[projectId] = !expandedNodes.projects[projectId];
            renderHierarchyTree();
        }
        
        // 选择层级节点
        function selectHierarchyNode(type, id) {
            currentFilterType = type;
            currentFilterId = id;
            
            // 更新激活状态
            document.querySelectorAll('.tree-header').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.tree-header[data-type="${type}"][data-id="${id}"]`);
            if (activeEl) activeEl.classList.add('active');
            
            // 如果选择了课程或项目，自动展开
            if (type === 'course') {
                expandedNodes.courses[id] = true;
            } else if (type === 'project') {
                expandedNodes.projects[id] = true;
                // 也展开父课程
                const project = projects.find(p => p.project_id === id);
                if (project) {
                    expandedNodes.courses[project.course_id] = true;
                }
            } else if (type === 'task') {
                // 展开父项目和父课程
                const task = tasks.find(t => t.task_id === id);
                if (task) {
                    expandedNodes.projects[task.project_id] = true;
                    const project = projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        expandedNodes.courses[project.course_id] = true;
                    }
                }
            }
            
            renderHierarchyTree();
            loadQuestions();
        }
        
        // ================== 项目管理 ==================
        function openAddProject() {
            document.getElementById('project-modal-title').textContent = '➕ 新建项目';
            document.getElementById('edit-project-id').value = '';
            document.getElementById('project-name').value = '';
            document.getElementById('project-desc').value = '';
            // 更新课程选择列表
            updateCourseSelects();
            // 如果当前选择了课程，默认选中该课程
            const projCourseSelect = document.getElementById('project-course');
            if (projCourseSelect) {
                if (currentFilterType === 'course' && currentFilterId !== 'all') {
                    projCourseSelect.value = currentFilterId;
                } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                    const project = projects.find(p => p.project_id === currentFilterId);
                    if (project) projCourseSelect.value = project.course_id;
                } else if (currentFilterType === 'task' && currentFilterId !== 'all') {
                    const task = tasks.find(t => t.task_id === currentFilterId);
                    if (task) {
                        const project = projects.find(p => p.project_id === task.project_id);
                        if (project) projCourseSelect.value = project.course_id;
                    }
                } else {
                    projCourseSelect.value = '';
                }
            }
            // 重置颜色选择
            document.querySelectorAll('.project-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
            document.querySelector('.project-color-opt').style.borderColor = 'white';
            document.querySelector('input[name="project-color"]').checked = true;
            document.getElementById('project-modal').style.display = 'flex';
        }
        
        async function editProject(projectId) {
            const project = projects.find(p => p.project_id === projectId);
            if (!project) return;
            
            document.getElementById('project-modal-title').textContent = '✏️ 编辑项目';
            document.getElementById('edit-project-id').value = projectId;
            document.getElementById('project-name').value = project.name;
            document.getElementById('project-desc').value = project.description || '';
            
            // 更新课程选择列表并选中
            updateCourseSelects();
            const projCourseSelect = document.getElementById('project-course');
            if (projCourseSelect) {
                projCourseSelect.value = project.course_id || '';
            }
            
            // 选中对应颜色
            document.querySelectorAll('input[name="project-color"]').forEach(input => {
                if (input.value === project.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('project-modal').style.display = 'flex';
        }
        
        function closeProjectModal() {
            document.getElementById('project-modal').style.display = 'none';
        }
        
        async function saveProject() {
            const id = document.getElementById('edit-project-id').value;
            const courseId = document.getElementById('project-course').value;
            const name = document.getElementById('project-name').value.trim();
            const description = document.getElementById('project-desc').value.trim();
            const color = document.querySelector('input[name="project-color"]:checked')?.value || '#10b981';
            
            if (!courseId) { alert('请选择所属课程'); return; }
            if (!name) { alert('请输入项目名称'); return; }
            
            const data = { course_id: courseId, name, description, color };
            
            if (id) {
                // 更新项目
                const { error } = await supabaseClient.from('projects').update(data).eq('project_id', id);
                if (error) { alert('更新失败: ' + error.message); return; }
            } else {
                // 新建项目时初始化 task_count 和 question_count 为 0
                data.task_count = 0;
                data.question_count = 0;
                const { error } = await supabaseClient.from('projects').insert([data]);
                if (error) { alert('创建失败: ' + error.message); return; }
            }
            
            closeProjectModal();
            await loadHierarchy();
            
            // 更新课程的项目数量
            await updateCourseQuestionCount(courseId);
            
            alert('✅ 保存成功');
        }
        
        // 项目列表管理
        function manageProjects() {
            renderProjectsList();
            document.getElementById('projects-list-modal').style.display = 'flex';
        }
        
        function closeProjectsListModal() {
            document.getElementById('projects-list-modal').style.display = 'none';
        }
        
        function renderProjectsList() {
            const container = document.getElementById('projects-list-content');
            if (projects.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">暂无项目，请先创建项目</div>';
                return;
            }
            
            // 按课程分组显示项目
            let html = '';
            courses.forEach(course => {
                const courseProjects = projects.filter(p => p.course_id === course.course_id);
                if (courseProjects.length > 0) {
                    html += `<div style="font-size:0.85rem; color:${course.color}; margin:15px 0 10px 0; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">${course.icon || '📖'} ${course.name}</div>`;
                    courseProjects.forEach(p => {
                        // 计算任务数量
                        const taskCount = tasks.filter(t => t.project_id === p.project_id).length;
                        // 计算题目数量
                        const projectTaskIds = tasks.filter(t => t.project_id === p.project_id).map(t => t.task_id);
                        const qCount = questions.filter(q => projectTaskIds.includes(q.task_id)).length;
                        
                        html += `
                            <div style="display:flex; align-items:center; padding:12px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:8px; border-left:4px solid ${p.color};">
                                <div style="font-size:1.5rem; margin-right:12px;">${p.icon || '📁'}</div>
                                <div style="flex:1;">
                                    <div style="font-weight:bold;">${p.name}</div>
                                    <div style="font-size:0.8rem; color:#94a3b8; margin-top:2px;">
                                        ${taskCount} 个任务 | ${qCount} 道题目
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button onclick="editProject('${p.project_id}')" class="btn btn-secondary" style="padding:6px 10px; font-size:0.75rem;">✏️ 编辑</button>
                                    <button onclick="deleteProject('${p.project_id}')" class="btn btn-danger" style="padding:6px 10px; font-size:0.75rem;">🗑️ 删除</button>
                                </div>
                            </div>
                        `;
                    });
                }
            });
            
            if (!html) {
                html = '<div style="text-align:center; padding:30px; color:#666;">暂无项目，请先创建项目</div>';
            }
            
            container.innerHTML = html;
        }
        
        // 更新项目的任务数量和题目数量（使用新的统一函数）
        async function updateProjectStats(projectId) {
            await updateProjectQuestionCount(projectId);
        }
        
        // 删除项目（级联删除任务和题目）
        async function deleteProject(projectId) {
            // 计算将被删除的任务和题目数量
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            const taskCount = projectTasks.length;
            const projectTaskIds = projectTasks.map(t => t.task_id);
            const questionCount = questions.filter(q => projectTaskIds.includes(q.task_id)).length;
            
            const project = projects.find(p => p.project_id === projectId);
            const projectName = project ? project.name : '该项目';
            const course = project ? courses.find(c => c.course_id === project.course_id) : null;
            const courseName = course ? course.name : '';
            
            // 显示确认对话框，包含将被删除的任务和题目数量
            const confirmMsg = `确定要删除项目「${projectName}」吗？\n\n⚠️ 此操作将同时删除：\n• ${taskCount} 个任务\n• ${questionCount} 道题目\n\n此操作不可撤销！`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // 级联删除：先删除题目，再删除任务，最后删除项目
                
                // 1. 删除该项目下所有任务的题目
                if (projectTaskIds.length > 0) {
                    const { error: qError } = await supabaseClient
                        .from('questions')
                        .delete()
                        .in('task_id', projectTaskIds);
                    if (qError) {
                        console.error('删除题目失败:', qError);
                    }
                }
                
                // 2. 删除该项目下的所有任务
                const { error: tError } = await supabaseClient
                    .from('tasks')
                    .delete()
                    .eq('project_id', projectId);
                if (tError) {
                    console.error('删除任务失败:', tError);
                }
                
                // 3. 删除项目
                const { error } = await supabaseClient.from('projects').delete().eq('project_id', projectId);
                if (error) { 
                    alert('删除项目失败: ' + error.message); 
                    return; 
                }
                
                // 重置筛选状态
                if (currentFilterType === 'project' && currentFilterId === projectId) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                } else if (currentFilterType === 'task' && projectTaskIds.includes(currentFilterId)) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                }
                
                // 重新加载数据
                await loadHierarchy();
                await loadQuestions();
                
                // 更新课程的题目数量
                if (course) {
                    await updateCourseQuestionCount(course.course_id);
                }
                
                // 刷新项目列表弹窗（如果打开的话）
                if (document.getElementById('projects-list-modal').style.display === 'flex') {
                    renderProjectsList();
                }
                
                alert(`✅ 已删除项目「${projectName}」及其下属 ${taskCount} 个任务、${questionCount} 道题目`);
                
            } catch (err) {
                console.error('删除项目时发生错误:', err);
                alert('删除失败，请重试');
            }
        }
        
        // ================== 任务管理 ==================
        function openAddTask() {
            document.getElementById('task-modal-title').textContent = '➕ 新建任务';
            document.getElementById('edit-task-id').value = '';
            document.getElementById('task-name').value = '';
            document.getElementById('task-desc').value = '';
            
            // 更新课程选择列表
            updateTaskCourseSelect();
            
            // 根据当前选择的层级预设课程和项目
            const taskCourseSelect = document.getElementById('task-course');
            const taskProjectSelect = document.getElementById('task-project');
            
            if (currentFilterType === 'course' && currentFilterId !== 'all') {
                taskCourseSelect.value = currentFilterId;
                updateTaskProjectSelect();
            } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                const project = projects.find(p => p.project_id === currentFilterId);
                if (project) {
                    taskCourseSelect.value = project.course_id;
                    updateTaskProjectSelect();
                    taskProjectSelect.value = currentFilterId;
                }
            } else if (currentFilterType === 'task' && currentFilterId !== 'all') {
                const task = tasks.find(t => t.task_id === currentFilterId);
                if (task) {
                    const project = projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        taskCourseSelect.value = project.course_id;
                        updateTaskProjectSelect();
                        taskProjectSelect.value = task.project_id;
                    }
                }
            } else {
                taskCourseSelect.value = '';
                taskProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
            }
            
            // 重置颜色选择
            document.querySelectorAll('.task-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
            document.querySelector('.task-color-opt').style.borderColor = 'white';
            document.querySelector('input[name="task-color"]').checked = true;
            
            document.getElementById('task-modal').style.display = 'flex';
        }
        
        async function editTask(taskId) {
            const task = tasks.find(t => t.task_id === taskId);
            if (!task) return;
            
            document.getElementById('task-modal-title').textContent = '✏️ 编辑任务';
            document.getElementById('edit-task-id').value = taskId;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-desc').value = task.description || '';
            
            // 更新课程选择列表
            updateTaskCourseSelect();
            
            // 找到任务所属的项目和课程
            const project = projects.find(p => p.project_id === task.project_id);
            if (project) {
                document.getElementById('task-course').value = project.course_id;
                updateTaskProjectSelect();
                document.getElementById('task-project').value = task.project_id;
            }
            
            // 选中对应颜色
            document.querySelectorAll('input[name="task-color"]').forEach(input => {
                if (input.value === task.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('task-modal').style.display = 'flex';
        }
        
        function closeTaskModal() {
            document.getElementById('task-modal').style.display = 'none';
        }
        
        function updateTaskCourseSelect() {
            const taskCourseSelect = document.getElementById('task-course');
            if (taskCourseSelect) {
                taskCourseSelect.innerHTML = '<option value="">请选择课程</option>' + 
                    courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            }
        }
        
        function updateTaskProjectSelect() {
            const courseId = document.getElementById('task-course').value;
            const taskProjectSelect = document.getElementById('task-project');
            
            if (!courseId) {
                taskProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
                return;
            }
            
            const courseProjects = projects.filter(p => p.course_id === courseId);
            if (courseProjects.length === 0) {
                taskProjectSelect.innerHTML = '<option value="">该课程下暂无项目</option>';
            } else {
                taskProjectSelect.innerHTML = '<option value="">请选择项目</option>' + 
                    courseProjects.map(p => `<option value="${p.project_id}">${p.name}</option>`).join('');
            }
        }
        
        async function saveTask() {
            const id = document.getElementById('edit-task-id').value;
            const projectId = document.getElementById('task-project').value;
            const name = document.getElementById('task-name').value.trim();
            const description = document.getElementById('task-desc').value.trim();
            const color = document.querySelector('input[name="task-color"]:checked')?.value || '#f59e0b';
            
            if (!projectId) { alert('请选择所属项目'); return; }
            if (!name) { alert('请输入任务名称'); return; }
            
            const data = { project_id: projectId, name, description, color };
            
            if (id) {
                // 更新任务
                const { error } = await supabaseClient.from('tasks').update(data).eq('task_id', id);
                if (error) { alert('更新失败: ' + error.message); return; }
            } else {
                // 新建任务时初始化 question_count 为 0
                data.question_count = 0;
                const { error } = await supabaseClient.from('tasks').insert([data]);
                if (error) { alert('创建失败: ' + error.message); return; }
            }
            
            closeTaskModal();
            await loadHierarchy();
            
            // 更新项目和课程的任务/题目数量
            await updateProjectQuestionCount(projectId);
            const project = projects.find(p => p.project_id === projectId);
            if (project) {
                await updateCourseQuestionCount(project.course_id);
            }
            
            alert('✅ 保存成功');
        }
        
        // 任务列表管理
        function manageTasks() {
            renderTasksList();
            document.getElementById('tasks-list-modal').style.display = 'flex';
        }
        
        function closeTasksListModal() {
            document.getElementById('tasks-list-modal').style.display = 'none';
        }
        
        function renderTasksList() {
            const container = document.getElementById('tasks-list-content');
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">暂无任务，请先创建任务</div>';
                return;
            }
            
            // 按课程和项目分组显示任务
            let html = '';
            courses.forEach(course => {
                const courseProjects = projects.filter(p => p.course_id === course.course_id);
                let courseHasContent = false;
                let courseHtml = '';
                
                courseProjects.forEach(project => {
                    const projectTasks = tasks.filter(t => t.project_id === project.project_id);
                    if (projectTasks.length > 0) {
                        courseHasContent = true;
                        courseHtml += `<div style="font-size:0.8rem; color:${project.color}; margin:10px 0 8px 15px; font-weight:bold;">${project.icon || '📁'} ${project.name}</div>`;
                        projectTasks.forEach(t => {
                            const qCount = questions.filter(q => q.task_id === t.task_id).length;
                            courseHtml += `
                                <div style="display:flex; align-items:center; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin:0 0 6px 30px; border-left:3px solid ${t.color};">
                                    <div style="font-size:1.2rem; margin-right:10px;">${t.icon || '📋'}</div>
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; font-size:0.9rem;">${t.name}</div>
                                        <div style="font-size:0.75rem; color:#94a3b8; margin-top:2px;">
                                            ${qCount} 道题目
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:6px;">
                                        <button onclick="editTask('${t.task_id}')" class="btn btn-secondary" style="padding:5px 8px; font-size:0.7rem;">✏️ 编辑</button>
                                        <button onclick="deleteTask('${t.task_id}')" class="btn btn-danger" style="padding:5px 8px; font-size:0.7rem;">🗑️ 删除</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
                
                if (courseHasContent) {
                    html += `<div style="font-size:0.85rem; color:${course.color}; margin:15px 0 10px 0; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">${course.icon || '📖'} ${course.name}</div>`;
                    html += courseHtml;
                }
            });
            
            if (!html) {
                html = '<div style="text-align:center; padding:30px; color:#666;">暂无任务，请先创建任务</div>';
            }
            
            container.innerHTML = html;
        }
        
        // ================== 题目数量更新函数 ==================
        // 更新任务的题目数量
        async function updateTaskQuestionCount(taskId) {
            if (!taskId) return;
            const questionCount = questions.filter(q => q.task_id === taskId).length;
            
            const { error } = await supabaseClient.from('tasks').update({
                question_count: questionCount
            }).eq('task_id', taskId);
            
            if (error) {
                console.error('更新任务题目数量失败:', error);
            }
            
            // 同时更新本地缓存
            const task = tasks.find(t => t.task_id === taskId);
            if (task) {
                task.question_count = questionCount;
            }
        }
        
        // 更新项目的题目数量（从任务聚合）
        async function updateProjectQuestionCount(projectId) {
            if (!projectId) return;
            
            // 获取该项目下所有任务的题目数量总和
            const projectTaskIds = tasks.filter(t => t.project_id === projectId).map(t => t.task_id);
            const questionCount = questions.filter(q => projectTaskIds.includes(q.task_id)).length;
            const taskCount = projectTaskIds.length;
            
            const { error } = await supabaseClient.from('projects').update({
                question_count: questionCount,
                task_count: taskCount
            }).eq('project_id', projectId);
            
            if (error) {
                console.error('更新项目题目数量失败:', error);
            }
            
            // 同时更新本地缓存
            const project = projects.find(p => p.project_id === projectId);
            if (project) {
                project.question_count = questionCount;
                project.task_count = taskCount;
            }
        }
        
        // 更新课程的题目数量（从项目聚合）
        async function updateCourseQuestionCount(courseId) {
            if (!courseId) return;
            
            // 获取该课程下所有项目的题目数量总和
            const courseProjectIds = projects.filter(p => p.course_id === courseId).map(p => p.project_id);
            const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
            const questionCount = questions.filter(q => courseTaskIds.includes(q.task_id)).length;
            const projectCount = courseProjectIds.length;
            
            const { error } = await supabaseClient.from('courses').update({
                question_count: questionCount,
                project_count: projectCount
            }).eq('course_id', courseId);
            
            if (error) {
                console.error('更新课程题目数量失败:', error);
            }
            
            // 同时更新本地缓存
            const course = courses.find(c => c.course_id === courseId);
            if (course) {
                course.question_count = questionCount;
                course.project_count = projectCount;
            }
        }
        
        // 更新整个层级链的题目数量（从任务到项目到课程）
        async function updateHierarchyQuestionCounts(taskId) {
            if (!taskId) return;
            
            // 1. 更新任务的题目数量
            await updateTaskQuestionCount(taskId);
            
            // 2. 找到任务所属的项目并更新
            const task = tasks.find(t => t.task_id === taskId);
            if (task && task.project_id) {
                await updateProjectQuestionCount(task.project_id);
                
                // 3. 找到项目所属的课程并更新
                const project = projects.find(p => p.project_id === task.project_id);
                if (project && project.course_id) {
                    await updateCourseQuestionCount(project.course_id);
                }
            }
        }
        
        // 更新所有层级的题目数量（用于批量操作后）
        async function updateAllHierarchyCounts() {
            // 更新所有任务的题目数量
            for (const task of tasks) {
                await updateTaskQuestionCount(task.task_id);
            }
            
            // 更新所有项目的题目数量
            for (const project of projects) {
                await updateProjectQuestionCount(project.project_id);
            }
            
            // 更新所有课程的题目数量
            for (const course of courses) {
                await updateCourseQuestionCount(course.course_id);
            }
        }
        
        // 保留旧函数名以兼容现有代码
        async function updateTaskStats(taskId) {
            await updateTaskQuestionCount(taskId);
        }
        
        // 删除任务（级联删除题目）
        async function deleteTask(taskId) {
            // 计算将被删除的题目数量
            const questionCount = questions.filter(q => q.task_id === taskId).length;
            
            const task = tasks.find(t => t.task_id === taskId);
            const taskName = task ? task.name : '该任务';
            const project = task ? projects.find(p => p.project_id === task.project_id) : null;
            const projectName = project ? project.name : '';
            const course = project ? courses.find(c => c.course_id === project.course_id) : null;
            const courseName = course ? course.name : '';
            
            // 显示确认对话框，包含将被删除的题目数量
            const confirmMsg = `确定要删除任务「${taskName}」吗？\n\n⚠️ 此操作将同时删除：\n• ${questionCount} 道题目\n\n此操作不可撤销！`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // 级联删除：先删除题目，再删除任务
                
                // 1. 删除该任务下的所有题目
                if (questionCount > 0) {
                    const { error: qError } = await supabaseClient
                        .from('questions')
                        .delete()
                        .eq('task_id', taskId);
                    if (qError) {
                        console.error('删除题目失败:', qError);
                    }
                }
                
                // 2. 删除任务
                const { error } = await supabaseClient.from('tasks').delete().eq('task_id', taskId);
                if (error) { 
                    alert('删除任务失败: ' + error.message); 
                    return; 
                }
                
                // 重置筛选状态
                if (currentFilterType === 'task' && currentFilterId === taskId) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                }
                
                // 重新加载数据
                await loadHierarchy();
                await loadQuestions();
                
                // 更新项目和课程的题目数量
                if (project) {
                    await updateProjectQuestionCount(project.project_id);
                    if (course) {
                        await updateCourseQuestionCount(course.course_id);
                    }
                }
                
                // 刷新任务列表弹窗（如果打开的话）
                if (document.getElementById('tasks-list-modal').style.display === 'flex') {
                    renderTasksList();
                }
                
                alert(`✅ 已删除任务「${taskName}」及其下属 ${questionCount} 道题目`);
                
            } catch (err) {
                console.error('删除任务时发生错误:', err);
                alert('删除失败，请重试');
            }
        }
        
        function openAddCourse() {
            document.getElementById('course-modal-title').textContent = '➕ 新建课程';
            document.getElementById('edit-course-id').value = '';
            document.getElementById('course-name').value = '';
            document.getElementById('course-code').value = '';
            document.getElementById('course-teacher').value = '';
            document.getElementById('course-semester').value = '';
            document.getElementById('course-desc').value = '';
            // 重置颜色选择
            document.querySelectorAll('.course-color-opt').forEach(opt => opt.style.borderColor = 'transparent');
            document.querySelector('.course-color-opt').style.borderColor = 'white';
            document.querySelector('input[name="course-color"]').checked = true;
            document.getElementById('course-modal').style.display = 'flex';
        }
        
        async function editCourse(id) {
            const course = courses.find(c => c.course_id === id);
            if (!course) return;
            
            document.getElementById('course-modal-title').textContent = '✏️ 编辑课程';
            document.getElementById('edit-course-id').value = id;
            document.getElementById('course-name').value = course.name;
            document.getElementById('course-code').value = course.code || '';
            document.getElementById('course-teacher').value = course.teacher || '';
            document.getElementById('course-semester').value = course.semester || '';
            document.getElementById('course-desc').value = course.description || '';
            
            // 选中对应颜色
            document.querySelectorAll('input[name="course-color"]').forEach(input => {
                if (input.value === course.color) {
                    input.checked = true;
                    input.nextElementSibling.style.borderColor = 'white';
                } else {
                    input.nextElementSibling.style.borderColor = 'transparent';
                }
            });
            
            document.getElementById('course-modal').style.display = 'flex';
        }
        
        function closeCourseModal() {
            document.getElementById('course-modal').style.display = 'none';
        }
        
        async function saveCourse() {
            const id = document.getElementById('edit-course-id').value;
            const name = document.getElementById('course-name').value.trim();
            const code = document.getElementById('course-code').value.trim();
            const teacher = document.getElementById('course-teacher').value.trim();
            const semester = document.getElementById('course-semester').value.trim();
            const description = document.getElementById('course-desc').value.trim();
            const color = document.querySelector('input[name="course-color"]:checked')?.value || '#3b82f6';
            
            if (!name) { alert('请输入课程名称'); return; }
            
            const data = { name, code, teacher, semester, description, color };
            
            if (id) {
                // 更新课程时保留现有的 project_count 和 question_count
                const { error } = await supabaseClient.from('courses').update(data).eq('course_id', id);
                if (error) { alert('更新失败: ' + error.message); return; }
            } else {
                // 新建课程时初始化 project_count 和 question_count 为 0
                data.project_count = 0;
                data.question_count = 0;
                const { error } = await supabaseClient.from('courses').insert([data]);
                if (error) { alert('创建失败: ' + error.message); return; }
            }
            
            closeCourseModal();
            await loadHierarchy();
            alert('✅ 保存成功');
        }
        
        async function deleteCourse(id) {
            // 计算将被删除的项目、任务和题目数量
            const courseProjects = projects.filter(p => p.course_id === id);
            const projectCount = courseProjects.length;
            const courseProjectIds = courseProjects.map(p => p.project_id);
            const courseTasks = tasks.filter(t => courseProjectIds.includes(t.project_id));
            const taskCount = courseTasks.length;
            const courseTaskIds = courseTasks.map(t => t.task_id);
            const questionCount = questions.filter(q => courseTaskIds.includes(q.task_id)).length;
            
            const course = courses.find(c => c.course_id === id);
            const courseName = course ? course.name : '该课程';
            
            // 显示确认对话框，包含将被删除的项目数量
            const confirmMsg = `确定要删除课程「${courseName}」吗？\n\n⚠️ 此操作将同时删除：\n• ${projectCount} 个项目\n• ${taskCount} 个任务\n• ${questionCount} 道题目\n\n此操作不可撤销！`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // 级联删除：先删除题目，再删除任务，再删除项目，最后删除课程
                // 由于数据库设置了 ON DELETE CASCADE，只需删除课程即可
                // 但为了确保数据一致性，我们手动按顺序删除
                
                // 1. 删除该课程下所有任务的题目
                if (courseTaskIds.length > 0) {
                    const { error: qError } = await supabaseClient
                        .from('questions')
                        .delete()
                        .in('task_id', courseTaskIds);
                    if (qError) {
                        console.error('删除题目失败:', qError);
                    }
                }
                
                // 2. 删除该课程下所有项目的任务
                if (courseProjectIds.length > 0) {
                    const { error: tError } = await supabaseClient
                        .from('tasks')
                        .delete()
                        .in('project_id', courseProjectIds);
                    if (tError) {
                        console.error('删除任务失败:', tError);
                    }
                }
                
                // 3. 删除该课程下的所有项目
                const { error: pError } = await supabaseClient
                    .from('projects')
                    .delete()
                    .eq('course_id', id);
                if (pError) {
                    console.error('删除项目失败:', pError);
                }
                
                // 4. 删除课程
                const { error } = await supabaseClient.from('courses').delete().eq('course_id', id);
                if (error) { 
                    alert('删除课程失败: ' + error.message); 
                    return; 
                }
                
                // 重置筛选状态
                if (currentFilterType === 'course' && currentFilterId === id) {
                    currentFilterType = 'all';
                    currentFilterId = 'all';
                }
                
                // 重新加载数据
                await loadHierarchy();
                await loadQuestions();
                
                alert(`✅ 已删除课程「${courseName}」及其下属 ${projectCount} 个项目、${taskCount} 个任务、${questionCount} 道题目`);
                
            } catch (err) {
                console.error('删除课程时发生错误:', err);
                alert('删除失败，请重试');
            }
        }
        
        function manageCourses() {
            // 确保数据已加载后再渲染课程列表
            renderCoursesList();
            document.getElementById('courses-list-modal').style.display = 'flex';
        }
        
        // 打开课程管理列表弹窗
        function openCoursesListModal() {
            renderCoursesList();
            document.getElementById('courses-list-modal').style.display = 'flex';
        }
        
        function closeCoursesListModal() {
            document.getElementById('courses-list-modal').style.display = 'none';
        }
        
        function renderCoursesList() {
            const container = document.getElementById('courses-list-content');
            if (courses.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">暂无课程，请先创建课程</div>';
                return;
            }
            
            container.innerHTML = courses.map(c => {
                // 计算项目数量
                const projectCount = projects.filter(p => p.course_id === c.course_id).length;
                // 计算任务数量
                const courseProjectIds = projects.filter(p => p.course_id === c.course_id).map(p => p.project_id);
                const taskCount = tasks.filter(t => courseProjectIds.includes(t.project_id)).length;
                // 计算题目数量
                const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
                const qCount = questions.filter(q => courseTaskIds.includes(q.task_id)).length;
                
                return `
                    <div style="display:flex; align-items:center; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:10px; border-left:4px solid ${c.color};">
                        <div style="font-size:2rem; margin-right:15px;">${c.icon || '📖'}</div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:1.1rem;">${c.name}</div>
                            <div style="font-size:0.85rem; color:#94a3b8; margin-top:3px;">
                                ${c.code ? `代码: ${c.code} | ` : ''}${c.teacher ? `教师: ${c.teacher} | ` : ''}${projectCount} 个项目 | ${taskCount} 个任务 | ${qCount} 道题目
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="editCourse('${c.course_id}')" class="btn btn-secondary" style="padding:8px 12px; font-size:0.8rem;">✏️ 编辑</button>
                            <button onclick="deleteCourse('${c.course_id}')" class="btn btn-danger" style="padding:8px 12px; font-size:0.8rem;">🗑️ 删除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ================== 题目管理 ==================
        async function loadQuestions() {
            let query = supabaseClient.from('questions').select('*').order('round');
            
            // 筛选条件
            const typeFilter = document.getElementById('filter-type')?.value;
            const difficultyFilter = document.getElementById('filter-difficulty')?.value;
            const searchText = document.getElementById('search-input')?.value?.toLowerCase();
            
            if (typeFilter) query = query.eq('question_type', typeFilter);
            if (difficultyFilter) query = query.eq('difficulty', parseInt(difficultyFilter));
            
            const { data, error } = await query;
            if (error) {
                console.error('加载题目失败:', error);
                document.getElementById('question-list').innerHTML = '<div style="text-align:center; padding:50px; color:#ef4444;">加载失败</div>';
                return;
            }
            
            questions = data || [];
            
            // 根据层级筛选
            let filtered = questions;
            if (currentFilterType === 'task' && currentFilterId !== 'all') {
                filtered = questions.filter(q => q.task_id === currentFilterId);
            } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                const projectTaskIds = tasks.filter(t => t.project_id === currentFilterId).map(t => t.task_id);
                filtered = questions.filter(q => projectTaskIds.includes(q.task_id));
            } else if (currentFilterType === 'course' && currentFilterId !== 'all') {
                const courseProjectIds = projects.filter(p => p.course_id === currentFilterId).map(p => p.project_id);
                const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
                filtered = questions.filter(q => courseTaskIds.includes(q.task_id));
            }
            
            // 搜索过滤
            if (searchText) {
                filtered = filtered.filter(q => q.title.toLowerCase().includes(searchText) || (q.knowledge_tag || '').toLowerCase().includes(searchText));
            }
            
            // 保存当前显示的题目列表（用于批量操作）
            currentDisplayedQuestions = filtered;
            
            renderQuestions(filtered);
            updateStats();
            renderHierarchyTree();
        }
        
        function renderQuestions(list) {
            const container = document.getElementById('question-list');
            
            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#666;">暂无题目</div>';
                updateBatchToolbar();
                return;
            }
            
            // 获取当前搜索关键词用于高亮
            const searchKeyword = document.getElementById('search-input')?.value || '';
            
            container.innerHTML = list.map(q => {
                const type = typeConfig[q.question_type] || typeConfig.single;
                const task = tasks.find(t => t.task_id === q.task_id);
                const project = task ? projects.find(p => p.project_id === task.project_id) : null;
                const course = project ? courses.find(c => c.course_id === project.course_id) : null;
                const difficulty = '⭐'.repeat(q.difficulty || 1);
                const isSelected = BatchOperations.isSelected(q.id);
                
                // 构建层级路径显示
                let hierarchyPath = '';
                if (task) {
                    hierarchyPath = `<span style="background:${task.color}20; color:${task.color}; padding:2px 8px; border-radius:4px; font-size:0.75rem;" title="${course?.name || ''} > ${project?.name || ''} > ${task.name}">${task.name}</span>`;
                }
                
                // 高亮标题中的关键词
                const highlightedTitle = searchKeyword ? QuestionSearch.highlightKeyword(q.title, searchKeyword) : q.title;
                
                return `
                    <div class="question-item ${isSelected ? 'selected' : ''}" data-question-id="${q.id}" style="background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; display:flex; gap:15px; align-items:flex-start;">
                        <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                            <input type="checkbox" class="question-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleQuestionSelect('${q.id}')" onclick="event.stopPropagation()">
                            <div style="font-size:1.3rem; font-weight:bold; color:#3b82f6;">${q.round}</div>
                            <div style="font-size:0.65rem; color:#94a3b8;">序号</div>
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
                                <span style="background:${type.color}; color:white; padding:2px 8px; border-radius:4px; font-size:0.75rem;">${type.icon} ${type.name}</span>
                                ${hierarchyPath}
                                ${q.knowledge_tag ? `<span style="background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:0.75rem;">${q.knowledge_tag}</span>` : ''}
                                <span style="font-size:0.75rem; color:#f59e0b;">${difficulty}</span>
                            </div>
                            <div style="font-size:0.95rem; line-height:1.5; margin-bottom:8px;">${highlightedTitle}</div>
                            ${q.question_type !== 'fillblank' && q.question_type !== 'truefalse' ? `
                                <div style="display:flex; gap:15px; flex-wrap:wrap; font-size:0.85rem; color:#94a3b8;">
                                    ${q.option_a ? `<span>A. ${q.option_a.substring(0, 20)}${q.option_a.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_b ? `<span>B. ${q.option_b.substring(0, 20)}${q.option_b.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_c ? `<span>C. ${q.option_c.substring(0, 20)}${q.option_c.length > 20 ? '...' : ''}</span>` : ''}
                                    ${q.option_d ? `<span>D. ${q.option_d.substring(0, 20)}${q.option_d.length > 20 ? '...' : ''}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-end;">
                            <div style="background:#10b981; color:white; padding:5px 12px; border-radius:6px; font-weight:bold;">${q.answer}</div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="showVersionHistory('${q.id}')" class="btn btn-secondary" style="padding:5px 10px; font-size:0.75rem;" title="版本历史">📜</button>
                                <button onclick="editQuestion(${q.round})" class="btn btn-secondary" style="padding:5px 10px; font-size:0.75rem;">✏️ 编辑</button>
                                <button onclick="deleteQuestion(${q.round})" class="btn btn-danger" style="padding:5px 10px; font-size:0.75rem;">🗑️</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateBatchToolbar();
        }
        
        function updateStats() {
            const stats = { single: 0, multiple: 0, truefalse: 0, fillblank: 0 };
            questions.forEach(q => {
                const type = q.question_type || 'single';
                if (stats[type] !== undefined) stats[type]++;
            });
            
            document.getElementById('stat-single').textContent = stats.single;
            document.getElementById('stat-multiple').textContent = stats.multiple;
            document.getElementById('stat-truefalse').textContent = stats.truefalse;
            document.getElementById('stat-fillblank').textContent = stats.fillblank;
            document.getElementById('total-count').textContent = questions.length;
        }
        
        // 搜索和筛选
        document.getElementById('search-input')?.addEventListener('input', debounce(loadQuestions, 300));
        document.getElementById('filter-type')?.addEventListener('change', loadQuestions);
        document.getElementById('filter-difficulty')?.addEventListener('change', loadQuestions);
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ================== 添加/编辑题目 ==================
        async function openAddQuestion() {
            // 获取下一个可用序号
            const { data } = await supabaseClient.from('questions').select('round').order('round', { ascending: false }).limit(1);
            const nextRound = (data && data[0]) ? data[0].round + 1 : 1;
            
            document.getElementById('question-modal-title').textContent = '➕ 添加题目';
            document.getElementById('edit-question-id').value = '';
            document.getElementById('q-round').value = nextRound;
            document.getElementById('q-type').value = 'single';
            document.getElementById('q-title').value = '';
            document.getElementById('q-opt-a').value = '';
            document.getElementById('q-opt-b').value = '';
            document.getElementById('q-opt-c').value = '';
            document.getElementById('q-opt-d').value = '';
            document.getElementById('q-answer').value = '';
            document.getElementById('q-tag').value = '';
            document.getElementById('q-difficulty').value = '1';
            document.getElementById('q-explanation').value = '';
            
            // 初始化题目弹窗的课程选择器
            updateQuestionCourseSelect();
            
            // 根据当前选择的层级预设课程、项目和任务
            const qCourseSelect = document.getElementById('q-course');
            const qProjectSelect = document.getElementById('q-project');
            const qTaskSelect = document.getElementById('q-task');
            
            if (currentFilterType === 'task' && currentFilterId !== 'all') {
                const task = tasks.find(t => t.task_id === currentFilterId);
                if (task) {
                    const project = projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        qCourseSelect.value = project.course_id;
                        updateQuestionProjectSelect();
                        qProjectSelect.value = task.project_id;
                        updateQuestionTaskSelect();
                        qTaskSelect.value = currentFilterId;
                    }
                }
            } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                const project = projects.find(p => p.project_id === currentFilterId);
                if (project) {
                    qCourseSelect.value = project.course_id;
                    updateQuestionProjectSelect();
                    qProjectSelect.value = currentFilterId;
                    updateQuestionTaskSelect();
                }
            } else if (currentFilterType === 'course' && currentFilterId !== 'all') {
                qCourseSelect.value = currentFilterId;
                updateQuestionProjectSelect();
            } else {
                qProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
                qTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            }
            
            updateQuestionForm();
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        // 更新题目弹窗的课程选择器
        function updateQuestionCourseSelect() {
            const qCourseSelect = document.getElementById('q-course');
            if (qCourseSelect) {
                qCourseSelect.innerHTML = '<option value="">请选择课程</option>' + 
                    courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            }
        }
        
        // 更新题目弹窗的项目选择器
        function updateQuestionProjectSelect() {
            const courseId = document.getElementById('q-course').value;
            const qProjectSelect = document.getElementById('q-project');
            const qTaskSelect = document.getElementById('q-task');
            
            if (!courseId) {
                qProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
                qTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const courseProjects = projects.filter(p => p.course_id === courseId);
            if (courseProjects.length === 0) {
                qProjectSelect.innerHTML = '<option value="">该课程下暂无项目</option>';
                qTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            } else {
                qProjectSelect.innerHTML = '<option value="">请选择项目</option>' + 
                    courseProjects.map(p => `<option value="${p.project_id}">${p.name}</option>`).join('');
                qTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            }
        }
        
        // 更新题目弹窗的任务选择器
        function updateQuestionTaskSelect() {
            const projectId = document.getElementById('q-project').value;
            const qTaskSelect = document.getElementById('q-task');
            
            if (!projectId) {
                qTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            if (projectTasks.length === 0) {
                qTaskSelect.innerHTML = '<option value="">该项目下暂无任务</option>';
            } else {
                qTaskSelect.innerHTML = '<option value="">请选择任务</option>' + 
                    projectTasks.map(t => `<option value="${t.task_id}">${t.name}</option>`).join('');
            }
        }
        
        async function editQuestion(round) {
            const { data: q } = await supabaseClient.from('questions').select('*').eq('round', round).single();
            if (!q) { alert('题目不存在'); return; }
            
            document.getElementById('question-modal-title').textContent = '✏️ 编辑题目';
            document.getElementById('edit-question-id').value = q.id;
            document.getElementById('q-round').value = q.round;
            document.getElementById('q-type').value = q.question_type || 'single';
            document.getElementById('q-title').value = q.title;
            document.getElementById('q-opt-a').value = q.option_a || '';
            document.getElementById('q-opt-b').value = q.option_b || '';
            document.getElementById('q-opt-c').value = q.option_c || '';
            document.getElementById('q-opt-d').value = q.option_d || '';
            document.getElementById('q-answer').value = q.answer;
            document.getElementById('q-tag').value = q.knowledge_tag || '';
            document.getElementById('q-difficulty').value = q.difficulty || 1;
            document.getElementById('q-explanation').value = q.explanation || '';
            
            // 初始化题目弹窗的课程选择器
            updateQuestionCourseSelect();
            
            // 根据题目的task_id设置课程、项目和任务选择器
            const qCourseSelect = document.getElementById('q-course');
            const qProjectSelect = document.getElementById('q-project');
            const qTaskSelect = document.getElementById('q-task');
            
            if (q.task_id) {
                const task = tasks.find(t => t.task_id === q.task_id);
                if (task) {
                    const project = projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        qCourseSelect.value = project.course_id;
                        updateQuestionProjectSelect();
                        qProjectSelect.value = task.project_id;
                        updateQuestionTaskSelect();
                        qTaskSelect.value = q.task_id;
                    }
                }
            } else {
                qProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
                qTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            }
            
            updateQuestionForm();
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        function updateQuestionForm() {
            const type = document.getElementById('q-type').value;
            const optionsArea = document.getElementById('options-area');
            
            if (type === 'truefalse') {
                optionsArea.innerHTML = `
                    <div style="margin-bottom:15px; color:#94a3b8;">
                        判断题无需填写选项，答案请填写：对/错 或 T/F
                    </div>
                `;
            } else if (type === 'fillblank') {
                optionsArea.innerHTML = `
                    <div style="margin-bottom:15px; color:#94a3b8;">
                        填空题无需填写选项，题目中用 ____ 表示填空位置，答案填写标准答案
                    </div>
                `;
            } else {
                optionsArea.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div><label style="color:#94a3b8; font-size:0.85rem;">选项A</label><input id="q-opt-a" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">选项B</label><input id="q-opt-b" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">选项C</label><input id="q-opt-c" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                        <div><label style="color:#94a3b8; font-size:0.85rem;">选项D</label><input id="q-opt-d" style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f172a; color:white;"></div>
                    </div>
                `;
            }
        }
        
        function closeQuestionModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        async function saveQuestion() {
            const round = parseInt(document.getElementById('q-round').value);
            const type = document.getElementById('q-type').value;
            const taskId = document.getElementById('q-task').value;
            const title = document.getElementById('q-title').value.trim();
            const answer = document.getElementById('q-answer').value.trim().toUpperCase();
            const tag = document.getElementById('q-tag').value.trim() || null;
            const difficulty = parseInt(document.getElementById('q-difficulty').value);
            const explanation = document.getElementById('q-explanation').value.trim() || null;
            
            if (!round || !title || !answer) {
                alert('请填写序号、题目和答案');
                return;
            }
            
            // 验证必须选择任务
            if (!taskId) {
                alert('请选择所属任务');
                return;
            }
            
            const data = {
                round,
                question_type: type,
                task_id: taskId,
                title,
                option_a: document.getElementById('q-opt-a')?.value || null,
                option_b: document.getElementById('q-opt-b')?.value || null,
                option_c: document.getElementById('q-opt-c')?.value || null,
                option_d: document.getElementById('q-opt-d')?.value || null,
                answer,
                knowledge_tag: tag,
                difficulty,
                explanation,
                updated_at: new Date().toISOString()
            };
            
            // 获取旧题目的task_id（如果是编辑操作）
            const editId = document.getElementById('edit-question-id').value;
            let oldTaskId = null;
            if (editId) {
                const oldQuestion = questions.find(q => q.round === round);
                if (oldQuestion) {
                    oldTaskId = oldQuestion.task_id;
                }
            }
            
            // 检查是否是编辑现有题目
            const existingQuestion = questions.find(q => q.round === round);
            let error;
            
            if (existingQuestion) {
                // 更新现有题目
                const result = await supabaseClient.from('questions').update(data).eq('round', round);
                error = result.error;
            } else {
                // 插入新题目
                const result = await supabaseClient.from('questions').insert(data);
                error = result.error;
            }
            
            if (error) {
                alert('保存失败: ' + error.message);
                return;
            }
            
            closeQuestionModal();
            await loadHierarchy();
            await loadQuestions();
            
            // 更新题目数量：新任务和旧任务（如果不同）
            await updateHierarchyQuestionCounts(taskId);
            if (oldTaskId && oldTaskId !== taskId) {
                await updateHierarchyQuestionCounts(oldTaskId);
            }
            
            alert('✅ 保存成功');
        }
        
        async function deleteQuestion(round) {
            if (!confirm(`确定要删除第 ${round} 题吗？`)) return;
            
            // 获取题目的task_id以便更新计数
            const question = questions.find(q => q.round === round);
            const taskId = question ? question.task_id : null;
            
            const { error } = await supabaseClient.from('questions').delete().eq('round', round);
            if (error) {
                alert('删除失败: ' + error.message);
                return;
            }
            
            await loadQuestions();
            
            // 更新题目数量
            if (taskId) {
                await updateHierarchyQuestionCounts(taskId);
            }
        }

        // ================== 导入功能 ==================
        function openImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
            document.getElementById('import-preview').style.display = 'none';
            pendingImport = [];
            
            // 初始化导入弹窗的课程选择器
            updateImportCourseSelect();
            
            // 根据当前选择的层级预设课程、项目和任务
            const importCourseSelect = document.getElementById('import-course');
            const importProjectSelect = document.getElementById('import-project');
            const importTaskSelect = document.getElementById('import-task');
            
            if (currentFilterType === 'task' && currentFilterId !== 'all') {
                const task = tasks.find(t => t.task_id === currentFilterId);
                if (task) {
                    const project = projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        importCourseSelect.value = project.course_id;
                        updateImportProjectSelect();
                        importProjectSelect.value = task.project_id;
                        updateImportTaskSelect();
                        importTaskSelect.value = currentFilterId;
                    }
                }
            } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                const project = projects.find(p => p.project_id === currentFilterId);
                if (project) {
                    importCourseSelect.value = project.course_id;
                    updateImportProjectSelect();
                    importProjectSelect.value = currentFilterId;
                    updateImportTaskSelect();
                }
            } else if (currentFilterType === 'course' && currentFilterId !== 'all') {
                importCourseSelect.value = currentFilterId;
                updateImportProjectSelect();
            } else {
                importProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
                importTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            }
        }
        
        // 更新导入弹窗的课程选择器
        function updateImportCourseSelect() {
            const importCourseSelect = document.getElementById('import-course');
            if (importCourseSelect) {
                importCourseSelect.innerHTML = '<option value="">请选择课程</option>' + 
                    courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            }
        }
        
        // 更新导入弹窗的项目选择器
        function updateImportProjectSelect() {
            const courseId = document.getElementById('import-course').value;
            const importProjectSelect = document.getElementById('import-project');
            const importTaskSelect = document.getElementById('import-task');
            
            if (!courseId) {
                importProjectSelect.innerHTML = '<option value="">请先选择课程</option>';
                importTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const courseProjects = projects.filter(p => p.course_id === courseId);
            if (courseProjects.length === 0) {
                importProjectSelect.innerHTML = '<option value="">该课程下暂无项目</option>';
                importTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            } else {
                importProjectSelect.innerHTML = '<option value="">请选择项目</option>' + 
                    courseProjects.map(p => `<option value="${p.project_id}">${p.name}</option>`).join('');
                importTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
            }
        }
        
        // 更新导入弹窗的任务选择器
        function updateImportTaskSelect() {
            const projectId = document.getElementById('import-project').value;
            const importTaskSelect = document.getElementById('import-task');
            
            if (!projectId) {
                importTaskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            if (projectTasks.length === 0) {
                importTaskSelect.innerHTML = '<option value="">该项目下暂无任务</option>';
            } else {
                importTaskSelect.innerHTML = '<option value="">请选择任务</option>' + 
                    projectTasks.map(t => `<option value="${t.task_id}">${t.name}</option>`).join('');
            }
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }
        
        function handleFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) processFile(file);
        }
        
        // 导入解析结果
        let importParseResult = { valid: [], invalid: [], errors: [] };
        
        async function processFile(file) {
            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCSV = fileName.endsWith('.csv');
            
            if (!isExcel && !isCSV) {
                alert('请选择 CSV 或 Excel 文件');
                return;
            }
            
            const type = document.getElementById('import-type').value;
            
            try {
                if (isExcel) {
                    // 使用增强的Excel解析
                    importParseResult = await ImportExport.parseExcel(file, type);
                } else {
                    // 使用增强的CSV解析
                    const reader = new FileReader();
                    const text = await new Promise((resolve, reject) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = () => reject(new Error('文件读取失败'));
                        reader.readAsText(file, 'UTF-8');
                    });
                    importParseResult = ImportExport.parseCSV(text, type);
                }
                
                pendingImport = importParseResult.valid;
                
                // 更新统计
                document.getElementById('import-valid-count').textContent = importParseResult.valid.length;
                document.getElementById('import-invalid-count').textContent = importParseResult.invalid.length;
                
                // 显示预览
                document.getElementById('import-preview').style.display = 'block';
                document.getElementById('preview-count').textContent = pendingImport.length;
                document.getElementById('preview-list').innerHTML = pendingImport.slice(0, 5).map((q, i) => `
                    <div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.85rem;">
                        <strong>${i + 1}.</strong> ${q.title.substring(0, 60)}${q.title.length > 60 ? '...' : ''} 
                        <span style="color:#10b981;">[${q.answer}]</span>
                    </div>
                `).join('') + (pendingImport.length > 5 ? `<div style="padding:8px; color:#94a3b8; font-size:0.8rem;">... 还有 ${pendingImport.length - 5} 道题目</div>` : '');
                
                // 显示错误列表
                if (importParseResult.errors.length > 0) {
                    document.getElementById('import-errors').style.display = 'block';
                    document.getElementById('import-errors-list').innerHTML = importParseResult.errors.map(e => 
                        `<div style="padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.05);">第 ${e.row} 行: ${e.message}</div>`
                    ).join('');
                } else {
                    document.getElementById('import-errors').style.display = 'none';
                }
                
                if (pendingImport.length === 0) {
                    alert('未能解析出有效题目，请检查文件格式');
                }
            } catch (error) {
                alert('文件解析失败: ' + error.message);
            }
        }
        
        function parseCSV(text, type) {
            const lines = text.trim().split('\n');
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cells = parseCSVLine(line);
                if (cells.length < 2) continue;
                
                let q = { question_type: type };
                
                if (type === 'single' || type === 'multiple') {
                    // 题目,选项A,选项B,选项C,选项D,答案,知识点,难度
                    if (cells.length < 6) continue;
                    q.title = cells[0];
                    q.option_a = cells[1];
                    q.option_b = cells[2];
                    q.option_c = cells[3];
                    q.option_d = cells[4];
                    q.answer = cells[5].toUpperCase();
                    q.knowledge_tag = cells[6] || null;
                    q.difficulty = parseInt(cells[7]) || 1;
                } else if (type === 'truefalse') {
                    // 题目,答案,知识点,难度
                    q.title = cells[0];
                    let ans = cells[1].trim().toLowerCase();
                    q.answer = (ans === '对' || ans === 't' || ans === 'true' || ans === '正确') ? '对' : '错';
                    q.knowledge_tag = cells[2] || null;
                    q.difficulty = parseInt(cells[3]) || 1;
                } else if (type === 'fillblank') {
                    // 题目,答案,知识点,难度
                    q.title = cells[0];
                    q.answer = cells[1];
                    q.knowledge_tag = cells[2] || null;
                    q.difficulty = parseInt(cells[3]) || 1;
                }
                
                questions.push(q);
            }
            
            return questions;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        async function confirmImport() {
            if (pendingImport.length === 0) {
                alert('没有待导入的题目');
                return;
            }
            
            const taskId = document.getElementById('import-task').value;
            const clearBefore = document.getElementById('clear-before-import').checked;
            const startRound = parseInt(document.getElementById('start-round').value) || 1;
            
            // 验证必须选择任务
            if (!taskId) {
                alert('请选择目标任务');
                return;
            }
            
            // 如果需要清空该任务下的现有题目
            if (clearBefore) {
                await supabaseClient.from('questions').delete().eq('task_id', taskId);
            }
            
            // 添加序号和任务ID
            const questionsToInsert = pendingImport.map((q, i) => ({
                ...q,
                round: startRound + i,
                task_id: taskId
            }));
            
            // 逐个插入或更新题目
            let successCount = 0;
            let errorMsg = null;
            
            for (const q of questionsToInsert) {
                // 检查是否存在相同round的题目
                const { data: existing } = await supabaseClient.from('questions').select('round').eq('round', q.round).maybeSingle();
                
                let result;
                if (existing) {
                    // 更新现有题目
                    result = await supabaseClient.from('questions').update(q).eq('round', q.round);
                } else {
                    // 插入新题目
                    result = await supabaseClient.from('questions').insert(q);
                }
                
                if (result.error) {
                    errorMsg = result.error.message;
                    break;
                }
                successCount++;
            }
            
            if (errorMsg) {
                alert(`导入部分失败: ${errorMsg}\n已成功导入 ${successCount} 道题目`);
                return;
            }
            
            closeImportModal();
            await loadHierarchy();
            await loadQuestions();
            
            // 更新题目数量
            await updateHierarchyQuestionCounts(taskId);
            
            alert(`✅ 成功导入 ${questionsToInsert.length} 道题目`);
        }
        
        // ================== 格式说明 ==================
        function openFormatHelp() {
            document.getElementById('format-modal').style.display = 'flex';
        }
        
        function closeFormatHelp() {
            document.getElementById('format-modal').style.display = 'none';
        }
        
        // ================== 批量操作功能 ==================
        // 当前显示的题目列表（用于批量操作）
        let currentDisplayedQuestions = [];
        
        // 更新批量操作工具栏显示
        function updateBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const countSpan = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const count = BatchOperations.getSelectedCount();
            
            if (count > 0) {
                toolbar.classList.add('active');
                countSpan.textContent = count;
            } else {
                toolbar.classList.remove('active');
            }
            
            // 更新全选复选框状态
            if (selectAllCheckbox && currentDisplayedQuestions.length > 0) {
                const allSelected = currentDisplayedQuestions.every(q => BatchOperations.isSelected(q.id));
                selectAllCheckbox.checked = allSelected;
                selectAllCheckbox.indeterminate = count > 0 && !allSelected;
            }
        }
        
        // 切换单个题目选择
        function toggleQuestionSelect(questionId) {
            BatchOperations.toggleSelect(questionId);
            updateQuestionItemUI(questionId);
            updateBatchToolbar();
        }
        
        // 更新单个题目项的UI
        function updateQuestionItemUI(questionId) {
            const item = document.querySelector(`.question-item[data-question-id="${questionId}"]`);
            if (item) {
                const isSelected = BatchOperations.isSelected(questionId);
                item.classList.toggle('selected', isSelected);
                const checkbox = item.querySelector('.question-checkbox');
                if (checkbox) checkbox.checked = isSelected;
            }
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const questionIds = currentDisplayedQuestions.map(q => q.id);
            
            if (selectAllCheckbox.checked) {
                BatchOperations.selectAll(questionIds);
            } else {
                BatchOperations.deselectAll();
            }
            
            // 更新所有题目项的UI
            document.querySelectorAll('.question-item').forEach(item => {
                const qId = item.dataset.questionId;
                const isSelected = BatchOperations.isSelected(qId);
                item.classList.toggle('selected', isSelected);
                const checkbox = item.querySelector('.question-checkbox');
                if (checkbox) checkbox.checked = isSelected;
            });
            
            updateBatchToolbar();
        }
        
        // 取消批量选择
        function cancelBatchSelection() {
            BatchOperations.deselectAll();
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('selected');
                const checkbox = item.querySelector('.question-checkbox');
                if (checkbox) checkbox.checked = false;
            });
            document.getElementById('select-all-checkbox').checked = false;
            updateBatchToolbar();
        }
        
        // 批量删除题目
        async function batchDeleteQuestions() {
            const selectedIds = BatchOperations.getSelectedIds();
            if (selectedIds.length === 0) {
                alert('请先选择要删除的题目');
                return;
            }
            
            const result = await BatchOperations.batchDeleteWithConfirm(supabaseClient, selectedIds);
            
            if (result.cancelled) return;
            
            if (result.success) {
                // 记录操作日志
                await BatchOperations.logOperation(supabaseClient, 'delete', {
                    questionIds: selectedIds,
                    deleted: result.deleted,
                    failed: result.failed
                });
                
                alert(`✅ 成功删除 ${result.deleted} 道题目${result.failed > 0 ? `，${result.failed} 道失败` : ''}`);
                await loadQuestions();
                await updateAllHierarchyCounts();
            } else {
                alert('❌ 删除失败: ' + (result.errors.join(', ') || '未知错误'));
            }
        }
        
        // 打开批量移动弹窗
        function openBatchMoveModal() {
            const selectedIds = BatchOperations.getSelectedIds();
            if (selectedIds.length === 0) {
                alert('请先选择要移动的题目');
                return;
            }
            
            document.getElementById('batch-move-count').textContent = selectedIds.length;
            updateBatchMoveCourseSelect();
            document.getElementById('batch-move-modal').style.display = 'flex';
        }
        
        function closeBatchMoveModal() {
            document.getElementById('batch-move-modal').style.display = 'none';
        }
        
        function updateBatchMoveCourseSelect() {
            const select = document.getElementById('batch-move-course');
            select.innerHTML = '<option value="">请选择课程</option>' + 
                courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            document.getElementById('batch-move-project').innerHTML = '<option value="">请先选择课程</option>';
            document.getElementById('batch-move-task').innerHTML = '<option value="">请先选择项目</option>';
        }
        
        function updateBatchMoveProjectSelect() {
            const courseId = document.getElementById('batch-move-course').value;
            const projectSelect = document.getElementById('batch-move-project');
            const taskSelect = document.getElementById('batch-move-task');
            
            if (!courseId) {
                projectSelect.innerHTML = '<option value="">请先选择课程</option>';
                taskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const courseProjects = projects.filter(p => p.course_id === courseId);
            projectSelect.innerHTML = '<option value="">请选择项目</option>' + 
                courseProjects.map(p => `<option value="${p.project_id}">${p.name}</option>`).join('');
            taskSelect.innerHTML = '<option value="">请先选择项目</option>';
        }
        
        function updateBatchMoveTaskSelect() {
            const projectId = document.getElementById('batch-move-project').value;
            const taskSelect = document.getElementById('batch-move-task');
            
            if (!projectId) {
                taskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            taskSelect.innerHTML = '<option value="">请选择任务</option>' + 
                projectTasks.map(t => `<option value="${t.task_id}">${t.name}</option>`).join('');
        }
        
        async function confirmBatchMove() {
            const targetTaskId = document.getElementById('batch-move-task').value;
            if (!targetTaskId) {
                alert('请选择目标任务');
                return;
            }
            
            const selectedIds = BatchOperations.getSelectedIds();
            const result = await BatchOperations.batchMove(supabaseClient, selectedIds, targetTaskId);
            
            if (result.success) {
                // 记录操作日志
                await BatchOperations.logOperation(supabaseClient, 'move', {
                    questionIds: selectedIds,
                    targetTaskId: targetTaskId,
                    moved: result.moved,
                    failed: result.failed
                });
                
                alert(`✅ 成功移动 ${result.moved} 道题目`);
                closeBatchMoveModal();
                cancelBatchSelection();
                await loadQuestions();
                await updateAllHierarchyCounts();
            } else {
                alert('❌ 移动失败: ' + (result.errors.join(', ') || '未知错误'));
            }
        }
        
        // 打开批量编辑弹窗
        function openBatchEditModal() {
            const selectedIds = BatchOperations.getSelectedIds();
            if (selectedIds.length === 0) {
                alert('请先选择要编辑的题目');
                return;
            }
            
            document.getElementById('batch-edit-count').textContent = selectedIds.length;
            document.getElementById('batch-edit-difficulty').value = '';
            document.getElementById('batch-edit-tag').value = '';
            document.getElementById('batch-edit-modal').style.display = 'flex';
        }
        
        function closeBatchEditModal() {
            document.getElementById('batch-edit-modal').style.display = 'none';
        }
        
        async function confirmBatchEdit() {
            const difficulty = document.getElementById('batch-edit-difficulty').value;
            const knowledgeTag = document.getElementById('batch-edit-tag').value.trim();
            
            const updates = {};
            if (difficulty) updates.difficulty = parseInt(difficulty);
            if (knowledgeTag) updates.knowledge_tag = knowledgeTag;
            
            if (Object.keys(updates).length === 0) {
                alert('请至少修改一个字段');
                return;
            }
            
            const selectedIds = BatchOperations.getSelectedIds();
            const result = await BatchOperations.batchUpdate(supabaseClient, selectedIds, updates);
            
            if (result.success) {
                // 记录操作日志
                await BatchOperations.logOperation(supabaseClient, 'update', {
                    questionIds: selectedIds,
                    updates: updates,
                    updated: result.updated,
                    failed: result.failed
                });
                
                alert(`✅ 成功更新 ${result.updated} 道题目`);
                closeBatchEditModal();
                cancelBatchSelection();
                await loadQuestions();
            } else {
                alert('❌ 更新失败: ' + (result.errors.join(', ') || '未知错误'));
            }
        }
        
        // 打开批量复制弹窗
        function openBatchCopyModal() {
            const selectedIds = BatchOperations.getSelectedIds();
            if (selectedIds.length === 0) {
                alert('请先选择要复制的题目');
                return;
            }
            
            document.getElementById('batch-copy-count').textContent = selectedIds.length;
            updateBatchCopyCourseSelect();
            document.getElementById('batch-copy-modal').style.display = 'flex';
        }
        
        function closeBatchCopyModal() {
            document.getElementById('batch-copy-modal').style.display = 'none';
        }
        
        function updateBatchCopyCourseSelect() {
            const select = document.getElementById('batch-copy-course');
            select.innerHTML = '<option value="">请选择课程</option>' + 
                courses.map(c => `<option value="${c.course_id}">${c.name}</option>`).join('');
            document.getElementById('batch-copy-project').innerHTML = '<option value="">请先选择课程</option>';
            document.getElementById('batch-copy-task').innerHTML = '<option value="">请先选择项目</option>';
        }
        
        function updateBatchCopyProjectSelect() {
            const courseId = document.getElementById('batch-copy-course').value;
            const projectSelect = document.getElementById('batch-copy-project');
            const taskSelect = document.getElementById('batch-copy-task');
            
            if (!courseId) {
                projectSelect.innerHTML = '<option value="">请先选择课程</option>';
                taskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const courseProjects = projects.filter(p => p.course_id === courseId);
            projectSelect.innerHTML = '<option value="">请选择项目</option>' + 
                courseProjects.map(p => `<option value="${p.project_id}">${p.name}</option>`).join('');
            taskSelect.innerHTML = '<option value="">请先选择项目</option>';
        }
        
        function updateBatchCopyTaskSelect() {
            const projectId = document.getElementById('batch-copy-project').value;
            const taskSelect = document.getElementById('batch-copy-task');
            
            if (!projectId) {
                taskSelect.innerHTML = '<option value="">请先选择项目</option>';
                return;
            }
            
            const projectTasks = tasks.filter(t => t.project_id === projectId);
            taskSelect.innerHTML = '<option value="">请选择任务</option>' + 
                projectTasks.map(t => `<option value="${t.task_id}">${t.name}</option>`).join('');
        }
        
        async function confirmBatchCopy() {
            const targetTaskId = document.getElementById('batch-copy-task').value;
            if (!targetTaskId) {
                alert('请选择目标任务');
                return;
            }
            
            const selectedIds = BatchOperations.getSelectedIds();
            const result = await BatchOperations.batchCopy(supabaseClient, selectedIds, targetTaskId);
            
            if (result.success) {
                // 记录操作日志
                await BatchOperations.logOperation(supabaseClient, 'copy', {
                    sourceQuestionIds: selectedIds,
                    targetTaskId: targetTaskId,
                    copied: result.copied,
                    newIds: result.newIds
                });
                
                alert(`✅ 成功复制 ${result.copied} 道题目`);
                closeBatchCopyModal();
                cancelBatchSelection();
                await loadQuestions();
                await updateAllHierarchyCounts();
            } else {
                alert('❌ 复制失败: ' + (result.errors.join(', ') || '未知错误'));
            }
        }
        
        // ================== 高级搜索功能 ==================
        let savedFilters = [];
        
        function openAdvancedSearch() {
            // 同步当前筛选条件到高级搜索面板
            document.getElementById('adv-search-keyword').value = document.getElementById('search-input').value || '';
            document.getElementById('adv-search-type').value = document.getElementById('filter-type').value || '';
            document.getElementById('adv-search-difficulty').value = document.getElementById('filter-difficulty').value || '';
            document.getElementById('adv-search-tag').value = '';
            document.getElementById('adv-search-date-start').value = '';
            document.getElementById('adv-search-date-end').value = '';
            
            loadSavedFilters();
            document.getElementById('advanced-search-modal').style.display = 'flex';
        }
        
        function closeAdvancedSearch() {
            document.getElementById('advanced-search-modal').style.display = 'none';
        }
        
        async function loadSavedFilters() {
            savedFilters = await QuestionSearch.loadSavedFilters(supabaseClient);
            renderSavedFilters();
        }
        
        function renderSavedFilters() {
            const container = document.getElementById('saved-filters-list');
            
            if (savedFilters.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding:10px;">暂无保存的筛选条件</div>';
                return;
            }
            
            container.innerHTML = savedFilters.map(f => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px; margin-bottom:5px;">
                    <span style="cursor:pointer;" onclick="applySavedFilter('${f.id}')">${f.name}</span>
                    <button onclick="deleteSavedFilter('${f.id}')" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.8rem;">🗑️</button>
                </div>
            `).join('');
        }
        
        async function applySavedFilter(filterId) {
            const filter = savedFilters.find(f => f.id === filterId);
            if (!filter || !filter.filter_data) return;
            
            const data = filter.filter_data;
            document.getElementById('adv-search-keyword').value = data.keyword || '';
            document.getElementById('adv-search-type').value = data.type || '';
            document.getElementById('adv-search-difficulty').value = data.difficulty || '';
            document.getElementById('adv-search-tag').value = data.knowledge_tag || '';
            document.getElementById('adv-search-date-start').value = data.dateRange?.start || '';
            document.getElementById('adv-search-date-end').value = data.dateRange?.end || '';
        }
        
        async function deleteSavedFilter(filterId) {
            if (!confirm('确定要删除这个筛选条件吗？')) return;
            
            const result = await QuestionSearch.deleteSavedFilter(supabaseClient, filterId);
            if (result.success) {
                await loadSavedFilters();
            } else {
                alert('删除失败: ' + result.error);
            }
        }
        
        async function saveCurrentFilter() {
            const name = prompt('请输入筛选条件名称：');
            if (!name || !name.trim()) return;
            
            const filters = {
                keyword: document.getElementById('adv-search-keyword').value,
                type: document.getElementById('adv-search-type').value,
                difficulty: document.getElementById('adv-search-difficulty').value,
                knowledge_tag: document.getElementById('adv-search-tag').value,
                dateRange: {
                    start: document.getElementById('adv-search-date-start').value,
                    end: document.getElementById('adv-search-date-end').value
                }
            };
            
            const result = await QuestionSearch.saveFilter(supabaseClient, name.trim(), filters);
            if (result.success) {
                alert('✅ 筛选条件已保存');
                await loadSavedFilters();
            } else {
                alert('保存失败: ' + result.error);
            }
        }
        
        function resetAdvancedSearch() {
            document.getElementById('adv-search-keyword').value = '';
            document.getElementById('adv-search-type').value = '';
            document.getElementById('adv-search-difficulty').value = '';
            document.getElementById('adv-search-tag').value = '';
            document.getElementById('adv-search-date-start').value = '';
            document.getElementById('adv-search-date-end').value = '';
        }
        
        async function executeAdvancedSearch() {
            const keyword = document.getElementById('adv-search-keyword').value;
            const type = document.getElementById('adv-search-type').value;
            const difficulty = document.getElementById('adv-search-difficulty').value;
            const knowledgeTag = document.getElementById('adv-search-tag').value;
            const dateStart = document.getElementById('adv-search-date-start').value;
            const dateEnd = document.getElementById('adv-search-date-end').value;
            
            // 同步到主筛选栏
            document.getElementById('search-input').value = keyword;
            document.getElementById('filter-type').value = type;
            document.getElementById('filter-difficulty').value = difficulty;
            
            // 构建筛选条件
            const filters = {};
            if (type) filters.type = type;
            if (difficulty) filters.difficulty = parseInt(difficulty);
            if (knowledgeTag) filters.knowledge_tag = knowledgeTag;
            if (dateStart || dateEnd) {
                filters.dateRange = {};
                if (dateStart) filters.dateRange.start = dateStart;
                if (dateEnd) filters.dateRange.end = dateEnd;
            }
            
            // 根据层级筛选
            let baseQuestions = questions;
            if (currentFilterType === 'task' && currentFilterId !== 'all') {
                baseQuestions = questions.filter(q => q.task_id === currentFilterId);
            } else if (currentFilterType === 'project' && currentFilterId !== 'all') {
                const projectTaskIds = tasks.filter(t => t.project_id === currentFilterId).map(t => t.task_id);
                baseQuestions = questions.filter(q => projectTaskIds.includes(q.task_id));
            } else if (currentFilterType === 'course' && currentFilterId !== 'all') {
                const courseProjectIds = projects.filter(p => p.course_id === currentFilterId).map(p => p.project_id);
                const courseTaskIds = tasks.filter(t => courseProjectIds.includes(t.project_id)).map(t => t.task_id);
                baseQuestions = questions.filter(q => courseTaskIds.includes(q.task_id));
            }
            
            // 使用高级搜索模块进行搜索和筛选
            const result = QuestionSearch.searchAndFilter(baseQuestions, keyword, filters);
            
            // 保存当前显示的题目列表
            currentDisplayedQuestions = result;
            
            renderQuestions(result);
            closeAdvancedSearch();
        }
        
        // ================== AI助手功能 ==================
        let generatedQuestions = [];
        let currentOptimizeQuestion = null;
        let optimizedQuestion = null;
        
        function openAIAssistant() {
            loadAIConfig();
            updateOptimizeQuestionSelect();
            document.getElementById('ai-assistant-modal').style.display = 'flex';
        }
        
        function closeAIAssistant() {
            document.getElementById('ai-assistant-modal').style.display = 'none';
        }
        
        function switchAITab(tab) {
            // 更新按钮样式
            document.getElementById('ai-tab-generate').className = tab === 'generate' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('ai-tab-optimize').className = tab === 'optimize' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('ai-tab-config').className = tab === 'config' ? 'btn btn-primary' : 'btn btn-secondary';
            
            // 显示对应面板
            document.getElementById('ai-panel-generate').style.display = tab === 'generate' ? 'block' : 'none';
            document.getElementById('ai-panel-optimize').style.display = tab === 'optimize' ? 'block' : 'none';
            document.getElementById('ai-panel-config').style.display = tab === 'config' ? 'block' : 'none';
        }
        
        // AI配置管理
        function loadAIConfig() {
            const config = JSON.parse(localStorage.getItem('ai_config') || '{}');
            if (config.apiKey) document.getElementById('ai-config-key').value = config.apiKey;
            if (config.apiEndpoint) document.getElementById('ai-config-endpoint').value = config.apiEndpoint;
            if (config.model) document.getElementById('ai-config-model').value = config.model;
            if (config.provider) document.getElementById('ai-config-provider').value = config.provider;
            
            // 应用配置到AIAssistant模块
            if (config.apiKey) {
                AIAssistant.configure({
                    apiKey: config.apiKey,
                    apiEndpoint: config.apiEndpoint,
                    model: config.model,
                    provider: config.provider || 'openai'
                });
            }
        }
        
        function saveAIConfig() {
            const config = {
                provider: document.getElementById('ai-config-provider').value,
                apiKey: document.getElementById('ai-config-key').value,
                apiEndpoint: document.getElementById('ai-config-endpoint').value,
                model: document.getElementById('ai-config-model').value
            };
            
            localStorage.setItem('ai_config', JSON.stringify(config));
            
            AIAssistant.configure({
                apiKey: config.apiKey,
                apiEndpoint: config.apiEndpoint,
                model: config.model,
                provider: config.provider
            });
            
            showAIConfigStatus('✅ 配置已保存', 'success');
        }
        
        function updateAPIEndpoint() {
            const provider = document.getElementById('ai-config-provider').value;
            const endpoint = AIAssistant.getDefaultEndpoint(provider);
            document.getElementById('ai-config-endpoint').value = endpoint;
        }
        
        async function testAIConnection() {
            if (!AIAssistant.isConfigured()) {
                showAIConfigStatus('❌ 请先配置API密钥', 'error');
                return;
            }
            
            showAIConfigStatus('🔄 测试连接中...', 'info');
            
            const result = await AIAssistant.callAPI('请回复"连接成功"');
            
            if (result.success) {
                showAIConfigStatus('✅ 连接成功！', 'success');
            } else {
                showAIConfigStatus('❌ ' + AIAssistant.getFriendlyErrorMessage(result.errorType, result.error), 'error');
            }
        }
        
        function showAIConfigStatus(message, type) {
            const status = document.getElementById('ai-config-status');
            status.style.display = 'block';
            status.textContent = message;
            status.style.background = type === 'success' ? 'rgba(16,185,129,0.2)' : 
                                      type === 'error' ? 'rgba(239,68,68,0.2)' : 'rgba(59,130,246,0.2)';
            status.style.color = type === 'success' ? '#10b981' : 
                                 type === 'error' ? '#ef4444' : '#3b82f6';
        }
        
        // AI生成题目
        async function generateQuestionsWithAI() {
            const topic = document.getElementById('ai-gen-topic').value.trim();
            if (!topic) {
                alert('请输入知识点或主题');
                return;
            }
            
            if (!AIAssistant.isConfigured()) {
                alert('请先配置AI API密钥');
                switchAITab('config');
                return;
            }
            
            const options = {
                topic,
                type: document.getElementById('ai-gen-type').value,
                difficulty: parseInt(document.getElementById('ai-gen-difficulty').value),
                count: parseInt(document.getElementById('ai-gen-count').value),
                context: document.getElementById('ai-gen-context').value
            };
            
            // 显示加载状态
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '⏳ 生成中...';
            btn.disabled = true;
            
            const result = await AIAssistant.generateQuestions(options);
            
            btn.textContent = originalText;
            btn.disabled = false;
            
            if (result.success && result.questions.length > 0) {
                generatedQuestions = result.questions;
                renderGeneratedQuestions();
                document.getElementById('ai-gen-result').style.display = 'block';
            } else {
                alert('生成失败: ' + (result.error || '未知错误'));
            }
        }
        
        function renderGeneratedQuestions() {
            const container = document.getElementById('ai-gen-result-list');
            document.getElementById('ai-gen-result-count').textContent = generatedQuestions.length;
            
            container.innerHTML = generatedQuestions.map((q, i) => `
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                    <div style="font-weight:bold; margin-bottom:5px;">${i + 1}. ${q.title}</div>
                    ${q.option_a ? `<div style="font-size:0.85rem; color:#94a3b8;">A. ${q.option_a} | B. ${q.option_b} | C. ${q.option_c || '-'} | D. ${q.option_d || '-'}</div>` : ''}
                    <div style="font-size:0.85rem; color:#10b981; margin-top:5px;">答案: ${q.answer}</div>
                </div>
            `).join('');
            
            // 填充目标任务选择器
            populateTargetTaskSelect();
        }
        
        function populateTargetTaskSelect() {
            const select = document.getElementById('ai-gen-target-task');
            let options = '<option value="">请选择目标任务...</option>';
            
            // 遍历课程、项目、任务层级
            hierarchyData.courses.forEach(course => {
                const courseProjects = hierarchyData.projects.filter(p => p.course_id === course.course_id);
                courseProjects.forEach(project => {
                    const projectTasks = hierarchyData.tasks.filter(t => t.project_id === project.project_id);
                    projectTasks.forEach(task => {
                        options += `<option value="${task.task_id}">[${course.name}] ${project.name} / ${task.name}</option>`;
                    });
                });
            });
            
            select.innerHTML = options;
            
            // 如果当前已选择任务，自动选中
            if (currentFilterType === 'task' && currentFilterId !== 'all') {
                select.value = currentFilterId;
            }
        }
        
        async function saveGeneratedQuestions() {
            if (generatedQuestions.length === 0) {
                alert('没有可保存的题目');
                return;
            }
            
            // 从选择器获取目标任务
            const taskId = document.getElementById('ai-gen-target-task').value;
            
            if (!taskId) {
                alert('请选择要保存到的目标任务');
                return;
            }
            
            // 获取下一个可用序号
            const { data: maxRoundData } = await supabaseClient
                .from('questions')
                .select('round')
                .eq('task_id', taskId)
                .order('round', { ascending: false })
                .limit(1);
            
            let nextRound = maxRoundData && maxRoundData.length > 0 ? maxRoundData[0].round + 1 : 1;
            
            // 准备插入数据
            const questionsToInsert = generatedQuestions.map((q, i) => ({
                ...q,
                round: nextRound + i,
                task_id: taskId
            }));
            
            const { error } = await supabaseClient.from('questions').insert(questionsToInsert);
            
            if (error) {
                alert('保存失败: ' + error.message);
                return;
            }
            
            // 记录AI生成日志
            await AIAssistant.logOperation(supabaseClient, 'generate_save', {
                topic: document.getElementById('ai-gen-topic').value,
                type: document.getElementById('ai-gen-type').value,
                difficulty: document.getElementById('ai-gen-difficulty').value,
                count: questionsToInsert.length,
                taskId: taskId
            }, {
                savedCount: questionsToInsert.length,
                questions: questionsToInsert.map(q => ({ title: q.title, answer: q.answer }))
            });
            
            alert(`✅ 成功保存 ${questionsToInsert.length} 道题目`);
            clearGeneratedQuestions();
            await loadQuestions();
            await updateHierarchyQuestionCounts(taskId);
        }
        
        function clearGeneratedQuestions() {
            generatedQuestions = [];
            document.getElementById('ai-gen-result').style.display = 'none';
            document.getElementById('ai-gen-result-list').innerHTML = '';
        }
        
        // AI优化题目
        function updateOptimizeQuestionSelect() {
            const select = document.getElementById('ai-opt-question');
            select.innerHTML = '<option value="">请选择题目...</option>' + 
                currentDisplayedQuestions.slice(0, 50).map(q => 
                    `<option value="${q.id}">${q.round}. ${q.title.substring(0, 40)}${q.title.length > 40 ? '...' : ''}</option>`
                ).join('');
        }
        
        function loadQuestionForOptimize() {
            const questionId = document.getElementById('ai-opt-question').value;
            if (!questionId) {
                document.getElementById('ai-opt-preview').style.display = 'none';
                currentOptimizeQuestion = null;
                return;
            }
            
            // 使用 == 进行比较，因为 questionId 是字符串，q.id 可能是数字
            currentOptimizeQuestion = currentDisplayedQuestions.find(q => String(q.id) === String(questionId));
            if (!currentOptimizeQuestion) return;
            
            const q = currentOptimizeQuestion;
            document.getElementById('ai-opt-preview-content').innerHTML = `
                <div style="margin-bottom:8px;"><strong>题目:</strong> ${q.title}</div>
                ${q.option_a ? `<div style="font-size:0.9rem; color:#94a3b8;">A. ${q.option_a} | B. ${q.option_b} | C. ${q.option_c || '-'} | D. ${q.option_d || '-'}</div>` : ''}
                <div style="font-size:0.9rem; margin-top:5px;"><strong>答案:</strong> ${q.answer}</div>
                ${q.explanation ? `<div style="font-size:0.9rem; margin-top:5px;"><strong>解析:</strong> ${q.explanation}</div>` : ''}
            `;
            document.getElementById('ai-opt-preview').style.display = 'block';
            document.getElementById('ai-opt-result').style.display = 'none';
        }
        
        async function optimizeQuestionWithAI() {
            if (!currentOptimizeQuestion) {
                alert('请先选择要优化的题目');
                return;
            }
            
            if (!AIAssistant.isConfigured()) {
                alert('请先配置AI API密钥');
                switchAITab('config');
                return;
            }
            
            const result = await AIAssistant.optimizeQuestion(currentOptimizeQuestion);
            
            if (result.success) {
                optimizedQuestion = result.optimized;
                document.getElementById('ai-opt-result-content').innerHTML = `
                    <div style="margin-bottom:10px;"><strong>优化后题目:</strong> ${optimizedQuestion.title}</div>
                    ${optimizedQuestion.option_a ? `<div style="font-size:0.9rem; color:#94a3b8;">A. ${optimizedQuestion.option_a} | B. ${optimizedQuestion.option_b} | C. ${optimizedQuestion.option_c || '-'} | D. ${optimizedQuestion.option_d || '-'}</div>` : ''}
                    <div style="font-size:0.9rem; margin-top:5px;"><strong>答案:</strong> ${optimizedQuestion.answer}</div>
                    <div style="font-size:0.9rem; margin-top:5px;"><strong>解析:</strong> ${optimizedQuestion.explanation || '无'}</div>
                    ${result.suggestions?.length > 0 ? `<div style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;"><strong>优化建议:</strong><ul style="margin:5px 0 0 20px;">${result.suggestions.map(s => `<li>${s}</li>`).join('')}</ul></div>` : ''}
                `;
                document.getElementById('ai-opt-result').style.display = 'block';
            } else {
                alert('优化失败: ' + result.error);
            }
        }
        
        async function generateExplanationWithAI() {
            if (!currentOptimizeQuestion) {
                alert('请先选择题目');
                return;
            }
            
            if (!AIAssistant.isConfigured()) {
                alert('请先配置AI API密钥');
                switchAITab('config');
                return;
            }
            
            const result = await AIAssistant.generateExplanation(currentOptimizeQuestion);
            
            if (result.success) {
                optimizedQuestion = { ...currentOptimizeQuestion, explanation: result.explanation };
                document.getElementById('ai-opt-result-content').innerHTML = `
                    <div><strong>生成的解析:</strong></div>
                    <div style="margin-top:8px; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">${result.explanation}</div>
                `;
                document.getElementById('ai-opt-result').style.display = 'block';
            } else {
                alert('生成解析失败: ' + result.error);
            }
        }
        
        async function checkQualityWithAI() {
            if (!currentOptimizeQuestion) {
                alert('请先选择题目');
                return;
            }
            
            if (!AIAssistant.isConfigured()) {
                alert('请先配置AI API密钥');
                switchAITab('config');
                return;
            }
            
            const result = await AIAssistant.checkQuality(currentOptimizeQuestion);
            
            if (result.success) {
                const scoreColor = result.score >= 80 ? '#10b981' : result.score >= 60 ? '#f59e0b' : '#ef4444';
                document.getElementById('ai-opt-result-content').innerHTML = `
                    <div style="text-align:center; margin-bottom:15px;">
                        <div style="font-size:2rem; font-weight:bold; color:${scoreColor};">${result.score}</div>
                        <div style="color:#94a3b8;">质量评分</div>
                    </div>
                    ${result.issues?.length > 0 ? `<div style="margin-bottom:10px;"><strong style="color:#ef4444;">发现的问题:</strong><ul style="margin:5px 0 0 20px;">${result.issues.map(i => `<li>${i}</li>`).join('')}</ul></div>` : ''}
                    ${result.suggestions?.length > 0 ? `<div><strong style="color:#10b981;">改进建议:</strong><ul style="margin:5px 0 0 20px;">${result.suggestions.map(s => `<li>${s}</li>`).join('')}</ul></div>` : ''}
                `;
                document.getElementById('ai-opt-result').style.display = 'block';
                optimizedQuestion = null; // 质量检查不需要应用
            } else {
                alert('质量检查失败: ' + result.error);
            }
        }
        
        async function applyOptimization() {
            if (!optimizedQuestion || !currentOptimizeQuestion) {
                alert('没有可应用的优化结果');
                return;
            }
            
            // 保存版本历史
            await VersionHistory.saveVersionWithCleanup(
                supabaseClient,
                currentOptimizeQuestion.id,
                currentOptimizeQuestion,
                'AI优化前的版本'
            );
            
            // 更新题目
            const { error } = await supabaseClient
                .from('questions')
                .update({
                    title: optimizedQuestion.title,
                    option_a: optimizedQuestion.option_a,
                    option_b: optimizedQuestion.option_b,
                    option_c: optimizedQuestion.option_c,
                    option_d: optimizedQuestion.option_d,
                    answer: optimizedQuestion.answer,
                    explanation: optimizedQuestion.explanation
                })
                .eq('id', currentOptimizeQuestion.id);
            
            if (error) {
                alert('应用失败: ' + error.message);
                return;
            }
            
            // 记录AI优化日志
            await AIAssistant.logOperation(supabaseClient, 'optimize_apply', {
                questionId: currentOptimizeQuestion.id,
                originalTitle: currentOptimizeQuestion.title
            }, {
                optimizedTitle: optimizedQuestion.title,
                changes: ['title', 'options', 'answer', 'explanation'].filter(f => 
                    currentOptimizeQuestion[f === 'options' ? 'option_a' : f] !== optimizedQuestion[f === 'options' ? 'option_a' : f]
                )
            });
            
            alert('✅ 优化已应用');
            document.getElementById('ai-opt-result').style.display = 'none';
            await loadQuestions();
            updateOptimizeQuestionSelect();
        }
        
        // ================== 导出功能 ==================
        function openExportModal() {
            // 更新导出数量显示
            document.getElementById('export-current-count').textContent = currentDisplayedQuestions.length;
            document.getElementById('export-selected-count').textContent = BatchOperations.getSelectedCount();
            
            // 初始化格式选择样式
            document.querySelectorAll('.export-format-option').forEach(opt => {
                opt.style.borderColor = 'transparent';
                const radio = opt.querySelector('input[type="radio"]');
                if (radio.checked) {
                    opt.style.borderColor = '#3b82f6';
                }
            });
            
            // 添加格式选择事件
            document.querySelectorAll('.export-format-option').forEach(opt => {
                opt.onclick = function() {
                    document.querySelectorAll('.export-format-option').forEach(o => o.style.borderColor = 'transparent');
                    this.style.borderColor = '#3b82f6';
                    this.querySelector('input[type="radio"]').checked = true;
                };
            });
            
            document.getElementById('export-modal').style.display = 'flex';
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }
        
        async function executeExport() {
            const scope = document.getElementById('export-scope').value;
            const format = document.querySelector('input[name="export-format"]:checked').value;
            
            let questionsToExport = [];
            let filename = 'questions';
            
            switch (scope) {
                case 'current':
                    questionsToExport = currentDisplayedQuestions;
                    filename = 'questions_filtered';
                    break;
                case 'selected':
                    const selectedIds = BatchOperations.getSelectedIds();
                    questionsToExport = questions.filter(q => selectedIds.includes(q.id));
                    filename = 'questions_selected';
                    break;
                case 'all':
                    questionsToExport = questions;
                    filename = 'questions_all';
                    break;
            }
            
            if (questionsToExport.length === 0) {
                alert('没有可导出的题目');
                return;
            }
            
            try {
                // 添加时间戳到文件名
                const timestamp = new Date().toISOString().slice(0, 10);
                filename = `${filename}_${timestamp}`;
                
                ImportExport.exportQuestions(questionsToExport, format, filename);
                closeExportModal();
                alert(`✅ 成功导出 ${questionsToExport.length} 道题目`);
            } catch (error) {
                alert('导出失败: ' + error.message);
            }
        }
        
        // ================== 版本历史功能 ==================
        let currentVersionQuestionId = null;
        let selectedVersionId = null;
        let versionsList = [];
        
        async function showVersionHistory(questionId) {
            currentVersionQuestionId = questionId;
            selectedVersionId = null;
            
            // 获取当前题目信息
            const question = questions.find(q => q.id === questionId);
            if (question) {
                document.getElementById('version-current-title').textContent = question.title;
            }
            
            document.getElementById('version-history-modal').style.display = 'flex';
            document.getElementById('version-compare').style.display = 'none';
            document.getElementById('version-actions').style.display = 'none';
            
            await loadVersionList(questionId);
        }
        
        function closeVersionHistory() {
            document.getElementById('version-history-modal').style.display = 'none';
            currentVersionQuestionId = null;
            selectedVersionId = null;
        }
        
        async function loadVersionList(questionId) {
            const container = document.getElementById('version-list');
            container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">加载中...</div>';
            
            versionsList = await VersionHistory.getVersions(supabaseClient, questionId);
            
            if (versionsList.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">暂无历史版本</div>';
                return;
            }
            
            container.innerHTML = versionsList.map((v, i) => {
                const date = new Date(v.created_at).toLocaleString('zh-CN');
                return `
                    <div class="version-item" data-version-id="${v.id}" onclick="selectVersion('${v.id}')" 
                         style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s;">
                        <div>
                            <div style="font-weight:bold;">版本 ${v.version_number}</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">${date}</div>
                            ${v.changes_summary ? `<div style="font-size:0.8rem; color:#f59e0b; margin-top:3px;">${v.changes_summary}</div>` : ''}
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="event.stopPropagation(); previewVersion('${v.id}')" class="btn btn-secondary" style="padding:5px 10px; font-size:0.75rem;">👁️ 预览</button>
                            <button onclick="event.stopPropagation(); compareWithCurrent('${v.id}')" class="btn btn-primary" style="padding:5px 10px; font-size:0.75rem;">📊 对比</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectVersion(versionId) {
            selectedVersionId = versionId;
            
            // 更新选中样式
            document.querySelectorAll('.version-item').forEach(item => {
                item.style.borderColor = item.dataset.versionId === versionId ? '#3b82f6' : 'transparent';
            });
            
            document.getElementById('version-actions').style.display = 'flex';
        }
        
        async function previewVersion(versionId) {
            const version = await VersionHistory.getVersion(supabaseClient, versionId);
            if (!version || !version.content) {
                alert('无法加载版本内容');
                return;
            }
            
            const content = version.content;
            document.getElementById('version-compare-content').innerHTML = `
                <div style="background:rgba(255,255,255,0.05); border-radius:8px; padding:15px;">
                    <div style="margin-bottom:10px;"><strong>题目:</strong> ${content.title}</div>
                    ${content.option_a ? `<div style="font-size:0.9rem; color:#94a3b8;">A. ${content.option_a} | B. ${content.option_b} | C. ${content.option_c || '-'} | D. ${content.option_d || '-'}</div>` : ''}
                    <div style="margin-top:8px;"><strong>答案:</strong> ${content.answer}</div>
                    ${content.explanation ? `<div style="margin-top:8px;"><strong>解析:</strong> ${content.explanation}</div>` : ''}
                </div>
            `;
            document.getElementById('version-compare').style.display = 'block';
            selectedVersionId = versionId;
            document.getElementById('version-actions').style.display = 'flex';
        }
        
        async function compareWithCurrent(versionId) {
            const version = await VersionHistory.getVersion(supabaseClient, versionId);
            if (!version || !version.content) {
                alert('无法加载版本内容');
                return;
            }
            
            const currentQuestion = questions.find(q => q.id === currentVersionQuestionId);
            if (!currentQuestion) {
                alert('无法获取当前题目');
                return;
            }
            
            const comparison = VersionHistory.compareVersions(version, currentQuestion);
            
            if (comparison.changes.length === 0) {
                document.getElementById('version-compare-content').innerHTML = `
                    <div style="text-align:center; padding:20px; color:#10b981;">✅ 此版本与当前版本内容相同</div>
                `;
            } else {
                const fieldNames = {
                    title: '题目',
                    option_a: '选项A',
                    option_b: '选项B',
                    option_c: '选项C',
                    option_d: '选项D',
                    answer: '答案',
                    explanation: '解析',
                    difficulty: '难度',
                    knowledge_tag: '知识点'
                };
                
                document.getElementById('version-compare-content').innerHTML = `
                    <div style="font-size:0.9rem;">
                        ${comparison.changes.map(c => `
                            <div style="margin-bottom:12px; padding:10px; background:rgba(255,255,255,0.05); border-radius:6px;">
                                <div style="font-weight:bold; color:#f59e0b; margin-bottom:5px;">${fieldNames[c.field] || c.field}</div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                    <div>
                                        <div style="font-size:0.75rem; color:#94a3b8;">历史版本</div>
                                        <div style="background:rgba(239,68,68,0.1); padding:5px; border-radius:4px; margin-top:3px;">${c.old || '(空)'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:0.75rem; color:#94a3b8;">当前版本</div>
                                        <div style="background:rgba(16,185,129,0.1); padding:5px; border-radius:4px; margin-top:3px;">${c.new || '(空)'}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('version-compare').style.display = 'block';
            selectedVersionId = versionId;
            document.getElementById('version-actions').style.display = 'flex';
        }
        
        function closeVersionCompare() {
            document.getElementById('version-compare').style.display = 'none';
            document.getElementById('version-actions').style.display = 'none';
            selectedVersionId = null;
            
            document.querySelectorAll('.version-item').forEach(item => {
                item.style.borderColor = 'transparent';
            });
        }
        
        async function restoreSelectedVersion() {
            if (!selectedVersionId || !currentVersionQuestionId) {
                alert('请先选择要恢复的版本');
                return;
            }
            
            if (!confirm('确定要恢复到此版本吗？当前版本将被保存为新的历史记录。')) {
                return;
            }
            
            const result = await VersionHistory.restoreVersion(supabaseClient, currentVersionQuestionId, selectedVersionId);
            
            if (result.success) {
                alert('✅ 版本已恢复');
                closeVersionHistory();
                await loadQuestions();
            } else {
                alert('恢复失败: ' + result.error);
            }
        }
        
        // ================== 模板管理功能 ==================
        let customTemplates = [];
        
        function openTemplateManager() {
            loadCustomTemplates();
            document.getElementById('template-manager-modal').style.display = 'flex';
        }
        
        function closeTemplateManager() {
            document.getElementById('template-manager-modal').style.display = 'none';
            document.getElementById('create-template-form').style.display = 'none';
        }
        
        async function loadCustomTemplates() {
            const result = await QuestionTemplates.getTemplates(supabaseClient);
            if (result.success) {
                customTemplates = result.templates.filter(t => !t.is_builtin);
                renderCustomTemplates();
                updateTemplateSelect();
            }
        }
        
        function renderCustomTemplates() {
            const container = document.getElementById('custom-templates-list');
            
            if (customTemplates.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">暂无自定义模板</div>';
                return;
            }
            
            container.innerHTML = customTemplates.map(t => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                    <div>
                        <div style="font-weight:bold;">${t.name}</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">${t.description || t.question_type}</div>
                    </div>
                    <button onclick="deleteCustomTemplate('${t.id}')" class="btn btn-danger" style="padding:5px 10px; font-size:0.75rem;">🗑️</button>
                </div>
            `).join('');
        }
        
        function updateTemplateSelect() {
            const select = document.getElementById('q-template');
            if (!select) return;
            
            // 保留内置模板选项
            let html = `
                <option value="">选择模板...</option>
                <option value="single">📌 单选题模板</option>
                <option value="multiple">📋 多选题模板</option>
                <option value="truefalse">✅ 判断题模板</option>
                <option value="fillblank">✏️ 填空题模板</option>
            `;
            
            // 添加自定义模板
            if (customTemplates.length > 0) {
                html += '<option disabled>──────────</option>';
                customTemplates.forEach(t => {
                    html += `<option value="custom_${t.id}">⭐ ${t.name}</option>`;
                });
            }
            
            select.innerHTML = html;
        }
        
        function applyQuestionTemplate() {
            const templateId = document.getElementById('q-template').value;
            if (!templateId) return;
            
            let templateData;
            
            if (templateId.startsWith('custom_')) {
                // 自定义模板
                const customId = templateId.replace('custom_', '');
                const customTemplate = customTemplates.find(t => t.id === customId);
                if (customTemplate) {
                    templateData = QuestionTemplates.applyTemplate(null, customTemplate);
                }
            } else {
                // 内置模板
                templateData = QuestionTemplates.applyTemplate(templateId);
            }
            
            if (templateData) {
                // 应用模板数据到表单
                document.getElementById('q-type').value = templateData.question_type || 'single';
                document.getElementById('q-difficulty').value = templateData.difficulty || 3;
                
                if (templateData.knowledge_tag) {
                    document.getElementById('q-tag').value = templateData.knowledge_tag;
                }
                
                // 更新表单显示
                updateQuestionForm();
                
                // 如果模板有默认选项，填充它们
                if (templateData.option_a !== undefined) {
                    const optA = document.getElementById('q-opt-a');
                    if (optA && templateData.option_a) optA.value = templateData.option_a;
                }
                if (templateData.option_b !== undefined) {
                    const optB = document.getElementById('q-opt-b');
                    if (optB && templateData.option_b) optB.value = templateData.option_b;
                }
            }
        }
        
        function openCreateTemplate() {
            document.getElementById('create-template-form').style.display = 'block';
            document.getElementById('new-template-name').value = '';
            document.getElementById('new-template-tag').value = '';
        }
        
        function cancelCreateTemplate() {
            document.getElementById('create-template-form').style.display = 'none';
        }
        
        async function saveNewTemplate() {
            const name = document.getElementById('new-template-name').value.trim();
            if (!name) {
                alert('请输入模板名称');
                return;
            }
            
            const questionType = document.getElementById('new-template-type').value;
            const difficulty = parseInt(document.getElementById('new-template-difficulty').value);
            const knowledgeTag = document.getElementById('new-template-tag').value.trim();
            
            // 获取基础模板数据
            const baseTemplate = QuestionTemplates.applyTemplate(questionType);
            
            const template = {
                question_type: questionType,
                description: `${knowledgeTag || questionType} - 难度${difficulty}`,
                template_data: {
                    ...baseTemplate,
                    difficulty,
                    knowledge_tag: knowledgeTag || null
                }
            };
            
            const result = await QuestionTemplates.saveTemplate(supabaseClient, name, template);
            
            if (result.success) {
                alert('✅ 模板已保存');
                cancelCreateTemplate();
                await loadCustomTemplates();
            } else {
                alert('保存失败: ' + result.error);
            }
        }
        
        async function deleteCustomTemplate(templateId) {
            if (!confirm('确定要删除这个模板吗？')) return;
            
            const result = await QuestionTemplates.deleteTemplate(supabaseClient, templateId);
            
            if (result.success) {
                await loadCustomTemplates();
            } else {
                alert('删除失败: ' + result.error);
            }
        }
        
        // 页面加载时初始化模板
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomTemplates();
        });
    </script>
</body>
</html>
