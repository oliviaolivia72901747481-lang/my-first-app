<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š è¯¾å ‚æ•°æ®åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="/classroom/js/common.js"></script>
    <script src="/classroom/js/points.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f1f5f9;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .header p { opacity: 0.7; font-size: 0.9rem; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-card .icon { font-size: 2rem; margin-bottom: 10px; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: #1e293b; }
        .stat-card .label { color: #64748b; font-size: 0.9rem; }
        .stat-card.highlight { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; }
        .stat-card.highlight .value { color: white; }
        .stat-card.highlight .label { color: rgba(255,255,255,0.8); }
        
        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            background: white;
            color: #64748b;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #3b82f6;
            color: white;
        }
        .tab-btn:hover { transform: translateY(-2px); }
        
        /* é¢æ¿ */
        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: none;
        }
        .panel.active { display: block; }
        .panel-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        /* è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table th {
            background: #f8fafc;
            font-weight: bold;
            color: #475569;
        }
        .data-table tr:hover { background: #f8fafc; }
        
        /* æ­£ç¡®ç‡æ¡ */
        .rate-bar {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        .rate-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .rate-high { background: #10b981; }
        .rate-medium { background: #f59e0b; }
        .rate-low { background: #ef4444; }
        
        /* å­¦ç”Ÿåˆ—è¡¨ */
        .student-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: #f8fafc;
        }
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }
        .student-info { flex: 1; }
        .student-name { font-weight: bold; color: #1e293b; }
        .student-id { font-size: 0.8rem; color: #64748b; }
        .student-stats { text-align: right; }
        .student-points { font-size: 1.2rem; font-weight: bold; color: #f59e0b; }
        .student-rate { font-size: 0.8rem; color: #64748b; }
        
        /* åˆ·æ–°æŒ‰é’® */
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4);
            cursor: pointer;
            font-size: 1.5rem;
        }
        .refresh-btn:hover { transform: scale(1.1); }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š è¯¾å ‚æ•°æ®åˆ†æ</h1>
        <p>å®æ—¶ç›‘æ§å­¦ç”Ÿè¡¨ç°ï¼Œä¼˜åŒ–æ•™å­¦ç­–ç•¥</p>
    </div>
    
    <div class="container">
        <!-- æ¦‚è§ˆç»Ÿè®¡ -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="icon">ğŸ‘¥</div>
                <div class="value" id="stat-attendance">0</div>
                <div class="label">ä»Šæ—¥ç­¾åˆ°</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ“</div>
                <div class="value" id="stat-answers">0</div>
                <div class="label">ç­”é¢˜æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="icon">âœ…</div>
                <div class="value" id="stat-correct-rate">0%</div>
                <div class="label">å¹³å‡æ­£ç¡®ç‡</div>
            </div>
            <div class="stat-card">
                <div class="icon">â­</div>
                <div class="value" id="stat-total-points">0</div>
                <div class="label">ä»Šæ—¥å‘æ”¾ç§¯åˆ†</div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('questions')">ğŸ“š é¢˜ç›®åˆ†æ</button>
            <button class="tab-btn" onclick="switchTab('students')">ğŸ‘¤ å­¦ç”Ÿè¡¨ç°</button>
            <button class="tab-btn" onclick="switchTab('points')">ğŸ† ç§¯åˆ†ç®¡ç†</button>
        </div>
        
        <!-- é¢˜ç›®åˆ†æé¢æ¿ -->
        <div class="panel active" id="panel-questions">
            <div class="panel-title">ğŸ“š é¢˜ç›®æ­£ç¡®ç‡åˆ†æ</div>
            <div class="chart-container">
                <canvas id="questionChart"></canvas>
            </div>
            <table class="data-table" id="question-table">
                <thead>
                    <tr>
                        <th>é¢˜å·</th>
                        <th>é¢˜ç›®</th>
                        <th>æ­£ç¡®ç‡</th>
                        <th>ä½œç­”äººæ•°</th>
                        <th>éš¾åº¦</th>
                    </tr>
                </thead>
                <tbody id="question-tbody"></tbody>
            </table>
        </div>
        
        <!-- å­¦ç”Ÿè¡¨ç°é¢æ¿ -->
        <div class="panel" id="panel-students">
            <div class="panel-title">ğŸ‘¤ å­¦ç”Ÿè¡¨ç°æ’å</div>
            <div id="student-list"></div>
        </div>
        
        <!-- ç§¯åˆ†ç®¡ç†é¢æ¿ -->
        <div class="panel" id="panel-points">
            <div class="panel-title">ğŸ† ç§¯åˆ†ç®¡ç†</div>
            <div style="margin-bottom:20px; padding:15px; background:#f8fafc; border-radius:10px;">
                <h4 style="margin-bottom:10px;">æ‰‹åŠ¨åŠ å‡åˆ†</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <select id="point-student" style="flex:1; min-width:150px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                        <option value="">é€‰æ‹©å­¦ç”Ÿ...</option>
                    </select>
                    <input type="number" id="point-amount" placeholder="ç§¯åˆ†æ•°" style="width:100px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <input type="text" id="point-reason" placeholder="åŸå› " style="flex:1; min-width:150px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <button onclick="addManualPoints()" style="padding:10px 20px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">æ·»åŠ </button>
                </div>
            </div>
            <div class="panel-title">ğŸ“œ ç§¯åˆ†è®°å½•</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å­¦ç”Ÿ</th>
                        <th>ç§¯åˆ†</th>
                        <th>ç±»å‹</th>
                        <th>åŸå› </th>
                    </tr>
                </thead>
                <tbody id="points-log-tbody"></tbody>
            </table>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshAll()" id="refresh-btn">ğŸ”„</button>

    <script>
        const supabaseClient = ClassroomCommon.createSupabaseClient();
        let questionChart = null;
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`panel-${tabName}`).classList.add('active');
        }
        
        // åŠ è½½æ¦‚è§ˆç»Ÿè®¡
        async function loadOverviewStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString();
            
            // ä»Šæ—¥ç­¾åˆ°æ•°
            const { data: attendance } = await supabaseClient
                .from('attendance')
                .select('id')
                .gte('created_at', todayStr);
            document.getElementById('stat-attendance').innerText = attendance?.length || 0;
            
            // ä»Šæ—¥ç­”é¢˜æ•°
            const { data: answers } = await supabaseClient
                .from('vote_logs')
                .select('id, is_correct')
                .gte('created_at', todayStr);
            document.getElementById('stat-answers').innerText = answers?.length || 0;
            
            // å¹³å‡æ­£ç¡®ç‡
            if (answers && answers.length > 0) {
                const correctCount = answers.filter(a => a.is_correct).length;
                const rate = Math.round((correctCount / answers.length) * 100);
                document.getElementById('stat-correct-rate').innerText = rate + '%';
            }
            
            // ä»Šæ—¥å‘æ”¾ç§¯åˆ†
            const { data: points } = await supabaseClient
                .from('points_log')
                .select('points')
                .gte('created_at', todayStr)
                .gt('points', 0);
            const totalPoints = points?.reduce((sum, p) => sum + p.points, 0) || 0;
            document.getElementById('stat-total-points').innerText = totalPoints;
        }
        
        // åŠ è½½é¢˜ç›®åˆ†æ
        async function loadQuestionAnalysis() {
            // è·å–æ‰€æœ‰é¢˜ç›®
            const { data: questions } = await supabaseClient
                .from('questions')
                .select('*')
                .order('round', { ascending: true });
            
            if (!questions || questions.length === 0) {
                document.getElementById('question-tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">æš‚æ— é¢˜ç›®æ•°æ®</td></tr>';
                return;
            }
            
            // è·å–ç­”é¢˜è®°å½•
            const { data: logs } = await supabaseClient
                .from('vote_logs')
                .select('round, is_correct');
            
            // è®¡ç®—æ¯é¢˜çš„ç»Ÿè®¡
            const stats = questions.map(q => {
                const qLogs = logs?.filter(l => l.round === q.round) || [];
                const total = qLogs.length;
                const correct = qLogs.filter(l => l.is_correct).length;
                const rate = total > 0 ? Math.round((correct / total) * 100) : 0;
                
                return {
                    round: q.round,
                    title: q.title,
                    total,
                    correct,
                    rate
                };
            });
            
            // æ¸²æŸ“è¡¨æ ¼
            document.getElementById('question-tbody').innerHTML = stats.map(s => {
                const rateClass = s.rate >= 70 ? 'rate-high' : s.rate >= 40 ? 'rate-medium' : 'rate-low';
                const difficulty = s.rate >= 70 ? 'ç®€å•' : s.rate >= 40 ? 'ä¸­ç­‰' : 'å›°éš¾';
                const diffColor = s.rate >= 70 ? '#10b981' : s.rate >= 40 ? '#f59e0b' : '#ef4444';
                
                return `
                    <tr>
                        <td>ç¬¬${s.round}é¢˜</td>
                        <td>${s.title?.substring(0, 30) || '--'}${s.title?.length > 30 ? '...' : ''}</td>
                        <td>
                            <div class="rate-bar"><div class="rate-bar-fill ${rateClass}" style="width:${s.rate}%"></div></div>
                            ${s.rate}%
                        </td>
                        <td>${s.total}äºº</td>
                        <td style="color:${diffColor}; font-weight:bold;">${difficulty}</td>
                    </tr>
                `;
            }).join('');
            
            // æ›´æ–°å›¾è¡¨
            updateQuestionChart(stats);
        }
        
        // æ›´æ–°é¢˜ç›®å›¾è¡¨
        function updateQuestionChart(stats) {
            const ctx = document.getElementById('questionChart').getContext('2d');
            
            if (questionChart) {
                questionChart.destroy();
            }
            
            questionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.map(s => `ç¬¬${s.round}é¢˜`),
                    datasets: [{
                        label: 'æ­£ç¡®ç‡ (%)',
                        data: stats.map(s => s.rate),
                        backgroundColor: stats.map(s => 
                            s.rate >= 70 ? 'rgba(16, 185, 129, 0.7)' : 
                            s.rate >= 40 ? 'rgba(245, 158, 11, 0.7)' : 
                            'rgba(239, 68, 68, 0.7)'
                        ),
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }
        
        // åŠ è½½å­¦ç”Ÿè¡¨ç°
        async function loadStudentPerformance() {
            // è·å–å­¦ç”Ÿç§¯åˆ†
            const { data: students } = await supabaseClient
                .from('student_points')
                .select('*')
                .order('total_points', { ascending: false });
            
            if (!students || students.length === 0) {
                document.getElementById('student-list').innerHTML = '<div style="text-align:center;color:#999;padding:40px;">æš‚æ— å­¦ç”Ÿæ•°æ®</div>';
                return;
            }
            
            // è·å–ç­”é¢˜è®°å½•è®¡ç®—æ­£ç¡®ç‡
            const { data: logs } = await supabaseClient
                .from('vote_logs')
                .select('student_id, is_correct');
            
            const studentStats = students.map(s => {
                const sLogs = logs?.filter(l => l.student_id === s.student_id) || [];
                const total = sLogs.length;
                const correct = sLogs.filter(l => l.is_correct).length;
                const rate = total > 0 ? Math.round((correct / total) * 100) : 0;
                
                return { ...s, answerCount: total, correctRate: rate };
            });
            
            document.getElementById('student-list').innerHTML = studentStats.map((s, i) => `
                <div class="student-item">
                    <div class="student-avatar">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : s.student_name?.charAt(0) || '?'}</div>
                    <div class="student-info">
                        <div class="student-name">${s.student_name}</div>
                        <div class="student-id">${s.student_id} Â· ç­”é¢˜${s.answerCount}æ¬¡</div>
                    </div>
                    <div class="student-stats">
                        <div class="student-points">${s.total_points}åˆ†</div>
                        <div class="student-rate">æ­£ç¡®ç‡ ${s.correctRate}%</div>
                    </div>
                </div>
            `).join('');
            
            // æ›´æ–°å­¦ç”Ÿé€‰æ‹©ä¸‹æ‹‰æ¡†
            document.getElementById('point-student').innerHTML = 
                '<option value="">é€‰æ‹©å­¦ç”Ÿ...</option>' +
                students.map(s => `<option value="${s.student_id}" data-name="${s.student_name}">${s.student_name} (${s.student_id})</option>`).join('');
        }
        
        // åŠ è½½ç§¯åˆ†è®°å½•
        async function loadPointsLog() {
            const { data: logs } = await supabaseClient
                .from('points_log')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (!logs || logs.length === 0) {
                document.getElementById('points-log-tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">æš‚æ— ç§¯åˆ†è®°å½•</td></tr>';
                return;
            }
            
            const typeLabels = {
                'sign_in': 'ğŸ“… ç­¾åˆ°',
                'answer': 'ğŸ“ ç­”é¢˜',
                'buzzer': 'âš¡ æŠ¢ç­”',
                'lucky': 'ğŸ° ç‚¹å',
                'bonus': 'ğŸ å¥–åŠ±',
                'penalty': 'âš ï¸ æ‰£åˆ†'
            };
            
            document.getElementById('points-log-tbody').innerHTML = logs.map(log => `
                <tr>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                    <td>${log.student_name}</td>
                    <td style="color:${log.points >= 0 ? '#10b981' : '#ef4444'}; font-weight:bold;">
                        ${log.points >= 0 ? '+' : ''}${log.points}
                    </td>
                    <td>${typeLabels[log.type] || log.type}</td>
                    <td>${log.reason || '--'}</td>
                </tr>
            `).join('');
        }
        
        // æ‰‹åŠ¨åŠ å‡åˆ†
        async function addManualPoints() {
            const select = document.getElementById('point-student');
            const studentId = select.value;
            const studentName = select.options[select.selectedIndex]?.dataset?.name;
            const amount = parseInt(document.getElementById('point-amount').value);
            const reason = document.getElementById('point-reason').value.trim();
            
            if (!studentId || !studentName) {
                alert('è¯·é€‰æ‹©å­¦ç”Ÿ');
                return;
            }
            if (isNaN(amount) || amount === 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°');
                return;
            }
            
            const type = amount > 0 ? 'bonus' : 'penalty';
            const result = await PointsSystem.addPoints(
                supabaseClient, studentId, studentName, amount, type, reason || (amount > 0 ? 'æ•™å¸ˆå¥–åŠ±' : 'æ•™å¸ˆæ‰£åˆ†')
            );
            
            if (result.success) {
                alert(`âœ… å·²${amount > 0 ? 'å¥–åŠ±' : 'æ‰£é™¤'} ${studentName} ${Math.abs(amount)} ç§¯åˆ†`);
                document.getElementById('point-amount').value = '';
                document.getElementById('point-reason').value = '';
                loadPointsLog();
                loadStudentPerformance();
                loadOverviewStats();
            } else {
                alert('æ“ä½œå¤±è´¥: ' + (result.error?.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAll() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('spinning');
            
            await Promise.all([
                loadOverviewStats(),
                loadQuestionAnalysis(),
                loadStudentPerformance(),
                loadPointsLog()
            ]);
            
            btn.classList.remove('spinning');
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', refreshAll);
    </script>
</body>
</html>
