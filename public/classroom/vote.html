<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ è¯¾å ‚ç­”é¢˜å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/classroom/js/common.js"></script>
    <script src="/classroom/js/navigation.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f3f4f6; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; color: #666; background: white; padding: 10px 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .question-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; min-height: 120px; }
        .q-title { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 15px; line-height: 1.4; }
        .q-type-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; font-weight: normal; }
        .q-type-single { background: #dbeafe; color: #1d4ed8; }
        .q-type-multi { background: #fef3c7; color: #b45309; }
        .q-type-judge { background: #d1fae5; color: #047857; }
        .q-opt { font-size: 1rem; color: #555; margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 5px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .options-grid.judge-mode { grid-template-columns: 1fr 1fr; }
        button.vote-btn { padding: 20px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 12px; color: white; cursor: pointer; touch-action: manipulation; transition: all 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        button.vote-btn:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background-color: #cbd5e1 !important; opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        button.vote-btn.selected { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.5); }
        .btn-a { background-color: #FF6384; } .btn-b { background-color: #36A2EB; } .btn-c { background-color: #FFCE56; } .btn-d { background-color: #4BC0C0; }
        .btn-true { background-color: #10b981; } .btn-false { background-color: #ef4444; }
        #status-msg { text-align: center; margin-top: 20px; font-weight: bold; color: #666; min-height: 24px; }
        #submit-multi { display: none; margin-top: 15px; padding: 15px 40px; font-size: 1.2rem; background: #10b981; color: white; border: none; border-radius: 10px; cursor: pointer; }
        #submit-multi:disabled { background: #ccc; }
        .multi-hint { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="info-bar">
        <span>ğŸ‘¤ <span id="user-name">...</span></span>
        <span>ç¬¬ <span id="round-num">1</span> é¢˜</span>
    </div>

    <div class="question-box">
        <div id="q-title" class="q-title">ç­‰å¾…è€å¸ˆå‡ºé¢˜...</div>
        <div id="q-options"></div>
    </div>

    <div id="multi-hint" class="multi-hint" style="display:none;">ç‚¹å‡»é€‰æ‹©å¤šä¸ªé€‰é¡¹ï¼Œç„¶åç‚¹å‡»æäº¤</div>
    
    <div class="options-grid" id="options-grid">
        <button class="vote-btn btn-a" onclick="handleOptionClick('A')">A</button>
        <button class="vote-btn btn-b" onclick="handleOptionClick('B')">B</button>
        <button class="vote-btn btn-c" onclick="handleOptionClick('C')">C</button>
        <button class="vote-btn btn-d" onclick="handleOptionClick('D')">D</button>
    </div>
    
    <button id="submit-multi" onclick="submitMultiVote()">âœ… æäº¤ç­”æ¡ˆ</button>

    <div id="status-msg"></div>

    <script>
        // å…¨å±€å˜é‡ (éœ€è¦åœ¨onclickä¸­è®¿é—®)
        let supabaseClient = null;
        let myName = '';
        let myId = '';
        let currentRound = 1;
        let isRoundActive = true;
        let currentQuestion = null;
        let questionType = 'single'; // é¢˜ç›®ç±»å‹: single(å•é€‰), multi(å¤šé€‰), judge(åˆ¤æ–­)
        let selectedOptions = []; // å¤šé€‰é¢˜å·²é€‰é€‰é¡¹
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initVote() {
            // ä½¿ç”¨å…¬å…±é…ç½®å’Œèº«ä»½éªŒè¯
            supabaseClient = ClassroomCommon.createSupabaseClient();
            const userAuth = ClassroomCommon.checkUserAuth();
            if (!userAuth) return; // å¦‚æœæœªç­¾åˆ°ä¼šè‡ªåŠ¨è·³è½¬
            
            myName = userAuth.name;
            myId = userAuth.id;

        document.getElementById('user-name').innerText = myName;

        async function init() {
            // åˆå§‹çŠ¶æ€ï¼šç¦ç”¨æŒ‰é’®ï¼Œç­‰å¾…è€å¸ˆå¼€å§‹
            disableButtons();
            document.getElementById('status-msg').innerText = "â³ ç­‰å¾…è€å¸ˆå¼€å§‹...";
            document.getElementById('status-msg').style.color = "#94a3b8";
            
            const { data: config } = await supabaseClient.from('vote_config').select('*').eq('id', 1).maybeSingle();
            if (config) handleRoundChange(config);

            supabaseClient.channel('student-vote').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => handleRoundChange(payload.new)).subscribe();
        }

        // æ–°å¢ï¼šç­”é¢˜æ¨¡å¼å’Œå…è®¸å›ç­”çš„å­¦ç”Ÿ
        let answerMode = 'vote';
        let allowedStudent = null;
        
        async function handleRoundChange(config) {
            currentRound = config.current_round;
            isRoundActive = config.is_active;
            answerMode = config.answer_mode || 'vote';
            allowedStudent = config.allowed_student || null;
            
            document.getElementById('round-num').innerText = currentRound;
            
            // é‡ç½®å¤šé€‰çŠ¶æ€
            selectedOptions = [];
            document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
            
            await loadQuestion(currentRound);
            
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç­”é¢˜
            const hasVoted = await checkIfIVoted();
            if (hasVoted) return; // å·²ç­”é¢˜ï¼Œä¸éœ€è¦ç»§ç»­æ£€æŸ¥æƒé™

            // æ£€æŸ¥ç­”é¢˜çŠ¶æ€å’Œæƒé™
            if (!isRoundActive) {
                disableButtons();
                document.getElementById('status-msg').innerText = "â³ ç­‰å¾…è€å¸ˆå¼€å§‹...";
                document.getElementById('status-msg').style.color = "#94a3b8";
                document.getElementById('submit-multi').style.display = 'none';
            } else {
                // ç­”é¢˜å·²å¼€å§‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æƒå›ç­”
                checkAnswerPermission();
            }
        }
        
        function checkAnswerPermission() {
            // å¦‚æœæ˜¯æ™®é€šç­”é¢˜æ¨¡å¼(vote)ä¸”æ²¡æœ‰æŒ‡å®šå­¦ç”Ÿï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥å›ç­”
            if (answerMode === 'vote' && !allowedStudent) {
                document.getElementById('status-msg').innerText = "ğŸ“ è¯·ä½œç­”";
                document.getElementById('status-msg').style.color = "#10b981";
                enableButtons();
                return;
            }
            
            // æŠ¢ç­”æˆ–ç‚¹åæ¨¡å¼ï¼šåªæœ‰æŒ‡å®šå­¦ç”Ÿå¯ä»¥å›ç­”
            if (allowedStudent === myName) {
                const modeText = answerMode === 'buzzer' ? 'ğŸ† æŠ¢ç­”æˆåŠŸï¼' : 'ğŸ¯ ä½ è¢«ç‚¹åäº†ï¼';
                document.getElementById('status-msg').innerHTML = `${modeText} è¯·ä½œç­”`;
                document.getElementById('status-msg').style.color = "#10b981";
                enableButtons();
            } else {
                const modeText = answerMode === 'buzzer' ? 'æŠ¢ç­”' : 'ç‚¹å';
                document.getElementById('status-msg').innerHTML = `ğŸ‘€ ${modeText}å›ç­”ï¼š<strong>${allowedStudent}</strong>`;
                document.getElementById('status-msg').style.color = "#f59e0b";
                disableButtons();
                document.getElementById('submit-multi').style.display = 'none';
            }
        }

        async function loadQuestion(round) {
            const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
            currentQuestion = data;
            
            if (data) {
                // åˆ¤æ–­é¢˜ç›®ç±»å‹ (æ ¹æ® type å­—æ®µæˆ–ç­”æ¡ˆé•¿åº¦åˆ¤æ–­)
                questionType = data.type || 'single';
                if (!data.type && data.answer && data.answer.length > 1) {
                    questionType = 'multi';
                }
                // åˆ¤æ–­é¢˜ç‰¹æ®Šå¤„ç†
                if (data.option_a === 'æ­£ç¡®' && data.option_b === 'é”™è¯¯' && !data.option_c && !data.option_d) {
                    questionType = 'judge';
                }
                
                // æ˜¾ç¤ºé¢˜ç›®ç±»å‹æ ‡ç­¾
                const typeLabels = {
                    'single': '<span class="q-type-badge q-type-single">å•é€‰é¢˜</span>',
                    'multi': '<span class="q-type-badge q-type-multi">å¤šé€‰é¢˜</span>',
                    'judge': '<span class="q-type-badge q-type-judge">åˆ¤æ–­é¢˜</span>'
                };
                
                document.getElementById('q-title').innerHTML = `${round}. ${data.title} ${typeLabels[questionType] || ''}`;
                
                // æ ¹æ®é¢˜ç›®ç±»å‹æ¸²æŸ“é€‰é¡¹
                if (questionType === 'judge') {
                    renderJudgeOptions();
                } else {
                    renderNormalOptions(data);
                }
                
                // å¤šé€‰é¢˜æ˜¾ç¤ºæç¤ºå’Œæäº¤æŒ‰é’®
                document.getElementById('multi-hint').style.display = questionType === 'multi' ? 'block' : 'none';
                document.getElementById('submit-multi').style.display = questionType === 'multi' ? 'block' : 'none';
                
            } else {
                document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜`;
                document.getElementById('q-options').innerHTML = `<div style="color:#999;">(æ— é¢˜ç›®æ•°æ®)</div>`;
                renderNormalOptions(null);
            }
        }

        function renderNormalOptions(data) {
            const grid = document.getElementById('options-grid');
            grid.className = 'options-grid';
            grid.innerHTML = `
                <button class="vote-btn btn-a" onclick="handleOptionClick('A')">A</button>
                <button class="vote-btn btn-b" onclick="handleOptionClick('B')">B</button>
                <button class="vote-btn btn-c" onclick="handleOptionClick('C')">C</button>
                <button class="vote-btn btn-d" onclick="handleOptionClick('D')">D</button>
            `;
            
            if (data) {
                document.getElementById('q-options').innerHTML = `
                    <div class="q-opt">A. ${data.option_a || ''}</div>
                    <div class="q-opt">B. ${data.option_b || ''}</div>
                    <div class="q-opt">C. ${data.option_c || ''}</div>
                    <div class="q-opt">D. ${data.option_d || ''}</div>
                `;
            }
        }

        function renderJudgeOptions() {
            const grid = document.getElementById('options-grid');
            grid.className = 'options-grid judge-mode';
            grid.innerHTML = `
                <button class="vote-btn btn-true" onclick="handleOptionClick('A')" style="font-size:1.2rem;">âœ… æ­£ç¡®</button>
                <button class="vote-btn btn-false" onclick="handleOptionClick('B')" style="font-size:1.2rem;">âŒ é”™è¯¯</button>
            `;
            document.getElementById('q-options').innerHTML = '';
        }

        async function checkIfIVoted() {
            const { data } = await supabaseClient.from('vote_logs').select('option').eq('student_id', myId).eq('round', currentRound).maybeSingle();
            if (data) {
                disableButtons();
                document.getElementById('submit-multi').style.display = 'none';
                document.getElementById('multi-hint').style.display = 'none';
                document.getElementById('status-msg').innerText = `âœ… ä½ å·²é€‰: ${data.option}`;
                document.getElementById('status-msg').style.color = "#10b981";
                return true; // å·²æŠ•ç¥¨
            }
            return false; // æœªæŠ•ç¥¨
        }

            // åˆå§‹åŒ–ç­”é¢˜åŠŸèƒ½
            init();
            
            // å¯åŠ¨å…¨å±€æ§åˆ¶ç›‘å¬
            ClassroomCommon.initGlobalControlListener(supabaseClient);
            
            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
            if (typeof NavigationComponent !== 'undefined') {
                NavigationComponent.init();
            }
        }
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initVote);
        
        // å…¨å±€å‡½æ•° (éœ€è¦ä»HTML onclickè°ƒç”¨)
        function handleOptionClick(option) {
            if (!isRoundActive) return alert("å·²åœæ­¢ä½œç­”");
            
            if (questionType === 'multi') {
                // å¤šé€‰é¢˜ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                const btn = document.querySelector(`.btn-${option.toLowerCase()}`);
                if (selectedOptions.includes(option)) {
                    selectedOptions = selectedOptions.filter(o => o !== option);
                    btn.classList.remove('selected');
                } else {
                    selectedOptions.push(option);
                    btn.classList.add('selected');
                }
                // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
                document.getElementById('submit-multi').disabled = selectedOptions.length === 0;
            } else {
                // å•é€‰é¢˜/åˆ¤æ–­é¢˜ï¼šç›´æ¥æäº¤
                submitVote(option);
            }
        }

        async function submitMultiVote() {
            if (selectedOptions.length === 0) return;
            // æ’åºåæ‹¼æ¥ï¼Œå¦‚ "AB" æˆ– "ACD"
            const answer = selectedOptions.sort().join('');
            await submitVote(answer);
        }
        
        async function submitVote(option) {
            if (!isRoundActive) return alert("å·²åœæ­¢ä½œç­”");
            disableButtons();
            document.getElementById('submit-multi').disabled = true;

            // åˆ¤æ–­æ­£è¯¯ (å¤šé€‰é¢˜éœ€è¦å®Œå…¨åŒ¹é…)
            let isCorrect = false;
            if (currentQuestion && currentQuestion.answer) {
                const correctAnswer = currentQuestion.answer.toUpperCase().split('').sort().join('');
                const userAnswer = option.toUpperCase().split('').sort().join('');
                isCorrect = (userAnswer === correctAnswer);
            }
            
            const { error } = await supabaseClient.from('vote_logs').insert([{ 
                student_name: myName, 
                student_id: myId, 
                option: option, 
                round: currentRound,
                is_correct: isCorrect
            }]);

            if (!error) {
                document.getElementById('submit-multi').style.display = 'none';
                document.getElementById('multi-hint').style.display = 'none';
                document.getElementById('status-msg').innerText = `âœ… å·²æäº¤: ${option}`;
                document.getElementById('status-msg').style.color = "#10b981";
            } else {
                alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                enableButtons();
                if (questionType === 'multi') {
                    document.getElementById('submit-multi').disabled = false;
                }
            }
        }

        function disableButtons() { 
            document.querySelectorAll('.vote-btn').forEach(b => b.disabled = true); 
        }
        
        function enableButtons() { 
            document.querySelectorAll('.vote-btn').forEach(b => b.disabled = false); 
        }
    </script>
</body>
</html>