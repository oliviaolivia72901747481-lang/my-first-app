<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ç­”é¢˜å†å²</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/classroom/js/common.js"></script>
    <script src="/classroom/js/navigation.js"></script>
    <script src="/classroom/js/history.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            padding: 15px; 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #f3f4f6;
            padding-bottom: 80px;
        }
        
        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .page-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }
        .user-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* ç­›é€‰å™¨åŒºåŸŸ */
        .filter-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        .filter-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-label {
            font-size: 0.85rem;
            color: #666;
            min-width: 50px;
        }
        .date-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #ef4444;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .toggle-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* ç»Ÿè®¡æ‘˜è¦ */
        .stats-summary {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: block;
        }
        .stat-value.correct { color: #10b981; }
        .stat-value.wrong { color: #ef4444; }
        .stat-label {
            font-size: 0.75rem;
            color: #999;
        }
        
        /* ç­”é¢˜è®°å½•åˆ—è¡¨ */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid #10b981;
        }
        .history-item.wrong {
            border-left-color: #ef4444;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .item-round {
            font-size: 0.8rem;
            color: #999;
        }
        .item-time {
            font-size: 0.75rem;
            color: #bbb;
        }
        .item-title {
            font-size: 0.95rem;
            color: #333;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .item-answers {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }
        .answer-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .answer-tag.my-answer {
            background: #fef3c7;
            color: #b45309;
        }
        .answer-tag.my-answer.correct {
            background: #d1fae5;
            color: #047857;
        }
        .answer-tag.my-answer.wrong {
            background: #fee2e2;
            color: #dc2626;
        }
        .answer-tag.correct-answer {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .result-badge {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .result-badge.correct {
            background: #d1fae5;
            color: #047857;
        }
        .result-badge.wrong {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .empty-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .empty-hint {
            font-size: 0.85rem;
            color: #bbb;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .loading-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
</style>
</head>
<body>
    <div class="page-header">
        <span class="page-title">ğŸ“š ç­”é¢˜å†å²</span>
        <span class="user-info">ğŸ‘¤ <span id="user-name">...</span></span>
    </div>

    <!-- ç­›é€‰å™¨ -->
    <div class="filter-box">
        <div class="filter-row">
            <span class="filter-label">æ—¥æœŸ:</span>
            <input type="date" id="start-date" class="date-input" placeholder="å¼€å§‹æ—¥æœŸ">
            <span>-</span>
            <input type="date" id="end-date" class="date-input" placeholder="ç»“æŸæ—¥æœŸ">
        </div>
        <div class="filter-toggle">
            <label class="toggle-switch">
                <input type="checkbox" id="wrong-only">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">åªçœ‹é”™é¢˜</span>
        </div>
    </div>

    <!-- ç»Ÿè®¡æ‘˜è¦ -->
    <div class="stats-summary" id="stats-summary">
        <div class="stat-item">
            <span class="stat-value" id="total-count">0</span>
            <span class="stat-label">æ€»é¢˜æ•°</span>
        </div>
        <div class="stat-item">
            <span class="stat-value correct" id="correct-count">0</span>
            <span class="stat-label">æ­£ç¡®</span>
        </div>
        <div class="stat-item">
            <span class="stat-value wrong" id="wrong-count">0</span>
            <span class="stat-label">é”™è¯¯</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="accuracy-rate">0%</span>
            <span class="stat-label">æ­£ç¡®ç‡</span>
        </div>
    </div>

    <!-- ç­”é¢˜è®°å½•åˆ—è¡¨ -->
    <div id="history-list" class="history-list">
        <!-- åŠ¨æ€åŠ è½½ -->
    </div>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-text">æš‚æ— ç­”é¢˜è®°å½•</div>
        <div class="empty-hint">å¿«å»å‚ä¸è¯¾å ‚ç­”é¢˜å§ï¼</div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading-state" class="loading-state">
        <div class="loading-spinner">â³</div>
        <div>åŠ è½½ä¸­...</div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let supabaseClient = null;
        let myName = '';
        let myId = '';
        let allRecords = []; // æ‰€æœ‰ç­”é¢˜è®°å½•ç¼“å­˜

        // ä¸»åˆå§‹åŒ–å‡½æ•°
        async function initHistory() {
            // ä½¿ç”¨å…¬å…±é…ç½®å’Œèº«ä»½éªŒè¯
            supabaseClient = ClassroomCommon.createSupabaseClient();
            const userAuth = ClassroomCommon.checkUserAuth();
            if (!userAuth) return;
            
            myName = userAuth.name;
            myId = userAuth.id;
            document.getElementById('user-name').innerText = myName;

            // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('end-date').value = formatDateForInput(today);
            document.getElementById('start-date').value = formatDateForInput(weekAgo);

            // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
            document.getElementById('start-date').addEventListener('change', applyFilters);
            document.getElementById('end-date').addEventListener('change', applyFilters);
            document.getElementById('wrong-only').addEventListener('change', applyFilters);

            // åŠ è½½æ•°æ®
            await loadHistory();

            // å¯åŠ¨å…¨å±€æ§åˆ¶ç›‘å¬
            ClassroomCommon.initGlobalControlListener(supabaseClient);

            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
            if (typeof NavigationComponent !== 'undefined') {
                NavigationComponent.init();
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º input[type=date] æ ¼å¼
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // åŠ è½½ç­”é¢˜å†å²
        async function loadHistory() {
            showLoading(true);
            
            try {
                // ä½¿ç”¨ history.js ä¸­çš„å‡½æ•°è·å–æ•°æ®
                const result = await HistoryModule.getAnswerHistory(supabaseClient, myId);
                allRecords = result.records;
                
                // åº”ç”¨ç­›é€‰å¹¶æ¸²æŸ“
                applyFilters();
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                showEmpty(true);
            } finally {
                showLoading(false);
            }
        }

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        function applyFilters() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const wrongOnly = document.getElementById('wrong-only').checked;

            // ä½¿ç”¨ history.js ä¸­çš„ç­›é€‰å‡½æ•°
            let filtered = HistoryModule.filterRecords(allRecords, {
                startDate: startDate ? new Date(startDate) : null,
                endDate: endDate ? new Date(endDate + 'T23:59:59') : null,
                wrongOnly: wrongOnly
            });

            // æ’åºï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
            filtered = HistoryModule.sortRecordsByTime(filtered);

            // æ›´æ–°ç»Ÿè®¡å’Œåˆ—è¡¨
            updateStats(filtered);
            renderList(filtered);
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateStats(records) {
            const total = records.length;
            const correct = records.filter(r => r.is_correct).length;
            const wrong = total - correct;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            document.getElementById('total-count').textContent = total;
            document.getElementById('correct-count').textContent = correct;
            document.getElementById('wrong-count').textContent = wrong;
            document.getElementById('accuracy-rate').textContent = accuracy + '%';
        }

        // æ¸²æŸ“è®°å½•åˆ—è¡¨
        function renderList(records) {
            const listEl = document.getElementById('history-list');
            
            if (records.length === 0) {
                listEl.innerHTML = '';
                showEmpty(true);
                return;
            }
            
            showEmpty(false);
            
            listEl.innerHTML = records.map(record => {
                const isCorrect = record.is_correct;
                const itemClass = isCorrect ? '' : 'wrong';
                const answerClass = isCorrect ? 'correct' : 'wrong';
                const resultText = isCorrect ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯';
                const resultClass = isCorrect ? 'correct' : 'wrong';
                
                // æ ¼å¼åŒ–æ—¶é—´
                const time = new Date(record.created_at).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // é¢˜ç›®æ ‡é¢˜ï¼ˆå¦‚æœæœ‰å…³è”çš„é¢˜ç›®æ•°æ®ï¼‰
                const title = record.question_title || `ç¬¬ ${record.round} é¢˜`;
                const correctAnswer = record.correct_answer || record.question_answer || '-';
                
                return `
                    <div class="history-item ${itemClass}">
                        <div class="item-header">
                            <span class="item-round">ç¬¬ ${record.round} é¢˜</span>
                            <span class="item-time">${time}</span>
                        </div>
                        <div class="item-title">${ClassroomCommon.escapeHtml(title)}</div>
                        <div class="item-answers">
                            <span class="answer-tag my-answer ${answerClass}">æˆ‘çš„ç­”æ¡ˆ: ${record.option}</span>
                            <span class="answer-tag correct-answer">æ­£ç¡®ç­”æ¡ˆ: ${correctAnswer}</span>
                            <span class="result-badge ${resultClass}">${resultText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading-state').style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('history-list').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
            } else {
                document.getElementById('history-list').style.display = 'flex';
            }
        }

        // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
        function showEmpty(show) {
            document.getElementById('empty-state').style.display = show ? 'block' : 'none';
            document.getElementById('history-list').style.display = show ? 'none' : 'flex';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initHistory);
    </script>
</body>
</html>