<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« è¯¾å ‚ä¸­æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        h1 { font-size: 2.5rem; font-weight: 300; margin-bottom: 10px; }
        .subtitle { color: #94a3b8; margin-bottom: 30px; font-size: 1.1rem; }
        
        .main-container {
            display: flex;
            gap: 50px;
            align-items: stretch;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1400px;
            width: 100%;
        }
        
        /* äºŒç»´ç åŒºåŸŸ - æ”¾å¤§ */
        .qr-section {
            background: white;
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            min-width: 380px;
        }
        
        .qr-title { color: #1e293b; font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
        #qr-code { margin: 20px auto; }
        #qr-code img, #qr-code canvas { border-radius: 15px; }
        .qr-url { color: #64748b; font-size: 1rem; margin-top: 15px; word-break: break-all; }
        
        .student-count {
            margin-top: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-radius: 15px;
            color: #1e293b;
        }
        .count-label { font-size: 0.9rem; color: #64748b; }
        .count-number { font-size: 3rem; font-weight: bold; color: #2563eb; }
        
        /* å³ä¾§åŠŸèƒ½åŒº */
        .right-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
            max-width: 500px;
        }
        
        /* åŠŸèƒ½å¡ç‰‡ */
        .card {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 25px 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card.active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
        }
        
        .card-icon { font-size: 2.5rem; }
        .card-content { text-align: left; flex: 1; }
        .card-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 3px; }
        .card-desc { color: #94a3b8; font-size: 0.9rem; }
        
        .card-presentation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .card-presentation:hover { background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); }
        .card-presentation .card-desc { color: rgba(255,255,255,0.8); }
        
        .card-import {
            background: rgba(139, 92, 246, 0.2);
            border: 2px dashed #8b5cf6;
        }
        .card-import:hover { background: rgba(139, 92, 246, 0.3); }
        
        /* åº•éƒ¨æ§åˆ¶ */
        .bottom-controls {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .ctrl-btn {
            padding: 12px 25px;
            font-size: 0.95rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn-release { background: #ef4444; color: white; }
        .btn-release:hover { background: #dc2626; }
        .btn-endclass { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-endclass:hover { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        
        /* å¯¼å…¥æ¨¡æ€æ¡† */
        #import-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 550px;
            color: #333;
            text-align: center;
        }
        
        .modal-title { font-size: 1.5rem; margin-bottom: 10px; }
        .modal-desc { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
        
        .file-drop-area {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 50px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .file-drop-area:hover { border-color: #8b5cf6; background: #f5f3ff; }
        .file-drop-area.dragover { border-color: #8b5cf6; background: #f5f3ff; }
        
        .modal-btns { margin-top: 25px; display: flex; gap: 15px; justify-content: center; }
        .modal-btn {
            padding: 12px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-btn-cancel { background: #e5e7eb; color: #333; }
        .modal-btn-confirm { background: #8b5cf6; color: white; }
        
        input[type=file] { display: none; }
        
        /* çŠ¶æ€æ¡ */
        .status-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 8px;
            background: rgba(0,0,0,0.6);
            text-align: center;
            font-size: 0.85rem;
            z-index: 100;
        }
        .status-active { color: #10b981; }
        .status-idle { color: #94a3b8; }
        
        /* é¢˜åº“ä¿¡æ¯ */
        .question-info {
            margin-top: 10px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            font-size: 0.85rem;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="status-bar">
        å½“å‰çŠ¶æ€ï¼š<span id="current-status" class="status-idle">è‡ªç”±æ´»åŠ¨</span>
    </div>

    <h1>ğŸ“ æ™ºæ…§è¯¾å ‚</h1>
    <p class="subtitle">æ‰«ç è¿›å…¥ Â· å¼€å§‹äº’åŠ¨</p>
    
    <div class="main-container">
        <!-- äºŒç»´ç åŒºåŸŸ -->
        <div class="qr-section">
            <div class="qr-title">ğŸ“± å­¦ç”Ÿæ‰«ç å…¥å£</div>
            <div id="qr-code"></div>
            <div class="qr-url" id="qr-url"></div>
            <div class="student-count">
                <div class="count-label">ä»Šæ—¥ç­¾åˆ°</div>
                <div class="count-number" id="student-count">0</div>
                <div class="count-label">äºº</div>
            </div>
        </div>
        
        <!-- å³ä¾§åŠŸèƒ½åŒº -->
        <div class="right-section">
            <div class="card" id="card-sign" onclick="activateSign()">
                <div class="card-icon">ğŸ“</div>
                <div class="card-content">
                    <div class="card-title">å¼€å§‹ç­¾åˆ°</div>
                    <div class="card-desc">å­¦ç”Ÿæ‰«ç åè‡ªåŠ¨è·³è½¬ç­¾åˆ°é¡µé¢</div>
                </div>
            </div>
            
            <div class="card card-presentation" onclick="openPresentation()">
                <div class="card-icon">ğŸ¬</div>
                <div class="card-content">
                    <div class="card-title">è¯¾ä»¶æ’­æ”¾å™¨</div>
                    <div class="card-desc">PPT + ç­”é¢˜ + å¼¹å¹• + æŠ¢ç­” + ç‚¹å</div>
                </div>
            </div>
            
            <div class="card card-import" onclick="openImportModal()">
                <div class="card-icon">ğŸ“¥</div>
                <div class="card-content">
                    <div class="card-title">å¯¼å…¥é¢˜åº“</div>
                    <div class="card-desc">ä¸Šä¼  Excel æ–‡ä»¶å¯¼å…¥ç­”é¢˜é¢˜ç›®</div>
                </div>
            </div>
            
            <div class="question-info">
                ğŸ“Š å½“å‰é¢˜åº“ï¼š<span id="question-count">0</span> é“é¢˜ç›®
            </div>
        </div>
    </div>
    
    <div class="bottom-controls">
        <button class="ctrl-btn btn-release" onclick="releaseControl()">â¸ï¸ é‡Šæ”¾æ§åˆ¶</button>
        <button class="ctrl-btn btn-secondary" onclick="window.open('/sign-admin')">ğŸ“‹ ç­¾åˆ°ç®¡ç†</button>
        <button class="ctrl-btn btn-secondary" onclick="window.open('/vote-admin')">ğŸ“Š ç­”é¢˜ç®¡ç†</button>
        <button class="ctrl-btn btn-endclass" onclick="endClass()">ğŸ”” ä¸‹è¯¾</button>
    </div>
    
    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="import-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“¥ å¯¼å…¥ Excel é¢˜åº“</div>
            <div class="modal-desc">
                è¯·ä¸Šä¼  .xlsx æ–‡ä»¶ï¼Œè¡¨å¤´éœ€åŒ…å«ï¼šè½®æ¬¡ã€é¢˜ç›®ã€é€‰é¡¹Aã€é€‰é¡¹Bã€é€‰é¡¹Cã€é€‰é¡¹Dã€ç­”æ¡ˆ<br>
                <span style="color:#999; font-size:0.8rem;">ç±»å‹å¯é€‰ï¼šsingle(å•é€‰)ã€multi(å¤šé€‰)ã€judge(åˆ¤æ–­)</span>
            </div>
            
            <label class="file-drop-area" id="drop-area" for="file-input">
                <div style="font-size:3rem; margin-bottom:10px;">ğŸ“„</div>
                <div id="file-name">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(this)">
            </label>
            
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeImportModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="uploadExcel()">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        let selectedFile = null;
        
        // ç”ŸæˆäºŒç»´ç  - æ”¾å¤§åˆ° 280px
        function generateQRCode() {
            const studentUrl = window.location.origin + '/classroom';
            document.getElementById('qr-url').innerText = studentUrl;
            
            const container = document.getElementById('qr-code');
            container.innerHTML = '';
            
            try {
                new QRCode(container, {
                    text: studentUrl,
                    width: 280,
                    height: 280,
                    colorDark: '#1e293b',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (e) {
                console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', e);
                container.innerHTML = `<div style="padding:30px; background:#f1f5f9; border-radius:15px; color:#1e293b;">
                    <p style="margin-bottom:10px; font-size:1.2rem;">ğŸ“± è¯·è®¿é—®:</p>
                    <a href="${studentUrl}" style="color:#2563eb; font-size:1.1rem;">${studentUrl}</a>
                </div>`;
            }
        }
        
        // è·å–ç­¾åˆ°äººæ•°
        async function loadStudentCount() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { count } = await supabaseClient
                    .from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);
                document.getElementById('student-count').innerText = count || 0;
            } catch (e) {
                console.error('è·å–ç­¾åˆ°äººæ•°å¤±è´¥:', e);
            }
        }
        
        // è·å–é¢˜åº“æ•°é‡
        async function loadQuestionCount() {
            try {
                const { count } = await supabaseClient
                    .from('questions')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('question-count').innerText = count || 0;
            } catch (e) {
                console.error('è·å–é¢˜åº“æ•°é‡å¤±è´¥:', e);
            }
        }
        
        // å®æ—¶ç›‘å¬ç­¾åˆ°
        supabaseClient.channel('admin-attendance')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendance' }, loadStudentCount)
            .subscribe();
        
        // æ¿€æ´»ç­¾åˆ°æ¨¡å¼
        async function activateSign() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById('card-sign').classList.add('active');
            document.getElementById('current-status').innerText = 'ç­¾åˆ°è¿›è¡Œä¸­...';
            document.getElementById('current-status').className = 'status-active';
            
            await supabaseClient.from('global_state').update({
                current_page: '/sign',
                status: 'active'
            }).eq('id', 1);
            
            window.open('/sign-admin', '_blank');
        }
        
        function openPresentation() {
            window.open('/presentation', '_blank');
        }
        
        async function releaseControl() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById('current-status').innerText = 'è‡ªç”±æ´»åŠ¨';
            document.getElementById('current-status').className = 'status-idle';
            
            await supabaseClient.from('global_state').update({
                current_page: 'idle',
                status: 'idle'
            }).eq('id', 1);
        }
        
        // ä¸‹è¯¾åŠŸèƒ½ - åˆå§‹åŒ–æ‰€æœ‰çŠ¶æ€
        async function endClass() {
            if (!confirm('âš ï¸ ç¡®å®šè¦ä¸‹è¯¾å—ï¼Ÿ\n\nè¿™å°†ä¼šï¼š\nâ€¢ é‡Šæ”¾å­¦ç”Ÿç«¯æ§åˆ¶\nâ€¢ é‡ç½®ç­”é¢˜è½®æ¬¡\nâ€¢ å…³é—­æŠ¢ç­”åŠŸèƒ½\nâ€¢ æ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•ï¼ˆå¯é€‰ï¼‰')) {
                return;
            }
            
            const clearAttendance = confirm('æ˜¯å¦æ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"æ¸…ç©ºï¼Œç‚¹å‡»"å–æ¶ˆ"ä¿ç•™');
            
            try {
                // 1. é‡Šæ”¾å…¨å±€æ§åˆ¶
                await supabaseClient.from('global_state').update({
                    current_page: 'idle',
                    status: 'idle'
                }).eq('id', 1);
                
                // 2. é‡ç½®ç­”é¢˜é…ç½®
                await supabaseClient.from('vote_config').update({
                    current_round: 1,
                    is_active: false
                }).eq('id', 1);
                
                // 3. å…³é—­æŠ¢ç­”
                await supabaseClient.from('buzzer').update({
                    is_active: false,
                    winner: null
                }).eq('id', 1);
                
                // 4. æ¸…ç©ºä»Šæ—¥ç­”é¢˜è®°å½•
                const today = new Date().toISOString().split('T')[0];
                await supabaseClient.from('vote_logs').delete().gte('created_at', today);
                
                // 5. å¯é€‰ï¼šæ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•
                if (clearAttendance) {
                    await supabaseClient.from('attendance').delete().gte('created_at', today);
                }
                
                // æ›´æ–°ç•Œé¢
                document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
                document.getElementById('current-status').innerText = 'å·²ä¸‹è¯¾';
                document.getElementById('current-status').className = 'status-idle';
                loadStudentCount();
                
                alert('âœ… ä¸‹è¯¾æˆåŠŸï¼æ‰€æœ‰åŠŸèƒ½å·²é‡ç½®ã€‚');
            } catch (err) {
                console.error('ä¸‹è¯¾æ“ä½œå¤±è´¥:', err);
                alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
            }
        }
        
        // ========== é¢˜åº“å¯¼å…¥åŠŸèƒ½ ==========
        function openImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
            document.getElementById('file-name').innerText = 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„';
            selectedFile = null;
        }
        
        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('file-name').innerText = 'âœ… ' + selectedFile.name;
            }
        }
        
        async function uploadExcel() {
            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    const dbData = json.map(row => ({
                        round: row['è½®æ¬¡'],
                        title: row['é¢˜ç›®'],
                        option_a: row['é€‰é¡¹A'] || '',
                        option_b: row['é€‰é¡¹B'] || '',
                        option_c: row['é€‰é¡¹C'] || '',
                        option_d: row['é€‰é¡¹D'] || '',
                        answer: String(row['ç­”æ¡ˆ'] || '').toUpperCase(),
                        type: row['ç±»å‹'] || 'single'
                    }));
                    
                    // æ¸…ç©ºæ—§é¢˜åº“å¹¶å¯¼å…¥æ–°é¢˜åº“
                    await supabaseClient.from('questions').delete().neq('id', 0);
                    const { error } = await supabaseClient.from('questions').insert(dbData);
                    
                    if (error) throw error;
                    
                    alert(`âœ… å¯¼å…¥æˆåŠŸï¼å…± ${dbData.length} é“é¢˜ç›®`);
                    closeImportModal();
                    loadQuestionCount();
                } catch (err) {
                    console.error('å¯¼å…¥å¤±è´¥:', err);
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        }
        
        // æ‹–æ‹½ä¸Šä¼ 
        const dropArea = document.getElementById('drop-area');
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                selectedFile = e.dataTransfer.files[0];
                document.getElementById('file-name').innerText = 'âœ… ' + selectedFile.name;
            }
        });
        
        // åˆå§‹åŒ–
        async function init() {
            generateQRCode();
            loadStudentCount();
            loadQuestionCount();
            
            const { data } = await supabaseClient
                .from('global_state')
                .select('*')
                .eq('id', 1)
                .single();
            
            if (data && data.status === 'active') {
                if (data.current_page.includes('sign')) {
                    document.getElementById('card-sign').classList.add('active');
                }
                document.getElementById('current-status').innerText = 'ç³»ç»Ÿè¿è¡Œä¸­...';
                document.getElementById('current-status').className = 'status-active';
            }
        }
        
        init();
    </script>
</body>
</html>