<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« è¯¾å ‚ä¸­æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; 
            min-height: 100vh;
            padding: 20px;
        }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .top-bar h1 { font-size: 1.5rem; font-weight: 400; }
        .status-badge { 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-size: 0.9rem;
            background: rgba(255,255,255,0.1);
        }
        .status-badge.active { background: rgba(16, 185, 129, 0.3); color: #10b981; }
        .status-badge.idle { background: rgba(148, 163, 184, 0.3); color: #94a3b8; }

        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* äºŒç»´ç å¡ç‰‡ */
        .qr-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            color: #333;
        }
        .qr-card h3 { color: #1e293b; margin-bottom: 15px; font-size: 1.1rem; }
        #qr-code { margin: 0 auto; }
        #qr-code img, #qr-code canvas { border-radius: 10px; }
        .qr-url { color: #64748b; font-size: 0.8rem; margin-top: 10px; word-break: break-all; }
        .student-count {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-radius: 12px;
        }
        .count-number { font-size: 2.5rem; font-weight: bold; color: #2563eb; }
        .count-label { font-size: 0.8rem; color: #64748b; }
        
        /* åŠŸèƒ½æŒ‰é’®ç»„ */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn .icon { font-size: 1.5rem; }
        
        .btn-sign { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-presentation { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-import { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 2px dashed #8b5cf6; }
        .btn-release { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .btn-endclass { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; grid-column: span 2; }

        /* å³ä¾§æ˜¾ç¤ºåŒºåŸŸ */
        .right-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-nav {
            display: flex;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            gap: 10px;
        }
        .tab-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            background: transparent;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); }
        .tab-btn.active { background: #3b82f6; color: white; }
        
        /* æ ‡ç­¾é¡µå†…å®¹ */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .tab-pane { display: none; height: 100%; }
        .tab-pane.active { display: block; }
        
        /* ç­¾åˆ°ç®¡ç†æ ·å¼ */
        .sign-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        .sign-table th, .sign-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sign-table th { background: rgba(0,0,0,0.2); color: #94a3b8; font-size: 0.85rem; }
        .sign-table tr:hover { background: rgba(255,255,255,0.05); }
        
        /* ç­”é¢˜ç®¡ç†æ ·å¼ */
        .vote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .round-display { font-size: 1.8rem; font-weight: bold; color: #3b82f6; }
        .question-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .q-title { font-size: 1.3rem; margin-bottom: 15px; }
        .q-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .q-opt { padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.95rem; }
        .q-opt.correct { background: rgba(16, 185, 129, 0.3); border: 2px solid #10b981; }
        .chart-container { height: 200px; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; }
        .vote-controls { display: flex; gap: 10px; margin-top: 15px; }
        .vote-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .vote-btn.primary { background: #3b82f6; color: white; }
        .vote-btn.warning { background: #f59e0b; color: white; }
        .vote-btn.danger { background: #ef4444; color: white; }

        /* æŠ¢ç­”ç®¡ç†æ ·å¼ */
        .buzzer-display {
            text-align: center;
            padding: 40px;
        }
        .buzzer-status {
            font-size: 4rem;
            font-weight: bold;
            color: #3b82f6;
            margin: 30px 0;
            min-height: 100px;
        }
        .buzzer-controls { display: flex; gap: 15px; justify-content: center; }
        .buzzer-btn {
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        .buzzer-btn:hover { transform: translateY(-3px); }
        .buzzer-btn.start { background: #10b981; color: white; }
        .buzzer-btn.reset { background: #64748b; color: white; }
        
        /* å¯¼å…¥æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            color: #333;
            text-align: center;
        }
        .modal-title { font-size: 1.3rem; margin-bottom: 15px; }
        .file-drop {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 40px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-drop:hover, .file-drop.dragover { border-color: #8b5cf6; background: #f5f3ff; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-btn.cancel { background: #e5e7eb; color: #333; }
        .modal-btn.confirm { background: #8b5cf6; color: white; }
        
        input[type=file] { display: none; }
        
        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tool-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>

<body>
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
        <h1>ğŸ“ æ™ºæ…§è¯¾å ‚ä¸­æ§å°</h1>
        <div class="status-badge idle" id="status-badge">
            <span id="current-status">è‡ªç”±æ´»åŠ¨</span>
        </div>
    </div>
    
    <div class="main-layout">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- äºŒç»´ç  -->
            <div class="qr-card">
                <h3>ğŸ“± å­¦ç”Ÿæ‰«ç å…¥å£</h3>
                <div id="qr-code"></div>
                <div class="qr-url" id="qr-url"></div>
                <div class="student-count">
                    <div class="count-number" id="student-count">0</div>
                    <div class="count-label">ä»Šæ—¥ç­¾åˆ°äººæ•°</div>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰é’® -->
            <div class="action-buttons">
                <button class="action-btn btn-sign" onclick="activateSign()">
                    <span class="icon">ğŸ“</span>
                    <span>å¼€å§‹ç­¾åˆ°</span>
                </button>
                <button class="action-btn btn-presentation" onclick="openPresentation()">
                    <span class="icon">ğŸ¬</span>
                    <span>è¯¾ä»¶æ’­æ”¾</span>
                </button>
                <button class="action-btn btn-import" onclick="openImportModal()">
                    <span class="icon">ğŸ“¥</span>
                    <span>å¯¼å…¥é¢˜åº“</span>
                </button>
                <button class="action-btn btn-release" onclick="releaseControl()">
                    <span class="icon">â¸ï¸</span>
                    <span>é‡Šæ”¾æ§åˆ¶</span>
                </button>
                <button class="action-btn btn-endclass" onclick="endClass()">
                    <span class="icon">ğŸ””</span>
                    <span>ä¸‹è¯¾ Â· é‡ç½®æ‰€æœ‰åŠŸèƒ½</span>
                </button>
            </div>
            
            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; font-size:0.85rem; color:#94a3b8;">
                ğŸ“Š é¢˜åº“ï¼š<span id="question-count">0</span> é“é¢˜ç›®
            </div>
        </div>

        <!-- å³ä¾§æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="right-panel">
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('sign')">ğŸ“‹ ç­¾åˆ°ç®¡ç†</button>
                <button class="tab-btn" onclick="switchTab('vote')">ğŸ“Š ç­”é¢˜ç®¡ç†</button>
                <button class="tab-btn" onclick="switchTab('buzzer')">âš¡ æŠ¢ç­”ç®¡ç†</button>
            </div>
            
            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div class="tab-content">
                <!-- ç­¾åˆ°ç®¡ç† -->
                <div class="tab-pane active" id="tab-sign">
                    <div class="toolbar">
                        <button class="tool-btn" onclick="exportSignExcel()">ğŸ“¥ å¯¼å‡º Excel</button>
                        <button class="tool-btn" onclick="clearSignData()">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
                        <button class="tool-btn" onclick="loadSignData()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <table class="sign-table">
                        <thead>
                            <tr>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>ç­¾åˆ°æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="sign-tbody"></tbody>
                    </table>
                </div>
                
                <!-- ç­”é¢˜ç®¡ç† -->
                <div class="tab-pane" id="tab-vote">
                    <div class="vote-header">
                        <div class="round-display">ç¬¬ <span id="vote-round">1</span> é¢˜</div>
                        <div id="vote-status" style="color:#94a3b8;">å‡†å¤‡ä¸­...</div>
                    </div>
                    <div class="question-card">
                        <div class="q-title" id="q-title">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
                        <div class="q-options" id="q-options"></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="voteChart"></canvas>
                    </div>
                    <div class="vote-controls">
                        <button class="vote-btn warning" onclick="toggleVoteActive()">â¯ï¸ æš‚åœ/å…¬å¸ƒ</button>
                        <button class="vote-btn primary" onclick="prevVoteRound()">â¬…ï¸ ä¸Šä¸€é¢˜</button>
                        <button class="vote-btn primary" onclick="nextVoteRound()">â¡ï¸ ä¸‹ä¸€é¢˜</button>
                        <button class="vote-btn danger" onclick="resetVote()">ğŸ”„ é‡ç½®</button>
                    </div>
                </div>
                
                <!-- æŠ¢ç­”ç®¡ç† -->
                <div class="tab-pane" id="tab-buzzer">
                    <div class="buzzer-display">
                        <h2>ğŸš€ è¯¾å ‚æŠ¢ç­”ç³»ç»Ÿ</h2>
                        <div id="buzzer-indicator" style="margin:15px 0;">
                            <span style="display:inline-block; width:15px; height:15px; border-radius:50%; background:#94a3b8;"></span>
                            <span id="buzzer-status-text" style="color:#94a3b8; margin-left:10px;">ç­‰å¾…å¼€å§‹</span>
                        </div>
                        <div class="buzzer-status" id="buzzer-winner">Ready?</div>
                        <div class="buzzer-controls">
                            <button class="buzzer-btn reset" onclick="resetBuzzer()">ğŸ”„ é‡ç½®</button>
                            <button class="buzzer-btn start" onclick="startBuzzer()">â–¶ï¸ å¼€å§‹æŠ¢ç­”</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="import-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“¥ å¯¼å…¥ Excel é¢˜åº“</div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">
                è¡¨å¤´éœ€åŒ…å«ï¼šè½®æ¬¡ã€é¢˜ç›®ã€é€‰é¡¹Aã€é€‰é¡¹Bã€é€‰é¡¹Cã€é€‰é¡¹Dã€ç­”æ¡ˆ<br>
                <span style="color:#999; font-size:0.8rem;">ç±»å‹å¯é€‰ï¼šsingle(å•é€‰)ã€multi(å¤šé€‰)ã€judge(åˆ¤æ–­)</span>
            </p>
            <label class="file-drop" id="drop-area" for="file-input">
                <div style="font-size:2.5rem; margin-bottom:10px;">ğŸ“„</div>
                <div id="file-name">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <input type="file" id="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(this)">
            </label>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeImportModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="uploadExcel()">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        let selectedFile = null;
        let signData = [];
        let voteRound = 1;
        let isVoteActive = true;
        let currentQuestion = null;
        let voteChart = null;
        
        // ================== åˆå§‹åŒ– ==================
        async function init() {
            generateQRCode();
            loadStudentCount();
            loadQuestionCount();
            loadSignData();
            initVoteChart();
            loadVoteState();
            loadBuzzerState();
            
            // æ£€æŸ¥å…¨å±€çŠ¶æ€
            const { data } = await supabaseClient.from('global_state').select('*').eq('id', 1).single();
            if (data && data.status === 'active') {
                updateStatusBadge('active', 'ç³»ç»Ÿè¿è¡Œä¸­...');
            }
            
            // å®æ—¶ç›‘å¬
            setupRealtimeListeners();
        }
        
        function setupRealtimeListeners() {
            // ç­¾åˆ°ç›‘å¬
            supabaseClient.channel('admin-sign')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendance' }, () => {
                    loadSignData();
                    loadStudentCount();
                })
                .subscribe();
            
            // ç­”é¢˜ç›‘å¬
            supabaseClient.channel('admin-vote-config')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => {
                    updateVoteState(payload.new);
                })
                .subscribe();
            
            supabaseClient.channel('admin-vote-logs')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'vote_logs' }, () => {
                    loadVoteChartData();
                })
                .subscribe();
            
            // æŠ¢ç­”ç›‘å¬
            supabaseClient.channel('admin-buzzer')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'buzzer' }, payload => {
                    updateBuzzerUI(payload.new);
                })
                .subscribe();
        }

        // ================== é€šç”¨åŠŸèƒ½ ==================
        function generateQRCode() {
            const studentUrl = window.location.origin + '/classroom';
            document.getElementById('qr-url').innerText = studentUrl;
            const container = document.getElementById('qr-code');
            container.innerHTML = '';
            try {
                new QRCode(container, {
                    text: studentUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#1e293b',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (e) {
                container.innerHTML = `<div style="padding:20px; color:#666;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</div>`;
            }
        }
        
        async function loadStudentCount() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { count } = await supabaseClient.from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);
                document.getElementById('student-count').innerText = count || 0;
            } catch (e) { console.error(e); }
        }
        
        async function loadQuestionCount() {
            try {
                const { count } = await supabaseClient.from('questions')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('question-count').innerText = count || 0;
            } catch (e) { console.error(e); }
        }
        
        function updateStatusBadge(status, text) {
            const badge = document.getElementById('status-badge');
            const statusText = document.getElementById('current-status');
            badge.className = 'status-badge ' + status;
            statusText.innerText = text;
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        // ================== å·¦ä¾§æŒ‰é’®åŠŸèƒ½ ==================
        async function activateSign() {
            updateStatusBadge('active', 'ç­¾åˆ°è¿›è¡Œä¸­...');
            await supabaseClient.from('global_state').update({
                current_page: '/sign',
                status: 'active'
            }).eq('id', 1);
            switchTab('sign');
        }
        
        function openPresentation() {
            window.open('/presentation', '_blank');
        }
        
        async function releaseControl() {
            updateStatusBadge('idle', 'è‡ªç”±æ´»åŠ¨');
            await supabaseClient.from('global_state').update({
                current_page: 'idle',
                status: 'idle'
            }).eq('id', 1);
        }
        
        async function endClass() {
            if (!confirm('âš ï¸ ç¡®å®šè¦ä¸‹è¯¾å—ï¼Ÿ\n\nè¿™å°†ä¼šï¼š\nâ€¢ é‡Šæ”¾å­¦ç”Ÿç«¯æ§åˆ¶\nâ€¢ é‡ç½®ç­”é¢˜è½®æ¬¡\nâ€¢ å…³é—­æŠ¢ç­”åŠŸèƒ½\nâ€¢ æ¸…ç©ºä»Šæ—¥ç­”é¢˜è®°å½•')) return;
            
            const clearAttendance = confirm('æ˜¯å¦æ¸…ç©ºä»Šæ—¥ç­¾åˆ°è®°å½•ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"æ¸…ç©ºï¼Œç‚¹å‡»"å–æ¶ˆ"ä¿ç•™');
            
            try {
                await supabaseClient.from('global_state').update({ current_page: 'idle', status: 'idle' }).eq('id', 1);
                await supabaseClient.from('vote_config').update({ current_round: 1, is_active: false }).eq('id', 1);
                await supabaseClient.from('buzzer').update({ is_active: false, winner: null }).eq('id', 1);
                
                const today = new Date().toISOString().split('T')[0];
                await supabaseClient.from('vote_logs').delete().gte('created_at', today);
                
                if (clearAttendance) {
                    await supabaseClient.from('attendance').delete().gte('created_at', today);
                }
                
                updateStatusBadge('idle', 'å·²ä¸‹è¯¾');
                loadStudentCount();
                loadSignData();
                loadVoteState();
                
                alert('âœ… ä¸‹è¯¾æˆåŠŸï¼æ‰€æœ‰åŠŸèƒ½å·²é‡ç½®ã€‚');
            } catch (err) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
            }
        }

        // ================== ç­¾åˆ°ç®¡ç† ==================
        async function loadSignData() {
            try {
                const { data } = await supabaseClient.from('attendance')
                    .select('*')
                    .order('created_at', { ascending: false });
                signData = data || [];
                renderSignTable(signData);
            } catch (e) { console.error(e); }
        }
        
        function renderSignTable(data) {
            const tbody = document.getElementById('sign-tbody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#94a3b8; padding:30px;">æš‚æ— ç­¾åˆ°è®°å½•</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(row => `
                <tr>
                    <td>${row.student_id}</td>
                    <td><strong>${row.student_name}</strong></td>
                    <td style="color:#94a3b8; font-size:0.9rem;">${new Date(row.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        function exportSignExcel() {
            if (signData.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
            const excelData = signData.map(row => ({
                'å­¦å·': row.student_id,
                'å§“å': row.student_name,
                'ç­¾åˆ°æ—¶é—´': new Date(row.created_at).toLocaleString()
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç­¾åˆ°è¡¨');
            XLSX.writeFile(wb, `è¯¾å ‚ç­¾åˆ°_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        async function clearSignData() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç­¾åˆ°è®°å½•å—ï¼Ÿ')) return;
            await supabaseClient.from('attendance').delete().neq('id', 0);
            loadSignData();
            loadStudentCount();
            alert('å·²æ¸…ç©ºï¼');
        }
        
        // ================== ç­”é¢˜ç®¡ç† ==================
        function initVoteChart() {
            Chart.register(ChartDataLabels);
            const ctx = document.getElementById('voteChart').getContext('2d');
            voteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { color: 'white', font: { size: 16, weight: 'bold' } }
                    },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 14 } } }
                    }
                }
            });
        }
        
        async function loadVoteState() {
            try {
                const { data } = await supabaseClient.from('vote_config').select('*').eq('id', 1).single();
                if (data) updateVoteState(data);
            } catch (e) { console.error(e); }
        }
        
        async function updateVoteState(config) {
            voteRound = config.current_round;
            isVoteActive = config.is_active;
            document.getElementById('vote-round').innerText = voteRound;
            document.getElementById('vote-status').innerText = isVoteActive ? 'æ­£åœ¨æ¥æ”¶ç­”æ¡ˆ...' : 'â›” å·²åœæ­¢ä½œç­”';
            document.getElementById('vote-status').style.color = isVoteActive ? '#10b981' : '#ef4444';
            await loadQuestion(voteRound);
            await loadVoteChartData();
        }
        
        async function loadQuestion(round) {
            try {
                const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
                currentQuestion = data;
                if (data) {
                    document.getElementById('q-title').innerText = `${round}. ${data.title}`;
                    const opts = document.getElementById('q-options');
                    opts.innerHTML = `
                        <div class="q-opt ${!isVoteActive && data.answer.includes('A') ? 'correct' : ''}" id="opt-A">A. ${data.option_a || ''}</div>
                        <div class="q-opt ${!isVoteActive && data.answer.includes('B') ? 'correct' : ''}" id="opt-B">B. ${data.option_b || ''}</div>
                        <div class="q-opt ${!isVoteActive && data.answer.includes('C') ? 'correct' : ''}" id="opt-C">C. ${data.option_c || ''}</div>
                        <div class="q-opt ${!isVoteActive && data.answer.includes('D') ? 'correct' : ''}" id="opt-D">D. ${data.option_d || ''}</div>
                    `;
                } else {
                    document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜ (æ— æ•°æ®)`;
                    document.getElementById('q-options').innerHTML = '';
                }
            } catch (e) { console.error(e); }
        }

        async function loadVoteChartData() {
            try {
                const { data } = await supabaseClient.from('vote_logs').select('option').eq('round', voteRound);
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                if (data) data.forEach(row => { if (counts[row.option] !== undefined) counts[row.option]++; });
                voteChart.data.datasets[0].data = [counts.A, counts.B, counts.C, counts.D];
                
                if (!isVoteActive && currentQuestion) {
                    const colors = ['A', 'B', 'C', 'D'].map(opt => 
                        currentQuestion.answer.includes(opt) ? '#10b981' : '#ef4444'
                    );
                    voteChart.data.datasets[0].backgroundColor = colors;
                } else {
                    voteChart.data.datasets[0].backgroundColor = ['#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'];
                }
                voteChart.update();
            } catch (e) { console.error(e); }
        }
        
        async function toggleVoteActive() {
            await supabaseClient.from('vote_config').update({ is_active: !isVoteActive }).eq('id', 1);
        }
        
        async function prevVoteRound() {
            if (voteRound <= 1) return;
            await supabaseClient.from('vote_config').update({ current_round: voteRound - 1, is_active: true }).eq('id', 1);
        }
        
        async function nextVoteRound() {
            await supabaseClient.from('vote_config').update({ current_round: voteRound + 1, is_active: true }).eq('id', 1);
        }
        
        async function resetVote() {
            if (!confirm('é‡ç½®æ‰€æœ‰ç­”é¢˜æ•°æ®ï¼Ÿ')) return;
            await supabaseClient.from('vote_logs').delete().neq('id', 0);
            await supabaseClient.from('vote_config').update({ current_round: 1, is_active: true }).eq('id', 1);
        }
        
        // ================== æŠ¢ç­”ç®¡ç† ==================
        async function loadBuzzerState() {
            try {
                const { data } = await supabaseClient.from('buzzer').select('*').eq('id', 1).single();
                if (data) updateBuzzerUI(data);
            } catch (e) { console.error(e); }
        }
        
        function updateBuzzerUI(data) {
            const winner = document.getElementById('buzzer-winner');
            const indicator = document.getElementById('buzzer-indicator').querySelector('span');
            const statusText = document.getElementById('buzzer-status-text');
            
            if (data.winner) {
                winner.innerText = data.winner + ' ğŸ†';
                winner.style.color = '#3b82f6';
                indicator.style.background = '#94a3b8';
                statusText.innerText = 'æŠ¢ç­”ç»“æŸ';
                triggerConfetti();
            } else if (data.is_active) {
                winner.innerText = 'GO!!!';
                winner.style.color = '#ef4444';
                indicator.style.background = '#10b981';
                statusText.innerText = 'æ­£åœ¨è¿›è¡Œ';
            } else {
                winner.innerText = 'Ready?';
                winner.style.color = '#3b82f6';
                indicator.style.background = '#94a3b8';
                statusText.innerText = 'ç­‰å¾…å¼€å§‹';
            }
        }
        
        async function resetBuzzer() {
            document.getElementById('buzzer-winner').innerText = 'Ready?';
            await supabaseClient.from('buzzer').update({ is_active: false, winner: null }).eq('id', 1);
        }
        
        async function startBuzzer() {
            // æ›´æ–°å…¨å±€çŠ¶æ€è®©å­¦ç”Ÿè·³è½¬
            await supabaseClient.from('global_state').update({ status: 'active', current_page: 'buzzer.html' }).eq('id', 1);
            updateStatusBadge('active', 'æŠ¢ç­”è¿›è¡Œä¸­...');
            
            // å€’è®¡æ—¶
            const winner = document.getElementById('buzzer-winner');
            for (let i = 3; i >= 1; i--) {
                winner.innerText = i;
                winner.style.color = '#ef4444';
                await new Promise(r => setTimeout(r, 800));
            }
            winner.innerText = 'GO!!!';
            
            // å¯åŠ¨æŠ¢ç­”
            await supabaseClient.from('buzzer').update({ is_active: true, winner: null }).eq('id', 1);
        }
        
        function triggerConfetti() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // ================== é¢˜åº“å¯¼å…¥ ==================
        function openImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').style.display = 'none';
            document.getElementById('file-name').innerText = 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„';
            selectedFile = null;
        }
        
        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('file-name').innerText = 'âœ… ' + selectedFile.name;
            }
        }
        
        async function uploadExcel() {
            if (!selectedFile) return alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    const dbData = json.map(row => ({
                        round: row['è½®æ¬¡'],
                        title: row['é¢˜ç›®'],
                        option_a: row['é€‰é¡¹A'] || '',
                        option_b: row['é€‰é¡¹B'] || '',
                        option_c: row['é€‰é¡¹C'] || '',
                        option_d: row['é€‰é¡¹D'] || '',
                        answer: String(row['ç­”æ¡ˆ'] || '').toUpperCase(),
                        type: row['ç±»å‹'] || 'single'
                    }));
                    
                    await supabaseClient.from('questions').delete().neq('id', 0);
                    const { error } = await supabaseClient.from('questions').insert(dbData);
                    if (error) throw error;
                    
                    alert(`âœ… å¯¼å…¥æˆåŠŸï¼å…± ${dbData.length} é“é¢˜ç›®`);
                    closeImportModal();
                    loadQuestionCount();
                    loadVoteState();
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        }
        
        // æ‹–æ‹½ä¸Šä¼ 
        const dropArea = document.getElementById('drop-area');
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
        dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('dragover'); });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                selectedFile = e.dataTransfer.files[0];
                document.getElementById('file-name').innerText = 'âœ… ' + selectedFile.name;
            }
        });
        
        // å¯åŠ¨
        init();
    </script>
</body>
</html>