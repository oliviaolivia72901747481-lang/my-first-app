<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« è¯¾å ‚ä¸­æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; 
            min-height: 100vh;
            padding: 20px;
        }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .top-bar h1 { font-size: 1.5rem; font-weight: 400; }
        .status-badge { 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-size: 0.9rem;
            background: rgba(255,255,255,0.1);
        }
        .status-badge.active { background: rgba(16, 185, 129, 0.3); color: #10b981; }
        .status-badge.idle { background: rgba(148, 163, 184, 0.3); color: #94a3b8; }

        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* äºŒç»´ç å¡ç‰‡ */
        .qr-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            color: #333;
        }
        .qr-card h3 { color: #1e293b; margin-bottom: 15px; font-size: 1.1rem; }
        #qr-code { margin: 0 auto; }
        #qr-code img, #qr-code canvas { border-radius: 10px; }
        .qr-url { color: #64748b; font-size: 0.8rem; margin-top: 10px; word-break: break-all; }
        .student-count {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-radius: 12px;
        }
        .count-number { font-size: 2.5rem; font-weight: bold; color: #2563eb; }
        .count-label { font-size: 0.8rem; color: #64748b; }
        
        /* åŠŸèƒ½æŒ‰é’®ç»„ */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn .icon { font-size: 1.5rem; }
        
        .btn-sign { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-presentation { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-import { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 2px dashed #8b5cf6; }
        .btn-release { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .btn-sandbox { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
        .btn-endclass { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; grid-column: span 2; }

        /* å³ä¾§æ˜¾ç¤ºåŒºåŸŸ */
        .right-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-nav {
            display: flex;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            gap: 10px;
        }
        .tab-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            background: transparent;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); }
        .tab-btn.active { background: #3b82f6; color: white; }
        
        /* æ ‡ç­¾é¡µå†…å®¹ */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .tab-pane { display: none; height: 100%; }
        .tab-pane.active { display: block; }
        
        /* ç­¾åˆ°ç®¡ç†æ ·å¼ */
        .sign-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        .sign-table th, .sign-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sign-table th { background: rgba(0,0,0,0.2); color: #94a3b8; font-size: 0.85rem; }
        .sign-table tr:hover { background: rgba(255,255,255,0.05); }
        
        /* ç­”é¢˜ç®¡ç†æ ·å¼ */
        .vote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .round-display { font-size: 1.8rem; font-weight: bold; color: #3b82f6; }
        .question-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .q-title { font-size: 1.3rem; margin-bottom: 15px; }
        .q-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .q-opt { padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.95rem; }
        .q-opt.correct { background: rgba(16, 185, 129, 0.3); border: 2px solid #10b981; }
        .chart-container { height: 200px; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; }
        .vote-controls { display: flex; gap: 10px; margin-top: 15px; }
        .vote-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .vote-btn.primary { background: #3b82f6; color: white; }
        .vote-btn.warning { background: #f59e0b; color: white; }
        .vote-btn.danger { background: #ef4444; color: white; }
        
        /* æ¨¡å¼é€‰æ‹©æŒ‰é’® */
        .mode-btn {
            padding: 10px 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .mode-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .mode-btn.active[data-mode="vote"] { background: #3b82f6; color: white; border-color: #3b82f6; }
        .mode-btn.active[data-mode="buzzer"] { background: #ef4444; color: white; border-color: #ef4444; }
        .mode-btn.active[data-mode="lucky"] { background: #f59e0b; color: white; border-color: #f59e0b; }

        /* æŠ¢ç­”ç®¡ç†æ ·å¼ */
        .buzzer-display {
            text-align: center;
            padding: 40px;
        }
        .buzzer-status {
            font-size: 4rem;
            font-weight: bold;
            color: #3b82f6;
            margin: 30px 0;
            min-height: 100px;
        }
        .buzzer-controls { display: flex; gap: 15px; justify-content: center; }
        .buzzer-btn {
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        .buzzer-btn:hover { transform: translateY(-3px); }
        .buzzer-btn.start { background: #10b981; color: white; }
        .buzzer-btn.reset { background: #64748b; color: white; }
        
        /* å¯¼å…¥æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            color: #333;
            text-align: center;
        }
        .modal-title { font-size: 1.3rem; margin-bottom: 15px; }
        .file-drop {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 40px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-drop:hover, .file-drop.dragover { border-color: #8b5cf6; background: #f5f3ff; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-btn.cancel { background: #e5e7eb; color: #333; }
        .modal-btn.confirm { background: #8b5cf6; color: white; }
        
        input[type=file] { display: none; }
        
        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tool-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-card h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: white;
        }
        .login-card p {
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }
        .login-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            outline: none;
            transition: all 0.3s;
        }
        .login-input:focus {
            border-color: #3b82f6;
            background: rgba(255,255,255,0.15);
        }
        .login-input::placeholder {
            color: #64748b;
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        .login-error {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 15px;
            display: none;
        }
        .admin-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
        }
        .admin-info:hover {
            background: rgba(255,255,255,0.15);
        }
        .admin-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .admin-name {
            font-size: 0.9rem;
            color: white;
        }
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: none;
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>

<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-overlay" id="login-overlay">
        <div class="login-card">
            <div style="font-size:4rem; margin-bottom:20px;">ğŸ”</div>
            <h2>æ™ºæ…§è¯¾å ‚ä¸­æ§å°</h2>
            <p>è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ç™»å½•</p>
            <input type="password" class="login-input" id="admin-password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " onkeypress="if(event.key==='Enter')doLogin()">
            <button class="login-btn" onclick="doLogin()">ğŸš€ ç™»å½•</button>
            <div class="login-error" id="login-error">âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
            <div style="margin-top:30px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
                <p style="color:#64748b; font-size:0.8rem; margin-bottom:10px;">é»˜è®¤å¯†ç ï¼šadmin123</p>
                <button onclick="openPasswordSettings()" style="background:transparent; border:1px solid rgba(255,255,255,0.2); color:#94a3b8; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:0.85rem;">âš™ï¸ ä¿®æ”¹å¯†ç </button>
            </div>
        </div>
    </div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
        <h1>ğŸ“ æ™ºæ…§è¯¾å ‚ä¸­æ§å°</h1>
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="status-badge idle" id="status-badge">
                <span id="current-status">è‡ªç”±æ´»åŠ¨</span>
            </div>
            <div class="admin-info" id="admin-info" style="display:none;">
                <div class="admin-avatar">ğŸ‘¨â€ğŸ«</div>
                <span class="admin-name" id="admin-name">ç®¡ç†å‘˜</span>
                <button class="logout-btn" onclick="doLogout()">é€€å‡º</button>
            </div>
        </div>
    </div>
    
    <div class="main-layout">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- äºŒç»´ç  -->
            <div class="qr-card">
                <h3>ğŸ“± å­¦ç”Ÿæ‰«ç å…¥å£</h3>
                <div id="qr-code"></div>
                <div class="qr-url" id="qr-url"></div>
                <div class="student-count">
                    <div class="count-number" id="student-count">0</div>
                    <div class="count-label">ä»Šæ—¥ç­¾åˆ°äººæ•°</div>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰é’® -->
            <div class="action-buttons">
                <button class="action-btn btn-sign" onclick="activateSign()">
                    <span class="icon">ğŸ“</span>
                    <span>å¼€å§‹ç­¾åˆ°</span>
                </button>
                <button class="action-btn btn-presentation" onclick="openPresentation()">
                    <span class="icon">ğŸ¬</span>
                    <span>è¯¾ä»¶æ’­æ”¾</span>
                </button>
                <button class="action-btn btn-import" onclick="openQuestionBank()">
                    <span class="icon">ğŸ“</span>
                    <span>é¢˜åº“ç®¡ç†</span>
                </button>
                <button class="action-btn btn-sandbox" onclick="openSamplingSandbox()">
                    <span class="icon">ğŸ¯</span>
                    <span>é‡‡æ ·æ²™ç›˜</span>
                </button>
                <button class="action-btn btn-release" onclick="releaseControl()">
                    <span class="icon">â¸ï¸</span>
                    <span>é‡Šæ”¾æ§åˆ¶</span>
                </button>
                <button class="action-btn btn-endclass" onclick="endClass()">
                    <span class="icon">ğŸ””</span>
                    <span>ä¸‹è¯¾ Â· é‡ç½®æ‰€æœ‰åŠŸèƒ½</span>
                </button>
            </div>
            
            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; font-size:0.85rem; color:#94a3b8;">
                ğŸ“Š é¢˜åº“ï¼š<span id="question-count">0</span> é“é¢˜ç›®
            </div>
        </div>

        <!-- å³ä¾§æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="right-panel">
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('sign')">ğŸ“‹ ç­¾åˆ°ç®¡ç†</button>
                <button class="tab-btn" onclick="switchTab('result')">ğŸ“Š å®æ—¶ç»“æœ</button>
            </div>
            
            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div class="tab-content">
                <!-- ç­¾åˆ°ç®¡ç† -->
                <div class="tab-pane active" id="tab-sign">
                    <div class="toolbar">
                        <button class="tool-btn" onclick="exportSignExcel()">ğŸ“¥ å¯¼å‡º Excel</button>
                        <button class="tool-btn" onclick="clearSignData()">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
                        <button class="tool-btn" onclick="loadSignData()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <table class="sign-table">
                        <thead>
                            <tr>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>ç­¾åˆ°æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="sign-tbody"></tbody>
                    </table>
                </div>
                
                <!-- å®æ—¶ç»“æœ -->
                <div class="tab-pane" id="tab-result">
                    <div style="text-align:center; padding:20px;">
                        <p style="color:#94a3b8; margin-bottom:20px;">ğŸ“º å®æ—¶æ˜¾ç¤ºè¯¾ä»¶æ’­æ”¾å™¨ä¸­çš„äº’åŠ¨ç»“æœ</p>
                    </div>
                    
                    <!-- å½“å‰é¢˜ç›® -->
                    <div class="question-card">
                        <div class="vote-header" style="margin-bottom:15px;">
                            <div class="round-display">ç¬¬ <span id="vote-round">1</span> é¢˜</div>
                            <div id="vote-status" style="color:#94a3b8;">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div class="q-title" id="q-title">ç­‰å¾…è¯¾ä»¶æ’­æ”¾å™¨å¼€å§‹äº’åŠ¨...</div>
                        <div class="q-options" id="q-options"></div>
                    </div>
                    
                    <!-- ç­”é¢˜ç»Ÿè®¡ -->
                    <div class="chart-container" id="chart-container">
                        <canvas id="voteChart"></canvas>
                    </div>
                    
                    <!-- æŠ¢ç­”ç»“æœ -->
                    <div id="buzzer-result-card" style="background:rgba(255,255,255,0.1); border-radius:15px; padding:20px; margin-top:15px; text-align:center; display:none;">
                        <div style="font-size:0.9rem; color:#94a3b8; margin-bottom:10px;">âš¡ æŠ¢ç­”ç»“æœ</div>
                        <div id="buzzer-winner" style="font-size:2.5rem; font-weight:bold; color:#10b981;">ç­‰å¾…ä¸­...</div>
                    </div>
                    
                    <!-- å·¥å…·æ  -->
                    <div class="toolbar" style="margin-top:15px;">
                        <button class="tool-btn" onclick="exportVoteExcel()">ğŸ“¥ å¯¼å‡ºç­”é¢˜æŠ¥å‘Š</button>
                        <button class="tool-btn" onclick="resetVote()">ğŸ”„ é‡ç½®ç­”é¢˜æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        let signData = [];
        let voteRound = 1;
        let isVoteActive = true;
        let currentQuestion = null;
        let voteChart = null;
        let isLoggedIn = false;
        
        // ================== ç®¡ç†å‘˜ç™»å½•åŠŸèƒ½ ==================
        const DEFAULT_PASSWORD = 'admin123';
        const PASSWORD_KEY = 'classroom_admin_password';
        const LOGIN_KEY = 'classroom_admin_logged_in';
        const LOGIN_EXPIRY_KEY = 'classroom_admin_login_expiry';
        
        function getAdminPassword() {
            return localStorage.getItem(PASSWORD_KEY) || DEFAULT_PASSWORD;
        }
        
        function setAdminPassword(newPassword) {
            localStorage.setItem(PASSWORD_KEY, newPassword);
        }
        
        function checkLoginStatus() {
            const loggedIn = sessionStorage.getItem(LOGIN_KEY);
            const expiry = sessionStorage.getItem(LOGIN_EXPIRY_KEY);
            
            if (loggedIn === 'true' && expiry) {
                const expiryTime = parseInt(expiry);
                if (Date.now() < expiryTime) {
                    return true;
                }
            }
            return false;
        }
        
        function doLogin() {
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('login-error');
            
            if (password === getAdminPassword()) {
                // ç™»å½•æˆåŠŸï¼Œè®¾ç½®4å°æ—¶è¿‡æœŸ
                sessionStorage.setItem(LOGIN_KEY, 'true');
                sessionStorage.setItem(LOGIN_EXPIRY_KEY, (Date.now() + 4 * 60 * 60 * 1000).toString());
                isLoggedIn = true;
                
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-info').style.display = 'flex';
                errorEl.style.display = 'none';
                
                // åˆå§‹åŒ–ä¸»ç•Œé¢
                initMainInterface();
            } else {
                errorEl.style.display = 'block';
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password').focus();
            }
        }
        
        function doLogout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
            
            sessionStorage.removeItem(LOGIN_KEY);
            sessionStorage.removeItem(LOGIN_EXPIRY_KEY);
            isLoggedIn = false;
            
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('admin-info').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }
        
        function openPasswordSettings() {
            const currentPwd = prompt('è¯·è¾“å…¥å½“å‰å¯†ç ï¼š');
            if (currentPwd !== getAdminPassword()) {
                alert('âŒ å½“å‰å¯†ç é”™è¯¯');
                return;
            }
            
            const newPwd = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š');
            if (!newPwd || newPwd.length < 6) {
                alert('âŒ å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            
            const confirmPwd = prompt('è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ï¼š');
            if (newPwd !== confirmPwd) {
                alert('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            setAdminPassword(newPwd);
            alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼');
        }
        
        // ================== åˆå§‹åŒ– ==================
        function init() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (checkLoginStatus()) {
                isLoggedIn = true;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-info').style.display = 'flex';
                initMainInterface();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('admin-password').focus();
            }
        }
        
        async function initMainInterface() {
            generateQRCode();
            loadStudentCount();
            loadQuestionCount();
            loadSignData();
            initVoteChart();
            loadVoteState();
            loadBuzzerState();
            
            // æ£€æŸ¥å…¨å±€çŠ¶æ€
            try {
                const { data } = await supabaseClient.from('global_state').select('*').eq('id', 1).single();
                if (data && data.status === 'active') {
                    updateStatusBadge('active', 'ç³»ç»Ÿè¿è¡Œä¸­...');
                }
            } catch (e) {
                console.error('åŠ è½½å…¨å±€çŠ¶æ€å¤±è´¥:', e);
            }
            
            // å®æ—¶ç›‘å¬
            setupRealtimeListeners();
        }
        
        function setupRealtimeListeners() {
            // ç­¾åˆ°ç›‘å¬
            supabaseClient.channel('admin-sign')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendance' }, () => {
                    loadSignData();
                    loadStudentCount();
                })
                .subscribe();
            
            // ç­”é¢˜ç›‘å¬
            supabaseClient.channel('admin-vote-config')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => {
                    updateVoteState(payload.new);
                })
                .subscribe();
            
            supabaseClient.channel('admin-vote-logs')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'vote_logs' }, () => {
                    loadVoteChartData();
                })
                .subscribe();
            
            // æŠ¢ç­”ç›‘å¬
            supabaseClient.channel('admin-buzzer')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'buzzer' }, payload => {
                    updateBuzzerUI(payload.new);
                })
                .subscribe();
        }

        // ================== é€šç”¨åŠŸèƒ½ ==================
        function generateQRCode() {
            const studentUrl = window.location.origin + '/classroom';
            document.getElementById('qr-url').innerText = studentUrl;
            const container = document.getElementById('qr-code');
            container.innerHTML = '';
            try {
                new QRCode(container, {
                    text: studentUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#1e293b',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (e) {
                container.innerHTML = `<div style="padding:20px; color:#666;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</div>`;
            }
        }
        
        async function loadStudentCount() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { count } = await supabaseClient.from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);
                document.getElementById('student-count').innerText = count || 0;
            } catch (e) { console.error(e); }
        }
        
        async function loadQuestionCount() {
            try {
                const { count } = await supabaseClient.from('questions')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('question-count').innerText = count || 0;
            } catch (e) { console.error(e); }
        }
        
        function updateStatusBadge(status, text) {
            const badge = document.getElementById('status-badge');
            const statusText = document.getElementById('current-status');
            badge.className = 'status-badge ' + status;
            statusText.innerText = text;
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        // ================== å·¦ä¾§æŒ‰é’®åŠŸèƒ½ ==================
        async function activateSign() {
            updateStatusBadge('active', 'ç­¾åˆ°è¿›è¡Œä¸­...');
            await supabaseClient.from('global_state').update({
                current_page: '/sign',
                status: 'active'
            }).eq('id', 1);
            switchTab('sign');
        }
        
        function openPresentation() {
            window.open('/classroom/presentation.html', '_blank');
        }
        
        function openQuestionBank() {
            window.open('/classroom/questionbank.html', '_blank', 'width=1400,height=900');
        }
        
        function openSamplingSandbox() {
            window.open('/classroom/sampling-sandbox.html?mode=demo', '_blank');
        }
        
        async function releaseControl() {
            updateStatusBadge('idle', 'è‡ªç”±æ´»åŠ¨');
            await supabaseClient.from('global_state').update({
                current_page: 'idle',
                status: 'idle'
            }).eq('id', 1);
        }
        
        async function endClass() {
            // æ˜¾ç¤ºä¸‹è¯¾ç¡®è®¤å¼¹çª—
            showEndClassModal();
        }
        
        function showEndClassModal() {
            // åˆ›å»ºä¸‹è¯¾å¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'end-class-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:2000;';
            modal.innerHTML = `
                <div style="background:white; border-radius:20px; padding:30px; width:90%; max-width:500px; color:#333; text-align:center;">
                    <h2 style="margin-bottom:20px; color:#ef4444;">ğŸ”” ä¸‹è¯¾ç¡®è®¤</h2>
                    <p style="color:#666; margin-bottom:15px;">ä¸‹è¯¾å°†é‡ç½®æ‰€æœ‰äº’åŠ¨åŠŸèƒ½</p>
                    
                    <div style="background:#f8fafc; border-radius:10px; padding:15px; margin-bottom:20px; text-align:left;">
                        <div style="font-weight:bold; margin-bottom:10px;">ğŸ“Š æœ¬èŠ‚è¯¾æ•°æ®ç»Ÿè®¡</div>
                        <div id="end-class-stats" style="font-size:0.9rem; color:#666;">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <button onclick="doEndClass()" style="padding:15px; background:linear-gradient(135deg, #ef4444, #dc2626); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1rem;">
                            ğŸ”” ç¡®è®¤ä¸‹è¯¾
                        </button>
                        <button onclick="openPresentationForEndClass()" style="padding:15px; background:linear-gradient(135deg, #3b82f6, #8b5cf6); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1rem;">
                            ğŸ“¦ å­˜æ¡£å¹¶ä¸‹è¯¾ï¼ˆæ¨èï¼‰
                        </button>
                        <button onclick="closeEndClassModal()" style="padding:12px; background:#e5e7eb; color:#333; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">
                            å–æ¶ˆ
                        </button>
                    </div>
                    <p style="color:#999; font-size:0.8rem; margin-top:15px;">ğŸ’¡ "å­˜æ¡£å¹¶ä¸‹è¯¾"ä¼šæ‰“å¼€è¯¾ä»¶æ’­æ”¾å™¨è¿›è¡Œæ•°æ®å­˜æ¡£</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // åŠ è½½ç»Ÿè®¡æ•°æ®
            loadEndClassStats();
        }
        
        async function loadEndClassStats() {
            const statsDiv = document.getElementById('end-class-stats');
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const { data: attendance } = await supabaseClient.from('attendance').select('id').gte('created_at', today);
                const attendanceCount = attendance?.length || 0;
                
                const { data: voteLogs } = await supabaseClient.from('vote_logs').select('is_correct').gte('created_at', today);
                const answerCount = voteLogs?.length || 0;
                const correctCount = voteLogs?.filter(v => v.is_correct).length || 0;
                
                statsDiv.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div>ğŸ‘¥ ç­¾åˆ°äººæ•°ï¼š<strong>${attendanceCount}</strong> äºº</div>
                        <div>ğŸ“ ç­”é¢˜æ¬¡æ•°ï¼š<strong>${answerCount}</strong> æ¬¡</div>
                        <div>âœ… æ­£ç¡®ç‡ï¼š<strong>${answerCount > 0 ? Math.round(correctCount/answerCount*100) : 0}%</strong></div>
                    </div>
                `;
            } catch (e) {
                statsDiv.innerHTML = '<div style="color:#ef4444;">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        function closeEndClassModal() {
            const modal = document.getElementById('end-class-modal');
            if (modal) modal.remove();
        }
        
        function openPresentationForEndClass() {
            closeEndClassModal();
            // æ‰“å¼€è¯¾ä»¶æ’­æ”¾å™¨ï¼Œç”¨æˆ·å¯ä»¥åœ¨é‚£é‡Œè¿›è¡Œå­˜æ¡£å’Œä¸‹è¯¾
            window.open('/classroom/presentation.html', '_blank');
            alert('ğŸ’¡ è¯·åœ¨è¯¾ä»¶æ’­æ”¾å™¨ä¸­ç‚¹å‡»"ä¸‹è¯¾"æŒ‰é’®è¿›è¡Œæ•°æ®å­˜æ¡£');
        }
        
        async function doEndClass() {
            try {
                await supabaseClient.from('global_state').update({ current_page: 'idle', status: 'idle' }).eq('id', 1);
                await supabaseClient.from('vote_config').update({ current_round: 1, is_active: false }).eq('id', 1);
                await supabaseClient.from('buzzer').update({ is_active: false, winner: null }).eq('id', 1);
                
                const today = new Date().toISOString().split('T')[0];
                await supabaseClient.from('vote_logs').delete().gte('created_at', today);
                
                updateStatusBadge('idle', 'å·²ä¸‹è¯¾');
                loadStudentCount();
                loadSignData();
                loadVoteState();
                
                closeEndClassModal();
                alert('âœ… ä¸‹è¯¾æˆåŠŸï¼æ‰€æœ‰åŠŸèƒ½å·²é‡ç½®ã€‚\n\nâš ï¸ æ³¨æ„ï¼šæ•°æ®æœªå­˜æ¡£ï¼Œå¦‚éœ€å­˜æ¡£è¯·ä½¿ç”¨è¯¾ä»¶æ’­æ”¾å™¨çš„ä¸‹è¯¾åŠŸèƒ½');
            } catch (err) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
            }
        }

        // ================== ç­¾åˆ°ç®¡ç† ==================
        async function loadSignData() {
            try {
                const { data } = await supabaseClient.from('attendance')
                    .select('*')
                    .order('created_at', { ascending: false });
                signData = data || [];
                renderSignTable(signData);
            } catch (e) { console.error(e); }
        }
        
        function renderSignTable(data) {
            const tbody = document.getElementById('sign-tbody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#94a3b8; padding:30px;">æš‚æ— ç­¾åˆ°è®°å½•</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(row => `
                <tr>
                    <td>${row.student_id}</td>
                    <td><strong>${row.student_name}</strong></td>
                    <td style="color:#94a3b8; font-size:0.9rem;">${new Date(row.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        function exportSignExcel() {
            if (signData.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
            const excelData = signData.map(row => ({
                'å­¦å·': row.student_id,
                'å§“å': row.student_name,
                'ç­¾åˆ°æ—¶é—´': new Date(row.created_at).toLocaleString()
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç­¾åˆ°è¡¨');
            XLSX.writeFile(wb, `è¯¾å ‚ç­¾åˆ°_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        async function clearSignData() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç­¾åˆ°è®°å½•å—ï¼Ÿ')) return;
            await supabaseClient.from('attendance').delete().neq('id', 0);
            loadSignData();
            loadStudentCount();
            alert('å·²æ¸…ç©ºï¼');
        }
        
        // ================== ç­”é¢˜ç®¡ç† ==================
        function initVoteChart() {
            Chart.register(ChartDataLabels);
            const ctx = document.getElementById('voteChart').getContext('2d');
            voteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { color: 'white', font: { size: 16, weight: 'bold' } }
                    },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 14 } } }
                    }
                }
            });
        }
        
        async function loadVoteState() {
            try {
                const { data } = await supabaseClient.from('vote_config').select('*').eq('id', 1).single();
                if (data) updateVoteState(data);
            } catch (e) { console.error(e); }
        }
        
        async function updateVoteState(config) {
            voteRound = config.current_round;
            isVoteActive = config.is_active;
            document.getElementById('vote-round').innerText = voteRound;
            document.getElementById('vote-status').innerText = isVoteActive ? 'æ­£åœ¨æ¥æ”¶ç­”æ¡ˆ...' : 'â›” å·²åœæ­¢ä½œç­”';
            document.getElementById('vote-status').style.color = isVoteActive ? '#10b981' : '#ef4444';
            await loadQuestion(voteRound);
            await loadVoteChartData();
        }
        
        async function loadQuestion(round) {
            try {
                const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
                currentQuestion = data;
                if (data) {
                    document.getElementById('q-title').innerText = `${round}. ${data.title}`;
                    const opts = document.getElementById('q-options');
                    opts.innerHTML = `
                        <div class="q-opt ${!isVoteActive && data.answer.includes('A') ? 'correct' : ''}" id="opt-A">A. ${data.option_a || ''}</div>
                        <div class="q-opt ${!isVoteActive && data.answer.includes('B') ? 'correct' : ''}" id="opt-B">B. ${data.option_b || ''}</div>
                        <div class="q-opt ${!isVoteActive && data.answer.includes('C') ? 'correct' : ''}" id="opt-C">C. ${data.option_c || ''}</div>
                        <div class="q-opt ${!isVoteActive && data.answer.includes('D') ? 'correct' : ''}" id="opt-D">D. ${data.option_d || ''}</div>
                    `;
                    // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
                    updateModeDisplay(data.mode || 'vote');
                } else {
                    document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜ (æ— æ•°æ®)`;
                    document.getElementById('q-options').innerHTML = '';
                    updateModeDisplay('vote');
                }
            } catch (e) { console.error(e); }
        }
        
        // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
        function updateModeDisplay(mode) {
            // æ ¹æ®æ¨¡å¼æ˜¾ç¤º/éšè—ç›¸å…³åŒºåŸŸ
            const chartContainer = document.getElementById('chart-container');
            const buzzerCard = document.getElementById('buzzer-result-card');
            
            if (mode === 'vote') {
                chartContainer.style.display = 'block';
                buzzerCard.style.display = 'none';
            } else if (mode === 'buzzer') {
                chartContainer.style.display = 'none';
                buzzerCard.style.display = 'block';
            } else {
                chartContainer.style.display = 'none';
                buzzerCard.style.display = 'none';
            }
        }
        
        // å¯¼å‡ºç­”é¢˜æŠ¥å‘Š
        async function exportVoteExcel() {
            try {
                const { data: students } = await supabaseClient.from('attendance').select('student_name, student_id');
                const { data: logs } = await supabaseClient.from('vote_logs').select('*');
                
                if (!logs || logs.length === 0) {
                    alert('æš‚æ— ç­”é¢˜æ•°æ®');
                    return;
                }
                
                const reportData = logs.map(log => ({
                    'é¢˜ç›®è½®æ¬¡': `ç¬¬ ${log.round} é¢˜`,
                    'å­¦å·': log.student_id,
                    'å§“å': log.student_name,
                    'é€‰æ‹©': log.option,
                    'æ­£è¯¯': log.is_correct ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯',
                    'æ—¶é—´': new Date(log.created_at).toLocaleString()
                }));
                
                const ws = XLSX.utils.json_to_sheet(reportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ç­”é¢˜æŠ¥å‘Š');
                XLSX.writeFile(wb, `ç­”é¢˜æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (e) {
                console.error(e);
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }

        async function loadVoteChartData() {
            try {
                const { data } = await supabaseClient.from('vote_logs').select('option').eq('round', voteRound);
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                if (data) data.forEach(row => { if (counts[row.option] !== undefined) counts[row.option]++; });
                voteChart.data.datasets[0].data = [counts.A, counts.B, counts.C, counts.D];
                
                if (!isVoteActive && currentQuestion) {
                    const colors = ['A', 'B', 'C', 'D'].map(opt => 
                        currentQuestion.answer.includes(opt) ? '#10b981' : '#ef4444'
                    );
                    voteChart.data.datasets[0].backgroundColor = colors;
                } else {
                    voteChart.data.datasets[0].backgroundColor = ['#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'];
                }
                voteChart.update();
            } catch (e) { console.error(e); }
        }
        
        async function resetVote() {
            if (!confirm('é‡ç½®æ‰€æœ‰ç­”é¢˜æ•°æ®ï¼Ÿ')) return;
            await supabaseClient.from('vote_logs').delete().neq('id', 0);
            await supabaseClient.from('vote_config').update({ current_round: 1, is_active: true }).eq('id', 1);
        }
        
        // ================== æŠ¢ç­”ç»“æœæ˜¾ç¤º ==================
        async function loadBuzzerState() {
            try {
                const { data } = await supabaseClient.from('buzzer').select('*').eq('id', 1).single();
                if (data) updateBuzzerUI(data);
            } catch (e) { console.error(e); }
        }
        
        function updateBuzzerUI(data) {
            const winner = document.getElementById('buzzer-winner');
            const buzzerCard = document.getElementById('buzzer-result-card');
            
            if (data.winner) {
                winner.innerText = data.winner + ' ğŸ†';
                winner.style.color = '#10b981';
                buzzerCard.style.display = 'block';
                triggerConfetti();
            } else if (data.is_active) {
            } else {
                winner.innerText = 'ç­‰å¾…ä¸­...';
                winner.style.color = '#94a3b8';
            }
        }
        
        function triggerConfetti() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
        
        // å¯åŠ¨
        init();
    </script>
</body>
</html>