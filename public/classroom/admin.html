<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« è¯¾å ‚ä¸­æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- äºŒç»´ç ç”Ÿæˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
        }
        
        h1 { 
            font-size: 2.5rem; 
            font-weight: 300; 
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        
        .main-container {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1200px;
        }
        
        /* äºŒç»´ç åŒºåŸŸ */
        .qr-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .qr-title {
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        #qr-code {
            margin: 15px auto;
        }
        
        #qr-code canvas {
            border-radius: 10px;
        }
        
        .qr-url {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 10px;
            word-break: break-all;
            max-width: 250px;
        }
        
        .student-count {
            margin-top: 15px;
            padding: 10px 20px;
            background: #f1f5f9;
            border-radius: 10px;
            color: #1e293b;
        }
        
        .count-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
        }
        
        /* åŠŸèƒ½å¡ç‰‡åŒºåŸŸ */
        .cards-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 30px 40px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
            min-width: 350px;
        }
        
        .card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card.active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }
        
        .card-icon {
            font-size: 3.5rem;
        }
        
        .card-content {
            text-align: left;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .card-desc {
            color: #94a3b8;
            font-size: 0.95rem;
        }
        
        /* è¯¾ä»¶æ’­æ”¾å™¨å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        .card-presentation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .card-presentation:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        
        .card-presentation .card-desc {
            color: rgba(255,255,255,0.8);
        }
        
        /* åº•éƒ¨æ§åˆ¶ */
        .bottom-controls {
            margin-top: 40px;
            display: flex;
            gap: 15px;
        }
        
        .ctrl-btn {
            padding: 12px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn-release {
            background: #ef4444;
            color: white;
        }
        
        .btn-release:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* çŠ¶æ€æŒ‡ç¤º */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            text-align: center;
            font-size: 0.9rem;
            z-index: 100;
        }
        
        .status-active {
            color: #10b981;
        }
        
        .status-idle {
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="status-bar">
        å½“å‰çŠ¶æ€ï¼š<span id="current-status" class="status-idle">è‡ªç”±æ´»åŠ¨</span>
    </div>

    <h1>ğŸ“ æ™ºæ…§è¯¾å ‚</h1>
    <p class="subtitle">æ‰«ç è¿›å…¥ Â· å¼€å§‹äº’åŠ¨</p>
    
    <div class="main-container">
        <!-- äºŒç»´ç åŒºåŸŸ -->
        <div class="qr-section">
            <div class="qr-title">ğŸ“± å­¦ç”Ÿæ‰«ç å…¥å£</div>
            <div id="qr-code"></div>
            <div class="qr-url" id="qr-url"></div>
            <div class="student-count">
                <div>ä»Šæ—¥ç­¾åˆ°</div>
                <div class="count-number" id="student-count">0</div>
                <div style="font-size:0.8rem; color:#64748b;">äºº</div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½å¡ç‰‡ -->
        <div class="cards-section">
            <div class="card" id="card-sign" onclick="activateSign()">
                <div class="card-icon">ğŸ“</div>
                <div class="card-content">
                    <div class="card-title">å¼€å§‹ç­¾åˆ°</div>
                    <div class="card-desc">å­¦ç”Ÿæ‰«ç åè‡ªåŠ¨è·³è½¬ç­¾åˆ°é¡µé¢</div>
                </div>
            </div>
            
            <div class="card card-presentation" onclick="openPresentation()">
                <div class="card-icon">ğŸ¬</div>
                <div class="card-content">
                    <div class="card-title">è¯¾ä»¶æ’­æ”¾å™¨</div>
                    <div class="card-desc">PPT + ç­”é¢˜ + å¼¹å¹• + æŠ¢ç­” + ç‚¹å</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-controls">
        <button class="ctrl-btn btn-release" onclick="releaseControl()">â¸ï¸ é‡Šæ”¾æ§åˆ¶</button>
        <button class="ctrl-btn btn-secondary" onclick="window.open('/sign-admin')">ğŸ“‹ ç­¾åˆ°ç®¡ç†</button>
        <button class="ctrl-btn btn-secondary" onclick="window.open('/vote-admin')">ğŸ“Š ç­”é¢˜ç®¡ç†</button>
    </div>

    <script>
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const studentUrl = window.location.origin + '/classroom';
            document.getElementById('qr-url').innerText = studentUrl;
            
            QRCode.toCanvas(document.createElement('canvas'), studentUrl, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#1e293b',
                    light: '#ffffff'
                }
            }, function(error, canvas) {
                if (error) {
                    console.error(error);
                    return;
                }
                const container = document.getElementById('qr-code');
                container.innerHTML = '';
                container.appendChild(canvas);
            });
        }
        
        // è·å–ç­¾åˆ°äººæ•°
        async function loadStudentCount() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { count } = await supabaseClient
                    .from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);
                
                document.getElementById('student-count').innerText = count || 0;
            } catch (e) {
                console.error('è·å–ç­¾åˆ°äººæ•°å¤±è´¥:', e);
            }
        }
        
        // å®æ—¶ç›‘å¬ç­¾åˆ°
        supabaseClient.channel('admin-attendance')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendance' }, () => {
                loadStudentCount();
            })
            .subscribe();
        
        // æ¿€æ´»ç­¾åˆ°æ¨¡å¼
        async function activateSign() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById('card-sign').classList.add('active');
            document.getElementById('current-status').innerText = 'ç­¾åˆ°è¿›è¡Œä¸­...';
            document.getElementById('current-status').className = 'status-active';
            
            await supabaseClient.from('global_state').update({
                current_page: '/sign',
                status: 'active'
            }).eq('id', 1);
            
            // æ‰“å¼€ç­¾åˆ°ç®¡ç†é¡µé¢
            window.open('/sign-admin', '_blank');
        }
        
        // æ‰“å¼€è¯¾ä»¶æ’­æ”¾å™¨
        function openPresentation() {
            window.open('/presentation', '_blank');
        }
        
        // é‡Šæ”¾æ§åˆ¶
        async function releaseControl() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById('current-status').innerText = 'è‡ªç”±æ´»åŠ¨';
            document.getElementById('current-status').className = 'status-idle';
            
            await supabaseClient.from('global_state').update({
                current_page: 'idle',
                status: 'idle'
            }).eq('id', 1);
        }
        
        // åˆå§‹åŒ–
        async function init() {
            generateQRCode();
            loadStudentCount();
            
            // è¯»å–å½“å‰çŠ¶æ€
            const { data } = await supabaseClient
                .from('global_state')
                .select('*')
                .eq('id', 1)
                .single();
            
            if (data && data.status === 'active') {
                if (data.current_page.includes('sign')) {
                    document.getElementById('card-sign').classList.add('active');
                }
                document.getElementById('current-status').innerText = 'ç³»ç»Ÿè¿è¡Œä¸­...';
                document.getElementById('current-status').className = 'status-active';
            }
        }
        
        init();
    </script>
</body>
</html>