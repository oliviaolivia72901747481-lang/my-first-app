<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« è¯¾å ‚è¶…çº§ä¸­æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1e293b; color: white; padding: 20px; text-align: center; }
        h1 { margin-bottom: 30px; font-weight: 300; }
        
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px; max-width: 800px; margin: 0 auto;
        }

        /* é¥æ§å¡ç‰‡ */
        .card {
            background: rgba(255,255,255,0.1); border: 2px solid transparent;
            border-radius: 15px; padding: 20px; cursor: pointer;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
        }
        .card:hover { background: rgba(255,255,255,0.2); transform: translateY(-5px); }
        
        /* æ¿€æ´»çŠ¶æ€ */
        .card.active {
            border-color: #10b981; background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .icon { font-size: 3rem; margin-bottom: 10px; }
        .label { font-weight: bold; font-size: 1.1rem; }
        .desc { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; }

        /* åœæ­¢æŒ‰é’® */
        .stop-btn {
            margin-top: 40px; padding: 15px 40px;
            background: #ef4444; color: white; border: none; border-radius: 50px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        .stop-btn:active { transform: scale(0.95); }

        /* çŠ¶æ€æ¡ */
        #status-bar {
            margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.3);
            border-radius: 8px; font-size: 0.9rem; color: #10b981;
        }
    </style>
</head>
<body>

    <h1>ğŸš€ è¯¾å ‚è¶…çº§ä¸­æ§</h1>
    <div id="status-bar">å½“å‰çŠ¶æ€ï¼š<span id="current-status">è‡ªç”±æ´»åŠ¨</span></div>

    <div class="grid">
        <div class="card" id="card-sign" onclick="activateModule('sign', '/sign', '/sign-admin')">
            <div class="icon">ğŸ“…</div>
            <div class="label">ç­¾åˆ°æ¨¡å¼</div>
            <div class="desc">å­¦ç”Ÿç«¯å¼ºåˆ¶è·³è½¬ç­¾åˆ°</div>
        </div>

        <div class="card" id="card-vote" onclick="activateModule('vote', '/vote', '/vote-admin')">
            <div class="icon">ğŸ“Š</div>
            <div class="label">ç­”é¢˜æ¨¡å¼</div>
            <div class="desc">å…¨ç­åŒæ­¥æ˜¾ç¤ºé¢˜ç›®</div>
        </div>

        <div class="card" id="card-danmu" onclick="activateModule('danmu', '/danmu', '/danmu-admin')">
            <div class="icon">ğŸ’¬</div>
            <div class="label">å¼¹å¹•äº’åŠ¨</div>
            <div class="desc">å¼€å¯å¼¹å¹•å¢™</div>
        </div>

        <div class="card" id="card-buzzer" onclick="activateModule('buzzer', '/buzzer', '/buzzer-admin')">
            <div class="icon">âš¡</div>
            <div class="label">æŠ¢ç­”æ¨¡å¼</div>
            <div class="desc">è¿›å…¥æŠ¢ç­”å™¨</div>
        </div>
        
        <div class="card" onclick="window.open('/lucky.html')">
            <div class="icon">ğŸ°</div>
            <div class="label">éšæœºç‚¹å</div>
            <div class="desc">ä»…è€å¸ˆå¤§å±æ˜¾ç¤º</div>
        </div>
    </div>

    <button class="stop-btn" onclick="stopAll()">â¸ï¸ é‡Šæ”¾æ§åˆ¶ (è‡ªç”±æ¨¡å¼)</button>

    <script>
        // ================= é…ç½® =================
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co' 
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h' // âš ï¸ æ›¿æ¢æˆä½ çœŸå®çš„Key
        // =======================================
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)

        // 1. æ¿€æ´»æŸä¸ªæ¨¡å—
        async function activateModule(name, studentPath, teacherPath) {
            // è§†è§‰åé¦ˆ
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${name}`).classList.add('active');
            document.getElementById('current-status').innerText = `æ­£åœ¨è¿›è¡Œï¼š${name}`;

            // æ ¸å¿ƒï¼šæ›´æ–°æ•°æ®åº“ï¼ŒæŒ‡æŒ¥å…¨ç­è·³è½¬
            await supabaseClient.from('global_state').update({
                current_page: studentPath,
                status: 'active'
            }).eq('id', 1);

            // è€å¸ˆè‡ªå·±ä¹Ÿè¦è·³è½¬åˆ°å¯¹åº”çš„ç®¡ç†é¡µé¢ (æ–°çª—å£æ‰“å¼€)
            if(teacherPath) window.open(teacherPath, '_blank');
        }

        // 2. åœæ­¢æ§åˆ¶
        async function stopAll() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById('current-status').innerText = "è‡ªç”±æ´»åŠ¨ / ç­‰å¾…ä¸­";

            // æ›´æ–°æ•°æ®åº“ä¸º idle
            await supabaseClient.from('global_state').update({
                current_page: 'idle',
                status: 'idle'
            }).eq('id', 1);
        }

        // åˆå§‹åŒ–è¯»å–çŠ¶æ€
        supabaseClient.from('global_state').select('*').eq('id', 1).single().then(({data}) => {
            if(data && data.status === 'active') {
                // ç®€å•çš„æ ¹æ®è·¯å¾„é«˜äº®å¯¹åº”å¡ç‰‡
                if(data.current_page.includes('sign')) document.getElementById('card-sign').classList.add('active');
                if(data.current_page.includes('vote')) document.getElementById('card-vote').classList.add('active');
                if(data.current_page.includes('danmu')) document.getElementById('card-danmu').classList.add('active');
                if(data.current_page.includes('buzzer')) document.getElementById('card-buzzer').classList.add('active');
                document.getElementById('current-status').innerText = "ç³»ç»Ÿè¿è¡Œä¸­...";
            }
        });
    </script>
</body>
</html>