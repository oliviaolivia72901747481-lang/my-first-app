<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/classroom/js/common.js"></script>
    <script src="/classroom/js/navigation.js"></script>
    <script src="/classroom/js/stats.js"></script>
    <script src="/classroom/js/points.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .profile-card {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2.5rem;
        }
        .user-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .user-id {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 15px;
        }
        .rank-badge {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.95rem;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡é€šç”¨æ ·å¼ */
        .stats-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stats-title {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 15px 10px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        .stat-value.highlight {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-value.success { color: #10b981; }
        .stat-value.warning { color: #f59e0b; }
        .stat-label {
            font-size: 0.8rem;
            color: #999;
        }
        
        /* å¿«æ·å…¥å£ */
        .quick-links {
            display: flex;
            gap: 15px;
        }
        .quick-link {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quick-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .quick-link:active {
            transform: scale(0.98);
        }
        .quick-icon {
            font-size: 1.3rem;
        }
        .quick-text {
            font-size: 0.95rem;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
</style>
</head>
<body>
    <div class="container">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div class="profile-card">
            <div class="avatar">ğŸ‘¤</div>
            <div class="user-name" id="user-name">åŠ è½½ä¸­...</div>
            <div class="user-id" id="user-id">å­¦å·: --</div>
            <div class="rank-badge" id="rank-badge">æ’ååŠ è½½ä¸­...</div>
        </div>
        
        <!-- ä»Šæ—¥ç»Ÿè®¡ -->
        <div class="stats-card">
            <div class="stats-title">ğŸ“… ä»Šæ—¥ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value highlight" id="today-count">0</span>
                    <span class="stat-label">ç­”é¢˜æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value success" id="today-accuracy">0%</span>
                    <span class="stat-label">æ­£ç¡®ç‡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value warning" id="today-correct">0</span>
                    <span class="stat-label">ç­”å¯¹é¢˜æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value highlight" id="today-points">0</span>
                    <span class="stat-label">è·å¾—ç§¯åˆ†</span>
                </div>
            </div>
        </div>
        
        <!-- ç´¯è®¡ç»Ÿè®¡ -->
        <div class="stats-card">
            <div class="stats-title">ğŸ“Š ç´¯è®¡ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value highlight" id="total-count">0</span>
                    <span class="stat-label">æ€»ç­”é¢˜æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value success" id="total-accuracy">0%</span>
                    <span class="stat-label">æ€»æ­£ç¡®ç‡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value warning" id="total-correct">0</span>
                    <span class="stat-label">ç­”å¯¹é¢˜æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value highlight" id="total-points">0</span>
                    <span class="stat-label">æ€»ç§¯åˆ†</span>
                </div>
            </div>
        </div>
        
        <!-- å¿«æ·å…¥å£ -->
        <div class="stats-card">
            <div class="stats-title">ğŸš€ å¿«æ·å…¥å£</div>
            <div class="quick-links">
                <a href="history.html" class="quick-link">
                    <span class="quick-icon">ğŸ“š</span>
                    <span class="quick-text">ç­”é¢˜å†å²</span>
                </a>
                <a href="rank.html" class="quick-link">
                    <span class="quick-icon">ğŸ†</span>
                    <span class="quick-text">ç§¯åˆ†æ’è¡Œ</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let supabaseClient = null;
        let myName = '';
        let myId = '';

        /**
         * è·å–å­¦ç”Ÿç»Ÿè®¡æ•°æ®
         * @param {string} studentId - å­¦ç”ŸID
         * @returns {Object} { todayCount, todayCorrect, todayAccuracy, todayPoints, totalCount, totalCorrect, totalAccuracy, totalPoints, rank, totalStudents }
         * 
         * Validates: Requirements 1.2, 1.3, 1.4
         */
        async function getStudentStats(studentId) {
            try {
                // è·å–æ‰€æœ‰ç­”é¢˜è®°å½•
                const { data: records, error } = await supabaseClient
                    .from('vote_logs')
                    .select('*')
                    .eq('student_id', studentId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('è·å–ç­”é¢˜è®°å½•å¤±è´¥:', error);
                    return getEmptyStats();
                }

                // ä½¿ç”¨ stats.js è®¡ç®—ä»Šæ—¥ç»Ÿè®¡
                const todayStats = ClassroomStats.calculateTodayStats(records || []);
                
                // ä½¿ç”¨ stats.js è®¡ç®—æ€»ç»Ÿè®¡
                const totalStats = ClassroomStats.calculateTotalStats(records || []);

                // è·å–ç§¯åˆ†æ•°æ®
                const todayPointsData = await PointsSystem.getTodayStats(supabaseClient, studentId);
                const totalPoints = await PointsSystem.getStudentPoints(supabaseClient, studentId);

                // è·å–æ’å
                const rankInfo = await getStudentRank(studentId);

                return {
                    todayCount: todayStats.count,
                    todayCorrect: todayStats.correct,
                    todayAccuracy: todayStats.accuracy,
                    todayPoints: todayPointsData.total || 0,
                    totalCount: totalStats.count,
                    totalCorrect: totalStats.correct,
                    totalAccuracy: totalStats.accuracy,
                    totalPoints: totalPoints || 0,
                    rank: rankInfo.rank,
                    totalStudents: rankInfo.totalStudents
                };
            } catch (e) {
                console.error('è·å–å­¦ç”Ÿç»Ÿè®¡å¼‚å¸¸:', e);
                return getEmptyStats();
            }
        }

        /**
         * è·å–å­¦ç”Ÿæ’å
         * @param {string} studentId - å­¦ç”ŸID
         * @returns {Object} { rank, totalStudents }
         * 
         * Property 7: Student Rank Calculation
         * Validates: Requirements 1.4
         */
        async function getStudentRank(studentId) {
            try {
                // è·å–æ‰€æœ‰å­¦ç”Ÿç§¯åˆ†æ•°æ®ï¼ˆä¸é™åˆ¶æ•°é‡ï¼Œç”¨äºè®¡ç®—çœŸå®æ’åï¼‰
                const { data: allStudents, error } = await supabaseClient
                    .from('student_points')
                    .select('student_id, total_points')
                    .order('total_points', { ascending: false });

                if (error || !allStudents) {
                    console.error('è·å–æ’åæ•°æ®å¤±è´¥:', error);
                    return { rank: 0, totalStudents: 0 };
                }

                const totalStudents = allStudents.length;
                
                // ä½¿ç”¨ PointsSystem è®¡ç®—æ’å
                const rankResult = PointsSystem.calculateRank(allStudents, studentId, 'total_points');

                return {
                    rank: rankResult.rank,
                    totalStudents: totalStudents
                };
            } catch (e) {
                console.error('è·å–æ’åå¼‚å¸¸:', e);
                return { rank: 0, totalStudents: 0 };
            }
        }

        // è¿”å›ç©ºç»Ÿè®¡æ•°æ®
        function getEmptyStats() {
            return {
                todayCount: 0,
                todayCorrect: 0,
                todayAccuracy: 0,
                todayPoints: 0,
                totalCount: 0,
                totalCorrect: 0,
                totalAccuracy: 0,
                totalPoints: 0,
                rank: 0,
                totalStudents: 0
            };
        }

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        function updateDisplay(stats) {
            // ç”¨æˆ·ä¿¡æ¯
            document.getElementById('user-name').textContent = myName;
            document.getElementById('user-id').textContent = `å­¦å·: ${myId}`;
            
            // æ’åæ˜¾ç¤º
            if (stats.rank > 0) {
                document.getElementById('rank-badge').textContent = 
                    `ğŸ† ç­çº§æ’å ç¬¬${stats.rank}å / ${stats.totalStudents}äºº`;
            } else {
                document.getElementById('rank-badge').textContent = 'æš‚æ— æ’å';
            }

            // ä»Šæ—¥ç»Ÿè®¡
            document.getElementById('today-count').textContent = stats.todayCount;
            document.getElementById('today-correct').textContent = stats.todayCorrect;
            document.getElementById('today-accuracy').textContent = 
                Math.round(stats.todayAccuracy) + '%';
            document.getElementById('today-points').textContent = stats.todayPoints;

            // ç´¯è®¡ç»Ÿè®¡
            document.getElementById('total-count').textContent = stats.totalCount;
            document.getElementById('total-correct').textContent = stats.totalCorrect;
            document.getElementById('total-accuracy').textContent = 
                Math.round(stats.totalAccuracy) + '%';
            document.getElementById('total-points').textContent = stats.totalPoints;
        }

        // åˆå§‹åŒ–
        async function initProfile() {
            // åˆ›å»º Supabase å®¢æˆ·ç«¯
            supabaseClient = ClassroomCommon.createSupabaseClient();
            
            // æ£€æŸ¥ç”¨æˆ·èº«ä»½
            const userAuth = ClassroomCommon.checkUserAuth();
            if (!userAuth) return;
            
            myName = userAuth.name;
            myId = userAuth.id;

            // åŠ è½½ç»Ÿè®¡æ•°æ®
            const stats = await getStudentStats(myId);
            updateDisplay(stats);

            // å¯åŠ¨å…¨å±€æ§åˆ¶ç›‘å¬
            ClassroomCommon.initGlobalControlListener(supabaseClient);

            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
            if (typeof NavigationComponent !== 'undefined') {
                NavigationComponent.init();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initProfile);
    </script>
</body>
</html>
