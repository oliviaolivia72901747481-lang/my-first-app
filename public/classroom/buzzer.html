<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ è¯¾å ‚æŠ¢ç­”å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/classroom/js/common.js"></script>
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: #2c3e50;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º */
        .user-info {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.1);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
        }
        
        /* æ ¸å¿ƒæŠ¢ç­”æŒ‰é’® */
        #btn-buzz {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: none;
            font-size: 3rem;
            font-weight: bold;
            color: white;
            background: #95a5a6; /* é»˜è®¤ç°è‰²ï¼ˆæœªå¼€å§‹ï¼‰ */
            box-shadow: 0 15px 0 #7f8c8d;
            cursor: not-allowed;
            transition: all 0.1s;
            
            /* Safari å…¼å®¹æ€§ */
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; 
        }

        /* æ¿€æ´»çŠ¶æ€ */
        #btn-buzz.active {
            background: #e74c3c; /* çº¢è‰² */
            box-shadow: 0 15px 0 #c0392b;
            cursor: pointer;
            transform: translateY(0);
        }
        #btn-buzz.active:active {
            transform: translateY(15px);
            box-shadow: 0 0 0 #c0392b;
        }

        /* çŠ¶æ€æç¤ºæ–‡å­— */
        #status-text {
            margin-top: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            height: 50px;
        }
    </style>
</head>

<body>
    <div class="user-info">ğŸ‘¤ <span id="user-name">åŠ è½½ä¸­...</span></div>

    <button id="btn-buzz" onclick="doBuzz()">æŠ¢!</button>

    <div id="status-text">ç­‰å¾…è€å¸ˆå¼€å§‹...</div>

    <script>
        // ä½¿ç”¨å…¬å…±é…ç½®
        const supabaseClient = ClassroomCommon.createSupabaseClient();
        
        // æ£€æŸ¥ç”¨æˆ·èº«ä»½ï¼ˆä½¿ç”¨ç­¾åˆ°æ—¶ä¿å­˜çš„ä¿¡æ¯ï¼‰
        const userAuth = ClassroomCommon.checkUserAuth();
        if (!userAuth) {
            // æœªç­¾åˆ°ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°ç­¾åˆ°é¡µé¢
        }
        
        let myName = userAuth ? userAuth.name : '';
        let myId = userAuth ? userAuth.id : '';
        
        const btn = document.getElementById('btn-buzz');
        const status = document.getElementById('status-text');

        // æ˜¾ç¤ºç”¨æˆ·å
        document.getElementById('user-name').innerText = myName || 'æœªç™»å½•';

        // éŸ³æ•ˆ
        const audioClickSrc = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAABjhfX/gwA0LAAABBAAAACR2F3f9lAAIAAAAEEAAAA//uQZAAABjhfX/gwA0LAAABBAAAACR2F3f9lAAIAAAAEEAAAA//uQZAAABjhfX/gwA0LAAABBAAAACR2F3f9lAAIAAAAEEAAAA//uQZAAABjhfX/gwA0LAAABBAAAACR2F3f9lAAIAAAAEEAAAA//uQZAAABjhfX/gwA0LAAABBAAAACR2F3f9lAAIAAAAEEAAAA//uQZAAABjhfX/gwA0LAAABBAAAACR2F3f9lAAIAAAAEEAAAA//uQZAABjhmX38YYTIAAAAQAQAACR2F3f9lAAIAAAAEEAAAA//uQZAABjhmX38YYTIAAAAQAQAACR2F3f9lAAIAAAAEEAAAA//uQZAABjhmX38YYTIAAAAQAQAACR2F3f9lAAIAAAAEEAAAA//uQZAABjhmX38YYTIAAAAQAQAACR2F3f9lAAIAAAAEEAAAA//uQZAAAAAAA0gAAABBAAAACQAAAAA";
        const soundClick = new Audio(audioClickSrc);

        // åˆå§‹åŒ–
        if (myName) {
            initSupabase();
        }

        // 2. æ ¸å¿ƒç›‘å¬é€»è¾‘
        function initSupabase() {
            checkStatus();

            // ğŸ› ï¸ ä¿®å¤ 3ï¼šä½¿ç”¨ supabaseClient
            supabaseClient
                .channel('buzzer-room')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'buzzer' }, payload => {
                    handleStateChange(payload.new);
                })
                .subscribe();
        }

        async function checkStatus() {
            // ğŸ› ï¸ ä¿®å¤ 4ï¼šä½¿ç”¨ supabaseClient
            const { data } = await supabaseClient.from('buzzer').select('*').eq('id', 1).single();
            if(data) handleStateChange(data);
        }

        function handleStateChange(data) {
            if (data.winner) {
                // ğŸ† æœ‰äººæŠ¢åˆ°äº†
                btn.className = ''; 
                if (data.winner === myName) {
                    document.body.style.background = "#27ae60"; 
                    status.innerText = "ğŸ‰ æ­å–œä½ ï¼æŠ¢åˆ°äº†ï¼";
                    status.style.fontSize = "2rem";
                } else {
                    document.body.style.background = "#c0392b"; 
                    status.innerText = `æ…¢äº†ï¼è¢« ${data.winner} æŠ¢èµ°äº†`;
                }
            } else if (data.is_active) {
                // ğŸŸ¢ è€å¸ˆå¼€å§‹äº†
                btn.className = 'active'; 
                document.body.style.background = "#2c3e50"; 
                status.innerText = "å¿«æŠ¢ï¼ï¼ï¼";
                btn.disabled = false;
            } else {
                // â¸ï¸ è€å¸ˆé‡ç½®äº†
                btn.className = ''; 
                document.body.style.background = "#2c3e50";
                status.innerText = "ç­‰å¾…ä¸‹ä¸€è½®...";
                btn.disabled = true;
            }
        }

        // 3. æŠ¢ç­”åŠ¨ä½œ
        async function doBuzz() {
            if (!btn.classList.contains('active')) return;

            soundClick.currentTime = 0; 
            soundClick.play().catch(e => console.log("äº¤äº’é™åˆ¶"));

            // ä¹è§‚æ›´æ–°
            btn.className = '';
            status.innerText = "æŠ¢ç­”ä¸­...";

            // ğŸ› ï¸ ä¿®å¤ 5ï¼šä½¿ç”¨ supabaseClient
            const { data, error } = await supabaseClient
                .from('buzzer')
                .update({ winner: myName, is_active: false }) 
                .eq('id', 1)
                .is('winner', null) // åŸå­é”
                .select();
        }
    </script>
    <script>
(function() {
    // ä¿æŠ¤æœºåˆ¶ï¼šæ£€æŸ¥é¡µé¢æ˜¯å¦å·²ç»è¿æ¥äº† Supabase
    // å¦‚æœé¡µé¢æœ¬èº«è¿˜æ²¡åŠ è½½å¥½ supabaseClientï¼Œè¿™æ®µä»£ç å°±ä¸è¿è¡Œï¼Œé˜²æ­¢æŠ¥é”™
    const checkInterval = setInterval(() => {
        if (typeof supabaseClient !== 'undefined') {
            clearInterval(checkInterval);
            startListening();
        }
    }, 100);
    
    // é¡µé¢è·¯å¾„æ˜ å°„è¡¨ - æ”¯æŒä¸¤ç§æ ¼å¼
    const pageMap = {
        // æ–‡ä»¶åæ ¼å¼ (presentation.html ä½¿ç”¨)
        'vote.html': '/vote',
        'danmu.html': '/danmu',
        'buzzer.html': '/buzzer',
        'sign.html': '/sign',
        'lucky.html': '/lucky',
        // URLè·¯å¾„æ ¼å¼ (admin.html ä½¿ç”¨) - ç›´æ¥æ˜ å°„
        '/vote': '/vote',
        '/danmu': '/danmu',
        '/buzzer': '/buzzer',
        '/sign': '/sign',
        '/lucky': '/lucky'
    };

    function startListening() {
        console.log("ğŸ“¡ å·²å¯åŠ¨è¯¾å ‚é¥æ§ç›‘å¬...");
        supabaseClient
            .channel('global-control-sub')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state' }, payload => {
                const data = payload.new;
                const currentPath = window.location.pathname; // è·å–å½“å‰è·¯å¾„
                
                // 1. è€å¸ˆå¼€å¯äº†æŸä¸ªåŠŸèƒ½
                if (data.status === 'active' && data.current_page !== 'idle') {
                    let targetPage = data.current_page;
                    
                    // å¦‚æœåœ¨æ˜ å°„è¡¨ä¸­ï¼Œä½¿ç”¨æ˜ å°„å€¼
                    if (pageMap[data.current_page]) {
                        targetPage = pageMap[data.current_page];
                    } 
                    // å¦‚æœæ˜¯ .html æ–‡ä»¶åä½†ä¸åœ¨æ˜ å°„è¡¨ä¸­ï¼Œæ·»åŠ  /classroom/ å‰ç¼€
                    else if (data.current_page.endsWith('.html')) {
                        targetPage = `/classroom/${data.current_page}`;
                    }
                    // å¦‚æœå·²ç»æ˜¯ / å¼€å¤´çš„è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
                    else if (!data.current_page.startsWith('/')) {
                        targetPage = `/${data.current_page}`;
                    }
                    
                    // å¦‚æœæˆ‘å½“å‰ä¸åœ¨è€å¸ˆæŒ‡å®šçš„é¡µé¢ï¼Œå°±å¼ºåˆ¶è·³è¿‡å»
                    if (currentPath !== targetPage) {
                        console.log(`ğŸ‘¨â€ğŸ« è€å¸ˆåˆ‡æ¢åˆ°äº† ${targetPage}ï¼Œæ­£åœ¨è·Ÿè¿›...`);
                        window.location.href = targetPage;
                    }
                } 
                // 2. è€å¸ˆé‡Šæ”¾äº†æ§åˆ¶ (ä¸‹è¯¾/è‡ªç”±æ´»åŠ¨)
                else if (data.status === 'idle') {
                    // å¦‚æœæˆ‘ç°åœ¨ä¸æ˜¯åœ¨é¦–é¡µï¼Œå°±è¢«è¸¢å›é¦–é¡µ
                    if (currentPath !== '/classroom' && currentPath !== '/classroom/') {
                        console.log("â¸ï¸ è‡ªç”±æ´»åŠ¨æ¨¡å¼ï¼Œè¿”å›é¦–é¡µ");
                        window.location.href = '/classroom';
                    }
                }
            })
            .subscribe();
    }
})();
</script>
</body>
</html>