<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘©â€ğŸ« æ™ºèƒ½ç­”é¢˜æ€»æ§å°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; text-align: center; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        .header { margin-bottom: 20px; width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; }
        .round-display { font-size: 2rem; font-weight: bold; color: #2563eb; }
        .question-card { background: white; width: 100%; max-width: 1000px; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: left; position: relative; }
        .q-title { font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 20px; }
        .q-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 1.5rem; color: #555; }
        .q-opt-item { padding: 10px; border-radius: 8px; border: 2px solid transparent; }
        .highlight-answer { border-color: #10b981; background: #ecfdf5; color: #047857; font-weight: bold; }
        .chart-box { width: 100%; max-width: 1000px; height: 350px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 20px; margin-bottom: 30px; }
        button { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; transition: all 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-next { background: #2563eb; } .btn-stop { background: #f59e0b; } .btn-import { background: #8b5cf6; }
        #import-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:999; }
        .modal-content { background:white; padding:40px; border-radius:15px; width:500px; text-align: center; }
        .file-drop-area { border: 2px dashed #ccc; padding: 40px; margin: 20px 0; border-radius: 10px; cursor: pointer; background: #fafafa; }
        input[type=file] { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="round-display">ç¬¬ <span id="current-round">1</span> é¢˜</div>
        <div id="status-text" style="color:#666; font-size: 1.2rem;">å‡†å¤‡ä¸­...</div>
    </div>

    <div class="question-card">
        <div id="q-title" class="q-title">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
        <div class="q-options" id="q-options"></div>
        <div id="correct-ans-display" style="position:absolute; bottom:20px; right:30px; font-size:3rem; color:#10b981; font-weight:bold; display:none; transform: rotate(-10deg); border: 4px solid #10b981; padding: 5px 20px; border-radius: 10px;">A</div>
    </div>

    <div class="chart-box"><canvas id="myChart"></canvas></div>

    <div class="controls">
        <button class="btn-stop" onclick="toggleActive()" aria-label="æš‚åœæˆ–å…¬å¸ƒç­”æ¡ˆ">â¯ï¸ æš‚åœ/å…¬å¸ƒç­”æ¡ˆ</button>
        <button class="btn-next" onclick="nextRound()" aria-label="ä¸‹ä¸€é¢˜">â¡ï¸ ä¸‹ä¸€é¢˜</button>
        <button class="btn-import" onclick="openImport()" aria-label="å¯¼å…¥ Excel é¢˜åº“">ğŸ“¥ å¯¼å…¥ Excel é¢˜åº“</button>
    </div>

    <div style="margin-top:20px;">
        <button onclick="clearAll()" style="background:transparent; color:#999; border:1px solid #ddd; padding:8px 15px;" aria-label="é‡ç½®è¯¾å ‚ï¼Œæ¸…é™¤æ‰€æœ‰æ•°æ®">âš ï¸ é‡ç½®è¯¾å ‚</button>
        <button onclick="exportFullReport()" style="background:transparent; color:#10b981; border:1px solid #10b981; padding:8px 15px; margin-left: 10px; font-weight:bold;" aria-label="å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Š">ğŸ“Š å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Š</button>
    </div>

    <div id="import-modal" aria-modal="true" aria-labelledby="modal-title" role="dialog">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“‚ ä¸Šä¼  Excel é¢˜åº“</h3>
            <p style="color:#666; font-size:0.9rem;">è¯·ä¸Šä¼  .xlsx æ–‡ä»¶ï¼Œè¡¨å¤´éœ€åŒ…å«ï¼šè½®æ¬¡ã€é¢˜ç›®ã€é€‰é¡¹Aã€é€‰é¡¹Bã€é€‰é¡¹Cã€é€‰é¡¹Dã€ç­”æ¡ˆã€ç±»å‹(å¯é€‰)</p>
            <p style="color:#999; font-size:0.8rem; margin-top:5px;">ç±»å‹å¯å¡«ï¼šsingle(å•é€‰)ã€multi(å¤šé€‰)ã€judge(åˆ¤æ–­)<br>åˆ¤æ–­é¢˜åªéœ€å¡«é€‰é¡¹A=æ­£ç¡®ï¼Œé€‰é¡¹B=é”™è¯¯</p>
            <label class="file-drop-area" for="file-input" aria-label="ç‚¹å‡»é€‰æ‹©æ–‡ä»¶">
                <span style="font-size:3rem;">ğŸ“„</span><br><span id="file-name">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                <input type="file" id="file-input" accept=".xlsx, .xls" onchange="handleFileSelect(this)" aria-describedby="file-upload-desc">
            </label>
            <button onclick="closeImport()" style="background:#ccc; color:#333; padding:10px 30px;" aria-label="å…³é—­æ¨¡æ€æ¡†">å…³é—­</button>
            <button onclick="uploadExcel()" style="background:#8b5cf6; padding:10px 30px;" aria-label="ç¡®è®¤ä¸Šä¼ æ–‡ä»¶">ç¡®è®¤ä¸Šä¼ </button>
        </div>
    </div>

    <script>
        // Supabaseé…ç½® - æ³¨æ„ï¼šè¿™æ˜¯å‘å¸ƒå¯†é’¥ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡
        const supabaseUrl = 'https://urqxrtlzaifvambytoci.supabase.co';
        const supabaseKey = 'sb_publishable_UWJrATWMObB576H3ODCicQ_FXX5Li8h';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentRound = 1;
        let isActive = true;
        let currentQuestion = null;
        let selectedFile = null;

        Chart.register(ChartDataLabels);
        const myChart = new Chart(document.getElementById('myChart'), {
            type: 'bar',
            data: { labels: ['A', 'B', 'C', 'D'], datasets: [{ data: [0, 0, 0, 0], backgroundColor: ['#94a3b8', '#94a3b8', '#94a3b8', '#94a3b8'], borderRadius: 10 }] },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    datalabels: { color: 'white', font: { size: 24, weight: 'bold' } } 
                }, 
                scales: { 
                    y: { display: false }, 
                    x: { grid: { display: false }, ticks: { font: { size: 20 } } } 
                } 
            }
        });

        async function init() {
            try {
                const { data: config } = await supabaseClient.from('vote_config').select('*').eq('id', 1).maybeSingle();
                if (config) {
                    updateState(config);
                }

                supabaseClient.channel('admin-config')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vote_config' }, payload => updateState(payload.new))
                    .subscribe();
                supabaseClient.channel('admin-logs')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'vote_logs' }, loadChartData)
                    .subscribe();
                await loadChartData();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        async function updateState(config) {
            try {
                currentRound = config.current_round;
                isActive = config.is_active;
                document.getElementById('current-round').innerText = currentRound;
                document.getElementById('status-text').innerText = isActive ? "æ­£åœ¨æ¥æ”¶ç­”æ¡ˆ..." : "â›” å·²åœæ­¢ä½œç­” (æ˜¾ç¤ºç­”æ¡ˆ)";
                document.getElementById('status-text').style.color = isActive ? "#10b981" : "#ef4444";
                await loadQuestion(currentRound);
                document.getElementById('correct-ans-display').style.display = isActive ? 'none' : 'block';
                await loadChartData();
            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function loadQuestion(round) {
            try {
                const { data } = await supabaseClient.from('questions').select('*').eq('round', round).maybeSingle();
                currentQuestion = data;
                if (data) {
                    // åˆ¤æ–­é¢˜ç›®ç±»å‹
                    let questionType = data.type || 'single';
                    if (!data.type && data.answer && data.answer.length > 1) {
                        questionType = 'multi';
                    }
                    if (data.option_a === 'æ­£ç¡®' && data.option_b === 'é”™è¯¯' && !data.option_c && !data.option_d) {
                        questionType = 'judge';
                    }
                    
                    // é¢˜ç›®ç±»å‹æ ‡ç­¾
                    const typeLabels = {
                        'single': '<span style="background:#dbeafe;color:#1d4ed8;padding:3px 10px;border-radius:5px;font-size:0.9rem;margin-left:10px;">å•é€‰é¢˜</span>',
                        'multi': '<span style="background:#fef3c7;color:#b45309;padding:3px 10px;border-radius:5px;font-size:0.9rem;margin-left:10px;">å¤šé€‰é¢˜</span>',
                        'judge': '<span style="background:#d1fae5;color:#047857;padding:3px 10px;border-radius:5px;font-size:0.9rem;margin-left:10px;">åˆ¤æ–­é¢˜</span>'
                    };
                    
                    document.getElementById('q-title').innerHTML = `${round}. ${data.title} ${typeLabels[questionType] || ''}`;
                    
                    // æ ¹æ®é¢˜ç›®ç±»å‹æ¸²æŸ“é€‰é¡¹
                    if (questionType === 'judge') {
                        document.getElementById('q-options').innerHTML = `
                            <div class="q-opt-item" id="opt-A">A. âœ… æ­£ç¡®</div>
                            <div class="q-opt-item" id="opt-B">B. âŒ é”™è¯¯</div>
                        `;
                    } else {
                        document.getElementById('q-options').innerHTML = `
                            <div class="q-opt-item" id="opt-A">A. ${data.option_a || ''}</div>
                            <div class="q-opt-item" id="opt-B">B. ${data.option_b || ''}</div>
                            <div class="q-opt-item" id="opt-C">C. ${data.option_c || ''}</div>
                            <div class="q-opt-item" id="opt-D">D. ${data.option_d || ''}</div>
                        `;
                    }
                    
                    document.getElementById('correct-ans-display').innerText = data.answer;
                    if (!isActive) {
                        highlightCorrectOption(data.answer, questionType);
                    }
                } else {
                    document.getElementById('q-title').innerText = `ç¬¬ ${round} é¢˜ (æ— æ•°æ®)`;
                    document.getElementById('q-options').innerHTML = "";
                }
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
            }
        }

        function highlightCorrectOption(answer, questionType = 'single') {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.q-opt-item').forEach(el => el.classList.remove('highlight-answer'));
            
            // å¤šé€‰é¢˜ï¼šé«˜äº®å¤šä¸ªé€‰é¡¹
            const correctOptions = answer.toUpperCase().split('');
            correctOptions.forEach(opt => {
                const optDiv = document.getElementById(`opt-${opt}`);
                if (optDiv) {
                    optDiv.classList.add('highlight-answer');
                }
            });
            
            // æ›´æ–°å›¾è¡¨é¢œè‰²
            const colors = myChart.data.labels.map(label => 
                correctOptions.includes(label) ? '#10b981' : '#ef4444'
            );
            myChart.data.datasets[0].backgroundColor = colors;
            myChart.update();
        }

        async function loadChartData() {
            try {
                const { data } = await supabaseClient.from('vote_logs').select('option').eq('round', currentRound);
                if (data) {
                    const counts = { A: 0, B: 0, C: 0, D: 0 };
                    data.forEach(row => {
                        if (counts[row.option] !== undefined) {
                            counts[row.option]++;
                        }
                    });
                    myChart.data.datasets[0].data = [counts.A, counts.B, counts.C, counts.D];
                    if (isActive) {
                        myChart.data.datasets[0].backgroundColor = ['#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'];
                    } else if (currentQuestion) {
                        highlightCorrectOption(currentQuestion.answer);
                    }
                    myChart.update();
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        async function nextRound() {
            try {
                await supabaseClient.from('vote_config').update({ current_round: currentRound + 1, is_active: true }).eq('id', 1);
            } catch (error) {
                console.error('ä¸‹ä¸€é¢˜å¤±è´¥:', error);
                alert('ä¸‹ä¸€é¢˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function toggleActive() {
            try {
                await supabaseClient.from('vote_config').update({ is_active: !isActive }).eq('id', 1);
            } catch (error) {
                console.error('æš‚åœ/å…¬å¸ƒç­”æ¡ˆå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function clearAll() {
            try {
                if (confirm('é‡ç½®æ‰€æœ‰ï¼Ÿ')) {
                    await supabaseClient.from('vote_logs').delete().neq('id', 0);
                    await supabaseClient.from('vote_config').update({ current_round: 1, is_active: true }).eq('id', 1);
                }
            } catch (error) {
                console.error('é‡ç½®è¯¾å ‚å¤±è´¥:', error);
                alert('é‡ç½®è¯¾å ‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ================== ğŸŸ¢ æ ¸å¿ƒå‡çº§ï¼šå­¦æƒ…åˆ†æå¯¼å‡º ==================
        async function exportFullReport() {
            try {
                // 1. è·å–å…¨ç­åå• (ä»ç­¾åˆ°è¡¨)
                const { data: students } = await supabaseClient.from('attendance').select('student_name, student_id');
                if (!students || students.length === 0) {
                    alert('æš‚æ— ç­¾åˆ°å­¦ç”Ÿï¼Œæ— æ³•ç»Ÿè®¡ç¼ºç­”æƒ…å†µ');
                    return;
                }

                // 2. è·å–æ‰€æœ‰ç­”é¢˜è®°å½•
                const { data: logs } = await supabaseClient.from('vote_logs').select('*');
                
                // 3. æ•°æ®èåˆ (äº¤å‰å¯¹æ¯”)
                // å‡è®¾æˆ‘ä»¬åªç»Ÿè®¡å‰ currentRound é“é¢˜
                let reportData = [];
                
                // éå†æ¯ä¸€è½®é¢˜ç›® (ä»1åˆ°currentRound)
                for (let r = 1; r <= currentRound; r++) {
                    students.forEach(stu => {
                        // æŸ¥æ‰¾è¯¥å­¦ç”Ÿåœ¨ç¬¬ r è½®çš„ç­”é¢˜è®°å½•
                        const log = logs.find(l => l.student_id === stu.student_id && l.round === r);
                        
                        let status = 'âŒ æœªå›ç­”';
                        let choice = '-';
                        let correctness = '-';

                        if (log) {
                            status = 'âœ… å·²å›ç­”';
                            choice = log.option;
                            // åˆ¤æ–­æ­£è¯¯ (true è½¬æˆæ–‡å­—)
                            if (log.is_correct === true) {
                                correctness = 'âœ… æ­£ç¡®';
                            } else if (log.is_correct === false) {
                                correctness = 'âŒ é”™è¯¯';
                            } else {
                                correctness = 'æœªçŸ¥';
                            }
                        }

                        reportData.push({
                            'é¢˜ç›®è½®æ¬¡': `ç¬¬ ${r} é¢˜`,
                            'å­¦å·': stu.student_id,
                            'å§“å': stu.student_name,
                            'çŠ¶æ€': status,
                            'å­¦ç”Ÿé€‰æ‹©': choice,
                            'æ­£è¯¯åˆ¤æ–­': correctness
                        });
                    });
                }

                // 4. å¯¼å‡º Excel
                const ws = XLSX.utils.json_to_sheet(reportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'å­¦æƒ…åˆ†ææŠ¥å‘Š');
                XLSX.writeFile(wb, `å­¦æƒ…åˆ†æ_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Šå¤±è´¥:', error);
                alert('å¯¼å‡ºå­¦æƒ…åˆ†ææŠ¥å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        // ==============================================================

        // å¯¼å…¥åŠŸèƒ½ä¿æŒä¸å˜
        function openImport() {
            document.getElementById('import-modal').style.display = 'flex';
        }

        function closeImport() {
            document.getElementById('import-modal').style.display = 'none';
        }

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('file-name').innerText = selectedFile.name;
            }
        }

        async function uploadExcel() {
            try {
                if (!selectedFile) {
                    alert('è¯·é€‰æ‹©æ–‡ä»¶');
                    return;
                }
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        const dbData = json.map(row => ({
                            round: row['è½®æ¬¡'],
                            title: row['é¢˜ç›®'],
                            option_a: row['é€‰é¡¹A'] || '',
                            option_b: row['é€‰é¡¹B'] || '',
                            option_c: row['é€‰é¡¹C'] || '',
                            option_d: row['é€‰é¡¹D'] || '',
                            answer: String(row['ç­”æ¡ˆ'] || '').toUpperCase(),
                            type: row['ç±»å‹'] || 'single'
                        }));
                        await supabaseClient.from('questions').delete().neq('id', 0);
                        const { error } = await supabaseClient.from('questions').insert(dbData);
                        if (error) {
                            throw error;
                        }
                        alert('å¯¼å…¥æˆåŠŸï¼Œåˆ·æ–°é¡µé¢ç”Ÿæ•ˆ');
                        location.reload();
                    } catch (err) {
                        console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', err);
                        alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(selectedFile);
            } catch (error) {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        init();
    </script>
</body>
</html>