<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 10px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d1fae5; color: #047857; }
        .error { background: #fee2e2; color: #dc2626; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; background: #2563eb; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ•™å­¦è¾…åŠ©è½¯ä»¶åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>1. ä¾èµ–åº“åŠ è½½æµ‹è¯•</h3>
        <div id="lib-test-result"></div>
        <button onclick="testLibraries()">æµ‹è¯•åº“åŠ è½½</button>
    </div>
    
    <div class="test-section">
        <h3>2. Supabase è¿æ¥æµ‹è¯•</h3>
        <div id="supabase-test-result"></div>
        <button onclick="testSupabase()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
    </div>
    
    <div class="test-section">
        <h3>3. å¯¼èˆªç»„ä»¶æµ‹è¯•</h3>
        <div id="nav-test-result"></div>
        <button onclick="testNavigation()">æµ‹è¯•å¯¼èˆªç»„ä»¶</button>
    </div>
    
    <div class="test-section">
        <h3>4. å·¥å…·å‡½æ•°æµ‹è¯•</h3>
        <div id="utils-test-result"></div>
        <button onclick="testUtils()">æµ‹è¯•å·¥å…·å‡½æ•°</button>
    </div>

    <script>
        window.addEventListener('load', function() {
            console.log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
            setTimeout(() => {
                testLibraries();
                testNavigation();
                testUtils();
            }, 500);
        });

        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${isSuccess ? 'success' : 'error'}">${message}</div>`;
        }

        function testLibraries() {
            let results = [];
            
            // æµ‹è¯• Supabase
            if (typeof supabase !== 'undefined') {
                results.push('âœ… Supabase åº“åŠ è½½æˆåŠŸ');
            } else {
                results.push('âŒ Supabase åº“åŠ è½½å¤±è´¥');
            }
            
            // æµ‹è¯• ClassroomCommon
            if (typeof ClassroomCommon !== 'undefined') {
                results.push('âœ… ClassroomCommon åŠ è½½æˆåŠŸ');
            } else {
                results.push('âŒ ClassroomCommon åŠ è½½å¤±è´¥');
            }
            
            // æµ‹è¯• NavigationComponent
            if (typeof NavigationComponent !== 'undefined') {
                results.push('âœ… NavigationComponent åŠ è½½æˆåŠŸ');
            } else {
                results.push('âŒ NavigationComponent åŠ è½½å¤±è´¥');
            }
            
            const allSuccess = !results.some(r => r.includes('âŒ'));
            showResult('lib-test-result', results.join('<br>'), allSuccess);
        }

        async function testSupabase() {
            try {
                if (typeof ClassroomCommon === 'undefined') {
                    showResult('supabase-test-result', 'âŒ ClassroomCommon æœªåŠ è½½', false);
                    return;
                }
                
                const client = ClassroomCommon.createSupabaseClient();
                if (!client) {
                    showResult('supabase-test-result', 'âŒ æ— æ³•åˆ›å»º Supabase å®¢æˆ·ç«¯', false);
                    return;
                }
                
                // å°è¯•è¿æ¥æµ‹è¯•
                const { data, error } = await client.from('global_state').select('id').limit(1);
                
                if (error) {
                    showResult('supabase-test-result', `âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, false);
                } else {
                    showResult('supabase-test-result', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', true);
                }
            } catch (err) {
                showResult('supabase-test-result', `âŒ æµ‹è¯•å¼‚å¸¸: ${err.message}`, false);
            }
        }

        function testNavigation() {
            try {
                if (typeof NavigationComponent === 'undefined') {
                    showResult('nav-test-result', 'âŒ NavigationComponent æœªåŠ è½½', false);
                    return;
                }
                
                // æµ‹è¯•åˆå§‹åŒ–
                NavigationComponent.init();
                
                // æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†å¯¼èˆªæ 
                const nav = document.querySelector('.bottom-nav');
                if (nav) {
                    showResult('nav-test-result', 'âœ… å¯¼èˆªç»„ä»¶åˆå§‹åŒ–æˆåŠŸï¼Œå¯¼èˆªæ å·²åˆ›å»º', true);
                } else {
                    showResult('nav-test-result', 'âš ï¸ å¯¼èˆªç»„ä»¶åŠ è½½æˆåŠŸï¼Œä½†æœªåˆ›å»ºå¯¼èˆªæ ï¼ˆå¯èƒ½å› ä¸ºé¡µé¢ç±»å‹ï¼‰', true);
                }
            } catch (err) {
                showResult('nav-test-result', `âŒ å¯¼èˆªç»„ä»¶æµ‹è¯•å¤±è´¥: ${err.message}`, false);
            }
        }

        function testUtils() {
            try {
                if (typeof ClassroomCommon === 'undefined') {
                    showResult('utils-test-result', 'âŒ ClassroomCommon æœªåŠ è½½', false);
                    return;
                }
                
                let results = [];
                
                // æµ‹è¯• escapeHtml
                const testHtml = '<script>alert("test")</script>';
                const escaped = ClassroomCommon.escapeHtml(testHtml);
                if (escaped.includes('&lt;') && escaped.includes('&gt;')) {
                    results.push('âœ… HTML è½¬ä¹‰åŠŸèƒ½æ­£å¸¸');
                } else {
                    results.push('âŒ HTML è½¬ä¹‰åŠŸèƒ½å¼‚å¸¸');
                }
                
                // æµ‹è¯• getTodayKey
                const todayKey = ClassroomCommon.getTodayKey();
                if (todayKey && todayKey.includes('-')) {
                    results.push('âœ… æ—¥æœŸå‡½æ•°æ­£å¸¸');
                } else {
                    results.push('âŒ æ—¥æœŸå‡½æ•°å¼‚å¸¸');
                }
                
                // æµ‹è¯• formatTime
                const formatted = ClassroomCommon.formatTime(new Date().toISOString());
                if (formatted && formatted.length > 0) {
                    results.push('âœ… æ—¶é—´æ ¼å¼åŒ–åŠŸèƒ½æ­£å¸¸');
                } else {
                    results.push('âŒ æ—¶é—´æ ¼å¼åŒ–åŠŸèƒ½å¼‚å¸¸');
                }
                
                const allSuccess = !results.some(r => r.includes('âŒ'));
                showResult('utils-test-result', results.join('<br>'), allSuccess);
                
            } catch (err) {
                showResult('utils-test-result', `âŒ å·¥å…·å‡½æ•°æµ‹è¯•å¤±è´¥: ${err.message}`, false);
            }
        }
    </script>
</body>
</html>